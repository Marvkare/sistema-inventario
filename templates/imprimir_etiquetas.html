{% extends "base.html" %}

{% block title %}Imprimir Etiquetas{% endblock %}

{% block content %}
<div class="page-wrapper">
    <div class="container-limit">
        
        <div class="header-card">
            <div class="header-text">
                <h1>Impresión de Etiquetas</h1>
                <p>Genere e imprima etiquetas personalizadas para los resguardos.</p>
            </div>
            <div class="header-icon-box">
                <i class="fas fa-tags"></i>
            </div>
        </div>

        <div class="card calibration-card">
            <div class="card-header">
                <div class="icon-box"><i class="fas fa-ruler-combined"></i></div>
                <h2>Calibración de Medidas</h2>
            </div>
            <div class="card-body">
                <div class="calibration-wrapper">
                    <div class="calibration-info">
                        <i class="fas fa-info-circle"></i>
                        <p>Mida el rectángulo en su pantalla con una regla. Debe medir <strong>100mm x 50mm</strong>. Ajuste el slider si no coincide.</p>
                    </div>
                    
                    <div class="calibration-visual">
                        <div id="calibration-box" class="cal-box">
                            <span id="calibration-size">100mm × 50mm</span>
                        </div>
                    </div>

                    <div class="slider-group">
                        <label>Factor de corrección: <span id="calibration_value" class="badge badge-mono">100%</span></label>
                        <input type="range" id="calibration_factor" min="80" max="120" value="100">
                        <div class="slider-labels">
                            <span>80%</span>
                            <span>120%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid-2">
            <div class="card">
                <div class="card-header">
                    <div class="icon-box"><i class="fas fa-search"></i></div>
                    <h2>Buscar Resguardos</h2>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label>Buscar por No. de Inventario, Resguardo, etc.</label>
                        <div class="input-with-icon">
                            <i class="fas fa-search icon"></i>
                            <input type="text" id="search_input" placeholder="Escribe mínimo 3 caracteres...">
                        </div>
                    </div>
                    <div id="search_results" class="results-list hidden"></div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="icon-box"><i class="fas fa-list-ol"></i></div>
                    <h2>Lista para Imprimir</h2>
                </div>
                <div class="card-body">
                    <div id="print_list" class="print-queue">
                        <div id="print_list_empty_message" class="empty-queue">
                            <i class="fas fa-inbox"></i>
                            <p>Selecciona un resguardo para agregarlo.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="icon-box"><i class="fas fa-cogs"></i></div>
                <h2>Configuración de Impresión</h2>
            </div>
            <div class="card-body">
                
                <div class="grid-4 mb-4">
                    <div class="form-group">
                        <label>Plantilla Papel</label>
                        <select id="template_select">
                            <option value="Letter">Carta (216 x 279 mm)</option>
                            <option value="A4">A4 (210 × 297 mm)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Ancho Etiqueta (mm)</label>
                        <input type="number" id="label_width_input" value="64" min="20">
                    </div>
                    <div class="form-group">
                        <label>Alto Etiqueta (mm)</label>
                        <input type="number" id="label_height_input" value="32" min="20">
                    </div>
                    <div class="form-group flex-end">
                        <button id="preview_button" class="btn btn-primary btn-block">
                            <i class="fas fa-eye"></i> Previsualizar
                        </button>
                    </div>
                </div>

                <hr class="separator">

                <div class="grid-4 mt-4">
                    <div class="slider-group">
                        <label>Fuente: <span id="font_size_value">8pt</span></label>
                        <input type="range" id="font_size_input" min="4" max="14" value="8">
                    </div>
                    <div class="slider-group">
                        <label>Logos: <span id="logo_size_value">25px</span></label>
                        <input type="range" id="logo_size_input" min="15" max="50" value="25">
                    </div>
                    <div class="slider-group">
                        <label>Esp. Horiz: <span id="horizontal_spacing_value">5mm</span></label>
                        <input type="range" id="horizontal_spacing_input" min="0" max="20" value="5">
                    </div>
                    <div class="slider-group">
                        <label>Esp. Vert: <span id="vertical_spacing_value">6mm</span></label>
                        <input type="range" id="vertical_spacing_input" min="0" max="20" value="6">
                    </div>
                </div>

                <div class="checkbox-row mt-4">
                    <label class="checkbox-card full-width">
                        <input type="checkbox" id="truncate_text" checked>
                        <span>Ajustar texto largo automáticamente (Truncar)</span>
                    </label>
                </div>

                <h3 class="subsection-title mt-4"><i class="fas fa-arrows-alt"></i> Márgenes de Página (mm)</h3>
                <div class="grid-4">
                    <div class="slider-group">
                        <label>Superior: <span id="margin_top_value">4mm</span></label>
                        <input type="range" id="margin_top_input" min="0" max="50" value="4">
                    </div>
                    <div class="slider-group">
                        <label>Derecho: <span id="margin_right_value">0mm</span></label>
                        <input type="range" id="margin_right_input" min="0" max="50" value="0">
                    </div>
                    <div class="slider-group">
                        <label>Inferior: <span id="margin_bottom_value">0mm</span></label>
                        <input type="range" id="margin_bottom_input" min="0" max="50" value="0">
                    </div>
                    <div class="slider-group">
                        <label>Izquierdo: <span id="margin_left_value">6mm</span></label>
                        <input type="range" id="margin_left_input" min="0" max="50" value="6">
                    </div>
                </div>

            </div>
        </div>

        <div id="preview-section" class="card hidden mt-4">
            <div class="card-header header-between">
                <div class="header-left">
                    <div class="icon-box"><i class="fas fa-print"></i></div>
                    <h2>Previsualización</h2>
                </div>
                <div class="header-actions">
                    <button id="back_button" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Cerrar
                    </button>
                    <button id="print_button" class="btn btn-green">
                        <i class="fas fa-print"></i> Imprimir Ahora
                    </button>
                </div>
            </div>
            <div class="card-body preview-body">
                <div class="paper-sheet" id="print_container"></div>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block styles %}
<style>
    /* VARIABLES */
    :root {
        --col-burgundy: #6A2E4D;
        --col-beige: #BC9B6A;
        --col-bg: #f9fafb;
        --radius: 12px;
        --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
    }

    /* Layout */
    .page-wrapper { min-height: 100vh; background: var(--col-bg); padding: 2rem 1rem; }
    .container-limit { max-width: 1200px; margin: 0 auto; }
    .mb-4 { margin-bottom: 2rem; }
    .mt-4 { margin-top: 2rem; }
    .hidden { display: none !important; }

    /* Header */
    .header-card {
        background: linear-gradient(to right, var(--col-burgundy), #551E3A);
        border-radius: var(--radius); padding: 1.5rem 2rem; color: white;
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 2rem; box-shadow: var(--shadow);
    }
    .header-text h1 { margin: 0; font-size: 1.5rem; }
    .header-text p { margin: 0.5rem 0 0; opacity: 0.9; }
    .header-icon-box {
        width: 48px; height: 48px; background: var(--col-beige); border-radius: 50%;
        display: flex; align-items: center; justify-content: center; color: var(--col-burgundy); font-size: 1.2rem;
    }

    /* Cards */
    .card { background: white; border-radius: var(--radius); box-shadow: var(--shadow); border: 1px solid #e5e7eb; overflow: hidden; margin-bottom: 2rem; }
    .card-header { padding: 1rem 1.5rem; border-bottom: 1px solid #f3f4f6; background: rgba(106, 46, 77, 0.03); display: flex; align-items: center; gap: 0.8rem; }
    .header-between { justify-content: space-between; }
    .header-left { display: flex; align-items: center; gap: 0.8rem; }
    .icon-box { width: 32px; height: 32px; background: var(--col-burgundy); border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; }
    .card-header h2 { margin: 0; font-size: 1.1rem; color: var(--col-burgundy); }
    .card-body { padding: 1.5rem; }

    /* Grids */
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
    .grid-4 { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }

    /* Calibración */
    .calibration-card { border-left: 5px solid #f59e0b; }
    .calibration-info { display: flex; gap: 0.5rem; color: #b45309; font-size: 0.9rem; margin-bottom: 1rem; }
    .calibration-visual { display: flex; justify-content: center; background: #fffbeb; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; }
    .cal-box {
        width: 100mm; height: 50mm; border: 2px solid var(--col-burgundy);
        background: white; display: flex; align-items: center; justify-content: center;
        font-weight: 700; color: var(--col-burgundy); transition: all 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    /* Búsqueda */
    .input-with-icon { position: relative; }
    .input-with-icon input { width: 100%; padding: 0.7rem 1rem 0.7rem 2.5rem; border: 1px solid #d1d5db; border-radius: 8px; }
    .input-with-icon input:focus { outline: none; border-color: var(--col-burgundy); box-shadow: 0 0 0 3px rgba(106, 46, 77, 0.1); }
    .input-with-icon .icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #9ca3af; }
    
    .results-list { max-height: 200px; overflow-y: auto; border: 1px solid #e5e7eb; margin-top: 0.5rem; border-radius: 8px; }
    .result-item { padding: 0.5rem; border-bottom: 1px solid #f3f4f6; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
    .result-item:hover { background: #fdfbf7; }
    
    /* Cola de Impresión */
    .print-queue { min-height: 100px; max-height: 300px; overflow-y: auto; background: #fafafa; border: 1px dashed #d1d5db; border-radius: 8px; padding: 0.5rem; }
    .print-item { background: white; padding: 0.5rem; border-radius: 6px; border: 1px solid #e5e7eb; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    .empty-queue { text-align: center; padding: 2rem; color: #9ca3af; }
    .empty-queue i { font-size: 2rem; margin-bottom: 0.5rem; }

    /* Inputs Configuración */
    .form-group label { display: block; font-size: 0.85rem; font-weight: 600; color: #374151; margin-bottom: 0.3rem; }
    input[type="number"], select { width: 100%; padding: 0.6rem; border: 1px solid #d1d5db; border-radius: 6px; }
    .form-group.flex-end { display: flex; align-items: flex-end; }

    /* Sliders Personalizados */
    .slider-group label { display: flex; justify-content: space-between; font-size: 0.85rem; font-weight: 600; color: #4b5563; margin-bottom: 0.3rem; }
    input[type="range"] { -webkit-appearance: none; width: 100%; height: 6px; background: #e5e7eb; border-radius: 3px; outline: none; }
    input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; background: var(--col-burgundy); cursor: pointer; transition: transform 0.1s; }
    input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.2); }
    .slider-labels { display: flex; justify-content: space-between; font-size: 0.7rem; color: #9ca3af; margin-top: 2px; }

    .separator { margin: 1.5rem 0; border: 0; border-top: 1px dashed #e5e7eb; }
    .subsection-title { font-size: 1rem; font-weight: 700; color: var(--col-burgundy); margin-bottom: 1rem; }

    /* Checkbox Card */
    .checkbox-card { display: flex; align-items: center; gap: 0.5rem; padding: 0.8rem; background: #fdfbf7; border: 1px solid var(--col-beige); border-radius: 8px; cursor: pointer; }
    .checkbox-card input { width: 1.2rem; height: 1.2rem; accent-color: var(--col-burgundy); }

    /* Botones */
    .btn { padding: 0.6rem 1.2rem; border-radius: 8px; font-weight: 600; border: none; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem; transition: all 0.2s; }
    .btn-primary { background: var(--col-burgundy); color: white; }
    .btn-primary:hover { background: #551E3A; transform: translateY(-1px); }
    .btn-secondary { background: white; border: 1px solid #d1d5db; color: #374151; }
    .btn-secondary:hover { background: #f3f4f6; }
    .btn-green { background: #16a34a; color: white; }
    .btn-green:hover { background: #15803d; }
    .btn-danger { background: #ef4444; color: white; font-size: 0.75rem; padding: 0.3rem 0.6rem; border-radius: 4px; }
    .btn-select { background: #16a34a; color: white; font-size: 0.75rem; padding: 0.3rem 0.6rem; border-radius: 20px; }
    .btn-block { width: 100%; justify-content: center; }

    /* Hoja de Papel (Preview) */
    .preview-body { background: #555; padding: 2rem; display: flex; justify-content: center; overflow: auto; }
    .paper-sheet {
        background: white; box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        /* Dimensiones iniciales, JS las ajustará */
        width: 215.9mm; min-height: 279.4mm; padding: 5mm;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .grid-2 { grid-template-columns: 1fr; }
        .header-card { flex-direction: column; text-align: center; }
        .form-group.flex-end { margin-top: 1rem; }
        .header-actions { flex-direction: column; width: 100%; }
        .header-actions .btn { width: 100%; }
    }
    
    @media print {
        body * { visibility: hidden; }
        #print_container, #print_container * { visibility: visible; }
        #print_container { position: absolute; left: 0; top: 0; margin: 0; padding: 0; box-shadow: none; width: 100% !important; }
        @page { margin: 0; }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    console.log("✅ Script Etiquetas Cargado");

    // --- Variables ---
    const searchInput = document.getElementById('search_input');
    const searchResults = document.getElementById('search_results');
    const printList = document.getElementById('print_list');
    const printListEmptyMessage = document.getElementById('print_list_empty_message');
    const printContainer = document.getElementById('print_container');
    const previewSection = document.getElementById('preview-section');
    
    // Inputs Config
    const labelWidthInput = document.getElementById('label_width_input');
    const labelHeightInput = document.getElementById('label_height_input');
    const fontSizeInput = document.getElementById('font_size_input');
    const logoSizeInput = document.getElementById('logo_size_input');
    const horizontalSpacingInput = document.getElementById('horizontal_spacing_input');
    const verticalSpacingInput = document.getElementById('vertical_spacing_input');
    const truncateTextCheckbox = document.getElementById('truncate_text');
    
    // Márgenes
    const marginTopInput = document.getElementById('margin_top_input');
    const marginRightInput = document.getElementById('margin_right_input');
    const marginBottomInput = document.getElementById('margin_bottom_input');
    const marginLeftInput = document.getElementById('margin_left_input');
    
    // Calibración
    const calibrationFactorInput = document.getElementById('calibration_factor');
    const calibrationBox = document.getElementById('calibration-box');
    const calibrationSize = document.getElementById('calibration-size');

    let selectedItems = {};
    let searchTimeout = null;

    // --- UI Updates ---
    const updateLabels = () => {
        document.getElementById('font_size_value').textContent = `${fontSizeInput.value}pt`;
        document.getElementById('logo_size_value').textContent = `${logoSizeInput.value}px`;
        document.getElementById('horizontal_spacing_value').textContent = `${horizontalSpacingInput.value}mm`;
        document.getElementById('vertical_spacing_value').textContent = `${verticalSpacingInput.value}mm`;
        document.getElementById('margin_top_value').textContent = `${marginTopInput.value}mm`;
        document.getElementById('margin_right_value').textContent = `${marginRightInput.value}mm`;
        document.getElementById('margin_bottom_value').textContent = `${marginBottomInput.value}mm`;
        document.getElementById('margin_left_value').textContent = `${marginLeftInput.value}mm`;
        document.getElementById('calibration_value').textContent = `${calibrationFactorInput.value}%`;
        
        // Actualizar Caja Calibración
        const factor = parseInt(calibrationFactorInput.value) / 100;
        const w = 100 * factor;
        const h = 50 * factor;
        calibrationBox.style.width = `${w}mm`;
        calibrationBox.style.height = `${h}mm`;
        calibrationSize.textContent = `${w.toFixed(1)}mm × ${h.toFixed(1)}mm`;

        // Si el preview está visible, refrescar
        if (!previewSection.classList.contains('hidden') && Object.keys(selectedItems).length > 0) {
            renderLabelsForPreview();
        }
    };

    // Bind Events
    const inputs = [fontSizeInput, logoSizeInput, horizontalSpacingInput, verticalSpacingInput, 
                   marginTopInput, marginRightInput, marginBottomInput, marginLeftInput, 
                   calibrationFactorInput, truncateTextCheckbox, labelWidthInput, labelHeightInput];
    inputs.forEach(el => {
        el.addEventListener('input', updateLabels);
        el.addEventListener('change', updateLabels);
    });

    // --- Búsqueda ---
    const truncate = (text, len) => {
        if (!text) return '';
        return text.length > len ? text.substring(0, len) + '...' : text;
    };

    searchInput.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        const q = searchInput.value.trim();
        if (q.length < 3) {
            searchResults.classList.add('hidden');
            return;
        }
        
        searchTimeout = setTimeout(async () => {
            try {
                const res = await fetch('/buscar_bienes', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ query: q })
                });
                if (res.ok) {
                    const items = await res.json();
                    searchResults.innerHTML = '';
                    if (items.length === 0) {
                        searchResults.innerHTML = '<div class="p-2 text-gray-500">Sin resultados</div>';
                    } else {
                        items.forEach(item => {
                            const div = document.createElement('div');
                            div.className = 'result-item';
                            div.innerHTML = `
                                <div>
                                    <strong>${item.No_Inventario}</strong> - <small>${truncate(item.Descripcion_Corta_Del_Bien, 30)}</small>
                                    <div style="font-size:0.8rem; color:#666;">${item.No_Resguardo || 'Sin Resg.'} | ${item.Area_Nombre || '-'}</div>
                                </div>
                                <button class="btn-select">Agregar</button>
                            `;
                            div.querySelector('button').onclick = () => addItem(item);
                            searchResults.appendChild(div);
                        });
                    }
                    searchResults.classList.remove('hidden');
                }
            } catch (e) { console.error(e); }
        }, 300);
    });

    // --- Gestión de Lista ---
    const addItem = (item) => {
        if (selectedItems[item.id_resguardo]) return;
        selectedItems[item.id_resguardo] = item;
        
        const div = document.createElement('div');
        div.className = 'print-item';
        div.id = `item-${item.id_resguardo}`;
        div.innerHTML = `
            <span><strong>${item.No_Inventario}</strong> - ${truncate(item.Descripcion_Corta_Del_Bien, 25)}</span>
            <button class="btn-danger" onclick="removeItem('${item.id_resguardo}')">Quitar</button>
        `;
        printList.appendChild(div);
        printListEmptyMessage.classList.add('hidden');
        searchResults.classList.add('hidden');
        searchInput.value = '';
    };

    window.removeItem = (id) => {
        delete selectedItems[id];
        document.getElementById(`item-${id}`).remove();
        if (Object.keys(selectedItems).length === 0) {
            printListEmptyMessage.classList.remove('hidden');
        }
    };

    // --- Generación HTML ---
    const generateHTML = () => {
        let html = '';
        const config = {
            w: parseFloat(labelWidthInput.value),
            h: parseFloat(labelHeightInput.value),
            font: parseInt(fontSizeInput.value),
            logo: parseInt(logoSizeInput.value) * 0.264583, // px to mm approx
            hGap: parseInt(horizontalSpacingInput.value),
            vGap: parseInt(verticalSpacingInput.value),
            factor: parseInt(calibrationFactorInput.value) / 100,
            truncate: truncateTextCheckbox.checked
        };

        // Aplicar factor
        const finalW = config.w * config.factor;
        const finalH = config.h * config.factor;
        const finalHGap = config.hGap * config.factor;
        const finalVGap = config.vGap * config.factor;

        Object.values(selectedItems).forEach(item => {
            const desc = config.truncate ? truncate(item.Descripcion_Corta_Del_Bien, 35) : item.Descripcion_Corta_Del_Bien;
            const area = config.truncate ? truncate(item.Area_Nombre, 25) : item.Area_Nombre;
            
            html += `
                <div style="
                    width: ${finalW}mm; height: ${finalH}mm;
                    display: inline-flex; flex-direction: column;
                    margin-right: ${finalHGap}mm; margin-bottom: ${finalVGap}mm;
                    border: 0.25mm solid #5A2E44; padding: 2mm;
                    box-sizing: border-box; overflow: hidden;
                    font-family: sans-serif; font-size: ${config.font}pt;
                    color: #000; justify-content: space-between;
                    page-break-inside: avoid;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <img src="/static/images/image_e8aecf.jpg" style="height: ${config.logo}mm;">
                        <strong style="color: #5A2E44; font-size: 1.2em;">${item.No_Resguardo || 'S/N'}</strong>
                        <img src="/static/images/image_e8b1f6.png" style="height: ${config.logo}mm;">
                    </div>
                    <div style="flex-grow: 1; display: flex; flex-direction: column; justify-content: center; line-height: 1.2;">
                        <div style="display:flex; justify-content:space-between;">
                            <b>Inv:</b> <span>${item.No_Inventario}</span>
                        </div>
                        <div style="display:flex; justify-content:space-between;">
                            <b>Desc:</b> <span>${desc}</span>
                        </div>
                        <div style="display:flex; justify-content:space-between;">
                            <b>Área:</b> <span>${area}</span>
                        </div>
                    </div>
                </div>`;
        });
        return html;
    };

    const renderLabelsForPreview = () => {
        if (Object.keys(selectedItems).length === 0) {
            alert("Seleccione al menos un resguardo");
            return;
        }
        
        // Configurar márgenes del contenedor
        const factor = parseInt(calibrationFactorInput.value) / 100;
        const mt = parseInt(marginTopInput.value) * factor;
        const mr = parseInt(marginRightInput.value) * factor;
        const mb = parseInt(marginBottomInput.value) * factor;
        const ml = parseInt(marginLeftInput.value) * factor;
        
        printContainer.style.padding = `${mt}mm ${mr}mm ${mb}mm ${ml}mm`;
        
        // Tamaño de papel visual
        const paperSize = document.getElementById('template_select').value;
        printContainer.style.width = paperSize === 'Letter' ? '215.9mm' : '210mm';
        printContainer.style.minHeight = paperSize === 'Letter' ? '279.4mm' : '297mm';

        printContainer.innerHTML = generateHTML();
        previewSection.classList.remove('hidden');
        previewSection.scrollIntoView({behavior: 'smooth'});
    };

    // Botones
    document.getElementById('preview_button').onclick = renderLabelsForPreview;
    
    document.getElementById('print_button').onclick = () => {
        window.print();
    };
    
    document.getElementById('back_button').onclick = () => {
        previewSection.classList.add('hidden');
    };

    updateLabels();
});
</script>
{% endblock %}