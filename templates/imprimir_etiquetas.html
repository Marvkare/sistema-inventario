{% extends "base.html" %}

{% block title %}Imprimir Etiquetas - Sistema de Resguardos{% endblock %}

{% block styles %}
<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    
    :root {
        --color-burgundy: #6A2E4D;
        --color-burgundy-dark: #551E3A;
        --color-beige: #BC9B6A;
        --color-beige-light: #D7C3A0;
        --color-background-light: #f8f9fa;
    }

    .preview-container {
        width: 215.9mm;
        min-height: 279.4mm;
        margin: 10px auto;
        background: white;
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        padding: 10mm;
        box-sizing: border-box;
        border-radius: 12px;
    }
    
    .config-panel {
        background-color: #fefefe;
        border-radius: 12px;
        padding: 1.5rem;
        margin-top: 1rem;
        border: 1px solid #D7C3A0;
        box-shadow: 0 4px 6px rgba(106, 46, 77, 0.05);
    }
    
    .search-results-container {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #D7C3A0;
        border-radius: 8px;
        margin-top: 0.5rem;
        display: none;
        background: white;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }
    
    .print-list-container {
        min-height: 200px;
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #D7C3A0;
        border-radius: 8px;
        background: #fefefe;
    }
    
    .print-item:hover {
        background-color: #f8f5f0;
        transform: translateX(4px);
        transition: all 0.2s ease;
    }
    
    .margin-controls-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
    }
    
    @media (min-width: 768px) {
        .margin-controls-grid {
            grid-template-columns: repeat(4, 1fr);
        }
    }
    
    .calibration-box {
        width: 100mm;
        height: 50mm;
        border: 2px solid #6A2E4D;
        margin: 10px auto;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #f8f5f0 0%, #e8e0d0 100%);
        transition: all 0.3s ease;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(106, 46, 77, 0.1);
    }

    /* Scrollbar personalizado */
    .search-results-container::-webkit-scrollbar,
    .print-list-container::-webkit-scrollbar {
        width: 6px;
    }
    
    .search-results-container::-webkit-scrollbar-track,
    .print-list-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }
    
    .search-results-container::-webkit-scrollbar-thumb,
    .print-list-container::-webkit-scrollbar-thumb {
        background: #BC9B6A;
        border-radius: 3px;
    }
    
    .search-results-container::-webkit-scrollbar-thumb:hover,
    .print-list-container::-webkit-scrollbar-thumb:hover {
        background: #6A2E4D;
    }

    /* Estilos para inputs y selects */
    input[type="text"], 
    input[type="number"], 
    select {
        border: 1px solid #D7C3A0;
        transition: all 0.3s ease;
    }

    input[type="text"]:focus, 
    input[type="number"]:focus, 
    select:focus {
        outline: none;
        border-color: #6A2E4D;
        box-shadow: 0 0 0 3px rgba(106, 46, 77, 0.1);
    }

    /* Estilos para sliders */
    input[type="range"] {
        -webkit-appearance: none;
        height: 6px;
        background: #D7C3A0;
        border-radius: 3px;
    }

    input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 18px;
        height: 18px;
        background: #6A2E4D;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    input[type="range"]::-webkit-slider-thumb:hover {
        background: #551E3A;
        transform: scale(1.1);
    }

    /* Clase para ocultar elementos */
    .hidden {
        display: none !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-50 to-beige-light/20 py-8 px-4">
    <div class="max-w-7xl mx-auto">
        
        <!-- ENCABEZADO MEJORADO -->
        <div class="bg-white rounded-2xl shadow-xl border border-beige-light overflow-hidden mb-8">
            <div class="bg-gradient-to-r from-burgundy to-burgundy-dark p-6 text-white">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold">
                            Impresión de Etiquetas de Resguardos
                        </h1>
                        <p class="text-beige-light mt-2">
                            Genere e imprima etiquetas personalizadas para los resguardos del sistema
                        </p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="w-10 h-10 bg-beige rounded-full flex items-center justify-center">
                            <i class="fas fa-tags text-burgundy text-lg"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="space-y-8">
            <!-- SECCIÓN DE CALIBRACIÓN MEJORADA -->
            <div class="bg-white rounded-2xl shadow-lg border border-beige-light overflow-hidden">
                <div class="p-6 md:p-8">
                    <div class="flex items-center mb-6">
                        <div class="w-8 h-8 bg-burgundy rounded-full flex items-center justify-center mr-3">
                            <i class="fas fa-ruler text-white text-sm"></i>
                        </div>
                        <h2 class="text-xl font-bold text-burgundy">Calibración de Medidas</h2>
                    </div>
                    
                    <div class="bg-yellow-50 p-6 rounded-xl border border-yellow-200">
                        <p class="text-yellow-800 mb-4 flex items-center">
                            <i class="fas fa-info-circle mr-2"></i>
                            Mida el siguiente rectángulo con una regla. Debe medir 100mm x 50mm. Ajuste el factor de corrección si no coincide.
                        </p>
                        <div class="calibration-box" id="calibration-box">
                            <span id="calibration-size" class="font-semibold text-burgundy">100mm × 50mm</span>
                        </div>
                        <div class="mt-4">
                            <label for="calibration_factor" class="block text-sm font-semibold text-yellow-700 mb-2 flex items-center">
                                <i class="fas fa-sliders-h mr-2"></i>
                                Factor de corrección:
                            </label>
                            <input type="range" id="calibration_factor" min="80" max="120" value="100" class="w-full">
                            <div class="flex justify-between text-xs text-yellow-600 mt-1">
                                <span>80%</span>
                                <span id="calibration_value" class="font-semibold">100% (sin corrección)</span>
                                <span>120%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECCIÓN DE BÚSQUEDA Y SELECCIÓN MEJORADA -->
            <div class="bg-white rounded-2xl shadow-lg border border-beige-light overflow-hidden">
                <div class="p-6 md:p-8">
                    <div class="flex items-center mb-6">
                        <div class="w-8 h-8 bg-burgundy rounded-full flex items-center justify-center mr-3">
                            <i class="fas fa-search text-white text-sm"></i>
                        </div>
                        <h2 class="text-xl font-bold text-burgundy">Buscar y Seleccionar Resguardos</h2>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Búsqueda -->
                        <div>
                            <label for="search_input" class="block text-sm font-semibold text-gray-700 mb-2 flex items-center">
                                <i class="fas fa-search text-burgundy mr-2 text-xs"></i>
                                Buscar por No. de Inventario, Resguardo, etc.
                            </label>
                            <input type="text" 
                                   id="search_input" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200"
                                   placeholder="Escribe para buscar... (mínimo 3 caracteres)">
                            <div id="search_results" class="search-results-container"></div>
                        </div>

                        <!-- Lista para imprimir -->
                        <div>
                            <h3 class="text-lg font-semibold text-gray-700 mb-3 flex items-center">
                                <i class="fas fa-list text-burgundy mr-2"></i>
                                Resguardos para Imprimir
                            </h3>
                            <div id="print_list" class="print-list-container p-4">
                                <p id="print_list_empty_message" class="text-gray-400 text-sm italic text-center py-8">
                                    <i class="fas fa-inbox text-2xl mb-2 block"></i>
                                    Selecciona un resguardo para agregarlo.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CONFIGURACIÓN DE IMPRESIÓN MEJORADA -->
            <div class="bg-white rounded-2xl shadow-lg border border-beige-light overflow-hidden">
                <div class="p-6 md:p-8">
                    <div class="flex items-center mb-6">
                        <div class="w-8 h-8 bg-burgundy rounded-full flex items-center justify-center mr-3">
                            <i class="fas fa-cogs text-white text-sm"></i>
                        </div>
                        <h2 class="text-xl font-bold text-burgundy">Configuración de Impresión</h2>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div>
                            <label for="template_select" class="block text-sm font-semibold text-gray-700 mb-2">Plantilla de Etiqueta</label>
                            <select id="template_select" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200">
                                <option value="Letter">Tamaño Carta (216 x 279 mm)</option>
                                <option value="A4">Tamaño A4 (210 × 297 mm)</option>
                            </select>
                        </div>
                        <div>
                            <label for="label_width_input" class="block text-sm font-semibold text-gray-700 mb-2">Ancho de Etiqueta (mm)</label>
                            <input type="number" id="label_width_input" value="64" step="1" min="20" max="150" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200">
                        </div>
                        <div>
                            <label for="label_height_input" class="block text-sm font-semibold text-gray-700 mb-2">Alto de Etiqueta (mm)</label>
                            <input type="number" id="label_height_input" value="32" step="1" min="20" max="150" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200">
                        </div>
                        <div class="flex items-end">
                            <button id="preview_button" 
                                    class="w-full inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-semibold rounded-xl shadow-sm text-beige bg-gradient-to-r from-burgundy to-burgundy-dark hover:from-burgundy-dark hover:to-burgundy focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-burgundy transition-all duration-200 ease-in-out">
                                <i class="fas fa-eye mr-2"></i> Previsualizar
                            </button>
                        </div>
                    </div>

                    <!-- PANEL DE CONFIGURACIÓN MEJORADO -->
                    <div class="config-panel">
                        <h3 class="text-lg font-semibold text-burgundy mb-4 flex items-center">
                            <i class="fas fa-sliders-h mr-2"></i>
                            Ajustes de Contenido
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-6">
                            <div>
                                <label for="font_size_input" class="block text-sm font-semibold text-gray-700 mb-2">Tamaño de fuente</label>
                                <input type="range" id="font_size_input" min="2" max="14" value="8" class="w-full">
                                <span id="font_size_value" class="text-xs text-gray-500 block text-center mt-1">8pt</span>
                            </div>
                            <div>
                                <label for="logo_size_input" class="block text-sm font-semibold text-gray-700 mb-2">Tamaño de logos</label>
                                <input type="range" id="logo_size_input" min="15" max="50" value="25" class="w-full">
                                <span id="logo_size_value" class="text-xs text-gray-500 block text-center mt-1">25px</span>
                            </div>
                            <div>
                                <label for="horizontal_spacing_input" class="block text-sm font-semibold text-gray-700 mb-2">Esp. horizontal (mm)</label>
                                <input type="range" id="horizontal_spacing_input" min="0" max="20" value="5" step="1" class="w-full">
                                <span id="horizontal_spacing_value" class="text-xs text-gray-500 block text-center mt-1">5mm</span>
                            </div>
                            <div>
                                <label for="vertical_spacing_input" class="block text-sm font-semibold text-gray-700 mb-2">Esp. vertical (mm)</label>
                                <input type="range" id="vertical_spacing_input" min="0" max="20" value="6" step="1" class="w-full">
                                <span id="vertical_spacing_value" class="text-xs text-gray-500 block text-center mt-1">6mm</span>
                            </div>
                            <div class="flex items-center justify-center">
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="truncate_text" class="rounded border-gray-300 text-burgundy focus:ring-burgundy/50" checked>
                                    <span class="text-sm font-semibold text-gray-700">Ajustar texto</span>
                                </label>
                            </div>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-burgundy mt-8 mb-4 flex items-center">
                            <i class="fas fa-arrows-alt mr-2"></i>
                            Márgenes del Documento (mm)
                        </h3>
                        <div class="margin-controls-grid">
                            <div>
                                <label for="margin_top_input" class="block text-sm font-semibold text-gray-700 mb-2">Superior</label>
                                <input type="range" id="margin_top_input" min="0" max="30" value="4" step="1" class="w-full">
                                <span id="margin_top_value" class="text-xs text-gray-500 block text-center mt-1">4mm</span>
                            </div>
                            <div>
                                <label for="margin_right_input" class="block text-sm font-semibold text-gray-700 mb-2">Derecho</label>
                                <input type="range" id="margin_right_input" min="0" max="30" value="0" step="1" class="w-full">
                                <span id="margin_right_value" class="text-xs text-gray-500 block text-center mt-1">0mm</span>
                            </div>
                            <div>
                                <label for="margin_bottom_input" class="block text-sm font-semibold text-gray-700 mb-2">Inferior</label>
                                <input type="range" id="margin_bottom_input" min="0" max="30" value="0" step="1" class="w-full">
                                <span id="margin_bottom_value" class="text-xs text-gray-500 block text-center mt-1">0mm</span>
                            </div>
                            <div>
                                <label for="margin_left_input" class="block text-sm font-semibold text-gray-700 mb-2">Izquierdo</label>
                                <input type="range" id="margin_left_input" min="0" max="30" value="6" step="1" class="w-full">
                                <span id="margin_left_value" class="text-xs text-gray-500 block text-center mt-1">6mm</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECCIÓN DE PREVISUALIZACIÓN MEJORADA -->
        <div id="preview-section" class="bg-white rounded-2xl shadow-lg border border-beige-light overflow-hidden hidden mt-8">
            <div class="p-6 md:p-8">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-burgundy rounded-full flex items-center justify-center mr-3">
                            <i class="fas fa-print text-white text-sm"></i>
                        </div>
                        <h2 class="text-xl font-bold text-burgundy">Previsualización de Etiquetas</h2>
                    </div>
                    <div class="flex space-x-4">
                        <button id="print_button" 
                                class="inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-semibold rounded-xl shadow-sm text-white bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-all duration-200 ease-in-out">
                            <i class="fas fa-print mr-2"></i> Imprimir
                        </button>
                        <button id="back_button" 
                                class="inline-flex items-center justify-center px-6 py-3 border-2 border-gray-300 text-base font-semibold rounded-xl text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-all duration-200 ease-in-out">
                            <i class="fas fa-arrow-left mr-2"></i> Volver a ajustar
                        </button>
                    </div>
                </div>
                <div class="preview-container" id="print_container"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        console.log("✅ Script cargado - Impresión de Etiquetas");

        // --- Declaraciones de variables ---
        const searchInput = document.getElementById('search_input');
        const searchResults = document.getElementById('search_results');
        const printList = document.getElementById('print_list');
        const previewButton = document.getElementById('preview_button');
        const printButton = document.getElementById('print_button');
        const backButton = document.getElementById('back_button');
        const printListEmptyMessage = document.getElementById('print_list_empty_message');
        const printContainer = document.getElementById('print_container');
        const previewSection = document.getElementById('preview-section');
        const labelWidthInput = document.getElementById('label_width_input');
        const labelHeightInput = document.getElementById('label_height_input');
        const fontSizeInput = document.getElementById('font_size_input');
        const fontSizeValue = document.getElementById('font_size_value');
        const logoSizeInput = document.getElementById('logo_size_input');
        const logoSizeValue = document.getElementById('logo_size_value');
        const horizontalSpacingInput = document.getElementById('horizontal_spacing_input');
        const horizontalSpacingValue = document.getElementById('horizontal_spacing_value');
        const verticalSpacingInput = document.getElementById('vertical_spacing_input');
        const verticalSpacingValue = document.getElementById('vertical_spacing_value');
        const truncateTextCheckbox = document.getElementById('truncate_text');
        const marginTopInput = document.getElementById('margin_top_input');
        const marginTopValue = document.getElementById('margin_top_value');
        const marginRightInput = document.getElementById('margin_right_input');
        const marginRightValue = document.getElementById('margin_right_value');
        const marginBottomInput = document.getElementById('margin_bottom_input');
        const marginBottomValue = document.getElementById('margin_bottom_value');
        const marginLeftInput = document.getElementById('margin_left_input');
        const marginLeftValue = document.getElementById('margin_left_value');
        const calibrationFactorInput = document.getElementById('calibration_factor');
        const calibrationValue = document.getElementById('calibration_value');
        const calibrationBox = document.getElementById('calibration-box');
        const calibrationSize = document.getElementById('calibration-size');

        let selectedItems = {};
        let searchTimeout = null;
        
        const getConfig = () => ({
            baseFontSize: parseInt(fontSizeInput.value),
            logoSize: parseInt(logoSizeInput.value),
            horizontalSpacing: parseInt(horizontalSpacingInput.value),
            verticalSpacing: parseInt(verticalSpacingInput.value),
            truncateLongText: truncateTextCheckbox.checked,
            marginTop: parseInt(marginTopInput.value),
            marginRight: parseInt(marginRightInput.value),
            marginBottom: parseInt(marginBottomInput.value),
            marginLeft: parseInt(marginLeftInput.value),
            calibrationFactor: parseInt(calibrationFactorInput.value) / 100,
            labelWidth: parseFloat(labelWidthInput.value),
            labelHeight: parseFloat(labelHeightInput.value)
        });

        const applyCalibration = (measurement, factor) => measurement * factor;

        const updateCalibrationBox = () => {
            const factor = parseInt(calibrationFactorInput.value) / 100;
            const width = 100 * factor;
            const height = 50 * factor;
            calibrationBox.style.width = `${width}mm`;
            calibrationBox.style.height = `${height}mm`;
            calibrationSize.textContent = `${width.toFixed(1)}mm × ${height.toFixed(1)}mm`;
        };

        const updateUI = () => {
            fontSizeValue.textContent = `${fontSizeInput.value}pt`;
            logoSizeValue.textContent = `${logoSizeInput.value}px`;
            horizontalSpacingValue.textContent = `${horizontalSpacingInput.value}mm`;
            verticalSpacingValue.textContent = `${verticalSpacingInput.value}mm`;
            marginTopValue.textContent = `${marginTopInput.value}mm`;
            marginRightValue.textContent = `${marginRightInput.value}mm`;
            marginBottomValue.textContent = `${marginBottomInput.value}mm`;
            marginLeftValue.textContent = `${marginLeftInput.value}mm`;
            calibrationValue.textContent = `${calibrationFactorInput.value}%`;
            updateCalibrationBox();
            
            // CORRECCIÓN: Verificar correctamente si la sección de previsualización está visible
            if (!previewSection.classList.contains('hidden') && Object.keys(selectedItems).length > 0) {
                renderLabelsForPreview();
            }
        };
        
        // Centralizar los event listeners
        [fontSizeInput, logoSizeInput, horizontalSpacingInput, verticalSpacingInput, marginTopInput, marginRightInput, marginBottomInput, marginLeftInput, calibrationFactorInput, truncateTextCheckbox, labelWidthInput, labelHeightInput].forEach(el => {
            el.addEventListener('input', updateUI);
            el.addEventListener('change', updateUI);
        });
        
        // --- Funciones de búsqueda y selección ---
        const truncateText = (text, maxLength, shouldTruncate) => {
            if (!shouldTruncate || !text || text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        };

        const renderSearchResults = (items) => {
            searchResults.innerHTML = '';
            if (items.length === 0) {
                searchResults.innerHTML = '<p class="text-gray-500 p-2 text-sm italic">No se encontraron coincidencias.</p>';
                searchResults.style.display = 'block';
                return;
            }
            items.forEach(item => {
                const desc = item.Descripcion_Corta_Del_Bien && item.Descripcion_Corta_Del_Bien !== 'null' ? item.Descripcion_Corta_Del_Bien : 'Sin descripción';
                const resultItem = document.createElement('div');
                resultItem.classList.add('p-2', 'border-b', 'border-gray-200', 'flex', 'items-center', 'justify-between', 'hover:bg-gray-100', 'cursor-pointer');
                resultItem.dataset.itemData = JSON.stringify(item);
                resultItem.innerHTML = `
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-900">${item.No_Inventario} - ${desc}</p>
                        <p class="text-xs text-gray-500">Área: ${item.Area_Nombre || 'N/A'} | Resguardo: ${item.No_Resguardo || 'N/A'}</p>
                    </div>
                    <button class="add-to-print-list bg-green-500 hover:bg-green-600 text-white text-xs font-bold py-1 px-3 rounded-full transition-colors duration-200">Seleccionar</button>`;
                searchResults.appendChild(resultItem);
            });
            searchResults.style.display = 'block';
        };

        const addItemToPrintList = (item) => {
            if (selectedItems[item.id_resguardo]) return;
            selectedItems[item.id_resguardo] = item;
            const desc = item.Descripcion_Corta_Del_Bien && item.Descripcion_Corta_Del_Bien !== 'null' ? item.Descripcion_Corta_Del_Bien : 'Sin descripción';
            const listItem = document.createElement('div');
            listItem.className = 'p-2 bg-gray-100 rounded-md mb-2 flex items-center justify-between print-item';
            listItem.id = `print-item-${item.id_resguardo}`;
            listItem.innerHTML = `
                <p class="text-sm text-gray-800 flex-1">${item.No_Inventario} - ${desc}</p>
                <a href="/editar_resguardo/${item.id_resguardo}" target="_blank" class="mr-2 text-blue-600 hover:underline text-xs">Editar</a>
                <button class="remove-from-print-list bg-red-500 hover:bg-red-600 text-white text-xs font-bold py-1 px-3 rounded-full transition-colors duration-200" data-id="${item.id_resguardo}">Quitar</button>`;
            printList.appendChild(listItem);
            printListEmptyMessage.style.display = 'none';
        };

        searchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            const query = searchInput.value.trim();
            if (query.length < 3) {
                searchResults.style.display = 'none';
                return;
            }
            searchTimeout = setTimeout(async () => {
                try {
                    const response = await fetch('/buscar_bienes', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest'},
                        body: JSON.stringify({ query })
                    });
                    if (response.ok) {
                        renderSearchResults(await response.json());
                    } else {
                        searchResults.innerHTML = '<p class="text-red-500 p-2 text-sm">Error al buscar.</p>';
                        searchResults.style.display = 'block';
                    }
                } catch (error) {
                    searchResults.innerHTML = '<p class="text-red-500 p-2 text-sm">Error de conexión.</p>';
                    searchResults.style.display = 'block';
                }
            }, 300);
        });

        document.addEventListener('click', (e) => {
            if (e.target.closest('.add-to-print-list')) {
                const itemData = JSON.parse(e.target.closest('[data-item-data]').dataset.itemData);
                addItemToPrintList(itemData);
            }
            if (e.target.classList.contains('remove-from-print-list')) {
                const itemId = e.target.dataset.id;
                delete selectedItems[itemId];
                document.getElementById(`print-item-${itemId}`).remove();
                if(Object.keys(selectedItems).length === 0) printListEmptyMessage.style.display = 'block';
            }
            if (!searchResults.contains(e.target) && e.target !== searchInput) {
                searchResults.style.display = 'none';
            }
        });

        // --- GENERACIÓN DE ETIQUETAS ---
        const generateLabelsHTML = (items, config) => {
            let labelsHtml = '';
            const itemsArray = Object.values(items);
            
            // Aplicar calibración a las dimensiones y espaciados
            const labelWidth = applyCalibration(config.labelWidth, config.calibrationFactor);
            const labelHeight = applyCalibration(config.labelHeight, config.calibrationFactor);
            const hSpacing = applyCalibration(config.horizontalSpacing, config.calibrationFactor);
            const vSpacing = applyCalibration(config.verticalSpacing, config.calibrationFactor);
            
            // Conversión de unidades más directa y predecible
            const fontSizePt = config.baseFontSize;
            const logoHeightMm = (config.logoSize * 0.264583);
            const titleFontSizePt = fontSizePt * 1.5;
            const paddingMm = 2;

            itemsArray.forEach(item => {
                const descripcion = truncateText(
                    item.Descripcion_Corta_Del_Bien && item.Descripcion_Corta_Del_Bien !== 'null' ? item.Descripcion_Corta_Del_Bien : 'Sin descripción',
                    35, 
                    config.truncateLongText
                );
                const areaNombre = truncateText(item.Area_Nombre, 25, config.truncateLongText);
                const noResguardo = item.No_Resguardo || 'N/A';
                
                labelsHtml += `
                    <div style="
                        width: ${labelWidth}mm; 
                        height: ${labelHeight}mm; 
                        display: inline-flex; 
                        flex-direction: column;
                        margin-right: ${hSpacing}mm; 
                        margin-bottom: ${vSpacing}mm; 
                        border: 0.25mm solid #5A2E44; 
                        padding: ${paddingMm}mm;
                        box-sizing: border-box; 
                        page-break-inside: avoid; 
                        overflow: hidden;
                        font-size: ${fontSizePt}pt;
                        color: #1f2937;
                        justify-content: space-between;
                    ">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;">
                            <img src="/static/images/image_e8aecf.jpg" alt="Logo 1" style="height: ${logoHeightMm}mm; max-width: 35%;">
                            <p style="font-weight: bold; color: #5A2E44; font-size: ${titleFontSizePt}pt; margin: 0 1mm;">${noResguardo}</p>
                            <img src="/static/images/image_e8b1f6.png" alt="Logo 2" style="height: ${logoHeightMm}mm; max-width: 35%;">
                        </div>
                        <div style="flex-grow: 1; display: flex; flex-direction: column; justify-content: center; line-height: 1.2;">
                            <div style="display: flex; justify-content: space-between;">
                                <span style="font-weight: bold; padding-right: 5px;">Desc:</span>
                                <span style="text-align: right;">${descripcion}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="font-weight: bold; padding-right: 5px;">Área:</span>
                                <span style="text-align: right;">${areaNombre}</span>
                            </div>
                        </div>
                    </div>`;
            });
            return labelsHtml;
        };

        const renderLabelsForPreview = () => {
            if (Object.keys(selectedItems).length === 0) {
                alert('Por favor, selecciona al menos un resguardo.');
                return;
            }
            
            const config = getConfig();
            
            // Aplicar calibración a los márgenes
            const marginTop = applyCalibration(config.marginTop, config.calibrationFactor);
            const marginRight = applyCalibration(config.marginRight, config.calibrationFactor);
            const marginBottom = applyCalibration(config.marginBottom, config.calibrationFactor);
            const marginLeft = applyCalibration(config.marginLeft, config.calibrationFactor);
            
            printContainer.style.padding = `${marginTop}mm ${marginRight}mm ${marginBottom}mm ${marginLeft}mm`;
            printContainer.innerHTML = generateLabelsHTML(selectedItems, config);
            
            // CORRECCIÓN: Mostrar la sección de previsualización correctamente
            previewSection.classList.remove('hidden');
            previewSection.scrollIntoView({ behavior: 'smooth' });
        };

        const generateAndPrintLabels = () => {
            if (Object.keys(selectedItems).length === 0) {
                alert('Por favor, selecciona al menos un resguardo.');
                return;
            }
            
            const config = getConfig();
            const paperSize = document.getElementById('template_select').value.toLowerCase();
            const paperWidth = paperSize === 'letter' ? '215.9mm' : '210mm';
            const paperHeight = paperSize === 'letter' ? '279.4mm' : '297mm';

            // Aplicar calibración a los márgenes
            const marginTop = applyCalibration(config.marginTop, config.calibrationFactor);
            const marginRight = applyCalibration(config.marginRight, config.calibrationFactor);
            const marginBottom = applyCalibration(config.marginBottom, config.calibrationFactor);
            const marginLeft = applyCalibration(config.marginLeft, config.calibrationFactor);

            const printContent = `
                <!DOCTYPE html><html><head><title>Imprimir Etiquetas</title>
                <style>
                    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
                    @page {
                        size: ${paperSize};
                        margin: 0;
                    }
                    body { 
                        margin: 0; 
                        font-family: 'Inter', sans-serif;
                        width: ${paperWidth};
                    }
                    .container {
                        padding: ${marginTop}mm ${marginRight}mm ${marginBottom}mm ${marginLeft}mm;
                        box-sizing: border-box;
                    }
                </style>
                </head><body>
                <div class="container">
                    ${generateLabelsHTML(selectedItems, config)}
                </div>
                <script>
                    window.onload = () => { window.print(); setTimeout(() => window.close(), 100); };
                <\/script>
                </body></html>`;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.open();
            printWindow.document.write(printContent);
            printWindow.document.close();
        };

        // CORRECCIÓN: Event listeners corregidos
        previewButton.addEventListener('click', renderLabelsForPreview);
        printButton.addEventListener('click', generateAndPrintLabels);
        backButton.addEventListener('click', () => {
            previewSection.classList.add('hidden');
        });

        // Inicialización
        updateUI();
    });
</script>
{% endblock %}