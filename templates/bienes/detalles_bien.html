{% extends 'base.html' %}

{% block title %}Detalles del Bien - {{ bien.No_Inventario }}{% endblock %}

{% block content %}
<div class="page-wrapper">
    <div class="container-limit">
        
        <div class="header-card">
            <div class="header-content">
                <div class="title-row">
                    <h1>Detalles del Bien</h1>
                    <span class="badge badge-lg"><i class="fas fa-hashtag"></i> {{ bien.No_Inventario }}</span>
                </div>
                
                <div class="user-info-badge">
                    <i class="fas fa-user-circle"></i>
                    <span>Registrado por:</span>
                    <strong>{{ bien.registrado_por_nombres or 'Usuario no disponible' }}</strong>
                    <small>({{ bien.registrado_por_username or 'N/A' }})</small>
                </div>
            </div>

            <div class="header-actions">
                <a href="{{ url_for('bienes.editar_bien', bien_id=bien.id) }}" class="btn btn-primary">
                    <i class="fas fa-edit"></i> Editar Bien
                </a>
                <a href="{{ url_for('bienes.listar_bienes') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Volver
                </a>
            </div>
        </div>

        <div class="details-layout">
            
            <div class="main-column">
                
                <div class="card">
                    <div class="card-header">
                        <div class="icon-box"><i class="fas fa-info-circle"></i></div>
                        <h2>Información General y Técnica</h2>
                    </div>
                    <div class="card-body">
                        <div class="info-grid">
                            <div class="info-item">
                                <label>No. de Inventario</label>
                                <p class="highlight">{{ bien.No_Inventario or 'N/A' }}</p>
                            </div>
                            <div class="info-item">
                                <label>Cantidad</label>
                                <p>{{ bien.Cantidad or 'N/A' }}</p>
                            </div>
                            <div class="info-item">
                                <label>Estado del Bien</label>
                                <p>{{ bien.Estado_Del_Bien or 'N/A' }}</p>
                            </div>
                            <div class="info-item">
                                <label>Marca</label>
                                <p>{{ bien.Marca or 'N/A' }}</p>
                            </div>
                            <div class="info-item">
                                <label>Modelo</label>
                                <p>{{ bien.Modelo or 'N/A' }}</p>
                            </div>
                            <div class="info-item">
                                <label>No. Serie</label>
                                <p>{{ bien.Numero_De_Serie or 'N/A' }}</p>
                            </div>
                            
                            <div class="info-item full-width">
                                <label>Descripción Corta</label>
                                <p>{{ bien.Descripcion_Corta_Del_Bien or 'N/A' }}</p>
                            </div>
                            <div class="info-item full-width">
                                <label>Descripción Completa</label>
                                <div class="text-box">
                                    {{ bien.Descripcion_Del_Bien or 'N/A' }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="icon-box"><i class="fas fa-chart-line"></i></div>
                        <h2>Información Contable y Financiera</h2>
                    </div>
                    <div class="card-body">
                        <div class="info-grid">
                            <div class="info-item">
                                <label>Costo Inicial</label>
                                <p class="money">${{ "%.2f"|format(bien.Costo_Inicial|float) if bien.Costo_Inicial is not none else 'N/A' }}</p>
                            </div>
                            <div class="info-item">
                                <label>Depreciación Acum.</label>
                                <p class="money">${{ "%.2f"|format(bien.Depreciacion_Acumulada|float) if bien.Depreciacion_Acumulada is not none else 'N/A' }}</p>
                            </div>
                            <div class="info-item">
                                <label>Costo Final</label>
                                <p class="money">${{ "%.2f"|format(bien.Costo_Final|float) if bien.Costo_Final is not none else 'N/A' }}</p>
                            </div>
                            <div class="info-item">
                                <label>Valor en Libros</label>
                                <p class="money highlight">${{ "%.2f"|format(bien.Valor_En_Libros|float) if bien.Valor_En_Libros is not none else 'N/A' }}</p>
                            </div>
                            <div class="info-item">
                                <label>No. Factura</label>
                                <p>{{ bien.No_Factura or 'N/A' }}</p>
                            </div>
                            <div class="info-item">
                                <label>Fecha Factura</label>
                                <p>{{ bien.Fecha_Factura or 'N/A' }}</p>
                            </div>
                            <div class="info-item">
                                <label>Póliza</label>
                                <p>{{ bien.Poliza or 'N/A' }}</p>
                            </div>
                            <div class="info-item">
                                <label>Fecha Póliza</label>
                                <p>{{ bien.Fecha_Poliza or 'N/A' }}</p>
                            </div>
                            <div class="info-item">
                                <label>No. Cuenta</label>
                                <p>{{ bien.No_Cuenta or 'N/A' }}</p>
                            </div>
                            <div class="info-item">
                                <label>Subcuenta Arm.</label>
                                <p>{{ bien.Sub_Cuenta_Armonizadora or 'N/A' }}</p>
                            </div>
                            <div class="info-item">
                                <label>Rubro</label>
                                <p>{{ bien.Rubro or 'N/A' }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="icon-box"><i class="fas fa-clipboard-list"></i></div>
                        <h2>Historial en Inventarios</h2>
                    </div>
                    <div class="card-body">
                        <div class="history-stack">
                            {% if historial_inventarios %}
                                {% for historial in historial_inventarios %}
                                <div class="history-item">
                                    <div class="history-item-header">
                                        <div class="history-title">
                                            <h3>{{ historial.inventario_nombre }}</h3>
                                            <span class="badge badge-mono">{{ historial.inventario_tipo }}</span>
                                        </div>
                                        <span class="history-date">
                                            Inicio: {{ historial.fecha_inicio.strftime('%d/%m/%Y') }}
                                        </span>
                                    </div>

                                    <div class="history-details-grid">
                                        <div class="detail-block">
                                            <div class="sub-label"><i class="fas fa-user"></i> Creado por:</div>
                                            <p><strong>{{ historial.creador_nombres or 'N/A' }}</strong> <small>({{ historial.creador_username }})</small></p>
                                            
                                            <div class="sub-label mt-2"><i class="fas fa-users"></i> Brigada:</div>
                                            <ul class="brigade-list">
                                                {% for miembro in brigadas_por_inventario.get(historial.inventario_id, []) %}
                                                    <li>{{ miembro.nombres or 'N/A' }} <small>({{ miembro.username }})</small></li>
                                                {% else %}
                                                    <li>No asignada</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                        
                                        <div class="detail-block">
                                            <div class="sub-label"><i class="fas fa-user-shield"></i> Resguardante:</div>
                                            <p>{{ historial.Nombre_Del_Resguardante or 'N/A' }}</p>
                                            
                                            <div class="sub-label mt-2"><i class="fas fa-user-tie"></i> Jefe/Director:</div>
                                            <p>{{ historial.Nombre_Director_Jefe_De_Area or 'N/A' }}</p>
                                        </div>
                                    </div>

                                    {% set fotos = fotos_por_detalle.get(historial.detalle_id, []) %}
                                    {% if fotos %}
                                    <div class="history-photos">
                                        <div class="sub-label"><i class="fas fa-images"></i> Evidencia Fotográfica:</div>
                                        <div class="gallery-mini-grid">
                                            {% for foto_path in fotos %}
                                            <a href="{{ url_for('serve_uploaded_file', filename=foto_path) }}" target="_blank" class="gallery-item">
                                                <img src="{{ url_for('serve_uploaded_file', filename=foto_path) }}" loading="lazy">
                                            </a>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="empty-state-card">
                                    <i class="fas fa-folder-open"></i>
                                    <p>Este bien no ha participado en ningún inventario registrado.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

            </div> <div class="sidebar-column">
                
                <div class="card">
                    <div class="card-header">
                        <div class="icon-box"><i class="fas fa-tags"></i></div>
                        <h2>Clasificación</h2>
                    </div>
                    <div class="card-body">
                        <div class="info-stack">
                            <div class="info-item">
                                <label>Clasificación Legal</label>
                                <p class="highlight">{{ bien.Clasificacion_Legal or 'N/A' }}</p>
                            </div>
                            <div class="info-item">
                                <label>Área Presupuestal</label>
                                <p>{{ bien.Area_Presupuestal or 'N/A' }}</p>
                            </div>
                            <div class="info-item">
                                <label>Tipo de Alta</label>
                                <p>{{ bien.Tipo_De_Alta or 'N/A' }}</p>
                            </div>
                            <div class="info-item">
                                <label>Fecha Adquisición</label>
                                <p>{{ bien.Fecha_Adquisicion_Alta or 'N/A' }}</p>
                            </div>
                            <div class="info-item">
                                <label>Doc. Propiedad</label>
                                <p>{{ bien.Documento_Propiedad or 'N/A' }}</p>
                            </div>
                            <div class="info-item">
                                <label>Fecha Documento</label>
                                <p>{{ bien.Fecha_Documento_Propiedad or 'N/A' }}</p>
                            </div>
                            <div class="info-item">
                                <label>Proveedor</label>
                                <p>{{ bien.Proveedor or 'N/A' }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="icon-box"><i class="fas fa-history"></i></div>
                        <h2>Resguardos</h2>
                    </div>
                    <div class="card-body">
                        <div class="resguardo-list">
                            {% if resguardos %}
                                {% for resguardo in resguardos %}
                                <div class="resguardo-item">
                                    <div class="resguardo-header">
                                        <span class="resguardo-id"><i class="fas fa-file-alt"></i> No. {{ resguardo.No_Resguardo }}</span>
                                        {% if resguardo.Activo %}
                                            <span class="badge-status active">Activo</span>
                                        {% else %}
                                            <span class="badge-status inactive">Inactivo</span>
                                        {% endif %}
                                    </div>
                                    <p class="resguardo-person">
                                        <i class="fas fa-user"></i> {{ resguardo.Nombre_Del_Resguardante }}
                                    </p>
                                    <a href="{{ url_for('resguardos.ver_resguardo', id_resguardo=resguardo.id) }}" class="btn-block-link">
                                        <i class="fas fa-eye"></i> Ver Detalles
                                    </a>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="empty-state-mini">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <p>Sin resguardos asociados.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="icon-box"><i class="fas fa-images"></i></div>
                        <h2>Imágenes del Bien</h2>
                    </div>
                    <div class="card-body">
                        {% if imagenes %}
                            <div class="gallery-grid">
                                {% for imagen_path in imagenes %}
                                    <a href="{{ url_for('serve_uploaded_file', filename=imagen_path) }}" target="_blank" class="gallery-item">
                                        <img src="{{ url_for('serve_uploaded_file', filename=imagen_path) }}" loading="lazy">
                                    </a> 
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="empty-state-mini">
                                <i class="fas fa-image"></i>
                                <p>No hay imágenes adjuntas</p>
                            </div>
                        {% endif %}
                    </div>
                </div>

            </div> </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
    /* REUTILIZACIÓN DE VARIABLES (Asegura consistencia) */
    :root {
        --col-burgundy: #6A2E4D;
        --col-burgundy-dark: #551E3A;
        --col-beige: #BC9B6A;
        --col-beige-light: #fdfbf7;
        --radius: 12px;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        --text-gray: #6b7280;
        --text-dark: #1f2937;
    }

    /* Layout Base */
    .page-wrapper { min-height: 100vh; background: #f9fafb; padding: 2rem 1rem; }
    .container-limit { max-width: 1280px; margin: 0 auto; }

    /* Header */
    .header-card {
        background: linear-gradient(to right, var(--col-burgundy), var(--col-burgundy-dark));
        border-radius: var(--radius); padding: 1.5rem 2rem; color: white;
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 2rem; box-shadow: var(--shadow); flex-wrap: wrap; gap: 1rem;
    }
    .header-content { display: flex; flex-direction: column; gap: 0.5rem; }
    .title-row { display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; }
    .header-content h1 { margin: 0; font-size: 1.5rem; }
    
    .badge-lg { background: rgba(188, 155, 106, 0.3); padding: 0.3rem 0.8rem; border-radius: 20px; font-family: monospace; border: 1px solid rgba(188, 155, 106, 0.5); }
    
    .user-info-badge {
        display: inline-flex; align-items: center; gap: 0.4rem; 
        background: rgba(255,255,255,0.1); padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.85rem;
    }

    /* Botones Header */
    .header-actions { display: flex; gap: 0.5rem; }
    .btn { padding: 0.6rem 1.2rem; border-radius: 8px; font-weight: 600; text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem; border: none; cursor: pointer; transition: all 0.2s; font-size: 0.95rem; }
    .btn-primary { background: rgba(188, 155, 106, 0.3); border: 1px solid rgba(188, 155, 106, 0.5); color: white; }
    .btn-primary:hover { background: rgba(188, 155, 106, 0.5); transform: translateY(-1px); }
    .btn-secondary { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); color: white; }
    .btn-secondary:hover { background: rgba(255,255,255,0.25); transform: translateY(-1px); }

    /* LAYOUT GRID */
    .details-layout { display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; }

    /* Tarjetas Comunes */
    .card { background: white; border-radius: var(--radius); box-shadow: var(--shadow); border: 1px solid #e5e7eb; overflow: hidden; margin-bottom: 1.5rem; }
    .card-header { padding: 1rem 1.5rem; border-bottom: 1px solid #f3f4f6; background: rgba(106, 46, 77, 0.03); display: flex; align-items: center; gap: 0.8rem; }
    .icon-box { width: 32px; height: 32px; background: var(--col-burgundy); border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; }
    .card-header h2 { margin: 0; font-size: 1.1rem; color: var(--col-burgundy); }
    .card-body { padding: 1.5rem; }

    /* Grids de Información */
    .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1.5rem; }
    .info-stack { display: flex; flex-direction: column; gap: 1rem; }
    .info-item label { font-size: 0.8rem; font-weight: 600; color: var(--text-gray); text-transform: uppercase; display: block; margin-bottom: 0.2rem; }
    .info-item p { margin: 0; font-size: 1rem; color: var(--text-dark); word-break: break-word; }
    .info-item.full-width { grid-column: 1 / -1; }
    
    .highlight { font-weight: 700; color: var(--col-burgundy); }
    .money { font-family: monospace; font-size: 1.05rem; }
    .text-box { background: var(--col-beige-light); padding: 1rem; border-radius: 8px; border: 1px solid #e5e7eb; }

    /* ESTILOS DEL HISTORIAL DE INVENTARIO (Complejo) */
    .history-stack { display: flex; flex-direction: column; gap: 1rem; max-height: 600px; overflow-y: auto; padding-right: 5px; }
    
    .history-item { background: #fafafa; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; transition: border-color 0.2s; }
    .history-item:hover { border-color: var(--col-burgundy); }
    
    .history-item-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.5rem; border-bottom: 1px solid #eee; padding-bottom: 0.5rem; }
    .history-title h3 { margin: 0; font-size: 1rem; color: var(--text-dark); display: inline-block; margin-right: 0.5rem; }
    .badge-mono { background: var(--col-beige); color: white; padding: 0.1rem 0.5rem; border-radius: 4px; font-size: 0.75rem; }
    .history-date { font-size: 0.85rem; color: var(--text-gray); }

    .history-details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 0.9rem; }
    .sub-label { font-weight: 600; color: var(--text-gray); font-size: 0.8rem; margin-bottom: 0.2rem; }
    .sub-label i { color: var(--col-burgundy); width: 16px; }
    
    .brigade-list { list-style: disc inside; padding: 0; margin: 0; font-size: 0.85rem; color: var(--text-dark); }
    .brigade-list li small { color: #888; }

    .history-photos { margin-top: 1rem; border-top: 1px dashed #ddd; padding-top: 0.5rem; }
    .gallery-mini-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 0.5rem; margin-top: 0.5rem; }

    /* Lista de Resguardos (Sidebar) */
    .resguardo-list { display: flex; flex-direction: column; gap: 0.8rem; }
    .resguardo-item { background: #fafafa; border: 1px solid #e5e7eb; border-radius: 8px; padding: 0.8rem; }
    .resguardo-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
    .resguardo-id { font-weight: 700; color: var(--text-dark); font-size: 0.9rem; }
    
    .badge-status { font-size: 0.7rem; padding: 0.1rem 0.5rem; border-radius: 10px; font-weight: 600; }
    .badge-status.active { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
    .badge-status.inactive { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }

    .resguardo-person { font-size: 0.85rem; color: var(--text-gray); margin-bottom: 0.8rem; }
    .btn-block-link { display: block; text-align: center; background: var(--col-burgundy); color: white; text-decoration: none; padding: 0.5rem; border-radius: 6px; font-size: 0.85rem; transition: background 0.2s; }
    .btn-block-link:hover { background: var(--col-burgundy-dark); }

    /* Imágenes */
    .gallery-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; }
    .gallery-item { aspect-ratio: 1; overflow: hidden; border-radius: 8px; border: 1px solid #ddd; display: block; }
    .gallery-item img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s; }
    .gallery-item:hover img { transform: scale(1.1); }

    /* Empty States */
    .empty-state-card { text-align: center; padding: 2rem; color: #9ca3af; background: #fdfbf7; border: 2px dashed #e5e7eb; border-radius: 8px; }
    .empty-state-card i { font-size: 1.5rem; margin-bottom: 0.5rem; opacity: 0.5; }
    .empty-state-card p { margin: 0; font-size: 0.9rem; }

    .empty-state-mini { text-align: center; padding: 1.5rem; color: #9ca3af; border: 2px dashed #e5e7eb; border-radius: 8px; }
    .empty-state-mini i { font-size: 1.2rem; margin-bottom: 0.3rem; opacity: 0.5; }
    .empty-state-mini p { font-size: 0.8rem; margin: 0; }

    /* MÓVIL */
    @media (max-width: 900px) {
        .details-layout { grid-template-columns: 1fr; }
        .header-card { flex-direction: column; text-align: center; }
        .title-row { justify-content: center; }
        .header-actions { width: 100%; justify-content: center; }
        .history-details-grid { grid-template-columns: 1fr; }
    }
</style>
{% endblock %}