{% extends 'base.html' %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="bg-white shadow-lg rounded-xl overflow-hidden">
        <div class="px-6 py-4 bg-verde-mexicano-oscuro text-blanco-mexicano">
            {# --- TÍTULO DINÁMICO --- #}
            {% if is_edit %}
                <h1 class="text-3xl font-bold">Editar Bien</h1>
                <p class="text-xl font-light mt-1">{{ form_data.No_Inventario or 'Sin No. de Inventario' }}</p>
            {% else %}
                <h1 class="text-3xl font-bold">Registrar Nuevo Bien</h1>
            {% endif %}
        </div>
        <div class="p-6">
            {# El formulario envía a la misma URL desde la que se cargó #}
            <form method="POST" enctype="multipart/form-data" id="bien-form">
                
                <h2 class="text-2xl font-semibold mb-4 text-verde-mexicano-medio border-b-2 border-verde-mexicano-claro pb-2">Información General</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label for="No_Inventario" class="block text-sm font-medium text-gray-700 mb-1">No. de Inventario</label>
                        <input type="text" class="form-input" id="No_Inventario" name="No_Inventario" value="{{ form_data.No_Inventario or '' }}" required>
                    </div>
                </div>

                <h2 class="text-2xl font-semibold mb-4 text-verde-mexicano-medio border-b-2 border-verde-mexicano-claro pb-2">Datos Financieros</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label for="No_Factura" class="block text-sm font-medium text-gray-700 mb-1">No. de Factura</label>
                        <input type="text" class="form-input" id="No_Factura" name="No_Factura" value="{{ form_data.No_Factura or '' }}">
                    </div>
                    <div>
                        <label for="Fecha_Factura" class="block text-sm font-medium text-gray-700 mb-1">Fecha de Factura</label>
                        <input type="date" class="form-input" id="Fecha_Factura" name="Fecha_Factura" value="{{ form_data.Fecha_Factura or '' }}">
                    </div>
                    <div>
                        <label for="Costo_Inicial" class="block text-sm font-medium text-gray-700 mb-1">Costo Inicial</label>
                        <input type="number" step="0.01" class="form-input" id="Costo_Inicial" name="Costo_Inicial" value="{{ form_data.Costo_Inicial or '' }}" min="0">
                    </div>
                    <div>
                        <label for="Poliza" class="block text-sm font-medium text-gray-700 mb-1">Póliza</label>
                        <input type="text" class="form-input" id="Poliza" name="Poliza" value="{{ form_data.Poliza or '' }}">
                    </div>
                    <div>
                        <label for="Fecha_Poliza" class="block text-sm font-medium text-gray-700 mb-1">Fecha de Póliza</label>
                        <input type="date" class="form-input" id="Fecha_Poliza" name="Fecha_Poliza" value="{{ form_data.Fecha_Poliza or '' }}">
                    </div>
                </div>

                <h2 class="text-2xl font-semibold mb-4 text-verde-mexicano-medio border-b-2 border-verde-mexicano-claro pb-2">Detalles Técnicos y Descripción</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label for="Estado_Del_Bien" class="block text-sm font-medium text-gray-700 mb-1">Estado del Bien</label>
                        <select class="form-select" id="Estado_Del_Bien" name="Estado_Del_Bien">
                            <option value="" {% if not form_data.Estado_Del_Bien %}selected{% endif %} disabled>Seleccione...</option>
                            <option value="Nuevo" {% if form_data.Estado_Del_Bien == 'Nuevo' %}selected{% endif %}>Nuevo</option>
                            <option value="Bueno" {% if form_data.Estado_Del_Bien == 'Bueno' %}selected{% endif %}>Bueno</option>
                            <option value="Regular" {% if form_data.Estado_Del_Bien == 'Regular' %}selected{% endif %}>Regular</option>
                            <option value="Malo" {% if form_data.Estado_Del_Bien == 'Malo' %}selected{% endif %}>Malo</option>
                        </select>
                    </div>
                    <div>
                        <label for="Marca" class="block text-sm font-medium text-gray-700 mb-1">Marca</label>
                        <input type="text" class="form-input" id="Marca" name="Marca" value="{{ form_data.Marca or '' }}">
                    </div>
                    <div>
                        <label for="Modelo" class="block text-sm font-medium text-gray-700 mb-1">Modelo</label>
                        <input type="text" class="form-input" id="Modelo" name="Modelo" value="{{ form_data.Modelo or '' }}">
                    </div>
                    <div>
                        <label for="Numero_De_Serie" class="block text-sm font-medium text-gray-700 mb-1">Número de Serie</label>
                        <input type="text" class="form-input" id="Numero_De_Serie" name="Numero_De_Serie" value="{{ form_data.Numero_De_Serie or '' }}">
                    </div>
                </div>
                <div class="mb-6">
                    <label for="Descripcion_Del_Bien" class="block text-sm font-medium text-gray-700 mb-1">Descripción Completa del Bien</label>
                    <textarea class="form-textarea" id="Descripcion_Del_Bien" name="Descripcion_Del_Bien" rows="3">{{ form_data.Descripcion_Del_Bien or '' }}</textarea>
                </div>
                <div class="mb-6">
                    <label for="Descripcion_Corta_Del_Bien" class="block text-sm font-medium text-gray-700 mb-1">Descripción Corta del Bien</label>
                    <textarea class="form-textarea" id="Descripcion_Corta_Del_Bien" name="Descripcion_Corta_Del_Bien" rows="1">{{ form_data.Descripcion_Corta_Del_Bien or '' }}</textarea>
                </div>

                <h2 class="text-2xl font-semibold mb-4 text-verde-mexicano-medio border-b-2 border-verde-mexicano-claro pb-2">Información Contable</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label for="No_Cuenta" class="block text-sm font-medium text-gray-700 mb-1">No. de Cuenta</label>
                        <input type="text" class="form-input" id="No_Cuenta" name="No_Cuenta" value="{{ form_data.No_Cuenta or '' }}">
                    </div>
                    <div>
                        <label for="Sub_Cuenta_Armonizadora" class="block text-sm font-medium text-gray-700 mb-1">Subcuenta Armonizadora</label>
                        <input type="text" class="form-input" id="Sub_Cuenta_Armonizadora" name="Sub_Cuenta_Armonizadora" value="{{ form_data.Sub_Cuenta_Armonizadora or '' }}">
                    </div>
                    <div>
                        <label for="Proveedor" class="block text-sm font-medium text-gray-700 mb-1">Proveedor</label>
                        <input type="text" class="form-input" id="Proveedor" name="Proveedor" value="{{ form_data.Proveedor or '' }}">
                    </div>
                    <div>
                        <label for="Rubro" class="block text-sm font-medium text-gray-700 mb-1">Rubro</label>
                        <input type="text" class="form-input" id="Rubro" name="Rubro" value="{{ form_data.Rubro or '' }}">
                    </div>
                     <div>
                        <label for="Depreciacion_Acumulada" class="block text-sm font-medium text-gray-700 mb-1">Depreciación Acumulada</label>
                        <input type="number" step="0.01" class="form-input" id="Depreciacion_Acumulada" name="Depreciacion_Acumulada" value="{{ form_data.Depreciacion_Acumulada or '' }}" min="0">
                    </div>
                    <div>
                        <label for="Costo_Final_Cantidad" class="block text-sm font-medium text-gray-700 mb-1">Costo Final</label>
                        <input type="number" step="0.01" class="form-input" id="Costo_Final_Cantidad" name="Costo_Final_Cantidad" value="{{ form_data.Costo_Final_Cantidad or '' }}" min="0">
                    </div>
                     <div>
                        <label for="Tipo_De_Alta" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Alta</label>
                        <select class="form-select" id="Tipo_De_Alta" name="Tipo_De_Alta" required>
                            <option value="" {% if not form_data.Tipo_De_Alta %}selected{% endif %} disabled>Seleccione...</option>
                            <option value="Compra" {% if form_data.Tipo_De_Alta == 'Compra' %}selected{% endif %}>Compra</option>
                            <option value="Comodato" {% if form_data.Tipo_De_Alta == 'Comodato' %}selected{% endif %}>Comodato</option>
                            <option value="Donacion" {% if form_data.Tipo_De_Alta == 'Donacion' %}selected{% endif %}>Donación</option>
                        </select>
                    </div>
                    <div>
                        <label for="Cantidad" class="block text-sm font-medium text-gray-700 mb-1">Cantidad</label>
                        <input type="number" class="form-input" id="Cantidad" name="Cantidad" value="{{ form_data.Cantidad or '1' }}" min="1">
                    </div>
                </div>
                
                {# --- SECCIONES SOLO PARA EDITAR --- #}
                {% if is_edit %}
                    <hr class="my-8">
                    <h2 class="text-2xl font-semibold mb-4 text-verde-mexicano-medio border-b-2 border-verde-mexicano-claro pb-2">Resguardos Asociados</h2>
                    {% if form_data.resguardos %}
                        <div class="space-y-4 mb-6">
                            {% for resguardo in form_data.resguardos %}
                                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg shadow-sm">
                                    <div>
                                        <p class="font-semibold text-lg">No. de Resguardo: {{ resguardo.No_Resguardo }}</p>
                                        <p class="text-sm text-gray-500">
                                            Resguardante: {{ resguardo.Nombre_Del_Resguardante }}
                                            | Estado: 
                                            {% if resguardo.Activo %}<span class="font-bold text-green-600">Activo</span>{% else %}<span class="font-bold text-red-600">Inactivo</span>{% endif %}
                                        </p>
                                    </div>
                                    <a href="{{ url_for('resguardos.editar_resguardo', id_resguardo=resguardo.id) }}" class="btn-primary">
                                        <i class="fas fa-edit mr-2"></i> Editar Resguardo
                                    </a>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-lg mb-6" role="alert">
                            <p class="font-bold">Atención</p>
                            <p>Este bien no tiene resguardos asociados.</p>
                        </div>
                    {% endif %}
                {% endif %}

                <hr class="my-8 border-gray-300">

                <h2 class="text-2xl font-semibold mb-4 text-verde-mexicano-medio border-b-2 border-verde-mexicano-claro pb-2">Imágenes del Bien</h2>
                <div class="mb-6">
                    <label for="imagenes_bien" class="block text-sm font-medium text-gray-700 mb-1">Seleccionar Nuevas Imágenes</label>
                    <input type="file" id="imagenes_bien" name="imagenes_bien" class="form-input-file" accept="image/*" multiple>
                    <div id="preview_imagenes" class="flex flex-wrap gap-2 mt-4">
                        {# Mostrar imágenes existentes solo en modo de edición #}
                        {% if is_edit and form_data.imagenes %}
                            {% for imagen in form_data.imagenes %}
                                <div class="relative inline-block" id="imagen-{{ imagen.id }}">
                                    <img src="{{ url_for('bienes.serve_uploaded_file', filename=imagen.ruta_imagen) }}" class="h-24 w-24 object-cover rounded border" alt="Imagen del Bien">
                                    <button type="button" class="btn-delete-img" title="Eliminar imagen" onclick="marcarParaEliminar(this, '{{ imagen.id }}')">&times;</button>
                                </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>

                <div class="flex justify-end space-x-4">
                    {# --- BOTÓN DINÁMICO --- #}
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-save mr-2"></i>
                        {% if is_edit %}
                            Actualizar Bien
                        {% else %}
                            Guardar Bien
                        {% endif %}
                    </button>
                    <a href="{{ url_for('bienes.listar_bienes') }}" class="btn-secondary">
                        <i class="fas fa-times mr-2"></i> Cancelar
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// --- Elementos del DOM ---
const inputImagenes = document.getElementById('imagenes_bien');
const previewContenedor = document.getElementById('preview_imagenes');
const form = document.getElementById('bien-form');

// --- Almacén de archivos ---
// Este array mantendrá la lista de archivos NUEVOS que se van a subir.
let nuevosArchivos = [];

// --- MANEJO DE IMÁGENES EXISTENTES ---

/**
 * Marca una imagen existente para ser eliminada en el backend.
 * @param {HTMLElement} btn - El botón de eliminar que fue presionado.
 * @param {string} imageId - El ID de la imagen a eliminar.
 */
function marcarParaEliminar(btn, imageId) {
    if (confirm('¿Estás seguro de que quieres eliminar esta imagen? La eliminación será permanente al guardar.')) {
        // 1. Crear un input oculto: Este input le dirá al servidor qué imagen borrar.
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = 'eliminar_imagen_bien[]'; // El backend buscará este nombre.
        hiddenInput.value = imageId;
        form.appendChild(hiddenInput);

        // 2. Ocultar la imagen de la vista para dar feedback visual al usuario.
        btn.parentElement.style.display = 'none';
        
        console.log(`Imagen ${imageId} marcada para eliminar.`);
    }
}

// --- MANEJO DE IMÁGENES NUEVAS ---

/**
 * Se activa cuando el usuario selecciona archivos nuevos.
 * Añade los archivos a la lista y actualiza la previsualización.
 */
inputImagenes.addEventListener('change', function(event) {
    // Añade los archivos recién seleccionados a la lista existente.
    const nuevos = Array.from(event.target.files);
    nuevosArchivos.push(...nuevos);
    
    // Sincroniza el input <input type="file"> con nuestra lista actualizada.
    sincronizarInputFiles();
    
    // Muestra las previsualizaciones de los archivos en la lista.
    mostrarPreviewNuevas();
});

/**
 * Renderiza la previsualización de las imágenes nuevas en el contenedor.
 */
function mostrarPreviewNuevas() {
    // 1. Limpiar solo las previsualizaciones de imágenes NUEVAS.
    document.querySelectorAll('.preview-nueva').forEach(el => el.remove());

    // 2. Crear una previsualización para cada archivo en nuestra lista.
    nuevosArchivos.forEach((file) => {
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                // Contenedor para la imagen y el botón de eliminar.
                const contenedor = document.createElement('div');
                contenedor.className = "relative inline-block preview-nueva";
                
                // La imagen de previsualización.
                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = "h-24 w-24 object-cover rounded border";
                
                // El botón para eliminar esta previsualización.
                const btn = document.createElement('button');
                btn.type = "button";
                btn.innerHTML = '&times;';
                btn.className = "btn-delete-img";
                btn.title = "Quitar esta imagen";
                btn.onclick = function() {
                    // Eliminar el archivo de nuestra lista.
                    nuevosArchivos = nuevosArchivos.filter(f => f !== file);
                    // Volver a sincronizar el input y la previsualización.
                    sincronizarInputFiles();
                    mostrarPreviewNuevas();
                };

                contenedor.appendChild(img);
                contenedor.appendChild(btn);
                previewContenedor.appendChild(contenedor);
            };

            reader.readAsDataURL(file);
        }
    });
}

/**
 * Sincroniza el <input type="file"> con el contenido del array `nuevosArchivos`.
 * Esto es necesario porque no podemos modificar directamente la lista de archivos
 * de un input, pero sí podemos reemplazarla por una nueva.
 */
function sincronizarInputFiles() {
    const dataTransfer = new DataTransfer();
    nuevosArchivos.forEach(file => dataTransfer.items.add(file));
    inputImagenes.files = dataTransfer.files;
}
</script>
{% endblock %}

