{% extends "base.html" %}

{% block content %}
<div class="page-wrapper">
    <div class="container-limit">
        
        <div class="header-card">
            <div class="header-text">
                <h1>
                    {% if is_edit %}
                        Editar Plantilla: <strong>{{ template.name }}</strong>
                    {% else %}
                        Crear Plantilla de Consulta
                    {% endif %}
                </h1>
                <p>
                    {% if is_edit %}
                        Modifique la configuración de la plantilla existente.
                    {% else %}
                        Configure columnas y filtros para crear una consulta personalizada.
                    {% endif %}
                </p>
            </div>
            <div class="header-icon-box">
                <i class="fas fa-filter"></i>
            </div>
        </div>

        <div class="card">
            <form id="template-form" 
                  action="{{ url_for('plantillas.editar_plantilla', template_id=template.id) if is_edit else url_for('plantillas.crear_plantilla') }}" 
                  method="post">
                
                <div class="form-section">
                    <div class="section-header">
                        <div class="section-icon"><i class="fas fa-info"></i></div>
                        <h2>Información de la Plantilla</h2>
                    </div>
                    <div class="form-grid-1">
                        <div class="form-group">
                            <label for="template_name">Nombre de la Plantilla *</label>
                            <input type="text" name="template_name" id="template_name" 
                                   value="{{ template.name or '' }}" required 
                                   placeholder="Ej: Resguardos de Cómputo 2024">
                        </div>
                        <div class="form-group">
                            <label for="template_description">Descripción</label>
                            <textarea name="template_description" id="template_description" rows="2" 
                                      placeholder="Propósito de esta consulta">{{ template.description or '' }}</textarea>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="section-header">
                        <div class="section-icon"><i class="fas fa-columns"></i></div>
                        <h2>Seleccionar Columnas</h2>
                    </div>
                    <div class="checkbox-wrapper">
                        <p class="help-text">Marque las columnas que desea incluir:</p>
                        <div id="columns-container" class="checkbox-grid">
                            {% for column in columns %}
                            <label class="checkbox-card" for="column-{{ column }}">
                                <input id="column-{{ column }}" name="columns" type="checkbox" value="{{ column }}"
                                       {% if column in template_columns %}checked{% endif %}>
                                <span class="checkbox-label">{{ column.replace('_', ' ').title() }}</span>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="section-header">
                        <div class="section-icon"><i class="fas fa-sliders-h"></i></div>
                        <h2>Definir Filtros</h2>
                    </div>
                    
                    <div class="query-builder-wrapper">
                        <p class="help-text">Construya su consulta usando grupos lógicos (Y/O) y reglas:</p>
                        
                        <div id="query-builder-container"></div>
                        
                        <input type="hidden" name="filters_json" id="filters_json">
                    </div>
                </div>
                
                <div class="form-section mb-0">
                    <div class="section-header">
                        <div class="section-icon"><i class="fas fa-eye"></i></div>
                        <h2>Vista Previa</h2>
                    </div>
                    <div class="preview-wrapper">
                        <div id="preview-table-container" class="table-responsive">
                            <div class="empty-preview">
                                <i class="fas fa-table"></i>
                                <p>Selecciona columnas para ver la vista previa.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <a href="{{ url_for('plantillas.ver_plantillas') }}" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Cancelar
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> 
                        {% if is_edit %}Actualizar Plantilla{% else %}Guardar Plantilla{% endif %}
                    </button>
                </div>

            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
    /* VARIABLES */
    :root {
        --col-burgundy: #6A2E4D;
        --col-burgundy-dark: #551E3A;
        --col-beige: #BC9B6A;
        --col-bg: #f9fafb;
        --radius: 12px;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .page-wrapper { min-height: 100vh; background: var(--col-bg); padding: 2rem 1rem; }
    .container-limit { max-width: 1100px; margin: 0 auto; }

    /* Header */
    .header-card {
        background: linear-gradient(to right, var(--col-burgundy), var(--col-burgundy-dark));
        border-radius: var(--radius); padding: 1.5rem 2rem; color: white;
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 2rem; box-shadow: var(--shadow);
    }
    .header-text h1 { margin: 0; font-size: 1.5rem; }
    .header-text p { margin: 0.5rem 0 0; opacity: 0.9; }
    .header-icon-box {
        width: 48px; height: 48px; background: var(--col-beige); border-radius: 50%;
        display: flex; align-items: center; justify-content: center; color: var(--col-burgundy); font-size: 1.2rem;
    }

    /* Card & Form */
    .card { background: white; border-radius: var(--radius); box-shadow: var(--shadow); padding: 2rem; border: 1px solid #e5e7eb; }
    .form-section { margin-bottom: 2.5rem; }
    .section-header { display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; border-bottom: 2px solid #f3f4f6; padding-bottom: 0.5rem; }
    .section-icon { width: 32px; height: 32px; background: var(--col-burgundy); border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; }
    .section-header h2 { color: var(--col-burgundy); font-size: 1.2rem; margin: 0; }

    /* Inputs */
    .form-group { margin-bottom: 1rem; }
    .form-group label { display: block; font-weight: 600; color: #374151; font-size: 0.9rem; margin-bottom: 0.4rem; }
    input[type="text"], textarea { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px; font-size: 0.95rem; }
    input:focus, textarea:focus { outline: none; border-color: var(--col-burgundy); box-shadow: 0 0 0 3px rgba(106, 46, 77, 0.1); }

    /* Checkbox Grid */
    .checkbox-wrapper { background: #fafafa; border: 1px solid #e5e7eb; padding: 1.5rem; border-radius: 8px; }
    .checkbox-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.8rem; max-height: 300px; overflow-y: auto; }
    .checkbox-card { display: flex; align-items: center; padding: 0.6rem; background: white; border: 1px solid #e5e7eb; border-radius: 6px; cursor: pointer; }
    .checkbox-card:hover { border-color: var(--col-burgundy); background: #fdfbf7; }
    .checkbox-card input { margin-right: 0.6rem; accent-color: var(--col-burgundy); width: 1.1rem; height: 1.1rem; }

    /* --- ESTILOS DEL CONSTRUCTOR DE CONSULTAS (Query Builder) --- */
    .query-builder-wrapper { background: #fafafa; border: 1px solid #e5e7eb; padding: 1.5rem; border-radius: 8px; }

    /* Grupo Lógico (Container con borde punteado) */
    .query-group-item {
        background: rgba(188, 155, 106, 0.05); /* Beige muy suave */
        border: 2px dashed #d1d5db;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
        transition: all 0.2s;
    }
    .query-group-item:hover { border-color: var(--col-beige); }

    /* Header del Grupo (Botones Y/O + Acciones) */
    .group-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem; }
    .condition-toggle { display: flex; background: white; border: 1px solid #d1d5db; border-radius: 6px; overflow: hidden; }
    .condition-btn { border: none; padding: 0.4rem 1rem; cursor: pointer; background: white; color: #666; font-weight: 600; font-size: 0.9rem; transition: all 0.2s; }
    .condition-btn.active { background: var(--col-burgundy); color: white; }

    .group-actions { display: flex; gap: 0.5rem; }
    .btn-mini { padding: 0.4rem 0.8rem; border-radius: 6px; font-size: 0.8rem; font-weight: 600; cursor: pointer; border: 1px solid; display: flex; align-items: center; gap: 0.3rem; background: white; }
    .btn-add-rule { color: var(--col-burgundy); border-color: var(--col-burgundy); }
    .btn-add-rule:hover { background: rgba(106, 46, 77, 0.1); }
    .btn-add-group { color: #4b5563; border-color: #9ca3af; }
    .btn-add-group:hover { background: #f3f4f6; }
    .btn-remove { color: #ef4444; border-color: #fecaca; }
    .btn-remove:hover { background: #fef2f2; }

    /* Contenedor de Reglas (Indentado) */
    .rules-container { margin-left: 1rem; padding-left: 1rem; border-left: 2px dotted #e5e7eb; }

    /* Regla Individual (Fila Blanca) */
    .query-rule-item {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 0.8rem;
        margin-bottom: 0.8rem;
        display: flex;
        gap: 1rem;
        align-items: flex-end;
        flex-wrap: wrap;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .rule-col { flex: 1; min-width: 150px; }
    .rule-col label { display: block; font-size: 0.8rem; color: #6b7280; margin-bottom: 0.3rem; font-weight: 600; }
    .rule-col select, .rule-col input { width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem; }
    
    /* Botones Generales */
    .form-actions { margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end; gap: 1rem; }
    .btn { padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem; border: none; cursor: pointer; }
    .btn-primary { background: linear-gradient(to right, var(--col-burgundy), var(--col-burgundy-dark)); color: white; }
    .btn-secondary { background: white; border: 1px solid #d1d5db; color: #374151; }

    /* Preview Table */
    .preview-wrapper { background: white; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; }
    .table-responsive { overflow-x: auto; width: 100%; }
    .data-table { width: 100%; border-collapse: collapse; min-width: 800px; }
    .data-table th { background: #f9fafb; padding: 0.8rem; text-align: left; font-size: 0.85rem; font-weight: 600; color: #4b5563; border-bottom: 2px solid #e5e7eb; }
    .data-table td { padding: 0.8rem; border-bottom: 1px solid #f3f4f6; font-size: 0.9rem; color: #333; }
    .empty-preview { padding: 3rem; text-align: center; color: #9ca3af; }
    .empty-preview i { font-size: 2.5rem; margin-bottom: 0.5rem; opacity: 0.3; }

    @media (max-width: 768px) {
        .query-rule-item { flex-direction: column; align-items: stretch; }
        .group-header { flex-direction: column; align-items: stretch; }
        .group-actions { flex-wrap: wrap; }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        console.log("✅ Script de Plantillas Cargado");

        // --- 1. REFERENCIAS DOM ---
        const queryBuilderContainer = document.getElementById('query-builder-container');
        const columnsContainer = document.getElementById('columns-container');
        const previewTableContainer = document.getElementById('preview-table-container');
        const templateForm = document.getElementById('template-form');
        const hiddenFiltersInput = document.getElementById('filters_json');

        // --- 2. DATOS DESDE FLASK (Jinja2) ---
        const availableColumns = {{ columns | tojson | safe }};
        
        // Si estamos editando, carga los filtros guardados; si no, inicia vacío (AND)
        const initialTemplateFilters = {{ template_filters | tojson | safe }} || { condition: 'AND', rules: [] };
        
        let availableAreas = [];

        // --- 3. FUNCIONES AUXILIARES ---

        // Obtener áreas desde el backend para llenar los selectores
        const fetchAreas = async () => {
            try {
                // Asegúrate de que esta ruta exista en tu blueprint de areas
                const response = await fetch('{{ url_for("areas.get_areas") }}'); 
                if (!response.ok) throw new Error('Error al cargar áreas');
                availableAreas = await response.json();
            } catch (error) {
                console.error(error);
                availableAreas = []; 
            }
        };

        // Formatear nombre de columna (ej: "No_Inventario" -> "No Inventario")
        function formatColumnName(column) {
            return column.replace(/_/g, ' ')
                        .split(' ')
                        .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                        .join(' ');
        }

        // Escapar HTML para evitar inyección de código en la tabla
        function escapeHtml(unsafe) {
            if (unsafe === null || unsafe === undefined) return "";
            return unsafe.toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // --- 4. CONSTRUCTOR DE REGLAS (Fila Individual) ---
        function createFilterRule(ruleData = {}) {
            const ruleElement = document.createElement('div');
            ruleElement.className = 'query-rule-item'; // Clase CSS personalizada
            
            const columnOptions = availableColumns.map(col => 
                `<option value="${col}" ${ruleData.field === col ? 'selected' : ''}>${formatColumnName(col)}</option>`
            ).join('');

            ruleElement.innerHTML = `
                <div class="rule-col">
                    <label>Campo</label>
                    <select data-type="field">
                        <option value="">Seleccionar...</option>
                        ${columnOptions}
                    </select>
                </div>
                <div class="rule-col">
                    <label>Operador</label>
                    <select data-type="operator">
                        <option value="==" ${ruleData.operator === '==' ? 'selected' : ''}>Igual a</option>
                        <option value="!=" ${ruleData.operator === '!=' ? 'selected' : ''}>Diferente de</option>
                        <option value=">" ${ruleData.operator === '>' ? 'selected' : ''}>Mayor que</option>
                        <option value="<" ${ruleData.operator === '<' ? 'selected' : ''}>Menor que</option>
                        <option value="contains" ${ruleData.operator === 'contains' ? 'selected' : ''}>Contiene</option>
                        <option value="starts_with" ${ruleData.operator === 'starts_with' ? 'selected' : ''}>Inicia con</option>
                    </select>
                </div>
                <div class="rule-col filter-value-container">
                    </div>
                <div>
                    <button type="button" class="btn-mini btn-remove remove-rule-btn" title="Eliminar regla">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            `;

            const fieldSelect = ruleElement.querySelector('[data-type="field"]');
            const valueContainer = ruleElement.querySelector('.filter-value-container');

            // Función para cambiar entre Input Texto y Select (si es Área)
            const updateValueInput = (currentValue) => {
                const selectedField = fieldSelect.value;
                let newElement;
                
                // Si el campo es un Área, mostrar dropdown
                if (selectedField === 'Area_Nombre' || selectedField === 'Area') {
                    newElement = document.createElement('select');
                    newElement.dataset.type = 'value';
                    let options = '<option value="">Seleccionar área...</option>';
                    availableAreas.forEach(area => {
                        // Comparación laxa (==) para ids numéricos vs string
                        options += `<option value="${area.id}" ${currentValue == area.id ? 'selected' : ''}>${area.nombre}</option>`;
                    });
                    newElement.innerHTML = options;
                } else {
                    // Para todo lo demás, input de texto
                    newElement = document.createElement('input');
                    newElement.type = 'text';
                    newElement.dataset.type = 'value';
                    newElement.value = currentValue || '';
                    newElement.placeholder = 'Valor...';
                }
                
                valueContainer.innerHTML = '<label>Valor</label>';
                valueContainer.appendChild(newElement);
                
                // Listeners para actualizar la tabla al escribir/cambiar
                newElement.addEventListener('change', updatePreviewTable);
                if (newElement.tagName === 'INPUT') {
                    newElement.addEventListener('keyup', updatePreviewTable);
                }
            };
            
            // Eventos de la regla
            fieldSelect.addEventListener('change', () => {
                updateValueInput(''); // Resetear valor al cambiar campo
                updatePreviewTable();
            });

            ruleElement.querySelector('.remove-rule-btn').addEventListener('click', () => {
                ruleElement.remove();
                updatePreviewTable();
            });
            
            // Inicializar input
            updateValueInput(ruleData.value || '');
            
            // Listener para el operador
            ruleElement.querySelector('[data-type="operator"]').addEventListener('change', updatePreviewTable);

            return ruleElement;
        }

        // --- 5. CONSTRUCTOR DE GRUPOS (Y/O Recursivo) ---
        function createFilterGroup(groupData = { condition: 'AND', rules: [] }) {
            const groupElement = document.createElement('div');
            groupElement.className = 'query-group-item'; // Clase CSS personalizada
            
            const currentCondition = groupData.condition || 'AND';

            groupElement.innerHTML = `
                <div class="group-header">
                    <div class="condition-toggle">
                        <button type="button" data-condition="AND" class="condition-btn ${currentCondition === 'AND' ? 'active' : ''}">Y (Todas)</button>
                        <button type="button" data-condition="OR" class="condition-btn ${currentCondition === 'OR' ? 'active' : ''}">O (Alguna)</button>
                    </div>
                    
                    <div class="group-actions">
                        <button type="button" class="btn-mini btn-add-rule add-rule-btn">
                            <i class="fas fa-plus"></i> Regla
                        </button>
                        <button type="button" class="btn-mini btn-add-group add-group-btn">
                            <i class="fas fa-layer-group"></i> Grupo
                        </button>
                        <button type="button" class="btn-mini btn-remove remove-group-btn">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                
                <div class="rules-container space-y-2"></div>
            `;

            const rulesContainer = groupElement.querySelector('.rules-container');
            
            // Renderizar hijos recursivamente si existen
            if (groupData.rules && groupData.rules.length > 0) {
                groupData.rules.forEach(rule => {
                    if (rule.condition) {
                        // Es un subgrupo
                        rulesContainer.appendChild(createFilterGroup(rule));
                    } else {
                        // Es una regla simple
                        rulesContainer.appendChild(createFilterRule(rule));
                    }
                });
            }

            // Event Listeners del Grupo
            groupElement.querySelector('.add-rule-btn').addEventListener('click', () => {
                rulesContainer.appendChild(createFilterRule());
                updatePreviewTable();
            });

            groupElement.querySelector('.add-group-btn').addEventListener('click', () => {
                rulesContainer.appendChild(createFilterGroup({ condition: 'AND', rules: [] }));
                updatePreviewTable();
            });

            groupElement.querySelector('.remove-group-btn').addEventListener('click', () => {
                // Evitar borrar el grupo raíz si es el único
                if (queryBuilderContainer.children.length === 1 && groupElement === queryBuilderContainer.firstElementChild) {
                    alert("No se puede eliminar el grupo principal. Debe haber al menos uno.");
                    return;
                }
                groupElement.remove();
                updatePreviewTable();
            });

            // Toggle AND/OR
            groupElement.querySelectorAll('.condition-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    // Quitar active de hermanos
                    const parent = btn.parentElement;
                    parent.querySelectorAll('.condition-btn').forEach(b => b.classList.remove('active'));
                    // Poner active al clickeado
                    btn.classList.add('active');
                    updatePreviewTable();
                });
            });

            return groupElement;
        }

        // --- 6. CONVERTIR DOM A JSON (Para enviar al backend) ---
        function buildJsonFromDom(groupElement) {
            const groupData = {};
            
            const activeButton = groupElement.querySelector('.condition-toggle .condition-btn.active');
            groupData.condition = activeButton ? activeButton.dataset.condition : 'AND';
            groupData.rules = [];

            // Solo buscar en el contenedor de reglas directo de este grupo
            const rulesContainer = groupElement.querySelector(':scope > .rules-container');
            
            Array.from(rulesContainer.children).forEach(child => {
                if (child.classList.contains('query-group-item')) {
                    // Recursión: Es un grupo
                    groupData.rules.push(buildJsonFromDom(child));
                } 
                else if (child.classList.contains('query-rule-item')) {
                    // Es una regla
                    const field = child.querySelector('[data-type="field"]').value;
                    const operator = child.querySelector('[data-type="operator"]').value;
                    const valueElement = child.querySelector('[data-type="value"]');
                    const value = valueElement ? valueElement.value : '';

                    // Solo agregar si tiene campo y operador (valor puede estar vacío a veces)
                    if (field && operator) {
                        groupData.rules.push({ field, operator, value });
                    }
                }
            });
            return groupData;
        }

        // --- 7. VISTA PREVIA (Tabla con Imágenes) ---
        async function updatePreviewTable() {
            const selectedColumns = Array.from(document.querySelectorAll('input[name="columns"]:checked')).map(el => el.value);
            
            // Obtener filtros actuales del DOM
            const rootGroupElement = queryBuilderContainer.querySelector('.query-group-item');
            let filtersData = {};
            if (rootGroupElement) {
                filtersData = buildJsonFromDom(rootGroupElement);
            }

            // Si no hay columnas seleccionadas, mostrar mensaje
            if (selectedColumns.length === 0) {
                previewTableContainer.innerHTML = `
                    <div class="empty-preview">
                        <i class="fas fa-columns"></i>
                        <p>Selecciona al menos una columna para ver la vista previa.</p>
                    </div>`;
                return;
            }

            // Loader
            previewTableContainer.innerHTML = `
                <div style="padding:3rem; text-align:center; color:var(--col-burgundy);">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p style="margin-top:10px;">Cargando datos...</p>
                </div>`;

            try {
                const response = await fetch('{{ url_for("plantillas.preview_query") }}', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({columns: selectedColumns, filters: filtersData}) 
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Error en el servidor');
                }

                const filteredData = await response.json();

                // --- CONSTRUCCIÓN DE LA TABLA HTML ---
                let html = `<table class="data-table">
                                <thead>
                                    <tr>`;
                
                // Headers
                selectedColumns.forEach(col => {
                    html += `<th>${formatColumnName(col)}</th>`;
                });
                html += `   </tr>
                        </thead>
                        <tbody>`;

                if (filteredData.length > 0) {
                    filteredData.forEach(item => {
                        html += `<tr>`;
                        selectedColumns.forEach(col => {
                            // LÓGICA DE IMÁGENES CORREGIDA
                            if (col === 'imagenPath_bien' || col === 'imagenPath_resguardo') {
                                const images = item[col] || []; 
                                // Ahora images es un ARRAY de strings (URLs) ['/uploads/...', ...]
                                
                                if (Array.isArray(images) && images.length > 0) {
                                    let imgsHtml = '<div style="display:flex; gap:5px; flex-wrap:wrap;">';
                                    images.forEach(url => {
                                        imgsHtml += `
                                            <a href="${url}" target="_blank" title="Ver original">
                                                <img src="${url}" 
                                                     style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px; border: 1px solid #ccc; background: white;"
                                                     onerror="this.style.display='none'">
                                            </a>`;
                                    });
                                    imgsHtml += '</div>';
                                    html += `<td>${imgsHtml}</td>`;
                                } else {
                                    html += `<td><span style="color:#ccc; font-size:0.8rem;">Sin fotos</span></td>`;
                                }
                            } else {
                                // Valor normal de texto
                                let val = (item[col] !== null && item[col] !== undefined) ? escapeHtml(item[col]) : '<span style="color:#ccc">-</span>';
                                html += `<td>${val}</td>`;
                            }
                        });
                        html += `</tr>`;
                    });
                } else {
                    html += `<tr><td colspan="${selectedColumns.length}" style="text-align:center; padding:2rem; color:#666;">No se encontraron resultados con los filtros actuales.</td></tr>`;
                }
                html += `</tbody></table>`;
                
                previewTableContainer.innerHTML = html;

            } catch (error) {
                console.error(error);
                previewTableContainer.innerHTML = `
                    <div style="padding:2rem; text-align:center; color:#ef4444;">
                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                        <p>Error al cargar vista previa: ${error.message}</p>
                    </div>`;
            }
        }

        // --- 8. INICIALIZACIÓN ---
        async function init() {
            // 1. Cargar áreas
            await fetchAreas();
            
            // 2. Renderizar Filtros Iniciales
            queryBuilderContainer.innerHTML = '';
            // Si no hay filtros iniciales (creación), crea un grupo vacío. Si hay (edición), los renderiza.
            queryBuilderContainer.appendChild(createFilterGroup(initialTemplateFilters));
            
            // 3. Listeners para Checkboxes de Columnas
            document.querySelectorAll('input[name="columns"]').forEach(cb => {
                cb.addEventListener('change', updatePreviewTable);
            });

            // 4. Listener para Submit del Formulario
            templateForm.addEventListener('submit', (e) => {
                const root = queryBuilderContainer.querySelector('.query-group-item');
                if (root) {
                    // Guardar la estructura JSON en el input hidden
                    hiddenFiltersInput.value = JSON.stringify(buildJsonFromDom(root));
                }
                
                // Validaciones básicas
                const name = document.getElementById('template_name').value;
                if(!name) {
                    e.preventDefault();
                    alert("El nombre de la plantilla es obligatorio");
                }
            });

            // 5. Carga inicial de la tabla
            updatePreviewTable();
        }

        // Arrancar
        init();
    });
</script>
{% endblock %}