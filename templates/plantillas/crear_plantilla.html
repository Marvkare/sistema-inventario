{% extends "base.html" %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-50 to-beige-light/20 py-8 px-4">
    <div class="max-w-6xl mx-auto">
        <!-- Encabezado -->
        <div class="bg-white rounded-2xl shadow-xl border border-beige-light overflow-hidden mb-8">
            <div class="bg-gradient-to-r from-burgundy to-burgundy-dark p-6 text-white">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold">
                            Crear Plantilla de Consulta
                        </h1>
                        <p class="text-beige-light mt-2">
                            Configure columnas y filtros para crear una plantilla de consulta personalizada
                        </p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="w-10 h-10 bg-beige rounded-full flex items-center justify-center">
                            <i class="fas fa-filter text-burgundy text-lg"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Formulario -->
        <div class="bg-white rounded-2xl shadow-lg border border-beige-light overflow-hidden">
            <form id="template-form" action="{{ url_for('plantillas.crear_plantilla') }}" method="post" class="p-6 md:p-8">
                
                <!-- Sección: Información de la Plantilla -->
                <div class="mb-8">
                    <div class="flex items-center mb-6">
                        <div class="w-8 h-8 bg-burgundy rounded-full flex items-center justify-center mr-3">
                            <i class="fas fa-info text-white text-sm"></i>
                        </div>
                        <h2 class="text-xl font-bold text-burgundy">Información de la Plantilla</h2>
                    </div>
                    <div class="grid grid-cols-1 gap-6">
                        <div>
                            <label for="template_name" class="block text-sm font-semibold text-gray-700 mb-2 flex items-center">
                                <i class="fas fa-tag text-burgundy mr-2 text-xs"></i>
                                Nombre de la Plantilla *
                            </label>
                            <input type="text" 
                                   name="template_name" 
                                   id="template_name" 
                                   required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 bg-white/80"
                                   placeholder="Ingrese un nombre descriptivo para la plantilla">
                        </div>
                        <div>
                            <label for="template_description" class="block text-sm font-semibold text-gray-700 mb-2 flex items-center">
                                <i class="fas fa-align-left text-burgundy mr-2 text-xs"></i>
                                Descripción
                            </label>
                            <textarea name="template_description" 
                                      id="template_description" 
                                      rows="3"
                                      class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 bg-white/80 resize-none"
                                      placeholder="Describa el propósito de esta plantilla de consulta"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Sección: Selección de Columnas -->
                <div class="mb-8">
                    <div class="flex items-center mb-6">
                        <div class="w-8 h-8 bg-burgundy rounded-full flex items-center justify-center mr-3">
                            <i class="fas fa-columns text-white text-sm"></i>
                        </div>
                        <h2 class="text-xl font-bold text-burgundy">Seleccionar Columnas</h2>
                    </div>
                    <div class="bg-beige-light/30 rounded-xl p-6 border border-beige-light">
                        <p class="text-sm text-gray-600 mb-4">Seleccione las columnas que desea incluir en la consulta:</p>
                        <div id="columns-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 max-h-80 overflow-y-auto p-4 bg-white rounded-lg border border-gray-200">
                            {% for column in columns %}
                            <div class="flex items-center p-3 hover:bg-beige-light/20 rounded-lg transition-colors duration-200">
                                <input id="column-{{ column }}" 
                                       name="columns" 
                                       type="checkbox" 
                                       value="{{ column }}"
                                       class="h-5 w-5 text-burgundy border-gray-300 rounded focus:ring-burgundy/50">
                                <label for="column-{{ column }}" class="ml-3 block text-sm font-medium text-gray-700 cursor-pointer">
                                    {{ column.replace('_', ' ').title() }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Sección: Filtros Dinámicos -->
                <div class="mb-8">
                    <div class="flex items-center mb-6">
                        <div class="w-8 h-8 bg-burgundy rounded-full flex items-center justify-center mr-3">
                            <i class="fas fa-sliders-h text-white text-sm"></i>
                        </div>
                        <h2 class="text-xl font-bold text-burgundy">Definir Filtros</h2>
                    </div>
                    <div class="bg-beige-light/30 rounded-xl p-6 border border-beige-light">
                        <p class="text-sm text-gray-600 mb-4">Configure los filtros para su consulta personalizada:</p>
                        <div id="filters-container" class="space-y-4 mb-4">
                            <!-- Los filtros se agregarán aquí dinámicamente con JavaScript -->
                        </div>
                        <button type="button" 
                                id="add-filter-btn"
                                class="inline-flex items-center px-5 py-2.5 border border-burgundy text-sm font-semibold rounded-xl text-burgundy bg-white hover:bg-burgundy hover:text-white transition-all duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-burgundy">
                            <i class="fas fa-plus mr-2"></i> Añadir Filtro
                        </button>
                    </div>
                </div>
                
                <!-- Sección: Vista Previa -->
                <div class="mb-8">
                    <div class="flex items-center mb-6">
                        <div class="w-8 h-8 bg-burgundy rounded-full flex items-center justify-center mr-3">
                            <i class="fas fa-eye text-white text-sm"></i>
                        </div>
                        <h2 class="text-xl font-bold text-burgundy">Vista Previa de la Consulta</h2>
                    </div>
                    <div class="bg-beige-light/30 rounded-xl p-6 border border-beige-light">
                        <div id="preview-table-container" class="w-full overflow-x-auto bg-white rounded-lg border border-gray-200 shadow-sm">
                            <div class="flex items-center justify-center min-h-32 text-gray-500">
                                <div class="text-center">
                                    <i class="fas fa-table text-3xl mb-2 text-gray-300"></i>
                                    <p>Selecciona columnas y añade filtros para ver la vista previa.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Botones de Acción -->
                <div class="flex flex-col sm:flex-row justify-end gap-4 pt-6 border-t border-gray-200">
                    <a href="{{ url_for('index') }}" 
                       class="inline-flex items-center justify-center px-6 py-3 border-2 border-gray-300 text-base font-semibold rounded-xl text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-all duration-200 ease-in-out order-2 sm:order-1">
                        <i class="fas fa-times mr-2"></i> Cancelar
                    </a>
                    <button type="submit" 
                            class="inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-semibold rounded-xl shadow-sm text-white bg-gradient-to-r from-burgundy to-burgundy-dark hover:from-burgundy-dark hover:to-burgundy focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-burgundy transition-all duration-200 ease-in-out order-1 sm:order-2">
                        <i class="fas fa-save mr-2"></i> 
                        Guardar Plantilla
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
    .bg-burgundy { background-color: #6A2E4D; }
    .bg-burgundy-dark { background-color: #551E3A; }
    .text-burgundy { color: #6A2E4D; }
    .border-burgundy { border-color: #6A2E4D; }
    .focus\:ring-burgundy\/50:focus { --tw-ring-color: rgb(106 46 77 / 0.5); }
    .focus\:border-burgundy:focus { border-color: #6A2E4D; }
    
    .bg-beige { background-color: #BC9B6A; }
    .bg-beige-light { background-color: #D7C3A0; }
    .text-beige-light { color: #D7C3A0; }
    .border-beige { border-color: #BC9B6A; }
    .border-beige-light { border-color: #D7C3A0; }
    
    .from-burgundy { --tw-gradient-from: #6A2E4D; --tw-gradient-to: rgb(106 46 77 / 0); --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to); }
    .to-burgundy-dark { --tw-gradient-to: #551E3A; }
    
    input:focus, select:focus, textarea:focus {
        outline: none;
        box-shadow: 0 0 0 2px rgb(106 46 77 / 0.1);
    }
    
    /* Estilos para la tabla de vista previa */
    #preview-table-container table {
        border-collapse: separate;
        border-spacing: 0;
    }
    
    #preview-table-container th {
        background: linear-gradient(to bottom, #f9fafb, #f3f4f6);
        border-bottom: 2px solid #e5e7eb;
    }
    
    #preview-table-container tr:hover {
        background-color: #fef7f5;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const addFilterBtn = document.getElementById('add-filter-btn');
        const filtersContainer = document.getElementById('filters-container');
        const columnsContainer = document.getElementById('columns-container');
        const previewTableContainer = document.getElementById('preview-table-container');
        const availableColumns = {{ columns | tojson | safe }};
        let availableAreas = [];

        // Function to fetch areas from the server
        const fetchAreas = async () => {
            try {
                const response = await fetch('{{ url_for("areas.get_areas") }}');
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const data = await response.json();
                availableAreas = data;
            } catch (error) {
                console.error('Error fetching areas:', error);
                availableAreas = []; 
            }
        };
        
        // Función para crear un nuevo grupo de filtro con diseño mejorado
        function createFilterGroup() {
            const filterGroup = document.createElement('div');
            filterGroup.className = 'bg-white p-4 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-shadow duration-200';
            
            const columnOptions = availableColumns.map(col => 
                `<option value="${col}">${col.replace('_', ' ').charAt(0).toUpperCase() + col.replace('_', ' ').slice(1)}</option>`
            ).join('');

            filterGroup.innerHTML = `
                <div class="flex flex-col md:flex-row gap-4 items-start md:items-end">
                    <div class="flex-1">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Campo</label>
                        <select name="filter_field[]" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 bg-white/80">
                            <option value="">Seleccionar campo...</option>
                            ${columnOptions}
                        </select>
                    </div>
                    <div class="flex-1">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Operador</label>
                        <select name="filter_operator[]" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 bg-white/80">
                            <option value="==">Igual a</option>
                            <option value="!=">Diferente de</option>
                            <option value=">">Mayor que</option>
                            <option value="<">Menor que</option>
                            <option value=">=">Mayor o igual que</option>
                            <option value="<=">Menor o igual que</option>
                            <option value="contains">Contiene</option>
                            <option value="starts_with">Comienza con</option>
                            <option value="ends_with">Termina con</option>
                        </select>
                    </div>
                    <div class="flex-1 filter-value-container">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Valor</label>
                        <input type="text" name="filter_value[]" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 bg-white/80" placeholder="Valor del filtro">
                    </div>
                    <div class="flex items-end h-12">
                        <button type="button" class="remove-filter-btn text-red-500 hover:text-red-700 transition-colors duration-200 p-2 rounded-lg hover:bg-red-50">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
            `;

            // Agregar listener para el botón de eliminar
            filterGroup.querySelector('.remove-filter-btn').addEventListener('click', () => {
                filterGroup.style.opacity = '0';
                filterGroup.style.transform = 'translateX(-10px)';
                setTimeout(() => {
                    filterGroup.remove();
                    updatePreviewTable();
                }, 300);
            });

            const fieldSelect = filterGroup.querySelector('[name="filter_field[]"]');
            const valueContainer = filterGroup.querySelector('.filter-value-container');
            let valueInput = filterGroup.querySelector('[name="filter_value[]"]');

            // Función para actualizar el tipo de input de valor
            const updateValueInputType = () => {
                const selectedField = fieldSelect.value;
                let newValueInput;

                if (selectedField === 'Area') {
                    const areaOptions = availableAreas.map(area => `<option value="${area.id}">${area.nombre}</option>`).join('');
                    newValueInput = document.createElement('select');
                    newValueInput.name = 'filter_value[]';
                    newValueInput.className = 'w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 bg-white/80';
                    newValueInput.innerHTML = `<option value="">Seleccionar área...</option>${areaOptions}`;
                } else {
                    newValueInput = document.createElement('input');
                    newValueInput.type = 'text';
                    newValueInput.name = 'filter_value[]';
                    newValueInput.className = 'w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 bg-white/80';
                    newValueInput.placeholder = 'Valor del filtro';
                }

                valueContainer.replaceChild(newValueInput, valueInput);
                valueInput = newValueInput;
                
                valueInput.addEventListener('change', updatePreviewTable);
                if (selectedField !== 'Area') {
                    valueInput.addEventListener('keyup', updatePreviewTable);
                }
            };

            fieldSelect.addEventListener('change', () => {
                updateValueInputType();
                updatePreviewTable();
            });

            valueInput.addEventListener('change', updatePreviewTable);
            valueInput.addEventListener('keyup', updatePreviewTable);

            return filterGroup;
        }

        // Función para actualizar la tabla de vista previa con datos reales
        async function updatePreviewTable() {
            const selectedColumns = Array.from(document.querySelectorAll('input[name="columns"]:checked')).map(el => el.value);
            const filterGroups = Array.from(document.querySelectorAll('#filters-container > div'));
            const filters = filterGroups.map(group => {
                const fieldSelect = group.querySelector('[name="filter_field[]"]');
                const operatorSelect = group.querySelector('[name="filter_operator[]"]');
                const valueInput = group.querySelector('[name="filter_value[]"]');
                
                return {
                    field: fieldSelect ? fieldSelect.value : '',
                    operator: operatorSelect ? operatorSelect.value : '',
                    value: valueInput ? valueInput.value : ''
                };
            }).filter(filter => filter.field && filter.value);

            if (selectedColumns.length === 0) {
                previewTableContainer.innerHTML = `
                    <div class="flex items-center justify-center min-h-32 text-gray-500">
                        <div class="text-center">
                            <i class="fas fa-columns text-3xl mb-2 text-gray-300"></i>
                            <p>Selecciona columnas para ver la vista previa.</p>
                        </div>
                    </div>
                `;
                return;
            }

            previewTableContainer.innerHTML = `
                <div class="flex items-center justify-center min-h-32 text-burgundy">
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                        <p>Cargando datos...</p>
                    </div>
                </div>
            `;

            try {
                const response = await fetch('{{ url_for("plantillas.preview_query") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        columns: selectedColumns,
                        filters: filters
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    previewTableContainer.innerHTML = `
                        <div class="flex items-center justify-center min-h-32 text-red-500">
                            <div class="text-center">
                                <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                                <p>Error: ${error.error}</p>
                            </div>
                        </div>
                    `;
                    return;
                }

                const filteredData = await response.json();

                // Construir la tabla
                let tableHTML = `
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gradient-to-r from-gray-50 to-gray-100">
                            <tr>
                                ${selectedColumns.map(col => 
                                    `<th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider border-b border-gray-200">${formatColumnName(col)}</th>`
                                ).join('')}
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                `;

                if (filteredData.length === 0) {
                    tableHTML += `
                        <tr>
                            <td colspan="${selectedColumns.length}" class="px-6 py-8 text-center text-sm text-gray-500">
                                <i class="fas fa-search text-2xl mb-2 text-gray-300 block"></i>
                                No se encontraron resultados con los filtros aplicados.
                            </td>
                        </tr>
                    `;
                } else {
                    tableHTML += filteredData.map(item => `
                        <tr class="hover:bg-beige-light/10 transition-colors duration-150">
                            ${selectedColumns.map(col => {
                                if (col === 'imagenPath_bien' || col === 'imagenPath_resguardo') {
                                    const images = item[col] || [];
                                    return `
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="flex flex-wrap gap-1">
                                                ${images.length > 0 ? 
                                                    images.map(img => {
                                                        const filename = img.split('/').pop();
                                                        return `
                                                            <img src="/static/uploads/${filename}" 
                                                                 alt="Imagen" 
                                                                 class="h-12 w-12 object-cover rounded-lg border-2 border-beige-light shadow-sm hover:shadow-md transition-shadow duration-200"
                                                                 onerror="this.style.display='none'">
                                                        `;
                                                    }).join('') : 
                                                    '<span class="text-gray-400 text-sm">Sin imágenes</span>'
                                                }
                                            </div>
                                        </td>
                                    `;
                                } else {
                                    const value = item[col];
                                    return `
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                            ${value !== null && value !== undefined ? escapeHtml(value.toString()) : '<span class="text-gray-400">-</span>'}
                                        </td>
                                    `;
                                }
                            }).join('')}
                        </tr>
                    `).join('');
                }

                tableHTML += `
                        </tbody>
                    </table>
                `;

                previewTableContainer.innerHTML = tableHTML;

            } catch (error) {
                console.error('Error fetching data:', error);
                previewTableContainer.innerHTML = `
                    <div class="flex items-center justify-center min-h-32 text-red-500">
                        <div class="text-center">
                            <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
                            <p>Error al obtener los datos.</p>
                            <p class="text-sm mt-1">Por favor, revisa la consola para más detalles.</p>
                        </div>
                    </div>
                `;
            }
        }

        // Función auxiliar para formatear nombres de columnas
        function formatColumnName(column) {
            return column.replace(/_/g, ' ')
                        .split(' ')
                        .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                        .join(' ');
        }

        // Función auxiliar para escapar HTML (seguridad)
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Fetch areas and then proceed with creating the initial filter
        fetchAreas().then(() => {
            // Agregar un filtro al hacer clic en el botón
            addFilterBtn.addEventListener('click', () => {
                const newFilter = createFilterGroup();
                filtersContainer.appendChild(newFilter);
                updatePreviewTable();
            });
        
            // Agregar listeners a todos los checkboxes de columnas
            columnsContainer.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', updatePreviewTable);
            });
            
            // Añadir un filtro por defecto y actualizar la tabla al cargar la página
            if (filtersContainer.children.length === 0) {
                filtersContainer.appendChild(createFilterGroup());
            }
            updatePreviewTable();
        });

        // Validación del formulario
        document.getElementById('template-form').addEventListener('submit', function(e) {
            const templateName = document.getElementById('template_name').value.trim();
            const selectedColumns = Array.from(document.querySelectorAll('input[name="columns"]:checked')).length;
            
            if (!templateName) {
                e.preventDefault();
                alert('Por favor, ingrese un nombre para la plantilla.');
                return;
            }
            
            if (selectedColumns === 0) {
                e.preventDefault();
                alert('Por favor, seleccione al menos una columna para la plantilla.');
                return;
            }
        });
    });
</script>
{% endblock %}