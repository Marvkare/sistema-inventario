{% extends "base.html" %}

{% block content %}
<div class="flex-grow flex flex-col items-center p-8">
    <div class="container bg-white p-8 rounded-xl shadow-lg border border-gray-200 w-full max-w-4xl">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="flash-message flash-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Gestión de Áreas</h2>

        {# Formulario para Agregar/Editar Área #}
        <div class="bg-gray-50 p-6 rounded-lg mb-8 border border-gray-200">
            <h3 class="text-2xl font-semibold mb-4 text-gray-700" id="form-title">Agregar Nueva Área</h3>
            <form id="area-form" method="POST" action="{{ url_for('areas.manage_areas') }}" class="space-y-4">
                <input type="hidden" name="area_id" id="area_id" value="">
                <div>
                    <label for="area_name" class="block text-sm font-medium text-gray-700">Nombre del Área</label>
                    <input type="text" id="area_name" name="area_name" required
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                </div>
                <div>
                    <label for="area_numero" class="block text-sm font-medium text-gray-700">Número de Área (Opcional)</label>
                    <input type="number" id="area_numero" name="area_numero" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg shadow-md hover:bg-blue-700 transition-colors font-medium flex items-center">
                        <i class="fas fa-save mr-2"></i> Guardar Área
                    </button>
                    <button type="button" id="cancel-edit-btn" class="bg-gray-400 text-white px-6 py-2 rounded-lg shadow-md hover:bg-gray-500 transition-colors font-medium hidden">
                        <i class="fas fa-times-circle mr-2"></i> Cancelar Edición
                    </button>
                </div>
            </form>
        </div>

        {# Tabla de Áreas Existentes #}
        <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
            <h3 class="text-2xl font-semibold mb-4 text-gray-700">Áreas Existentes</h3>
            {% if areas %}
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID DB</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Número</th>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for area in areas %}
                        <tr id="area-row-{{ area.id }}">
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ area.id }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" data-name="{{ area.name }}">{{ area.name }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ area.numero | default('N/A') }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                                <button type="button" onclick="editArea({{ area.id }}, '{{ area.name }}', '{{ area.numero | default('') }}')"
                                        class="text-indigo-600 hover:text-indigo-900 mr-4" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </button>
                                
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="no-data">No hay áreas registradas aún.</p>
            {% endif %}
        </div>
    </div>
</div>

<script>
    // JavaScript para ocultar los mensajes flash
    document.addEventListener('DOMContentLoaded', () => {
        const flashMessages = document.querySelectorAll('.flash-message');
        flashMessages.forEach(msg => {
            setTimeout(() => {
                msg.style.opacity = '0';
                msg.style.display = 'none';
                msg.remove(); // Eliminar del DOM
            }, 6000);
        });
    });

    const formTitle = document.getElementById('form-title');
    const areaForm = document.getElementById('area-form');
    const areaIdInput = document.getElementById('area_id');
    const areaNameInput = document.getElementById('area_name');
    const areaNumeroInput = document.getElementById('area_numero'); // New input
    const saveButton = areaForm.querySelector('button[type="submit"]');
    const cancelButton = document.getElementById('cancel-edit-btn');

    function editArea(id, name, numero) {
        formTitle.textContent = 'Editar Área';
        areaIdInput.value = id;
        areaNameInput.value = name;
        areaNumeroInput.value = numero; // Set the value for the number input
        saveButton.innerHTML = '<i class="fas fa-save mr-2"></i> Actualizar Área';
        cancelButton.classList.remove('hidden');
        window.scrollTo({ top: 0, behavior: 'smooth' }); // Scroll to form
    }

    cancelButton.addEventListener('click', () => {
        resetForm();
    });

    function resetForm() {
        formTitle.textContent = 'Agregar Nueva Área';
        areaIdInput.value = '';
        areaNameInput.value = '';
        areaNumeroInput.value = ''; // Reset the number input
        saveButton.innerHTML = '<i class="fas fa-save mr-2"></i> Guardar Área';
        cancelButton.classList.add('hidden');
    }

    function deleteArea(id, name) {
        if (confirm(`¿Estás seguro de que quieres eliminar el área "${name}"? Esta acción no se puede deshacer.`)) {
            fetch(`/delete_area/${id}`, {
                method: 'POST', // Using POST for deletion as it changes state
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showFlashMessage(data.message, 'success');
                    document.getElementById(`area-row-${id}`).remove(); // Remove row from table
                } else {
                    showFlashMessage(data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error al eliminar el área:', error);
                showFlashMessage('Error de red o del servidor al eliminar el área.', 'error');
            });
        }
    }

    // Function to show flash messages from JavaScript (copied from crear_resguardo.html)
    function showFlashMessage(message, category) {
        const flashContainer = document.querySelector('.container');
        const newMessageDiv = document.createElement('div');
        newMessageDiv.classList.add('flash-message', `flash-${category}`);
        newMessageDiv.textContent = message;
        flashContainer.insertBefore(newMessageDiv, flashContainer.firstChild);

        setTimeout(() => {
            newMessageDiv.style.opacity = '0';
            newMessageDiv.style.display = 'none';
            newMessageDiv.remove();
        }, 6000);
    }
</script>
{% endblock %}