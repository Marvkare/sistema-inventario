{% extends "base.html" %}

{% block title %}
    {% if is_edit %}
        Editar Resguardo
    {% elif bien_precargado %}
        Crear Resguardo para Bien Existente
    {% else %}
        Crear Nuevo Bien y Resguardo
    {% endif %}
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-50 to-beige-light/20 py-8 px-4">
    <div class="max-w-7xl mx-auto">
        
        <!-- Encabezado -->
        <div class="bg-white rounded-2xl shadow-xl border border-beige-light overflow-hidden mb-8">
            <div class="bg-gradient-to-r from-burgundy to-burgundy-dark p-6 text-white">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold">
                            {% if is_edit %}
                                Editar Resguardo
                            {% elif bien_precargado %}
                                Crear Resguardo para Bien Existente
                            {% else %}
                                Formulario de Nuevo Bien y Resguardo
                            {% endif %}
                        </h1>
                        <p class="text-beige-light mt-2">
                            {% if is_edit %}
                                Modifique la información del resguardo y del bien
                            {% elif bien_precargado %}
                                Complete los datos del resguardo para el bien existente
                            {% else %}
                                Complete toda la información requerida para el nuevo bien y su resguardo
                            {% endif %}
                        </p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="w-10 h-10 bg-beige rounded-full flex items-center justify-center">
                            <i class="fas fa-file-contract text-burgundy text-lg"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mensajes Flash -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="flash-message flash-{{ category }} mb-6 p-4 rounded-lg border-l-4 {% if category == 'success' %}bg-green-100 border-green-500 text-green-700{% elif category == 'danger' %}bg-red-100 border-red-500 text-red-700{% else %}bg-blue-100 border-blue-500 text-blue-700{% endif %}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Formulario Principal -->
        <div class="bg-white rounded-2xl shadow-lg border border-beige-light overflow-hidden">
            <form id="resguardoForm" 
                  action="{{ url_for('resguardos.editar_resguardo', id_resguardo=form_data.resguardo_id) if is_edit else url_for('resguardos.crear_resguardo') }}" 
                  method="post" 
                  enctype="multipart/form-data" 
                  class="p-6 md:p-8 space-y-8">

                {% set is_new_bien_mode = not is_edit and not bien_precargado %}
                
                {% if is_edit %}
                    <input type="hidden" name="id_bien" value="{{ form_data.bien_id }}">
                {% elif bien_precargado %}
                    <input type="hidden" name="id_bien_existente" value="{{ form_data.id }}">
                {% endif %}

                <!-- SECCIÓN: INFORMACIÓN GENERAL DEL BIEN -->
                <div class="mb-8">
                    <div class="flex items-center mb-6">
                        <div class="w-8 h-8 bg-burgundy rounded-full flex items-center justify-center mr-3">
                            <i class="fas fa-box text-white text-sm"></i>
                        </div>
                        <h2 class="text-xl font-bold text-burgundy">Información General del Bien</h2>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- No. Inventario -->
                        <div>
                            <label for="No_Inventario" class="block text-sm font-semibold text-gray-700 mb-2 flex items-center">
                                <i class="fas fa-hashtag text-burgundy mr-2 text-xs"></i>
                                No. de Inventario *
                            </label>
                            <input type="text" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 {% if not is_new_bien_mode %}bg-gray-100 text-gray-500 cursor-not-allowed{% else %}bg-white/80{% endif %}" 
                                   id="No_Inventario" 
                                   name="No_Inventario" 
                                   value="{{ form_data.No_Inventario or '' }}" 
                                   {% if not is_new_bien_mode %}disabled{% endif %} 
                                   required
                                   placeholder="Ingrese el número de inventario">
                        </div>

                        <!-- Cantidad -->
                        <div>
                            <label for="Cantidad" class="block text-sm font-semibold text-gray-700 mb-2 flex items-center">
                                <i class="fas fa-cubes text-burgundy mr-2 text-xs"></i>
                                Cantidad *
                            </label>
                            <input type="number" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 {% if not is_new_bien_mode %}bg-gray-100 text-gray-500 cursor-not-allowed{% else %}bg-white/80{% endif %}" 
                                   id="Cantidad" 
                                   name="Cantidad" 
                                   value="{{ form_data.Cantidad or '1' }}" 
                                   min="1" 
                                   {% if not is_new_bien_mode %}disabled{% endif %}
                                   required
                                   placeholder="Cantidad de unidades">
                        </div>

                        <!-- Descripción Corta -->
                        <div>
                            <label for="Descripcion_Corta_Del_Bien" class="block text-sm font-semibold text-gray-700 mb-2 flex items-center">
                                <i class="fas fa-align-left text-burgundy mr-2 text-xs"></i>
                                Descripción Corta
                            </label>
                            <input type="text" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 {% if not is_new_bien_mode %}bg-gray-100 text-gray-500 cursor-not-allowed{% else %}bg-white/80{% endif %}" 
                                   id="Descripcion_Corta_Del_Bien" 
                                   name="Descripcion_Corta_Del_Bien" 
                                   value="{{ form_data.Descripcion_Corta_Del_Bien or '' }}" 
                                   {% if not is_new_bien_mode %}disabled{% endif %}
                                   placeholder="Descripción breve del bien">
                        </div>

                        <!-- Marca -->
                        <div>
                            <label for="Marca" class="block text-sm font-semibold text-gray-700 mb-2 flex items-center">
                                <i class="fas fa-tag text-burgundy mr-2 text-xs"></i>
                                Marca
                            </label>
                            <input type="text" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 {% if not is_new_bien_mode %}bg-gray-100 text-gray-500 cursor-not-allowed{% else %}bg-white/80{% endif %}" 
                                   id="Marca" 
                                   name="Marca" 
                                   value="{{ form_data.Marca or '' }}" 
                                   {% if not is_new_bien_mode %}disabled{% endif %}
                                   placeholder="Marca del bien">
                        </div>

                        <!-- Modelo -->
                        <div>
                            <label for="Modelo" class="block text-sm font-semibold text-gray-700 mb-2 flex items-center">
                                <i class="fas fa-cube text-burgundy mr-2 text-xs"></i>
                                Modelo
                            </label>
                            <input type="text" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 {% if not is_new_bien_mode %}bg-gray-100 text-gray-500 cursor-not-allowed{% else %}bg-white/80{% endif %}" 
                                   id="Modelo" 
                                   name="Modelo" 
                                   value="{{ form_data.Modelo or '' }}" 
                                   {% if not is_new_bien_mode %}disabled{% endif %}
                                   placeholder="Modelo del bien">
                        </div>

                        <!-- Número de Serie -->
                        <div>
                            <label for="Numero_De_Serie" class="block text-sm font-semibold text-gray-700 mb-2 flex items-center">
                                <i class="fas fa-barcode text-burgundy mr-2 text-xs"></i>
                                Número de Serie
                            </label>
                            <input type="text" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 {% if not is_new_bien_mode %}bg-gray-100 text-gray-500 cursor-not-allowed{% else %}bg-white/80{% endif %}" 
                                   id="Numero_De_Serie" 
                                   name="Numero_De_Serie" 
                                   value="{{ form_data.Numero_De_Serie or '' }}" 
                                   {% if not is_new_bien_mode %}disabled{% endif %}
                                   placeholder="Número de serie">
                        </div>

                        <!-- Estado del Bien -->
                        <div>
                            <label for="Estado_Del_Bien" class="block text-sm font-semibold text-gray-700 mb-2 flex items-center">
                                <i class="fas fa-clipboard-check text-burgundy mr-2 text-xs"></i>
                                Estado del Bien
                            </label>
                            <select class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 {% if not is_new_bien_mode %}bg-gray-100 text-gray-500 cursor-not-allowed{% else %}bg-white/80{% endif %}" 
                                    id="Estado_Del_Bien" 
                                    name="Estado_Del_Bien" 
                                    {% if not is_new_bien_mode %}disabled{% endif %}>
                                <option value="" disabled selected>Seleccione el estado...</option>
                                <option value="Nuevo" {% if form_data.Estado_Del_Bien == 'Nuevo' %}selected{% endif %}>Nuevo</option>
                                <option value="Bueno" {% if form_data.Estado_Del_Bien == 'Bueno' %}selected{% endif %}>Bueno</option>
                                <option value="Regular" {% if form_data.Estado_Del_Bien == 'Regular' %}selected{% endif %}>Regular</option>
                                <option value="Malo" {% if form_data.Estado_Del_Bien == 'Malo' %}selected{% endif %}>Malo</option>
                            </select>
                        </div>

                        <!-- Tipo de Alta -->
                        <div>
                            <label for="Tipo_De_Alta" class="block text-sm font-semibold text-gray-700 mb-2 flex items-center">
                                <i class="fas fa-sign-in-alt text-burgundy mr-2 text-xs"></i>
                                Tipo de Alta *
                            </label>
                            <select class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 {% if not is_new_bien_mode %}bg-gray-100 text-gray-500 cursor-not-allowed{% else %}bg-white/80{% endif %}" 
                                    id="Tipo_De_Alta" 
                                    name="Tipo_De_Alta" 
                                    {% if not is_new_bien_mode %}disabled{% endif %} 
                                    required>
                                <option value="" disabled selected>Seleccione el tipo...</option>
                                <option value="Compra" {% if form_data.Tipo_De_Alta == 'Compra' %}selected{% endif %}>Compra</option>
                                <option value="Donacion" {% if form_data.Tipo_De_Alta == 'Donacion' %}selected{% endif %}>Donación</option>
                                <option value="Comodato" {% if form_data.Tipo_De_Alta == 'Comodato' %}selected{% endif %}>Comodato</option>
                            </select>
                        </div>

                        <!-- Clasificación Legal -->
                        <div>
                            <label for="Clasificacion_Legal" class="block text-sm font-semibold text-gray-700 mb-2 flex items-center">
                                <i class="fas fa-balance-scale text-burgundy mr-2 text-xs"></i>
                                Clasificación Legal *
                            </label>
                            <select class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 {% if not is_new_bien_mode %}bg-gray-100 text-gray-500 cursor-not-allowed{% else %}bg-white/80{% endif %}" 
                                    id="Clasificacion_Legal" 
                                    name="Clasificacion_Legal" 
                                    {% if not is_new_bien_mode %}disabled{% endif %} 
                                    required>
                                <option value="" disabled selected>Seleccione...</option>
                                <option value="Dominio Público" {% if form_data.Clasificacion_Legal == 'Dominio Público' %}selected{% endif %}>Dominio Público</option>
                                <option value="Dominio Privado" {% if form_data.Clasificacion_Legal == 'Dominio Privado' %}selected{% endif %}>Dominio Privado</option>
                            </select>
                        </div>

                        <!-- Área Presupuestal -->
                        <div>
                            <label for="Area_Presupuestal" class="block text-sm font-semibold text-gray-700 mb-2 flex items-center">
                                <i class="fas fa-chart-pie text-burgundy mr-2 text-xs"></i>
                                Área Presupuestal
                            </label>
                            <input type="text" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 {% if not is_new_bien_mode %}bg-gray-100 text-gray-500 cursor-not-allowed{% else %}bg-white/80{% endif %}" 
                                   id="Area_Presupuestal" 
                                   name="Area_Presupuestal" 
                                   value="{{ form_data.Area_Presupuestal or '' }}" 
                                   {% if not is_new_bien_mode %}disabled{% endif %}
                                   placeholder="Área presupuestal">
                        </div>
                    </div>

                    <!-- Descripción Completa -->
                    <div class="mt-6">
                        <label for="Descripcion_Del_Bien" class="block text-sm font-semibold text-gray-700 mb-2 flex items-center">
                            <i class="fas fa-align-left text-burgundy mr-2 text-xs"></i>
                            Descripción Completa del Bien
                        </label>
                        <textarea class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 {% if not is_new_bien_mode %}bg-gray-100 text-gray-500 cursor-not-allowed{% else %}bg-white/80{% endif %} resize-none" 
                                  id="Descripcion_Del_Bien" 
                                  name="Descripcion_Del_Bien" 
                                  rows="4"
                                  {% if not is_new_bien_mode %}disabled{% endif %}
                                  placeholder="Descripción detallada del bien">{{ form_data.Descripcion_Del_Bien or '' }}</textarea>
                    </div>
                </div>

                <!-- SECCIÓN: DATOS FINANCIEROS Y CONTABLES -->
                <div class="mb-8">
                    <div class="flex items-center mb-6">
                        <div class="w-8 h-8 bg-burgundy rounded-full flex items-center justify-center mr-3">
                            <i class="fas fa-dollar-sign text-white text-sm"></i>
                        </div>
                        <h2 class="text-xl font-bold text-burgundy">Datos Financieros y Contables</h2>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- No. Factura -->
                        <div>
                            <label for="No_Factura" class="block text-sm font-semibold text-gray-700 mb-2">No. de Factura</label>
                            <input type="text" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 {% if not is_new_bien_mode %}bg-gray-100 text-gray-500 cursor-not-allowed{% else %}bg-white/80{% endif %}" 
                                   id="No_Factura" 
                                   name="No_Factura" 
                                   value="{{ form_data.No_Factura or '' }}" 
                                   {% if not is_new_bien_mode %}disabled{% endif %}
                                   placeholder="Número de factura">
                        </div>

                        <!-- Fecha Factura -->
                        <div>
                            <label for="Fecha_Factura" class="block text-sm font-semibold text-gray-700 mb-2">Fecha de Factura</label>
                            <input type="date" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 {% if not is_new_bien_mode %}bg-gray-100 text-gray-500 cursor-not-allowed{% else %}bg-white/80{% endif %}" 
                                   id="Fecha_Factura" 
                                   name="Fecha_Factura" 
                                   value="{{ form_data.Fecha_Factura or '' }}" 
                                   {% if not is_new_bien_mode %}disabled{% endif %}>
                        </div>

                        <!-- Costo Inicial -->
                        <div>
                            <label for="Costo_Inicial" class="block text-sm font-semibold text-gray-700 mb-2">Costo Inicial</label>
                            <input type="number" 
                                   step="0.01" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 {% if not is_new_bien_mode %}bg-gray-100 text-gray-500 cursor-not-allowed{% else %}bg-white/80{% endif %}" 
                                   id="Costo_Inicial" 
                                   name="Costo_Inicial" 
                                   value="{{ form_data.Costo_Inicial or '' }}" 
                                   min="0"
                                   {% if not is_new_bien_mode %}disabled{% endif %}
                                   placeholder="0.00">
                        </div>

                        <!-- Depreciación Acumulada -->
                        <div>
                            <label for="Depreciacion_Acumulada" class="block text-sm font-semibold text-gray-700 mb-2">Depreciación Acumulada</label>
                            <input type="number" 
                                   step="0.01" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 {% if not is_new_bien_mode %}bg-gray-100 text-gray-500 cursor-not-allowed{% else %}bg-white/80{% endif %}" 
                                   id="Depreciacion_Acumulada" 
                                   name="Depreciacion_Acumulada" 
                                   value="{{ form_data.Depreciacion_Acumulada or '' }}" 
                                   min="0"
                                   {% if not is_new_bien_mode %}disabled{% endif %}
                                   placeholder="0.00">
                        </div>

                        <!-- Costo Final -->
                        <div>
                            <label for="Costo_Final" class="block text-sm font-semibold text-gray-700 mb-2">Costo Final</label>
                            <input type="number" 
                                   step="0.01" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 {% if not is_new_bien_mode %}bg-gray-100 text-gray-500 cursor-not-allowed{% else %}bg-white/80{% endif %}" 
                                   id="Costo_Final" 
                                   name="Costo_Final" 
                                   value="{{ form_data.Costo_Final or '' }}" 
                                   min="0"
                                   {% if not is_new_bien_mode %}disabled{% endif %}
                                   placeholder="0.00">
                        </div>

                        <!-- Valor en Libros -->
                        <div>
                            <label for="Valor_En_Libros" class="block text-sm font-semibold text-gray-700 mb-2">Valor en Libros</label>
                            <input type="number" 
                                   step="0.01" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 {% if not is_new_bien_mode %}bg-gray-100 text-gray-500 cursor-not-allowed{% else %}bg-white/80{% endif %}" 
                                   id="Valor_En_Libros" 
                                   name="Valor_En_Libros" 
                                   value="{{ form_data.Valor_En_Libros or '' }}" 
                                   min="0"
                                   {% if not is_new_bien_mode %}disabled{% endif %}
                                   placeholder="0.00">
                        </div>

                        <!-- Póliza -->
                        <div>
                            <label for="Poliza" class="block text-sm font-semibold text-gray-700 mb-2">Póliza</label>
                            <input type="text" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 {% if not is_new_bien_mode %}bg-gray-100 text-gray-500 cursor-not-allowed{% else %}bg-white/80{% endif %}" 
                                   id="Poliza" 
                                   name="Poliza" 
                                   value="{{ form_data.Poliza or '' }}" 
                                   {% if not is_new_bien_mode %}disabled{% endif %}
                                   placeholder="Número de póliza">
                        </div>

                        <!-- Fecha Póliza -->
                        <div>
                            <label for="Fecha_Poliza" class="block text-sm font-semibold text-gray-700 mb-2">Fecha de Póliza</label>
                            <input type="date" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 {% if not is_new_bien_mode %}bg-gray-100 text-gray-500 cursor-not-allowed{% else %}bg-white/80{% endif %}" 
                                   id="Fecha_Poliza" 
                                   name="Fecha_Poliza" 
                                   value="{{ form_data.Fecha_Poliza or '' }}" 
                                   {% if not is_new_bien_mode %}disabled{% endif %}>
                        </div>

                        <!-- No. Cuenta -->
                        <div>
                            <label for="No_Cuenta" class="block text-sm font-semibold text-gray-700 mb-2">No. de Cuenta</label>
                            <input type="text" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 {% if not is_new_bien_mode %}bg-gray-100 text-gray-500 cursor-not-allowed{% else %}bg-white/80{% endif %}" 
                                   id="No_Cuenta" 
                                   name="No_Cuenta" 
                                   value="{{ form_data.No_Cuenta or '' }}" 
                                   {% if not is_new_bien_mode %}disabled{% endif %}
                                   placeholder="Número de cuenta">
                        </div>

                        <!-- Subcuenta Armonizadora -->
                        <div>
                            <label for="Sub_Cuenta_Armonizadora" class="block text-sm font-semibold text-gray-700 mb-2">Subcuenta Armonizadora</label>
                            <input type="text" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 {% if not is_new_bien_mode %}bg-gray-100 text-gray-500 cursor-not-allowed{% else %}bg-white/80{% endif %}" 
                                   id="Sub_Cuenta_Armonizadora" 
                                   name="Sub_Cuenta_Armonizadora" 
                                   value="{{ form_data.Sub_Cuenta_Armonizadora or '' }}" 
                                   {% if not is_new_bien_mode %}disabled{% endif %}
                                   placeholder="Subcuenta armonizadora">
                        </div>

                        <!-- Rubro -->
                        <div>
                            <label for="Rubro" class="block text-sm font-semibold text-gray-700 mb-2">Rubro</label>
                            <input type="text" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 {% if not is_new_bien_mode %}bg-gray-100 text-gray-500 cursor-not-allowed{% else %}bg-white/80{% endif %}" 
                                   id="Rubro" 
                                   name="Rubro" 
                                   value="{{ form_data.Rubro or '' }}" 
                                   {% if not is_new_bien_mode %}disabled{% endif %}
                                   placeholder="Rubro contable">
                        </div>

                        <!-- Proveedor -->
                        <div>
                            <label for="Proveedor" class="block text-sm font-semibold text-gray-700 mb-2">Proveedor</label>
                            <input type="text" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 {% if not is_new_bien_mode %}bg-gray-100 text-gray-500 cursor-not-allowed{% else %}bg-white/80{% endif %}" 
                                   id="Proveedor" 
                                   name="Proveedor" 
                                   value="{{ form_data.Proveedor or '' }}" 
                                   {% if not is_new_bien_mode %}disabled{% endif %}
                                   placeholder="Nombre del proveedor">
                        </div>
                    </div>
                </div>

                <!-- SECCIÓN: INFORMACIÓN ADICIONAL DEL BIEN -->
                <div class="mb-8">
                    <div class="flex items-center mb-6">
                        <div class="w-8 h-8 bg-burgundy rounded-full flex items-center justify-center mr-3">
                            <i class="fas fa-file-alt text-white text-sm"></i>
                        </div>
                        <h2 class="text-xl font-bold text-burgundy">Información Adicional del Bien</h2>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Documento de Propiedad -->
                        <div>
                            <label for="Documento_Propiedad" class="block text-sm font-semibold text-gray-700 mb-2">Documento de Propiedad</label>
                            <input type="text" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 {% if not is_new_bien_mode %}bg-gray-100 text-gray-500 cursor-not-allowed{% else %}bg-white/80{% endif %}" 
                                   id="Documento_Propiedad" 
                                   name="Documento_Propiedad" 
                                   value="{{ form_data.Documento_Propiedad or '' }}" 
                                   {% if not is_new_bien_mode %}disabled{% endif %}
                                   placeholder="Documento de propiedad">
                        </div>

                        <!-- Fecha Documento Propiedad -->
                        <div>
                            <label for="Fecha_Documento_Propiedad" class="block text-sm font-semibold text-gray-700 mb-2">Fecha del Documento</label>
                            <input type="date" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 {% if not is_new_bien_mode %}bg-gray-100 text-gray-500 cursor-not-allowed{% else %}bg-white/80{% endif %}" 
                                   id="Fecha_Documento_Propiedad" 
                                   name="Fecha_Documento_Propiedad" 
                                   value="{{ form_data.Fecha_Documento_Propiedad or '' }}" 
                                   {% if not is_new_bien_mode %}disabled{% endif %}>
                        </div>

                        <!-- Fecha Adquisición/Alta -->
                        <div>
                            <label for="Fecha_Adquisicion_Alta" class="block text-sm font-semibold text-gray-700 mb-2">Fecha de Adquisición/Alta</label>
                            <input type="date" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 {% if not is_new_bien_mode %}bg-gray-100 text-gray-500 cursor-not-allowed{% else %}bg-white/80{% endif %}" 
                                   id="Fecha_Adquisicion_Alta" 
                                   name="Fecha_Adquisicion_Alta" 
                                   value="{{ form_data.Fecha_Adquisicion_Alta or '' }}" 
                                   {% if not is_new_bien_mode %}disabled{% endif %}>
                        </div>
                    </div>
                </div>

                <!-- SECCIÓN: DATOS DEL RESGUARDO -->
                <div class="mb-8">
                    <div class="flex items-center mb-6">
                        <div class="w-8 h-8 bg-burgundy rounded-full flex items-center justify-center mr-3">
                            <i class="fas fa-user-shield text-white text-sm"></i>
                        </div>
                        <h2 class="text-xl font-bold text-burgundy">Datos del Resguardo</h2>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Área -->
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <label for="Area" class="block text-sm font-semibold text-gray-700 flex items-center">
                                    <i class="fas fa-building text-burgundy mr-2 text-xs"></i>
                                    Área *
                                </label>
                                <div class="flex items-center gap-2">
                                    <button type="button" id="refresh-areas-btn" class="p-1 rounded-full hover:bg-gray-200 text-burgundy hover:text-burgundy-dark transition-colors" title="Actualizar Lista">
                                        <i class="fas fa-sync-alt text-sm"></i>
                                    </button>
                                    <a href="{{ url_for('areas.manage_areas') }}" target="_blank" class="p-1 rounded-full hover:bg-gray-200 text-burgundy hover:text-burgundy-dark transition-colors" title="Gestionar Áreas">
                                        <i class="fas fa-external-link-alt text-sm"></i>
                                    </a>
                                </div>
                            </div>
                            <select id="Area" name="Area" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 bg-white/80" required>
                                <option value="">Selecciona un área</option>
                                {% for area in areas %}
                                    <option value="{{ area.id }}" {% if form_data.Area_id == area.id %}selected{% endif %}>{{ area.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- No. Resguardo -->
                        <div>
                            <label for="No_Resguardo" class="block text-sm font-semibold text-gray-700 mb-2 flex items-center">
                                <i class="fas fa-file-alt text-burgundy mr-2 text-xs"></i>
                                No. de Resguardo
                            </label>
                            <input type="text" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 bg-white/80" 
                                   id="No_Resguardo" 
                                   name="No_Resguardo" 
                                   value="{{ form_data.No_Resguardo or '' }}" 
                                   placeholder="Número de resguardo">
                        </div>

                        <!-- Ubicación -->
                        <div>
                            <label for="Ubicacion" class="block text-sm font-semibold text-gray-700 mb-2 flex items-center">
                                <i class="fas fa-map-marker-alt text-burgundy mr-2 text-xs"></i>
                                Ubicación Física
                            </label>
                            <input type="text" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 bg-white/80" 
                                   id="Ubicacion" 
                                   name="Ubicacion" 
                                   value="{{ form_data.Ubicacion or '' }}" 
                                   placeholder="Ubicación física del bien">
                        </div>

                        <!-- Nombre Resguardante -->
                        <div>
                            <label for="Nombre_Del_Resguardante" class="block text-sm font-semibold text-gray-700 mb-2 flex items-center">
                                <i class="fas fa-user text-burgundy mr-2 text-xs"></i>
                                Nombre del Resguardante
                            </label>
                            <input type="text" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 bg-white/80" 
                                   id="Nombre_Del_Resguardante" 
                                   name="Nombre_Del_Resguardante" 
                                   value="{{ form_data.Nombre_Del_Resguardante or '' }}" 
                                   placeholder="Nombre completo del resguardante">
                        </div>

                        <!-- Puesto -->
                        <div>
                            <label for="Puesto_Trabajador" class="block text-sm font-semibold text-gray-700 mb-2 flex items-center">
                                <i class="fas fa-briefcase text-burgundy mr-2 text-xs"></i>
                                Puesto del Resguardante
                            </label>
                            <input type="text" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 bg-white/80" 
                                   id="Puesto_Trabajador" 
                                   name="Puesto_Trabajador" 
                                   value="{{ form_data.Puesto_Trabajador or '' }}" 
                                   placeholder="Puesto del resguardante">
                        </div>

                        <!-- RFC -->
                        <div>
                            <label for="RFC_Trabajador" class="block text-sm font-semibold text-gray-700 mb-2 flex items-center">
                                <i class="fas fa-id-card text-burgundy mr-2 text-xs"></i>
                                RFC del Resguardante
                            </label>
                            <input type="text" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 bg-white/80" 
                                   id="RFC_Trabajador" 
                                   name="RFC_Trabajador" 
                                   value="{{ form_data.RFC_Trabajador or '' }}" 
                                   maxlength="13"
                                   placeholder="RFC del resguardante">
                        </div>

                        <!-- No. Trabajador -->
                        <div>
                            <label for="No_Trabajador" class="block text-sm font-semibold text-gray-700 mb-2 flex items-center">
                                <i class="fas fa-id-badge text-burgundy mr-2 text-xs"></i>
                                No. de Trabajador
                            </label>
                            <input type="text" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 bg-white/80" 
                                   id="No_Trabajador" 
                                   name="No_Trabajador" 
                                   value="{{ form_data.No_Trabajador or '' }}" 
                                   placeholder="Número de trabajador">
                        </div>

                        <!-- No. Nómina -->
                        <div>
                            <label for="No_Nomina_Trabajador" class="block text-sm font-semibold text-gray-700 mb-2 flex items-center">
                                <i class="fas fa-money-check text-burgundy mr-2 text-xs"></i>
                                No. de Nómina
                            </label>
                            <input type="number" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 bg-white/80" 
                                   id="No_Nomina_Trabajador" 
                                   name="No_Nomina_Trabajador" 
                                   value="{{ form_data.No_Nomina_Trabajador or '' }}" 
                                   placeholder="Número de nómina">
                        </div>

                        <!-- Fecha Resguardo -->
                        <div>
                            <label for="Fecha_Resguardo" class="block text-sm font-semibold text-gray-700 mb-2 flex items-center">
                                <i class="fas fa-calendar-alt text-burgundy mr-2 text-xs"></i>
                                Fecha de Resguardo
                            </label>
                            <input type="date" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 bg-white/80" 
                                   id="Fecha_Resguardo" 
                                   name="Fecha_Resguardo" 
                                   value="{{ form_data.Fecha_Resguardo or '' }}">
                        </div>

                        <!-- Nombre Director/Jefe -->
                        <div class="md:col-span-2">
                            <label for="Nombre_Director_Jefe_De_Area" class="block text-sm font-semibold text-gray-700 mb-2 flex items-center">
                                <i class="fas fa-user-tie text-burgundy mr-2 text-xs"></i>
                                Nombre Director/Jefe de Área
                            </label>
                            <input type="text" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 bg-white/80" 
                                   id="Nombre_Director_Jefe_De_Area" 
                                   name="Nombre_Director_Jefe_De_Area" 
                                   value="{{ form_data.Nombre_Director_Jefe_De_Area or '' }}" 
                                   placeholder="Nombre del director o jefe de área">
                        </div>

                        <!-- Tipo de Resguardo -->
                        <div>
                            <label for="Tipo_De_Resguardo" class="block text-sm font-semibold text-gray-700 mb-2 flex items-center">
                                <i class="fas fa-shield-alt text-burgundy mr-2 text-xs"></i>
                                Tipo de Resguardo
                            </label>
                            <select id="Tipo_De_Resguardo" name="Tipo_De_Resguardo" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 bg-white/80">
                                <option value="0" {% if form_data.Tipo_De_Resguardo == 0 %}selected{% endif %}>Resguardo Normal</option>
                                <option value="1" {% if form_data.Tipo_De_Resguardo == 1 %}selected{% endif %}>Sujeto de Control</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- SECCIÓN: IMÁGENES -->
                <div class="mb-8">
                    <div class="flex items-center mb-6">
                        <div class="w-8 h-8 bg-burgundy rounded-full flex items-center justify-center mr-3">
                            <i class="fas fa-images text-white text-sm"></i>
                        </div>
                        <h2 class="text-xl font-bold text-burgundy">Imágenes</h2>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Imágenes del Bien -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center">
                                <i class="fas fa-box text-burgundy mr-2"></i>
                                Imágenes del Bien
                            </label>
                            <input type="file" 
                                   id="imagenes_bien" 
                                   name="imagenes_bien" 
                                   multiple 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 bg-white/80 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-burgundy file:text-white hover:file:bg-burgundy-dark"
                                   accept="image/*"
                                   {% if not is_new_bien_mode %}disabled{% endif %}>
                            <div id="preview_imagenes_bien" class="mt-4 flex flex-wrap gap-2 min-h-[6rem] bg-gray-50 p-2 rounded border">
                                {% if imagenes_bien_db %}
                                    {% for img in imagenes_bien_db %}
                                    <div class="relative inline-block" id="imagen-bien-{{ img.id }}">
                                        <img src="{{ url_for('bienes.serve_uploaded_file', filename=img.ruta_imagen) }}" class="h-24 w-24 object-cover rounded-md border">
                                        {% if is_edit %}
                                        <button type="button" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center shadow-lg hover:bg-red-700 transition-colors duration-200" title="Marcar para eliminar" onclick="marcarParaEliminar(this, 'eliminar_imagen_bien[]', '{{ img.id }}')">
                                            <i class="fas fa-times text-xs"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>

                        <!-- Imágenes del Resguardo -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center">
                                <i class="fas fa-file-contract text-burgundy mr-2"></i>
                                Imágenes del Resguardo
                            </label>
                            <input type="file" 
                                   id="imagenes_resguardo" 
                                   name="imagenes_resguardo" 
                                   multiple 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 bg-white/80 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-burgundy file:text-white hover:file:bg-burgundy-dark"
                                   accept="image/*">
                            <div id="preview_imagenes_resguardo" class="mt-4 flex flex-wrap gap-2 min-h-[6rem] bg-gray-50 p-2 rounded border">
                                {% if imagenes_resguardo_db %}
                                    {% for img in imagenes_resguardo_db %}
                                    <div class="relative inline-block" id="imagen-resguardo-{{ img.id }}">
                                        <img src="{{ url_for('bienes.serve_uploaded_file', filename=img.ruta_imagen) }}" class="h-24 w-24 object-cover rounded-md border">
                                        {% if is_edit %}
                                        <button type="button" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center shadow-lg hover:bg-red-700 transition-colors duration-200" title="Marcar para eliminar" onclick="marcarParaEliminar(this, 'eliminar_imagen_resguardo[]', '{{ img.id }}')">
                                            <i class="fas fa-times text-xs"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Botones de Acción -->
                <div class="flex flex-col sm:flex-row justify-end gap-4 pt-6 border-t border-gray-200">
                    <a href="{{ url_for('resguardos.ver_resguardos') }}" 
                       class="inline-flex items-center justify-center px-6 py-3 border-2 border-gray-300 text-base font-semibold rounded-xl text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-all duration-200 ease-in-out order-2 sm:order-1">
                        <i class="fas fa-times mr-2"></i> Cancelar
                    </a>
                    <button type="submit" 
                            class="inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-semibold rounded-xl shadow-sm text-white bg-gradient-to-r from-burgundy to-burgundy-dark hover:from-burgundy-dark hover:to-burgundy focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-burgundy transition-all duration-200 ease-in-out order-1 sm:order-2">
                        <i class="fas fa-save mr-2"></i>
                        {% if is_edit %}
                            Guardar Cambios
                        {% else %}
                            Guardar Resguardo
                        {% endif %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
    .bg-burgundy { background-color: #6A2E4D; }
    .bg-burgundy-dark { background-color: #551E3A; }
    .text-burgundy { color: #6A2E4D; }
    .border-burgundy { border-color: #6A2E4D; }
    .focus\:ring-burgundy\/50:focus { --tw-ring-color: rgb(106 46 77 / 0.5); }
    .focus\:border-burgundy:focus { border-color: #6A2E4D; }
    
    .bg-beige { background-color: #BC9B6A; }
    .bg-beige-light { background-color: #D7C3A0; }
    .text-beige-light { color: #D7C3A0; }
    .border-beige { border-color: #BC9B6A; }
    .border-beige-light { border-color: #D7C3A0; }
    
    .from-burgundy { --tw-gradient-from: #6A2E4D; --tw-gradient-to: rgb(106 46 77 / 0); --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to); }
    .to-burgundy-dark { --tw-gradient-to: #551E3A; }
    
    input:focus, select:focus, textarea:focus {
        outline: none;
        box-shadow: 0 0 0 2px rgb(106 46 77 / 0.1);
    }
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('resguardoForm');
    
    // JS para actualizar áreas
    const refreshAreasBtn = document.getElementById('refresh-areas-btn');
    const areaSelect = document.getElementById('Area');
    const originalIcon = refreshAreasBtn.innerHTML;
    const spinnerIcon = '<i class="fas fa-spinner fa-spin"></i>';

    refreshAreasBtn.addEventListener('click', async () => {
        refreshAreasBtn.innerHTML = spinnerIcon;
        refreshAreasBtn.disabled = true;
        try {
            const response = await fetch("{{ url_for('resguardos.get_areas_api') }}");
            if (!response.ok) throw new Error('Error al cargar las áreas.');
            const areas = await response.json();
            const selectedValue = areaSelect.value;
            areaSelect.innerHTML = '<option value="">Selecciona un área</option>';
            areas.forEach(area => {
                const option = document.createElement('option');
                option.value = area.id;
                option.textContent = area.nombre;
                areaSelect.appendChild(option);
            });
            areaSelect.value = selectedValue;
        } catch (error) {
            console.error('Error:', error);
            alert('No se pudo actualizar la lista de áreas.');
        } finally {
            refreshAreasBtn.innerHTML = originalIcon;
            refreshAreasBtn.disabled = false;
        }
    });

    // JS para manejo de imágenes
    window.marcarParaEliminar = function(btn, inputName, imageId) {
        if (confirm('¿Estás seguro de que quieres marcar esta imagen para eliminar? La eliminación será permanente al guardar.')) {
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = inputName;
            hiddenInput.value = imageId;
            form.appendChild(hiddenInput);
            btn.parentElement.style.display = 'none';
        }
    }

    function setupImageManager(inputId, previewId) {
        const inputElement = document.getElementById(inputId);
        const previewContainer = document.getElementById(previewId);
        
        if (!inputElement) return;

        let fileStore = [];
        inputElement.addEventListener('change', (event) => {
            fileStore.push(...Array.from(event.target.files));
            sincronizarInput();
            renderizarPreview();
        });

        function renderizarPreview() {
            previewContainer.querySelectorAll('.preview-nueva').forEach(el => el.remove());
            fileStore.forEach((file) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const contenedor = document.createElement('div');
                    contenedor.className = "relative inline-block preview-nueva";
                    
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = "h-24 w-24 object-cover rounded border";
                    
                    const btn = document.createElement('button');
                    btn.type = "button";
                    btn.innerHTML = '&times;';
                    btn.className = "absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center shadow-lg hover:bg-red-700 transition-colors duration-200";
                    btn.title = "Quitar esta imagen";
                    
                    btn.onclick = () => {
                        fileStore = fileStore.filter(f => f !== file);
                        sincronizarInput();
                        renderizarPreview();
                    };
                    
                    contenedor.appendChild(img);
                    contenedor.appendChild(btn);
                    previewContainer.prepend(contenedor);
                };
                reader.readAsDataURL(file);
            });
        }

        function sincronizarInput() {
            const dataTransfer = new DataTransfer();
            fileStore.forEach(file => dataTransfer.items.add(file));
            inputElement.files = dataTransfer.files;
        }
    }

    setupImageManager('imagenes_bien', 'preview_imagenes_bien');
    setupImageManager('imagenes_resguardo', 'preview_imagenes_resguardo');
});
</script>
{% endblock %}
