{% extends "base.html" %}

{% block title %}
    {% if is_edit %}Editar Resguardo{% elif bien_precargado %}Crear Resguardo (Bien Existente){% else %}Crear Nuevo Bien y Resguardo{% endif %}
{% endblock %}

{% block content %}
<div class="page-wrapper">
    <div class="container-limit">
        
        <div class="header-card">
            <div class="header-text">
                <h1>
                    {% if is_edit %}
                        Editar Resguardo
                    {% elif bien_precargado %}
                        Resguardo para Bien Existente
                    {% else %}
                        Nuevo Bien y Resguardo
                    {% endif %}
                </h1>
                <p>
                    {% if is_edit %}
                        Modifique la información del resguardo y del bien asociado.
                    {% elif bien_precargado %}
                        Complete los datos del resguardo para el bien seleccionado.
                    {% else %}
                        Complete la información para registrar el bien y asignar su resguardo.
                    {% endif %}
                </p>
            </div>
            <div class="header-icon-box">
                <i class="fas fa-file-contract"></i>
            </div>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-wrapper">
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">
                        <i class="fas fa-info-circle"></i> {{ message }}
                    </div>
                {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <div class="form-card">
            <form id="resguardoForm" 
                  action="{{ url_for('resguardos.editar_resguardo', id_resguardo=form_data.resguardo_id) if is_edit else url_for('resguardos.crear_resguardo') }}" 
                  method="post" 
                  enctype="multipart/form-data">

                {% set is_new_bien_mode = not is_edit and not bien_precargado %}
                
                {% if is_edit %}
                    <input type="hidden" name="id_bien" value="{{ form_data.bien_id }}">
                {% elif bien_precargado %}
                    <input type="hidden" name="id_bien_existente" value="{{ form_data.id }}">
                {% endif %}

                <div class="form-section">
                    <div class="section-header">
                        <div class="section-icon"><i class="fas fa-box"></i></div>
                        <h2>Información General del Bien</h2>
                    </div>

                    <div class="form-grid-3">
                        <div class="form-group">
                            <label for="No_Inventario"><i class="fas fa-hashtag icon-label"></i> No. de Inventario *</label>
                            <input type="text" id="No_Inventario" name="No_Inventario" 
                                   value="{{ form_data.No_Inventario or '' }}" 
                                   {% if not is_new_bien_mode %}disabled class="input-disabled"{% endif %} 
                                   required placeholder="Ingrese el número">
                        </div>

                        <div class="form-group">
                            <label for="Cantidad"><i class="fas fa-cubes icon-label"></i> Cantidad *</label>
                            <input type="number" id="Cantidad" name="Cantidad" 
                                   value="{{ form_data.Cantidad or '1' }}" min="1" 
                                   {% if not is_new_bien_mode %}disabled class="input-disabled"{% endif %} 
                                   required>
                        </div>

                        <div class="form-group">
                            <label for="Descripcion_Corta_Del_Bien"><i class="fas fa-align-left icon-label"></i> Descripción Corta</label>
                            <input type="text" id="Descripcion_Corta_Del_Bien" name="Descripcion_Corta_Del_Bien" 
                                   value="{{ form_data.Descripcion_Corta_Del_Bien or '' }}" 
                                   {% if not is_new_bien_mode %}disabled class="input-disabled"{% endif %}>
                        </div>

                        <div class="form-group">
                            <label for="Marca"><i class="fas fa-tag icon-label"></i> Marca</label>
                            <input type="text" id="Marca" name="Marca" 
                                   value="{{ form_data.Marca or '' }}" 
                                   {% if not is_new_bien_mode %}disabled class="input-disabled"{% endif %}>
                        </div>

                        <div class="form-group">
                            <label for="Modelo"><i class="fas fa-cube icon-label"></i> Modelo</label>
                            <input type="text" id="Modelo" name="Modelo" 
                                   value="{{ form_data.Modelo or '' }}" 
                                   {% if not is_new_bien_mode %}disabled class="input-disabled"{% endif %}>
                        </div>

                        <div class="form-group">
                            <label for="Numero_De_Serie"><i class="fas fa-barcode icon-label"></i> Número de Serie</label>
                            <input type="text" id="Numero_De_Serie" name="Numero_De_Serie" 
                                   value="{{ form_data.Numero_De_Serie or '' }}" 
                                   {% if not is_new_bien_mode %}disabled class="input-disabled"{% endif %}>
                        </div>

                        <div class="form-group">
                            <label for="Estado_Del_Bien"><i class="fas fa-clipboard-check icon-label"></i> Estado</label>
                            <select id="Estado_Del_Bien" name="Estado_Del_Bien" {% if not is_new_bien_mode %}disabled class="input-disabled"{% endif %}>
                                <option value="" disabled selected>Seleccione...</option>
                                <option value="Nuevo" {% if form_data.Estado_Del_Bien == 'Nuevo' %}selected{% endif %}>Nuevo</option>
                                <option value="Bueno" {% if form_data.Estado_Del_Bien == 'Bueno' %}selected{% endif %}>Bueno</option>
                                <option value="Regular" {% if form_data.Estado_Del_Bien == 'Regular' %}selected{% endif %}>Regular</option>
                                <option value="Malo" {% if form_data.Estado_Del_Bien == 'Malo' %}selected{% endif %}>Malo</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="Tipo_De_Alta"><i class="fas fa-sign-in-alt icon-label"></i> Tipo de Alta *</label>
                            <select id="Tipo_De_Alta" name="Tipo_De_Alta" required {% if not is_new_bien_mode %}disabled class="input-disabled"{% endif %}>
                                <option value="" disabled selected>Seleccione...</option>
                                <option value="Compra" {% if form_data.Tipo_De_Alta == 'Compra' %}selected{% endif %}>Compra</option>
                                <option value="Donacion" {% if form_data.Tipo_De_Alta == 'Donacion' %}selected{% endif %}>Donación</option>
                                <option value="Comodato" {% if form_data.Tipo_De_Alta == 'Comodato' %}selected{% endif %}>Comodato</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="Clasificacion_Legal"><i class="fas fa-balance-scale icon-label"></i> Clasificación Legal *</label>
                            <select id="Clasificacion_Legal" name="Clasificacion_Legal" required {% if not is_new_bien_mode %}disabled class="input-disabled"{% endif %}>
                                <option value="" disabled selected>Seleccione...</option>
                                <option value="Dominio Público" {% if form_data.Clasificacion_Legal == 'Dominio Público' %}selected{% endif %}>Dominio Público</option>
                                <option value="Dominio Privado" {% if form_data.Clasificacion_Legal == 'Dominio Privado' %}selected{% endif %}>Dominio Privado</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="Area_Presupuestal"><i class="fas fa-chart-pie icon-label"></i> Área Presupuestal</label>
                            <input type="text" id="Area_Presupuestal" name="Area_Presupuestal" 
                                   value="{{ form_data.Area_Presupuestal or '' }}" 
                                   {% if not is_new_bien_mode %}disabled class="input-disabled"{% endif %}>
                        </div>
                    </div>

                    <div class="form-group mt-3">
                        <label for="Descripcion_Del_Bien"><i class="fas fa-align-left icon-label"></i> Descripción Completa</label>
                        <textarea id="Descripcion_Del_Bien" name="Descripcion_Del_Bien" rows="3" 
                                  {% if not is_new_bien_mode %}disabled class="input-disabled"{% endif %}>{{ form_data.Descripcion_Del_Bien or '' }}</textarea>
                    </div>
                </div>

                <div class="form-section">
                    <div class="section-header">
                        <div class="section-icon"><i class="fas fa-dollar-sign"></i></div>
                        <h2>Datos Financieros</h2>
                    </div>
                    <div class="form-grid-3">
                        <div class="form-group">
                            <label for="No_Factura">No. de Factura</label>
                            <input type="text" id="No_Factura" name="No_Factura" value="{{ form_data.No_Factura or '' }}" {% if not is_new_bien_mode %}disabled class="input-disabled"{% endif %}>
                        </div>
                        <div class="form-group">
                            <label for="Fecha_Factura">Fecha de Factura</label>
                            <input type="date" id="Fecha_Factura" name="Fecha_Factura" value="{{ form_data.Fecha_Factura or '' }}" {% if not is_new_bien_mode %}disabled class="input-disabled"{% endif %}>
                        </div>
                        <div class="form-group">
                            <label for="Costo_Inicial">Costo Inicial</label>
                            <input type="number" step="0.01" id="Costo_Inicial" name="Costo_Inicial" value="{{ form_data.Costo_Inicial or '' }}" placeholder="0.00" {% if not is_new_bien_mode %}disabled class="input-disabled"{% endif %}>
                        </div>
                        <div class="form-group">
                            <label for="Depreciacion_Acumulada">Depreciación Acum.</label>
                            <input type="number" step="0.01" id="Depreciacion_Acumulada" name="Depreciacion_Acumulada" value="{{ form_data.Depreciacion_Acumulada or '' }}" placeholder="0.00" {% if not is_new_bien_mode %}disabled class="input-disabled"{% endif %}>
                        </div>
                        <div class="form-group">
                            <label for="Costo_Final">Costo Final</label>
                            <input type="number" step="0.01" id="Costo_Final" name="Costo_Final" value="{{ form_data.Costo_Final or '' }}" placeholder="0.00" {% if not is_new_bien_mode %}disabled class="input-disabled"{% endif %}>
                        </div>
                        <div class="form-group">
                            <label for="Valor_En_Libros">Valor en Libros</label>
                            <input type="number" step="0.01" id="Valor_En_Libros" name="Valor_En_Libros" value="{{ form_data.Valor_En_Libros or '' }}" placeholder="0.00" {% if not is_new_bien_mode %}disabled class="input-disabled"{% endif %}>
                        </div>
                        <div class="form-group">
                            <label for="Poliza">Póliza</label>
                            <input type="text" id="Poliza" name="Poliza" value="{{ form_data.Poliza or '' }}" {% if not is_new_bien_mode %}disabled class="input-disabled"{% endif %}>
                        </div>
                        <div class="form-group">
                            <label for="Fecha_Poliza">Fecha de Póliza</label>
                            <input type="date" id="Fecha_Poliza" name="Fecha_Poliza" value="{{ form_data.Fecha_Poliza or '' }}" {% if not is_new_bien_mode %}disabled class="input-disabled"{% endif %}>
                        </div>
                        <div class="form-group">
                            <label for="No_Cuenta">No. de Cuenta</label>
                            <input type="text" id="No_Cuenta" name="No_Cuenta" value="{{ form_data.No_Cuenta or '' }}" {% if not is_new_bien_mode %}disabled class="input-disabled"{% endif %}>
                        </div>
                        <div class="form-group">
                            <label for="Sub_Cuenta_Armonizadora">Subcuenta Arm.</label>
                            <input type="text" id="Sub_Cuenta_Armonizadora" name="Sub_Cuenta_Armonizadora" value="{{ form_data.Sub_Cuenta_Armonizadora or '' }}" {% if not is_new_bien_mode %}disabled class="input-disabled"{% endif %}>
                        </div>
                        <div class="form-group">
                            <label for="Rubro">Rubro</label>
                            <input type="text" id="Rubro" name="Rubro" value="{{ form_data.Rubro or '' }}" {% if not is_new_bien_mode %}disabled class="input-disabled"{% endif %}>
                        </div>
                        <div class="form-group">
                            <label for="Proveedor">Proveedor</label>
                            <input type="text" id="Proveedor" name="Proveedor" value="{{ form_data.Proveedor or '' }}" {% if not is_new_bien_mode %}disabled class="input-disabled"{% endif %}>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="section-header">
                        <div class="section-icon"><i class="fas fa-file-alt"></i></div>
                        <h2>Información Adicional</h2>
                    </div>
                    <div class="form-grid-3">
                        <div class="form-group">
                            <label for="Documento_Propiedad">Documento Propiedad</label>
                            <input type="text" id="Documento_Propiedad" name="Documento_Propiedad" value="{{ form_data.Documento_Propiedad or '' }}" {% if not is_new_bien_mode %}disabled class="input-disabled"{% endif %}>
                        </div>
                        <div class="form-group">
                            <label for="Fecha_Documento_Propiedad">Fecha Documento</label>
                            <input type="date" id="Fecha_Documento_Propiedad" name="Fecha_Documento_Propiedad" value="{{ form_data.Fecha_Documento_Propiedad or '' }}" {% if not is_new_bien_mode %}disabled class="input-disabled"{% endif %}>
                        </div>
                        <div class="form-group">
                            <label for="Fecha_Adquisicion_Alta">Fecha Adquisición</label>
                            <input type="date" id="Fecha_Adquisicion_Alta" name="Fecha_Adquisicion_Alta" value="{{ form_data.Fecha_Adquisicion_Alta or '' }}" {% if not is_new_bien_mode %}disabled class="input-disabled"{% endif %}>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="section-header">
                        <div class="section-icon"><i class="fas fa-user-shield"></i></div>
                        <h2>Datos del Resguardo</h2>
                    </div>
                    <div class="form-grid-3">
                        <div class="form-group">
                            <div class="label-with-action">
                                <label for="Area"><i class="fas fa-building icon-label"></i> Área *</label>
                                <div class="action-links">
                                    <button type="button" id="refresh-areas-btn" class="btn-icon-small" title="Actualizar Lista"><i class="fas fa-sync-alt"></i></button>
                                    <a href="{{ url_for('areas.manage_areas') }}" target="_blank" class="btn-icon-small" title="Gestionar Áreas"><i class="fas fa-external-link-alt"></i></a>
                                </div>
                            </div>
                            <select id="Area" name="Area" required>
                                <option value="">Selecciona un área</option>
                                {% for area in areas %}
                                    <option value="{{ area.id }}" {% if form_data.Area_id == area.id %}selected{% endif %}>{{ area.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="No_Resguardo"><i class="fas fa-file-alt icon-label"></i> No. de Resguardo</label>
                            <input type="text" id="No_Resguardo" name="No_Resguardo" value="{{ form_data.No_Resguardo or '' }}">
                        </div>
                        <div class="form-group">
                            <label for="Ubicacion"><i class="fas fa-map-marker-alt icon-label"></i> Ubicación Física</label>
                            <input type="text" id="Ubicacion" name="Ubicacion" value="{{ form_data.Ubicacion or '' }}">
                        </div>
                        <div class="form-group">
                            <label for="Nombre_Del_Resguardante"><i class="fas fa-user icon-label"></i> Nombre Resguardante</label>
                            <input type="text" id="Nombre_Del_Resguardante" name="Nombre_Del_Resguardante" value="{{ form_data.Nombre_Del_Resguardante or '' }}">
                        </div>
                        <div class="form-group">
                            <label for="Puesto_Trabajador"><i class="fas fa-briefcase icon-label"></i> Puesto</label>
                            <input type="text" id="Puesto_Trabajador" name="Puesto_Trabajador" value="{{ form_data.Puesto_Trabajador or '' }}">
                        </div>
                        <div class="form-group">
                            <label for="RFC_Trabajador"><i class="fas fa-id-card icon-label"></i> RFC</label>
                            <input type="text" id="RFC_Trabajador" name="RFC_Trabajador" value="{{ form_data.RFC_Trabajador or '' }}" maxlength="13">
                        </div>
                        <div class="form-group">
                            <label for="No_Trabajador"><i class="fas fa-id-badge icon-label"></i> No. Trabajador</label>
                            <input type="text" id="No_Trabajador" name="No_Trabajador" value="{{ form_data.No_Trabajador or '' }}">
                        </div>
                        <div class="form-group">
                            <label for="No_Nomina_Trabajador"><i class="fas fa-money-check icon-label"></i> No. Nómina</label>
                            <input type="number" id="No_Nomina_Trabajador" name="No_Nomina_Trabajador" value="{{ form_data.No_Nomina_Trabajador or '' }}">
                        </div>
                        <div class="form-group">
                            <label for="Fecha_Resguardo"><i class="fas fa-calendar-alt icon-label"></i> Fecha Resguardo</label>
                            <input type="date" id="Fecha_Resguardo" name="Fecha_Resguardo" value="{{ form_data.Fecha_Resguardo or '' }}">
                        </div>
                        <div class="form-group full-width">
                            <label for="Nombre_Director_Jefe_De_Area"><i class="fas fa-user-tie icon-label"></i> Nombre Director/Jefe de Área</label>
                            <input type="text" id="Nombre_Director_Jefe_De_Area" name="Nombre_Director_Jefe_De_Area" value="{{ form_data.Nombre_Director_Jefe_De_Area or '' }}">
                        </div>
                        <div class="form-group">
                            <label for="Tipo_De_Resguardo"><i class="fas fa-shield-alt icon-label"></i> Tipo de Resguardo</label>
                            <select id="Tipo_De_Resguardo" name="Tipo_De_Resguardo">
                                <option value="0" {% if form_data.Tipo_De_Resguardo == 0 %}selected{% endif %}>Resguardo Normal</option>
                                <option value="1" {% if form_data.Tipo_De_Resguardo == 1 %}selected{% endif %}>Sujeto de Control</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="section-header">
                        <div class="section-icon"><i class="fas fa-images"></i></div>
                        <h2>Imágenes</h2>
                    </div>
                    
                    <div class="form-grid-2">
                        <div class="upload-wrapper">
                            <label class="upload-title"><i class="fas fa-box"></i> Imágenes del Bien</label>
                            <div class="upload-container">
                                <input type="file" id="imagenes_bien" name="imagenes_bien" multiple accept="image/*"
                                       {% if not is_new_bien_mode %}disabled hidden{% endif %}>
                                {% if not is_new_bien_mode %}<p class="help-text">Modificar en editar bien</p>{% endif %}
                            </div>
                            
                            <div id="preview_imagenes_bien" class="preview-grid">
                                {% if imagenes_bien_db %}
                                    {% for img in imagenes_bien_db %}
                                    <div class="preview-item" id="imagen-bien-{{ img.id }}">
                                        <img src="{{ url_for('serve_uploaded_file', filename=img.ruta_imagen) }}">
                                        {% if is_edit %}
                                        <button type="button" class="btn-delete-img" onclick="marcarParaEliminar(this, 'eliminar_imagen_bien[]', '{{ img.id }}')">
                                            <i class="fas fa-times"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>

                        <div class="upload-wrapper">
                            <label class="upload-title"><i class="fas fa-file-contract"></i> Imágenes del Resguardo</label>
                            <div class="upload-container">
                                <input type="file" id="imagenes_resguardo" name="imagenes_resguardo" multiple accept="image/*">
                            </div>
                            
                            <div id="preview_imagenes_resguardo" class="preview-grid">
                                {% if imagenes_resguardo_db %}
                                    {% for img in imagenes_resguardo_db %}
                                    <div class="preview-item" id="imagen-resguardo-{{ img.id }}">
                                        <img src="{{ url_for('serve_uploaded_file', filename=img.ruta_imagen) }}">
                                        {% if is_edit %}
                                        <button type="button" class="btn-delete-img" onclick="marcarParaEliminar(this, 'eliminar_imagen_resguardo[]', '{{ img.id }}')">
                                            <i class="fas fa-times"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <a href="{{ url_for('resguardos.ver_resguardos') }}" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Cancelar
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i>
                        {% if is_edit %}Guardar Cambios{% else %}Guardar Resguardo{% endif %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
    /* VARIABLES (Se usan las mismas que en base.html, se pueden omitir si ya están allí) */
    :root {
        --col-burgundy: #6A2E4D;
        --col-burgundy-dark: #551E3A;
        --col-beige: #BC9B6A;
        --col-beige-light: #fdfbf7;
        --radius: 12px;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    /* Layout */
    .page-wrapper { min-height: 100vh; background: #f9fafb; padding: 2rem 1rem; }
    .container-limit { max-width: 1280px; margin: 0 auto; }

    /* Header */
    .header-card {
        background: linear-gradient(to right, var(--col-burgundy), var(--col-burgundy-dark));
        border-radius: var(--radius); padding: 1.5rem 2rem; color: white;
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 2rem; box-shadow: var(--shadow);
    }
    .header-text h1 { margin: 0; font-size: 1.5rem; }
    .header-text p { margin: 0.5rem 0 0; color: #e2e8f0; font-size: 0.9rem; }
    .header-icon-box {
        width: 48px; height: 48px; background: var(--col-beige); border-radius: 50%;
        display: flex; align-items: center; justify-content: center; color: var(--col-burgundy); font-size: 1.2rem;
    }

    /* Formulario */
    .form-card { background: white; border-radius: var(--radius); box-shadow: var(--shadow); padding: 2rem; border: 1px solid #e5e7eb; }
    .form-section { margin-bottom: 2.5rem; }
    .section-header { display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; border-bottom: 2px solid #f3f4f6; padding-bottom: 0.5rem; }
    .section-icon { width: 32px; height: 32px; background: var(--col-burgundy); border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; }
    .section-header h2 { color: var(--col-burgundy); font-size: 1.2rem; margin: 0; }

    /* Grids */
    .form-grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; }
    .form-grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1.5rem; }
    .full-width { grid-column: 1 / -1; }

    /* Inputs */
    .form-group { display: flex; flex-direction: column; gap: 0.5rem; }
    .form-group label { font-size: 0.9rem; font-weight: 600; color: #374151; }
    .icon-label { color: var(--col-burgundy); margin-right: 0.4rem; }
    input, select, textarea {
        width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px; font-size: 0.95rem;
    }
    input:focus, select:focus, textarea:focus { outline: none; border-color: var(--col-burgundy); box-shadow: 0 0 0 3px rgba(106, 46, 77, 0.1); }
    
    /* Input Deshabilitado */
    .input-disabled, input:disabled, select:disabled, textarea:disabled {
        background-color: #f3f4f6; color: #6b7280; cursor: not-allowed; border-color: #e5e7eb;
    }

    /* Botón especial Área */
    .label-with-action { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.2rem; }
    .action-links { display: flex; gap: 0.5rem; }
    .btn-icon-small {
        background: none; border: none; cursor: pointer; color: var(--col-burgundy); font-size: 0.9rem; padding: 0.2rem;
    }
    .btn-icon-small:hover { color: var(--col-burgundy-dark); transform: scale(1.1); }

    /* Upload e Imágenes */
    .upload-wrapper { border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; background: #fafafa; }
    .upload-title { display: block; margin-bottom: 1rem; color: var(--col-burgundy); }
    .upload-container input[type="file"] { border: none; padding: 0; }
    .preview-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 0.8rem; margin-top: 1rem; }
    .preview-item { position: relative; height: 80px; width: 80px; }
    .preview-item img { width: 100%; height: 100%; object-fit: cover; border-radius: 6px; border: 1px solid #ddd; }
    .btn-delete-img {
        position: absolute; top: -5px; right: -5px; background: #ef4444; color: white;
        width: 20px; height: 20px; border-radius: 50%; border: none; cursor: pointer;
        display: flex; align-items: center; justify-content: center; font-size: 0.7rem;
    }
    .help-text { font-size: 0.8rem; color: #888; font-style: italic; }

    /* Botones Acción */
    .form-actions { margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end; gap: 1rem; }
    .btn { padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem; border: none; cursor: pointer; transition: all 0.2s; }
    .btn-primary { background: linear-gradient(to right, var(--col-burgundy), var(--col-burgundy-dark)); color: white; }
    .btn-secondary { background: white; border: 1px solid #d1d5db; color: #374151; }
    .btn-primary:hover { opacity: 0.9; } .btn-secondary:hover { background: #f3f4f6; }
    
    /* Alertas */
    .flash-wrapper { margin-bottom: 1rem; }
    .alert { padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem; border-left: 4px solid; display: flex; align-items: center; gap: 0.5rem; }
    .alert-success { background: #ecfdf5; border-color: #10b981; color: #065f46; }
    .alert-danger { background: #fef2f2; border-color: #ef4444; color: #991b1b; }
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Variables ---
    const form = document.getElementById('resguardoForm');
    const submitButton = form.querySelector('button[type="submit"]');
    const submitButtonOriginalText = submitButton.innerHTML;
    const spinnerIcon = '<i class="fas fa-spinner fa-spin"></i>';

    // --- ACTUALIZAR ÁREAS ---
    const refreshAreasBtn = document.getElementById('refresh-areas-btn');
    const areaSelect = document.getElementById('Area');
    
    if(refreshAreasBtn) {
        const originalIcon = refreshAreasBtn.innerHTML;
        refreshAreasBtn.addEventListener('click', async () => {
            refreshAreasBtn.innerHTML = spinnerIcon;
            refreshAreasBtn.disabled = true;
            try {
                const response = await fetch("{{ url_for('resguardos.get_areas_api') }}");
                if (!response.ok) throw new Error('Error al cargar.');
                const areas = await response.json();
                const selectedValue = areaSelect.value;
                areaSelect.innerHTML = '<option value="">Selecciona un área</option>';
                areas.forEach(area => {
                    const option = document.createElement('option');
                    option.value = area.id;
                    option.textContent = area.nombre;
                    areaSelect.appendChild(option);
                });
                areaSelect.value = selectedValue;
            } catch (error) {
                console.error(error);
                alert('No se pudo actualizar la lista.');
            } finally {
                refreshAreasBtn.innerHTML = originalIcon;
                refreshAreasBtn.disabled = false;
            }
        });
    }

    // --- MANEJO DE IMÁGENES ---
    window.marcarParaEliminar = function(btn, inputName, imageId) {
        if (confirm('¿Eliminar esta imagen permanentemente al guardar?')) {
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = inputName;
            hiddenInput.value = imageId;
            form.appendChild(hiddenInput);
            // Ocultamos el contenedor padre .preview-item
            btn.closest('.preview-item').style.display = 'none';
        }
    }

    function setupImageManager(inputId, previewId) {
        const inputElement = document.getElementById(inputId);
        const previewContainer = document.getElementById(previewId);
        if (!inputElement) return;

        let fileStore = [];
        inputElement.addEventListener('change', (event) => {
            fileStore.push(...Array.from(event.target.files));
            sincronizarInput();
            renderizarPreview();
        });

        function renderizarPreview() {
            // Eliminar solo las nuevas (que no tengan ID de base de datos)
            previewContainer.querySelectorAll('.preview-new').forEach(el => el.remove());
            
            fileStore.forEach((file) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const div = document.createElement('div');
                    div.className = "preview-item preview-new"; // Clase CSS nueva
                    
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    
                    const btn = document.createElement('button');
                    btn.type = "button";
                    btn.className = "btn-delete-img"; // Clase CSS nueva
                    btn.innerHTML = '<i class="fas fa-times"></i>';
                    
                    btn.onclick = () => {
                        fileStore = fileStore.filter(f => f !== file);
                        sincronizarInput();
                        renderizarPreview();
                    };
                    
                    div.appendChild(img);
                    div.appendChild(btn);
                    previewContainer.prepend(div);
                };
                reader.readAsDataURL(file);
            });
        }

        function sincronizarInput() {
            const dataTransfer = new DataTransfer();
            fileStore.forEach(file => dataTransfer.items.add(file));
            inputElement.files = dataTransfer.files;
        }
    }

    setupImageManager('imagenes_bien', 'preview_imagenes_bien');
    setupImageManager('imagenes_resguardo', 'preview_imagenes_resguardo');

    // --- ENVÍO FORMULARIO ---
    form.addEventListener('submit', async (event) => {
        event.preventDefault();
        submitButton.disabled = true;
        submitButton.innerHTML = `${spinnerIcon} Guardando...`;

        const formData = new FormData(form);
        const disabledFields = form.querySelectorAll(':disabled');
        
        // Habilitar campos deshabilitados (excepto inputs de archivos ocultos)
        disabledFields.forEach(field => {
            if (!field.name || field.type === 'file') return;
            field.disabled = false;
            formData.set(field.name, field.value);
        });

        try {
            const response = await fetch(form.action, { method: 'POST', body: formData });
            const data = await response.json();

            if (response.ok) {
                window.location.href = data.redirect_url;
            } else {
                alert(`Error: ${data.message}`);
                submitButton.disabled = false;
                submitButton.innerHTML = submitButtonOriginalText;
            }
        } catch (error) {
            console.error(error);
            alert('Error de conexión.');
            submitButton.disabled = false;
            submitButton.innerHTML = submitButtonOriginalText;
        } finally {
            // Restaurar estado disabled
            disabledFields.forEach(field => {
                if (field.name && field.type !== 'file') field.disabled = true;
            });
        }
    });
});
</script>
{% endblock %}