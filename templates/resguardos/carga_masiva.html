{% extends "base.html" %}

{% block title %}Guía para Carga Masiva{% endblock %}

{% block content %}
<div class="page-wrapper">
    <div class="container-limit">
        
        <div class="header-card">
            <div class="header-text">
                <h1>Guía para Carga Masiva con Excel</h1>
                <p>Sigue estas instrucciones para asegurar una importación de datos exitosa.</p>
            </div>
            <div class="header-icon-box">
                <i class="fas fa-file-excel"></i>
            </div>
        </div>

        <div class="card">
            
            <div class="section mb-4">
                <div class="section-header">
                    <div class="section-icon"><i class="fas fa-info-circle"></i></div>
                    <h2>Instrucciones Generales</h2>
                </div>
                
                <div class="info-box">
                    <ul class="check-list">
                        <li>
                            <i class="fas fa-check"></i>
                            <span>Sube un archivo en formato <strong>.xlsx</strong> o <strong>.xls</strong></span>
                        </li>
                        <li>
                            <i class="fas fa-check"></i>
                            <span>Los nombres de columnas deben coincidir <strong>exactamente</strong>.</span>
                        </li>
                        <li>
                            <i class="fas fa-check"></i>
                            <span>El sistema distingue mayúsculas, minúsculas y acentos.</span>
                        </li>
                        <li>
                            <i class="fas fa-exclamation-triangle warning-icon"></i>
                            <span>La columna <strong class="text-burgundy">"AREA"</strong> es obligatoria.</span>
                        </li>
                    </ul>
                </div>
            </div>

            <div class="section mb-4">
                <div class="section-header">
                    <div class="section-icon"><i class="fas fa-list-alt"></i></div>
                    <h2>Columnas Soportadas</h2>
                </div>

                <div class="columns-wrapper">
                    <div class="controls-bar">
                        <p class="help-text"><i class="fas fa-check-square"></i> Selecciona para generar tu plantilla.</p>
                        <label class="select-all-label">
                            <input type="checkbox" id="select-all">
                            <span>Seleccionar Todo</span>
                        </label>
                    </div>

                    <div class="column-grid">
                        {% for col in [
                            "NO. DE INVENTARIO", "NO. FACTURA", "NO. DE CUENTA", "PROVEEDOR",
                            "DESCRIPCION DEL BIEN", "DESCRIPCION CORTA DEL BIEN", "RUBRO",
                            "NO.POLIZA", "FECHA POLIZA", "SUB-CTA. ARMONIZADORA", "FECHA FACTURA",
                            "COSTO INICIAL", "DEPRECIACION ACUMULADA", "COSTO FINAL", "CANTIDAD",
                            "ESTADO DEL BIEN", "MARCA", "MODELO", "NUMERO DE SERIE", "TIPO DE ALTA",
                            "CLASIFICACION LEGAL", "AREA PRESUPUESTAL", "DOCUMENTO PROPIEDAD",
                            "FECHA DOCUMENTO PROPIEDAD", "VALOR EN LIBROS", "FECHA ADQUISICION/ALTA",
                            "AREA", "UBICACION", "NO. DE RESGUARDO", "TIPO DE RESGUARDO",
                            "FECHA DE RESGUARDO", "NO. DE TRABAJADOR", "PUESTO TRABAJADOR",
                            "RFC TRABAJADOR", "NO. DE NOMINA TRABAJADOR", "NOMBRE DEL RESGUARDANTE",
                            "NOMBRE DIRECTOR/JEFES DE AREA"
                        ] %} 
                        <div class="column-card">
                            <label class="column-label" for="col_{{ loop.index }}">
                                <input type="checkbox" 
                                       id="col_{{ loop.index }}" 
                                       value="{{ col }}" 
                                       class="column-checkbox">
                                <span class="col-name" title="{{ col }}">{{ col }}</span>
                            </label>
                            
                            <button type="button" class="btn-copy" title="Copiar nombre">
                                <i class="fas fa-copy"></i>
                            </button>
                            
                            <span class="tooltip">¡Copiado!</span>
                        </div>
                        {% endfor %}
                    </div>

                    <div class="actions-right">
                        <button id="generate-excel" class="btn btn-primary">
                            <i class="fas fa-file-download"></i> Generar Plantilla Excel
                        </button>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <div class="section-icon"><i class="fas fa-upload"></i></div>
                    <h2>Subir Archivo Excel</h2>
                </div>
                
                <div class="upload-zone">
                    <p class="upload-instruction">
                        <i class="fas fa-lightbulb"></i> Una vez listo tu archivo, súbelo aquí.
                    </p>
                    
                    <form action="{{ url_for('excel_import.upload_excel') }}" method="post" enctype="multipart/form-data" class="upload-form">
                        <input type="file" name="excel_file" required accept=".xlsx,.xls" class="file-input">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-upload"></i> Subir Excel
                        </button>
                    </form>
                    
                    <small class="file-types">Formatos aceptados: .xlsx, .xls</small>
                </div>
            </div>

            <div class="footer-actions">
                <a href="{{ url_for('resguardos.crear_resguardo') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Volver al Formulario
                </a>
                <div class="footer-link">
                    <i class="fas fa-download"></i>
                    ¿Necesitas ayuda? <a href="#">Descargar ejemplo completo</a>
                </div>
            </div>

        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
    /* --- VARIABLES (Coherencia Visual) --- */
    :root {
        --col-burgundy: #6A2E4D;
        --col-burgundy-dark: #551E3A;
        --col-beige: #BC9B6A;
        --col-beige-light: #fdfbf7;
        --col-bg: #f9fafb;
        --radius: 12px;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    /* Layout */
    .page-wrapper { min-height: 100vh; background: var(--col-bg); padding: 2rem 1rem; }
    .container-limit { max-width: 1100px; margin: 0 auto; }
    .mb-4 { margin-bottom: 2rem; }
    .text-burgundy { color: var(--col-burgundy); }

    /* Header */
    .header-card {
        background: linear-gradient(to right, var(--col-burgundy), var(--col-burgundy-dark));
        border-radius: var(--radius); padding: 1.5rem 2rem; color: white;
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 2rem; box-shadow: var(--shadow);
    }
    .header-text h1 { margin: 0; font-size: 1.6rem; }
    .header-text p { margin: 0.5rem 0 0; opacity: 0.9; }
    .header-icon-box {
        width: 48px; height: 48px; background: var(--col-beige); border-radius: 50%;
        display: flex; align-items: center; justify-content: center; color: var(--col-burgundy); font-size: 1.2rem;
    }

    /* Tarjeta Principal */
    .card { background: white; border-radius: var(--radius); box-shadow: var(--shadow); border: 1px solid #e5e7eb; padding: 2rem; }
    
    /* Secciones */
    .section-header { display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; }
    .section-icon { width: 32px; height: 32px; background: var(--col-burgundy); border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; }
    .section-header h2 { color: var(--col-burgundy); font-size: 1.25rem; margin: 0; }

    /* A. Caja de Instrucciones */
    .info-box { background: rgba(188, 155, 106, 0.1); border: 2px solid var(--col-beige); border-radius: var(--radius); padding: 1.5rem; }
    .check-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 0.8rem; }
    .check-list li { display: flex; align-items: flex-start; gap: 0.8rem; font-size: 0.95rem; color: #4b5563; }
    .check-list i.fa-check { color: #10b981; margin-top: 3px; }
    .warning-icon { color: #f59e0b; margin-top: 3px; }

    /* B. Selector de Columnas */
    .columns-wrapper { background: #fafafa; border: 1px solid #e5e7eb; border-radius: var(--radius); padding: 1.5rem; }
    
    .controls-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem; }
    .help-text { margin: 0; font-size: 0.9rem; color: #6b7280; display: flex; align-items: center; gap: 0.5rem; }
    .help-text i { color: var(--col-burgundy); }
    
    .select-all-label { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-weight: 600; font-size: 0.9rem; color: #374151; }
    .select-all-label input { width: 1.1rem; height: 1.1rem; cursor: pointer; accent-color: var(--col-burgundy); }

    /* GRID DE COLUMNAS */
    .column-grid { 
        display: grid; 
        grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); 
        gap: 0.8rem; 
    }
    
    .column-card {
        background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 0.75rem;
        display: flex; justify-content: space-between; align-items: center; position: relative;
        transition: all 0.2s;
    }
    .column-card:hover { border-color: var(--col-burgundy); box-shadow: 0 2px 4px rgba(0,0,0,0.05); transform: translateY(-1px); }
    
    .column-label { display: flex; align-items: center; gap: 0.8rem; cursor: pointer; flex: 1; min-width: 0; }
    .column-label input { width: 1rem; height: 1rem; cursor: pointer; accent-color: var(--col-burgundy); flex-shrink: 0; }
    .col-name { font-family: monospace; font-size: 0.85rem; color: #374151; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .column-card:hover .col-name { color: var(--col-burgundy); font-weight: 600; }

    .btn-copy { 
        background: none; border: none; color: #9ca3af; cursor: pointer; padding: 0.25rem; 
        transition: color 0.2s; flex-shrink: 0;
    }
    .btn-copy:hover { color: var(--col-burgundy); }

    /* Tooltip "Copiado" */
    .tooltip {
        position: absolute; top: -10px; right: -5px; background: #10b981; color: white;
        font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; pointer-events: none;
        opacity: 0; transition: opacity 0.3s; font-weight: 600;
    }
    .tooltip.show { opacity: 1; }

    .actions-right { text-align: right; margin-top: 1.5rem; }

    /* C. Zona de Carga */
    .upload-zone { border: 2px dashed var(--col-beige); border-radius: var(--radius); padding: 2rem; background: rgba(188, 155, 106, 0.05); }
    .upload-instruction { margin: 0 0 1.5rem 0; color: #4b5563; font-weight: 500; display: flex; align-items: center; gap: 0.5rem; }
    .upload-instruction i { color: var(--col-burgundy); }
    
    .upload-form { display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; }
    .file-input { flex: 1; padding: 0.7rem; background: white; border: 1px solid #d1d5db; border-radius: 8px; }
    .file-types { display: block; margin-top: 0.8rem; font-size: 0.85rem; color: #6b7280; }

    /* D. Footer */
    .footer-actions { margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
    .footer-link { font-size: 0.9rem; color: #4b5563; }
    .footer-link a { color: var(--col-burgundy); font-weight: 600; text-decoration: none; }
    .footer-link a:hover { text-decoration: underline; }

    /* Botones */
    .btn { padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem; border: none; cursor: pointer; transition: all 0.2s; font-size: 0.95rem; }
    .btn-primary { background: linear-gradient(to right, var(--col-burgundy), var(--col-burgundy-dark)); color: white; }
    .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }
    .btn-secondary { background: white; border: 2px solid var(--col-beige); color: var(--col-burgundy); }
    .btn-secondary:hover { background: rgba(188, 155, 106, 0.1); }

    /* Móvil */
    @media (max-width: 640px) {
        .header-card { flex-direction: column; text-align: center; gap: 1rem; }
        .upload-form { flex-direction: column; width: 100%; }
        .file-input, .btn { width: 100%; justify-content: center; }
        .footer-actions { justify-content: center; text-align: center; }
    }
</style>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Referencias ---
    const selectAllCheckbox = document.getElementById('select-all');
    const allColumnCheckboxes = document.querySelectorAll('.column-checkbox');
    const generateExcelBtn = document.getElementById('generate-excel');

    // --- 1. Lógica de Copiar al Portapapeles ---
    document.querySelectorAll('.btn-copy').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation(); // Evitar que marque el checkbox al dar click
            
            // Buscar el contenedor padre .column-card
            const card = btn.closest('.column-card');
            // Obtener el texto del span .col-name
            const textToCopy = card.querySelector('.col-name').textContent.trim();
            
            // Método moderno de copiado (fallback a execCommand si falla)
            if (navigator.clipboard) {
                navigator.clipboard.writeText(textToCopy).then(() => showFeedback(card));
            } else {
                // Fallback para navegadores viejos
                const textArea = document.createElement('textarea');
                textArea.value = textToCopy;
                textArea.style.position = 'fixed'; // Evitar scroll
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    showFeedback(card);
                } catch (err) {
                    console.error('Error al copiar', err);
                }
                document.body.removeChild(textArea);
            }
        });
    });

    function showFeedback(card) {
        const tooltip = card.querySelector('.tooltip');
        if (tooltip) {
            tooltip.classList.add('show');
            setTimeout(() => {
                tooltip.classList.remove('show');
            }, 1500);
        }
    }

    // --- 2. Lógica de "Seleccionar Todo" ---
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', () => {
            allColumnCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
        });
    }

    allColumnCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', () => {
            // Si desmarcan uno, quitamos el check de "Todos"
            if (!checkbox.checked) {
                selectAllCheckbox.checked = false;
            } else {
                // Si todos están marcados, activamos "Todos"
                const allChecked = [...allColumnCheckboxes].every(cb => cb.checked);
                selectAllCheckbox.checked = allChecked;
            }
        });
    });

    // --- 3. Generar Excel (Librería XLSX) ---
    if (generateExcelBtn) {
        generateExcelBtn.addEventListener('click', () => {
            const selectedColumns = [...allColumnCheckboxes]
                .filter(cb => cb.checked)
                .map(cb => cb.value);

            if (selectedColumns.length === 0) {
                alert('Por favor, selecciona al menos una columna.');
                return;
            }

            // Crear libro y hoja
            const wb = XLSX.utils.book_new();
            const wsData = [ selectedColumns ]; // Primera fila son los encabezados
            const ws = XLSX.utils.aoa_to_sheet(wsData);

            XLSX.utils.book_append_sheet(wb, ws, 'Plantilla');
            XLSX.writeFile(wb, 'Plantilla_Carga_Masiva.xlsx');
        });
    }
});
</script>
{% endblock %}