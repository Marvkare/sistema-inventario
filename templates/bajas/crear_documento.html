{% extends 'base.html' %}

{% block title %}Añadir Documento al Expediente #{{ proceso.id }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-50 to-beige-light/20 py-8 px-4">
    <div class="max-w-4xl mx-auto">
        
        <!-- Encabezado -->
        <div class="bg-white rounded-2xl shadow-xl border border-beige-light overflow-hidden mb-8">
            <div class="bg-gradient-to-r from-burgundy to-burgundy-dark p-6 text-white">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div class="flex-1">
                        <a href="{{ url_for('bajas.ver_proceso', proceso_id=proceso.id) }}" 
                           class="text-beige-light hover:text-white text-sm mb-2 inline-block transition-colors duration-200">
                            <i class="fas fa-arrow-left mr-2"></i> Volver al Proceso
                        </a>
                        <h1 class="text-2xl md:text-3xl font-bold">
                            Añadir Documento al Expediente #{{ proceso.id }}
                        </h1>
                        <p class="text-beige-light mt-2">Complete la información del documento y adjunte los archivos correspondientes</p>
                    </div>
                    <div class="w-12 h-12 bg-beige rounded-full flex items-center justify-center shadow-lg">
                        <i class="fas fa-file-upload text-burgundy text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Formulario -->
        <form id="documentoForm" 
              action="{{ url_for('bajas.crear_documento_expediente', proceso_id=proceso.id) }}" 
              method="POST" 
              enctype="multipart/form-data" 
              class="bg-white rounded-2xl shadow-lg border border-beige-light overflow-hidden">
            
            <div class="p-8 space-y-8">
                <!-- Tipo de Documento -->
                <div>
                    <label for="tipo_documento" class="block text-sm font-semibold text-gray-700 mb-3 flex items-center">
                        <i class="fas fa-file-alt text-burgundy mr-2"></i>
                        Tipo de Documento <span class="text-red-600 ml-1">*</span>
                    </label>
                    <select id="tipo_documento" name="tipo_documento" required 
                            class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 bg-white">
                        <option value="" disabled selected>Seleccione un tipo de documento...</option>
                        <option value="Solicitud de Baja">Solicitud de Baja</option>
                        <option value="Dictamen Técnico">Dictamen Técnico</option>
                        <option value="Denuncia de Robo">Denuncia de Robo</option>
                        <option value="Acta de Siniestro">Acta de Siniestro</option>
                        <option value="Avalúo Comercial">Avalúo Comercial</option>
                        <option value="Acta de Comité">Acta de Comité</option>
                        <option value="Acta de Baja">Acta de Baja</option>
                        <option value="Acta de Investigación">Acta de Investigación</option>
                        <option value="Fotografías del bien">Fotografías del bien</option>
                        <option value="Acta de echos">Acta de echos</option>
                        <option value="Otro">Otro</option>
                    </select>
                </div>
                
                <!-- Metadatos -->
                <div>
                    <label for="metadatos" class="block text-sm font-semibold text-gray-700 mb-3 flex items-center">
                        <i class="fas fa-code text-burgundy mr-2"></i>
                        Metadatos <span class="text-gray-500 text-xs font-normal ml-1">(Opcional, formato JSON)</span>
                    </label>
                    <textarea id="metadatos" name="metadatos" rows="4" 
                              class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 bg-white resize-none font-mono text-sm"
                              placeholder='Ejemplo: {"valor": 5000.00, "fecha_avaluo": "2025-10-10"}'></textarea>
                    <p class="text-xs text-gray-500 mt-2 flex items-center">
                        <i class="fas fa-info-circle text-burgundy mr-1"></i>
                        Utilice formato JSON válido para información adicional del documento
                    </p>
                </div>

                <!-- Archivos Adjuntos -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-3 flex items-center">
                        <i class="fas fa-paperclip text-burgundy mr-2"></i>
                        Archivos Adjuntos <span class="text-red-600 ml-1">*</span>
                    </label>
                    <div id="dropZone" class="mt-1 flex justify-center px-6 pt-8 pb-8 border-2 border-dashed border-beige-light rounded-xl bg-beige-light/10 hover:bg-beige-light/20 transition-all duration-300 cursor-pointer">
                        <div class="space-y-3 text-center">
                            <i class="fas fa-cloud-upload-alt text-4xl text-burgundy/60"></i>
                            <div class="flex flex-col sm:flex-row text-sm text-gray-600 items-center justify-center space-y-2 sm:space-y-0 sm:space-x-1">
                                <label for="archivos_adjuntos" class="relative cursor-pointer bg-white rounded-xl font-semibold text-burgundy hover:text-burgundy-dark transition-colors duration-200 px-4 py-2 border border-burgundy/20">
                                    <span>Seleccionar archivos</span>
                                    <input type="file" id="archivos_adjuntos" name="archivos_adjuntos_input" multiple class="sr-only"/>
                                </label>
                                <p class="text-gray-500">o arrástrelos aquí</p>
                            </div>
                            <p class="text-xs text-gray-500">
                                <i class="fas fa-file text-burgundy mr-1"></i>
                                Formatos: PDF, PNG, JPG - Máximo 10MB por archivo
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Vista Previa de Archivos -->
                <div id="file-preview-container" class="space-y-3"></div>
            </div>

            <!-- Botones de Acción -->
            <div class="flex flex-col sm:flex-row justify-end gap-4 p-6 border-t border-beige-light bg-gray-50 rounded-b-2xl">
                <a href="{{ url_for('bajas.ver_proceso', proceso_id=proceso.id) }}" 
                   class="inline-flex items-center justify-center px-6 py-3 border-2 border-gray-300 text-base font-semibold rounded-xl text-gray-700 bg-white hover:bg-gray-50 transition-all duration-200 order-2 sm:order-1">
                    <i class="fas fa-times mr-2"></i> Cancelar
                </a>
                <button type="submit" 
                        class="inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-semibold rounded-xl shadow-lg text-white bg-gradient-to-r from-burgundy to-burgundy-dark hover:from-burgundy-dark hover:to-burgundy transition-all duration-300 transform hover:scale-105 order-1 sm:order-2">
                    <i class="fas fa-save mr-2"></i> 
                    Guardar Documento y Archivos
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
    .bg-burgundy { background-color: #6A2E4D; }
    .bg-burgundy-dark { background-color: #551E3A; }
    .text-burgundy { color: #6A2E4D; }
    .border-burgundy { border-color: #6A2E4D; }
    .focus\:ring-burgundy\/50:focus { --tw-ring-color: rgb(106 46 77 / 0.5); }
    .focus\:border-burgundy:focus { border-color: #6A2E4D; }
    
    .bg-beige { background-color: #BC9B6A; }
    .bg-beige-light { background-color: #D7C3A0; }
    .text-beige-light { color: #D7C3A0; }
    .border-beige { border-color: #BC9B6A; }
    .border-beige-light { border-color: #D7C3A0; }
    
    .from-burgundy { --tw-gradient-from: #6A2E4D; --tw-gradient-to: rgb(106 46 77 / 0); --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to); }
    .to-burgundy-dark { --tw-gradient-to: #551E3A; }
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const fileInput = document.getElementById('archivos_adjuntos');
    const previewContainer = document.getElementById('file-preview-container');
    const form = document.getElementById('documentoForm');
    const dropZone = document.getElementById('dropZone');
    
    const fileLabel = document.querySelector('label[for="archivos_adjuntos"]');

    let selectedFiles = [];

    // Manejar selección de archivos
    fileInput.addEventListener('change', () => {
        const newFiles = Array.from(fileInput.files);
        selectedFiles = selectedFiles.concat(newFiles);
        console.log(`Archivos añadidos. Total ahora: ${selectedFiles.length}`, selectedFiles);
        
        fileInput.value = '';
        renderPreviews();
    });

    // Manejar drag and drop
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('border-burgundy', 'bg-burgundy/5', 'scale-105');
    });

    dropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dropZone.classList.remove('border-burgundy', 'bg-burgundy/5', 'scale-105');
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('border-burgundy', 'bg-burgundy/5', 'scale-105');
        
        const newFiles = Array.from(e.dataTransfer.files);
        selectedFiles = selectedFiles.concat(newFiles);
        console.log(`Archivos añadidos por drag & drop. Total ahora: ${selectedFiles.length}`, selectedFiles);
        
        renderPreviews();
    });

    fileLabel.addEventListener('click', (e) => {
        e.stopPropagation();
    });

    function renderPreviews() {
        previewContainer.innerHTML = '';
        if (selectedFiles.length > 0) {
            const title = document.createElement('div');
            title.className = 'flex items-center text-sm font-semibold text-gray-700 mb-3';
            title.innerHTML = `
                <i class="fas fa-list text-burgundy mr-2"></i>
                Archivos seleccionados (${selectedFiles.length})
            `;
            previewContainer.appendChild(title);
        }

        selectedFiles.forEach((file, index) => {
            const fileElement = document.createElement('div');
            fileElement.className = 'flex items-center justify-between bg-beige-light/20 p-4 rounded-xl border border-beige-light hover:bg-beige-light/30 transition-colors duration-200';
            fileElement.innerHTML = `
                <div class="flex items-center space-x-3 flex-1">
                    <i class="fas fa-file text-burgundy text-lg"></i>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-gray-800 truncate">${file.name}</p>
                        <p class="text-xs text-gray-500">${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                    </div>
                </div>
                <button type="button" data-index="${index}" 
                        class="remove-file-btn text-red-500 hover:text-red-700 hover:bg-red-50 w-8 h-8 rounded-full flex items-center justify-center transition-colors duration-200">
                    <i class="fas fa-times text-sm"></i>
                </button>
            `;
            previewContainer.appendChild(fileElement);
        });
    }

    // Delegación de eventos para eliminar archivos
    previewContainer.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-file-btn') || e.target.closest('.remove-file-btn')) {
            const button = e.target.classList.contains('remove-file-btn') ? e.target : e.target.closest('.remove-file-btn');
            const indexToRemove = parseInt(button.dataset.index, 10);
            removeFile(indexToRemove);
        }
    });

    function removeFile(index) {
        selectedFiles.splice(index, 1);
        console.log(`Archivo eliminado. Total ahora: ${selectedFiles.length}`, selectedFiles);
        renderPreviews();
    }

    // Validación del formulario
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        console.log('Iniciando envío de formulario...');
        
        // Validación
        const tipoDocumento = document.getElementById('tipo_documento').value;
        if (!tipoDocumento) {
            alert('Debe seleccionar un tipo de documento.');
            return;
        }

        if (selectedFiles.length === 0) {
            alert('Debe seleccionar al menos un archivo adjunto.');
            console.error('Validación fallida: No hay archivos seleccionados.');
            return;
        }

        // Validar tamaño de archivos
        const maxSize = 10 * 1024 * 1024; // 10MB
        const archivosDemasiadoGrandes = selectedFiles.filter(file => file.size > maxSize);
        if (archivosDemasiadoGrandes.length > 0) {
            alert(`Los siguientes archivos exceden el tamaño máximo de 10MB: ${archivosDemasiadoGrandes.map(f => f.name).join(', ')}`);
            return;
        }

        const submitButton = form.querySelector('button[type="submit"]');
        const originalText = submitButton.innerHTML;
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Guardando...';

        // Construcción del FormData
        const formData = new FormData();
        formData.append('tipo_documento', tipoDocumento);
        formData.append('metadatos', document.getElementById('metadatos').value);
        
        selectedFiles.forEach(file => {
            formData.append('archivos_adjuntos', file);
        });

        console.log('FormData listo para enviar:');
        for (let [key, value] of formData.entries()) {
            console.log(key, value instanceof File ? value.name : value);
        }

        // Envío con Fetch
        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'Accept': 'application/json',
            }
        })
        .then(async (response) => {
            // Verificar si la respuesta es JSON
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                const text = await response.text();
                console.error('Respuesta no JSON recibida:', text.substring(0, 200));
                throw new Error('El servidor devolvió una respuesta no JSON');
            }
            
            if (!response.ok) {
                // Parsear el error como JSON
                const errorData = await response.json();
                throw new Error(errorData.error || `Error ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Respuesta exitosa:', data);
            alert(data.message || 'Documento guardado exitosamente.');
            window.location.href = "{{ url_for('bajas.ver_proceso', proceso_id=proceso.id) }}";
        })
        .catch(error => {
            console.error('Error al guardar el documento:', error);
            
            // Mostrar mensaje de error más específico
            let errorMessage = 'Error al guardar el documento: ' + error.message;
            if (error.message.includes('respuesta no JSON')) {
                errorMessage = 'Error del servidor: Respuesta inesperada. Contacte al administrador.';
            } else if (error.message.includes('Failed to fetch')) {
                errorMessage = 'Error de conexión. Verifique su conexión a internet.';
            }
            
            alert(errorMessage);
            submitButton.disabled = false;
            submitButton.innerHTML = originalText;
        });
    });

    // Validación de JSON en tiempo real
    const metadatosTextarea = document.getElementById('metadatos');
    metadatosTextarea.addEventListener('input', function() {
        const value = this.value.trim();
        if (value === '') {
            this.classList.remove('border-red-500', 'border-green-500');
            return;
        }

        try {
            JSON.parse(value);
            this.classList.remove('border-red-500');
            this.classList.add('border-green-500');
        } catch (e) {
            this.classList.remove('border-green-500');
            this.classList.add('border-red-500');
        }
    });

    // Efectos visuales para el drop zone
    dropZone.addEventListener('click', () => {
        fileInput.click();
    });
});
</script>
{% endblock %}