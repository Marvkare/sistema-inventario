{% extends 'base.html' %}

{% block title %}Añadir Documento al Expediente #{{ proceso.id }}{% endblock %}

{% block content %}
<div class="page-wrapper">
    <div class="container-limit">
        
        <div class="header-card">
            <div class="header-content">
                <div class="breadcrumbs">
                    <a href="{{ url_for('bajas.ver_proceso', proceso_id=proceso.id) }}">
                        <i class="fas fa-arrow-left"></i> Volver al Proceso
                    </a>
                </div>
                <h1>Añadir Documento</h1>
                <p>Expediente de Baja #{{ proceso.id }}</p>
            </div>
            <div class="header-icon-box">
                <i class="fas fa-file-upload"></i>
            </div>
        </div>

        <div class="card">
            <form id="documentoForm" 
                  action="{{ url_for('bajas.crear_documento_expediente', proceso_id=proceso.id) }}" 
                  method="POST" 
                  enctype="multipart/form-data">
                
                <div class="card-body">
                    
                    <div class="form-group">
                        <label for="tipo_documento">
                            <i class="fas fa-tag icon-label"></i> Tipo de Documento *
                        </label>
                        <select id="tipo_documento" name="tipo_documento" required>
                            <option value="" disabled selected>Seleccione un tipo...</option>
                            <option value="Solicitud de Baja">Solicitud de Baja</option>
                            <option value="Dictamen Técnico">Dictamen Técnico</option>
                            <option value="Denuncia de Robo">Denuncia de Robo</option>
                            <option value="Acta de Siniestro">Acta de Siniestro</option>
                            <option value="Avalúo Comercial">Avalúo Comercial</option>
                            <option value="Acta de Comité">Acta de Comité</option>
                            <option value="Acta de Baja">Acta de Baja</option>
                            <option value="Acta de Investigación">Acta de Investigación</option>
                            <option value="Fotografías del bien">Fotografías del bien</option>
                            <option value="Acta de echos">Acta de Hechos</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="metadatos">
                            <i class="fas fa-code icon-label"></i> Metadatos (Opcional)
                        </label>
                        <textarea id="metadatos" name="metadatos" rows="3" 
                                  class="font-mono"
                                  placeholder='Ej: {"valor": 5000.00, "fecha": "2025-10-10"}'></textarea>
                        <p class="help-text">Formato JSON válido para información adicional.</p>
                    </div>

                    <div class="form-group">
                        <label>
                            <i class="fas fa-paperclip icon-label"></i> Archivos Adjuntos *
                        </label>
                        
                        <div id="dropZone" class="drop-zone">
                            <div class="drop-zone-content">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <p class="drop-text">Arrastra archivos aquí o</p>
                                <label for="archivos_adjuntos" class="btn btn-secondary btn-sm">
                                    Seleccionar Archivos
                                    <input type="file" id="archivos_adjuntos" name="archivos_adjuntos_input" multiple class="hidden"/>
                                </label>
                                <p class="drop-info">PDF, PNG, JPG - Máx 10MB</p>
                            </div>
                        </div>
                    </div>

                    <div id="file-preview-container" class="file-list-stack"></div>

                </div>

                <div class="form-actions">
                    <a href="{{ url_for('bajas.ver_proceso', proceso_id=proceso.id) }}" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Cancelar
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Guardar Documento
                    </button>
                </div>

            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
    /* VARIABLES */
    :root {
        --col-burgundy: #6A2E4D;
        --col-burgundy-dark: #551E3A;
        --col-beige: #BC9B6A;
        --col-beige-light: #fdfbf7;
        --col-bg: #f9fafb;
        --radius: 12px;
        --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        
        --border-color: #e5e7eb;
        --text-gray: #6b7280;
        --text-dark: #1f2937;
    }

    /* Layout */
    .page-wrapper { min-height: 100vh; background: var(--col-bg); padding: 2rem 1rem; }
    .container-limit { max-width: 800px; margin: 0 auto; }

    /* Header */
    .header-card {
        background: linear-gradient(to right, var(--col-burgundy), var(--col-burgundy-dark));
        border-radius: var(--radius); padding: 1.5rem 2rem; color: white;
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 2rem; box-shadow: var(--shadow);
    }
    .breadcrumbs a { color: rgba(255,255,255,0.8); text-decoration: none; font-size: 0.9rem; display: block; margin-bottom: 0.5rem; }
    .breadcrumbs a:hover { color: white; text-decoration: underline; }
    .header-content h1 { margin: 0; font-size: 1.5rem; }
    .header-content p { margin: 0.5rem 0 0; opacity: 0.9; }
    .header-icon-box {
        width: 48px; height: 48px; background: var(--col-beige); border-radius: 50%;
        display: flex; align-items: center; justify-content: center; color: var(--col-burgundy); font-size: 1.2rem;
    }

    /* Card */
    .card { background: white; border-radius: var(--radius); box-shadow: var(--shadow); border: 1px solid var(--border-color); overflow: hidden; }
    .card-body { padding: 2rem; }

    /* Formulario */
    .form-group { margin-bottom: 1.5rem; }
    .form-group label { display: block; font-weight: 600; color: var(--text-dark); margin-bottom: 0.5rem; font-size: 0.95rem; }
    .icon-label { color: var(--col-burgundy); margin-right: 0.4rem; }
    
    select, textarea { width: 100%; padding: 0.8rem; border: 1px solid #d1d5db; border-radius: 8px; font-size: 0.95rem; background: white; transition: border 0.2s; }
    select:focus, textarea:focus { outline: none; border-color: var(--col-burgundy); box-shadow: 0 0 0 3px rgba(106, 46, 77, 0.1); }
    
    .font-mono { font-family: monospace; font-size: 0.9rem; }
    .help-text { font-size: 0.8rem; color: var(--text-gray); margin-top: 0.4rem; }

    /* Validation States (JSON) */
    textarea.valid-json { border-color: #10b981; background-color: #f0fdf4; }
    textarea.invalid-json { border-color: #ef4444; background-color: #fef2f2; }

    /* --- ZONA DE CARGA (DROP ZONE) --- */
    .drop-zone {
        border: 2px dashed var(--col-beige);
        background: rgba(188, 155, 106, 0.05);
        border-radius: var(--radius);
        padding: 2rem;
        text-align: center;
        transition: all 0.2s;
        cursor: pointer;
    }
    .drop-zone:hover { background: rgba(188, 155, 106, 0.1); border-color: var(--col-burgundy); }
    .drop-zone.drag-over { background: rgba(106, 46, 77, 0.1); border-color: var(--col-burgundy); transform: scale(1.02); }

    .drop-zone-content i { font-size: 2.5rem; color: var(--col-burgundy); opacity: 0.6; margin-bottom: 1rem; display: block; }
    .drop-text { font-size: 1rem; color: var(--text-gray); margin-bottom: 1rem; }
    .drop-info { font-size: 0.8rem; color: #9ca3af; margin-top: 1rem; }
    
    .hidden { display: none !important; }

    /* LISTA DE ARCHIVOS */
    .file-list-stack { margin-top: 1.5rem; display: flex; flex-direction: column; gap: 0.8rem; }
    .list-title { font-weight: 600; color: var(--text-dark); font-size: 0.9rem; margin-bottom: 0.5rem; }
    
    .file-item {
        display: flex; justify-content: space-between; align-items: center;
        padding: 0.8rem; background: #fafafa; border: 1px solid var(--border-color); border-radius: 8px;
        transition: background 0.2s;
    }
    .file-item:hover { background: #f3f4f6; }
    
    .file-info { display: flex; align-items: center; gap: 0.8rem; overflow: hidden; }
    .file-icon { width: 36px; height: 36px; background: var(--col-beige-light); color: var(--col-burgundy); border-radius: 6px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    
    .file-details { display: flex; flex-direction: column; min-width: 0; }
    .file-name { font-weight: 600; font-size: 0.9rem; color: var(--text-dark); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .file-size { font-size: 0.75rem; color: var(--text-gray); }

    .btn-remove-file {
        width: 30px; height: 30px; border-radius: 50%; border: none; background: transparent;
        color: #ef4444; cursor: pointer; display: flex; align-items: center; justify-content: center;
        transition: background 0.2s; flex-shrink: 0;
    }
    .btn-remove-file:hover { background: #fee2e2; }

    /* BOTONES ACCIÓN */
    .form-actions { padding: 1.5rem 2rem; background: #f9fafb; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 1rem; }
    .btn { padding: 0.7rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem; transition: all 0.2s; font-size: 0.95rem; }
    
    .btn-primary { background: linear-gradient(to right, var(--col-burgundy), var(--col-burgundy-dark)); color: white; }
    .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }
    
    .btn-secondary { background: white; border: 1px solid #d1d5db; color: #374151; }
    .btn-secondary:hover { background: #f3f4f6; }
    .btn-sm { padding: 0.4rem 1rem; font-size: 0.85rem; }

    @media (max-width: 640px) {
        .header-card { flex-direction: column; text-align: center; }
        .form-actions { flex-direction: column; }
        .btn { width: 100%; justify-content: center; }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const fileInput = document.getElementById('archivos_adjuntos');
    const previewContainer = document.getElementById('file-preview-container');
    const form = document.getElementById('documentoForm');
    const dropZone = document.getElementById('dropZone');
    
    let selectedFiles = [];

    // --- MANEJO DE ARCHIVOS ---
    
    const handleFiles = (files) => {
        const newFiles = Array.from(files);
        selectedFiles = selectedFiles.concat(newFiles);
        renderPreviews();
    };

    fileInput.addEventListener('change', () => {
        handleFiles(fileInput.files);
        fileInput.value = ''; // Reset para permitir seleccionar el mismo archivo
    });

    // --- DRAG AND DROP ---
    
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('drag-over');
    });

    dropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
        handleFiles(e.dataTransfer.files);
    });

    dropZone.addEventListener('click', (e) => {
        // Evitar que el click en el input file dispare el click del dropzone
        if (e.target.closest('label')) {
            return;
        }
        
        // Solo si el clic fue en el área vacía (fondo gris), forzamos la apertura
        fileInput.click();
    });

    // --- RENDERIZADO (HTML LIMPIO) ---
    
    function renderPreviews() {
        previewContainer.innerHTML = '';
        
        if (selectedFiles.length > 0) {
            const title = document.createElement('div');
            title.className = 'list-title';
            title.innerHTML = `<i class="fas fa-list"></i> Archivos seleccionados (${selectedFiles.length})`;
            previewContainer.appendChild(title);
        }

        selectedFiles.forEach((file, index) => {
            const fileElement = document.createElement('div');
            fileElement.className = 'file-item';
            
            const sizeMB = (file.size / 1024 / 1024).toFixed(2);
            
            fileElement.innerHTML = `
                <div class="file-info">
                    <div class="file-icon"><i class="fas fa-file"></i></div>
                    <div class="file-details">
                        <span class="file-name" title="${file.name}">${file.name}</span>
                        <span class="file-size">${sizeMB} MB</span>
                    </div>
                </div>
                <button type="button" class="btn-remove-file" data-index="${index}" title="Eliminar">
                    <i class="fas fa-times"></i>
                </button>
            `;
            previewContainer.appendChild(fileElement);
        });
    }

    // Delegación de evento para eliminar
    previewContainer.addEventListener('click', (e) => {
        const btn = e.target.closest('.btn-remove-file');
        if (btn) {
            const index = parseInt(btn.dataset.index, 10);
            selectedFiles.splice(index, 1);
            renderPreviews();
        }
    });

    // --- VALIDACIÓN JSON ---
    const metaInput = document.getElementById('metadatos');
    metaInput.addEventListener('input', function() {
        if (this.value.trim() === '') {
            this.classList.remove('valid-json', 'invalid-json');
            return;
        }
        try {
            JSON.parse(this.value);
            this.classList.remove('invalid-json');
            this.classList.add('valid-json');
        } catch (e) {
            this.classList.remove('valid-json');
            this.classList.add('invalid-json');
        }
    });

    // --- ENVÍO (AJAX) ---
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const tipo = document.getElementById('tipo_documento').value;
        if (!tipo) { alert('Seleccione tipo de documento'); return; }
        if (selectedFiles.length === 0) { alert('Adjunte al menos un archivo'); return; }

        // Verificar tamaño (10MB)
        const largeFiles = selectedFiles.filter(f => f.size > 10 * 1024 * 1024);
        if (largeFiles.length > 0) {
            alert(`Archivos muy pesados: ${largeFiles.map(f=>f.name).join(', ')}`);
            return;
        }

        const btn = form.querySelector('button[type="submit"]');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';

        const formData = new FormData();
        formData.append('tipo_documento', tipo);
        formData.append('metadatos', metaInput.value);
        selectedFiles.forEach(f => formData.append('archivos_adjuntos', f));

        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: { 'Accept': 'application/json' }
        })
        .then(res => {
            if (!res.ok) return res.json().then(err => { throw new Error(err.error || 'Error servidor') });
            return res.json();
        })
        .then(data => {
            alert(data.message || 'Guardado con éxito');
            // Redirigir usando la URL construida por Flask en el template, o la del JSON si el backend la envía
            window.location.href = "{{ url_for('bajas.ver_proceso', proceso_id=proceso.id) }}";
        })
        .catch(err => {
            console.error(err);
            alert(err.message);
            btn.disabled = false;
            btn.innerHTML = originalText;
        });
    });
});
</script>
{% endblock %}