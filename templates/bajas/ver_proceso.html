{% extends 'base.html' %}

{% block title %}Detalles del Proceso de Baja - #{{ proceso.id }}{% endblock %}

{% block content %}
<div class="page-wrapper">
    <div class="container-limit">
        
        <div class="header-card">
            <div class="header-content">
                <div class="breadcrumbs">
                    <a href="{{ url_for('bajas.gestionar_bajas') }}">
                        <i class="fas fa-arrow-left"></i> Volver a la lista
                    </a>
                </div>
                <h1>Detalles del Proceso de Baja #{{ proceso.id }}</h1>
                <p>Seguimiento completo del proceso de desincorporación.</p>
            </div>
            
            <div class="header-status">
                <span class="status-label">Estatus:</span>
                {% if proceso.estatus == 'Solicitado' %}
                    <span class="badge badge-blue">Solicitado</span>
                {% elif proceso.estatus in ['En Dictamen Técnico', 'Pendiente de Comité'] %}
                    <span class="badge badge-yellow">{{ proceso.estatus }}</span>
                {% elif proceso.estatus == 'Finalizado' %}
                    <span class="badge badge-green">Finalizado</span>
                {% elif proceso.estatus == 'Rechazado' %}
                    <span class="badge badge-red">Rechazado</span>
                {% else %}
                    <span class="badge badge-gray">{{ proceso.estatus }}</span>
                {% endif %}
            </div>
        </div>

        <div class="details-layout">
            
            <div class="main-column">

                <div class="card">
                    <div class="card-header">
                        <div class="icon-box"><i class="fas fa-project-diagram"></i></div>
                        <h2>Línea de Proceso</h2>
                    </div>
                    <div class="card-body">
                        {% if workflow %}
                            <div class="timeline-stack">
                                {% set statuses = workflow.timeline %}
                                {% set current_index = statuses.index(proceso.estatus) if proceso.estatus in statuses else -1 %}
                                
                                {% for status in statuses %}
                                <div class="timeline-item {% if loop.index0 <= current_index %}active{% endif %}">
                                    <div class="timeline-marker">
                                        {% if loop.index0 < current_index %}<i class="fas fa-check"></i>
                                        {% elif loop.index0 == current_index %}<i class="fas fa-play"></i>
                                        {% else %}<i class="fas fa-clock"></i>{% endif %}
                                    </div>
                                    <div class="timeline-content">
                                        <h4>{{ status }}</h4>
                                        {% if loop.index0 == current_index %}
                                            <small>Estado actual del proceso</small>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="empty-state-mini">
                                <i class="fas fa-exclamation-triangle text-yellow"></i>
                                <p>No hay flujo definido para "{{ proceso.motivo }}".</p>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="icon-box"><i class="fas fa-info-circle"></i></div>
                        <h2>Información de la Solicitud</h2>
                    </div>
                    <div class="card-body">
                        <div class="info-grid">
                            <div class="info-item">
                                <label>Solicitante</label>
                                <p class="highlight">{{ proceso.nombre_solicitante }}</p>
                            </div>
                            <div class="info-item">
                                <label>Jefe de Área (Vo.Bo.)</label>
                                <p>{{ proceso.nombre_jefe_area or 'No especificado' }}</p>
                            </div>
                            <div class="info-item">
                                <label>Fecha de Inicio</label>
                                <p>{{ proceso.fecha_inicio.strftime('%d de %B de %Y') }}</p>
                            </div>
                            <div class="info-item">
                                <label>Capturado por</label>
                                <p>{{ proceso.usuario_captura.username if proceso.usuario_captura else 'No disponible' }}</p>
                            </div>
                            <div class="info-item">
                                <label>Motivo</label>
                                <p class="highlight">{{ proceso.motivo }}</p>
                            </div>
                            <div class="info-item full-width">
                                <label>Justificación Detallada</label>
                                <div class="text-box">
                                    {{ proceso.justificacion_solicitud }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="icon-box"><i class="fas fa-folder-open"></i></div>
                        <h2>Expediente Digital</h2>
                    </div>
                    <div class="card-body">
                        
                        {% if workflow %}
                            {% set uploaded_docs = proceso.documentos|map(attribute='tipo_documento')|list %}
                            <div class="checklist-section">
                                <h3>Checklist de Documentos</h3>
                                <div class="checklist-grid">
                                    {% for name, desc in workflow.documentos_requeridos.items() %}
                                    <div class="checklist-item {% if name in uploaded_docs %}completed{% endif %}">
                                        <div class="check-icon">
                                            {% if name in uploaded_docs %}<i class="fas fa-check"></i>
                                            {% else %}<i class="fas fa-clock"></i>{% endif %}
                                        </div>
                                        <div class="check-info">
                                            <p class="check-name">{{ name }}</p>
                                            <p class="check-desc">{{ desc }}</p>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}

                        <div class="upload-action-area">
                            <a href="{{ url_for('bajas.crear_documento_expediente', proceso_id=proceso.id) }}" class="btn btn-primary btn-lg">
                                <i class="fas fa-plus-circle"></i> Añadir Documento al Expediente
                            </a>
                        </div>

                        <div class="files-history">
                            <h3>Historial de Documentos</h3>
                            {% if proceso.documentos %}
                                <div class="files-stack">
                                    {% for doc in proceso.documentos %}
                                    <div class="file-group">
                                        <div class="file-group-header">
                                            <span class="doc-type">{{ doc.tipo_documento }}</span>
                                            <span class="doc-uploader">Subido por: {{ doc.usuario_carga.username if doc.usuario_carga else 'N/A' }}</span>
                                        </div>
                                        <div class="file-list">
                                            {% for adjunto in doc.archivos_adjuntos %}
                                            <div class="file-item">
                                                <div class="file-info">
                                                    {% if adjunto.tipo_mime and adjunto.tipo_mime.startswith('image/') %}
                                                        <img src="{{ url_for('serve_uploaded_file', filename=adjunto.ruta_archivo) }}" class="file-thumb">
                                                    {% else %}
                                                        <div class="file-icon"><i class="fas fa-file-alt"></i></div>
                                                    {% endif %}
                                                    <span class="file-name">{{ adjunto.nombre_archivo }}</span>
                                                </div>
                                                <a href="{{ url_for('bajas.descargar_documento', adjunto_id=adjunto.id) }}" class="btn-icon-small" title="Descargar">
                                                    <i class="fas fa-download"></i>
                                                </a>
                                            </div>
                                            {% else %}
                                                <p class="no-files">Sin archivos adjuntos.</p>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="empty-state-mini">
                                    <i class="fas fa-inbox"></i>
                                    <p>Aún no se han cargado documentos.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

            </div> <div class="sidebar-column">
                
                <div class="card">
                    <div class="card-header">
                        <div class="icon-box"><i class="fas fa-box"></i></div>
                        <h2>Bien a Desincorporar</h2>
                    </div>
                    <div class="card-body">
                        <div class="info-stack">
                            <div class="info-item">
                                <label>No. Inventario</label>
                                <p class="highlight">{{ proceso.bien.No_Inventario }}</p>
                            </div>
                            <div class="info-item">
                                <label>Descripción</label>
                                <p>{{ proceso.bien.Descripcion_Del_Bien }}</p>
                            </div>
                            <div class="grid-2-mini">
                                <div class="info-item">
                                    <label>Marca</label>
                                    <p>{{ proceso.bien.Marca or 'N/A' }}</p>
                                </div>
                                <div class="info-item">
                                    <label>Modelo</label>
                                    <p>{{ proceso.bien.Modelo or 'N/A' }}</p>
                                </div>
                            </div>
                            <div class="info-item">
                                <label>No. Serie</label>
                                <p>{{ proceso.bien.Numero_De_Serie or 'N/A' }}</p>
                            </div>
                            <div class="info-item">
                                <label>Costo</label>
                                <p class="money">${{ "%.2f"|format(proceso.bien.Costo_Inicial) }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="icon-box"><i class="fas fa-play-circle"></i></div>
                        <h2>Acciones</h2>
                    </div>
                    <div class="card-body">
                        <div class="actions-stack">
                            {% if workflow %}
                                {% set transicion = workflow.transiciones.get(proceso.estatus) %}
                                
                                {% if transicion %}
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle"></i>
                                        <p>Requerido: <strong>{{ transicion.documento_necesario }}</strong></p>
                                    </div>

                                    {% if proceso.estatus == 'Autorizado para Disposición' %}
                                        <button id="openDisposicionBtn" class="btn btn-yellow btn-block">
                                            <i class="fas fa-tasks"></i> Registrar Disposición
                                        </button>
                                    {% endif %}

                                    <form action="{{ url_for('bajas.actualizar_estatus', proceso_id=proceso.id) }}" method="POST">
                                        <input type="hidden" name="nuevo_estatus" value="{{ transicion.siguiente_estatus }}">
                                        <button type="submit" class="btn btn-primary btn-block"
                                                onclick="return confirm('¿Continuar? Verifique haber cargado el documento requerido.')">
                                            <i class="fas fa-arrow-right"></i> {{ transicion.texto_accion }}
                                        </button>
                                    </form>
                                {% endif %}

                                {% if proceso.estatus in ['Solicitado', 'Pendiente de Comité'] %}
                                    <form action="{{ url_for('bajas.actualizar_estatus', proceso_id=proceso.id) }}" method="POST">
                                        <input type="hidden" name="nuevo_estatus" value="Rechazado">
                                        <button type="submit" class="btn btn-red btn-block"
                                                onclick="return confirm('ADVERTENCIA: ¿Rechazar solicitud?')">
                                            <i class="fas fa-times-circle"></i> Rechazar
                                        </button>
                                    </form>
                                {% endif %}

                                {% if proceso.estatus == 'Finalizado' %}
                                    <form action="{{ url_for('bajas.actualizar_estatus', proceso_id=proceso.id) }}" method="POST">
                                        <input type="hidden" name="nuevo_estatus" value="Finalizado">
                                        <button type="submit" class="btn btn-dark btn-block"
                                                onclick="return confirm('¿FINALIZAR el proceso? Esta acción es irreversible.')">
                                            <i class="fas fa-flag-checkered"></i> Finalizar Proceso
                                        </button>
                                    </form>
                                {% endif %}

                            {% else %}
                                <div class="empty-state-mini">
                                    <p>Sin acciones disponibles.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                {% if proceso.disposicion_final %}
                <div class="card">
                    <div class="card-header">
                        <div class="icon-box"><i class="fas fa-recycle"></i></div>
                        <h2>Disposición Final</h2>
                    </div>
                    <div class="card-body">
                        <div class="info-stack">
                            <div class="info-item">
                                <label>Tipo</label>
                                <p class="highlight">{{ proceso.disposicion_final.tipo_disposicion }}</p>
                            </div>
                            <div class="info-item">
                                <label>Fecha</label>
                                <p>{{ proceso.disposicion_final.fecha_disposicion.strftime('%d/%m/%Y') }}</p>
                            </div>
                            <div class="info-item">
                                <label>Estatus</label>
                                <span class="badge {% if proceso.disposicion_final.estatus == 'Completado' %}badge-green{% else %}badge-yellow{% endif %}">
                                    {{ proceso.disposicion_final.estatus }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

            </div> </div>
    </div>
</div>

<div id="disposicionModal" class="modal-overlay hidden">
    <div class="modal-container">
        <div class="modal-header">
            <h3>Registrar Disposición Final</h3>
            <button type="button" id="closeDisposicionModal" class="btn-icon-close"><i class="fas fa-times"></i></button>
        </div>
        
        <div class="modal-body">
            <form id="disposicionForm" action="{{ url_for('bajas.registrar_disposicion_final', proceso_id=proceso.id) }}" method="POST">
                
                <div class="form-group">
                    <label for="tipo_disposicion">Tipo de Disposición *</label>
                    <select id="tipo_disposicion" name="tipo_disposicion" required>
                        <option value="" disabled selected>Seleccione...</option>
                        <option value="Enajenación">Enajenación (Venta)</option>
                        <option value="Donación">Donación</option>
                        <option value="Destrucción">Destrucción</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="fecha_disposicion">Fecha *</label>
                    <input type="date" id="fecha_disposicion" name="fecha_disposicion" required>
                </div>

                <div id="campo_enajenacion" class="conditional-field hidden">
                    <label for="valor_enajenacion">Valor de Venta *</label>
                    <input type="number" id="valor_enajenacion" name="valor_enajenacion" step="0.01" min="0">
                </div>

                <div id="campo_donacion" class="conditional-field hidden">
                    <label for="nombre_donatario">Nombre del Donatario *</label>
                    <input type="text" id="nombre_donatario" name="nombre_donatario">
                </div>

                <div id="campo_destruccion" class="conditional-field hidden">
                    <label for="detalles_destruccion">Detalles de Destrucción *</label>
                    <textarea id="detalles_destruccion" name="detalles_destruccion" rows="3"></textarea>
                </div>
            </form>
        </div>

        <div class="modal-footer">
            <button type="button" id="cancelDisposicionBtn" class="btn btn-secondary">Cancelar</button>
            <button type="submit" form="disposicionForm" class="btn btn-primary">Guardar</button>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
    /* VARIABLES */
    :root {
        --col-burgundy: #6A2E4D;
        --col-burgundy-dark: #551E3A;
        --col-beige: #BC9B6A;
        --col-beige-light: #fdfbf7;
        --radius: 12px;
        --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        
        --bg-blue: #eff6ff; --text-blue: #1e40af;
        --bg-yellow: #fefce8; --text-yellow: #854d0e;
        --bg-green: #f0fdf4; --text-green: #166534;
        --bg-red: #fef2f2; --text-red: #991b1b;
    }

    /* Layout */
    .page-wrapper { min-height: 100vh; background: #f9fafb; padding: 2rem 1rem; }
    .container-limit { max-width: 1200px; margin: 0 auto; }
    .details-layout { display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; }

    /* Header */
    .header-card {
        background: linear-gradient(to right, var(--col-burgundy), var(--col-burgundy-dark));
        border-radius: var(--radius); padding: 1.5rem 2rem; color: white;
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 2rem; box-shadow: var(--shadow);
    }
    .breadcrumbs a { color: rgba(255,255,255,0.8); text-decoration: none; font-size: 0.9rem; display: block; margin-bottom: 0.5rem; }
    .breadcrumbs a:hover { color: white; text-decoration: underline; }
    .header-content h1 { margin: 0; font-size: 1.5rem; }
    
    /* Status Badge Header */
    .header-status { text-align: right; }
    .status-label { display: block; font-size: 0.8rem; opacity: 0.8; margin-bottom: 0.2rem; }
    .badge { padding: 0.3rem 0.8rem; border-radius: 20px; font-weight: 600; font-size: 0.9rem; display: inline-block; }
    .badge-blue { background: var(--bg-blue); color: var(--text-blue); }
    .badge-yellow { background: var(--bg-yellow); color: var(--text-yellow); }
    .badge-green { background: var(--bg-green); color: var(--text-green); }
    .badge-red { background: var(--bg-red); color: var(--text-red); }
    .badge-gray { background: #f3f4f6; color: #374151; }

    /* Cards */
    .card { background: white; border-radius: var(--radius); box-shadow: var(--shadow); border: 1px solid #e5e7eb; overflow: hidden; margin-bottom: 1.5rem; }
    .card-header { padding: 1rem 1.5rem; border-bottom: 1px solid #f3f4f6; background: rgba(106, 46, 77, 0.03); display: flex; align-items: center; gap: 0.8rem; }
    .icon-box { width: 32px; height: 32px; background: var(--col-burgundy); border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; }
    .card-header h2 { margin: 0; font-size: 1.1rem; color: var(--col-burgundy); }
    .card-body { padding: 1.5rem; }

    /* Línea de Tiempo */
    .timeline-stack { position: relative; padding-left: 1rem; }
    .timeline-stack::before { content: ''; position: absolute; left: 1.9rem; top: 0; bottom: 0; width: 2px; background: #e5e7eb; }
    .timeline-item { display: flex; gap: 1rem; align-items: flex-start; margin-bottom: 1.5rem; position: relative; z-index: 1; }
    
    .timeline-marker {
        width: 30px; height: 30px; border-radius: 50%; background: #e5e7eb; color: #6b7280;
        display: flex; align-items: center; justify-content: center; font-size: 0.8rem;
        border: 2px solid white; box-shadow: 0 0 0 1px #e5e7eb;
    }
    .timeline-item.active .timeline-marker { background: var(--col-burgundy); color: white; box-shadow: 0 0 0 2px rgba(106, 46, 77, 0.2); }
    .timeline-content h4 { margin: 0; font-size: 0.95rem; color: #374151; }
    .timeline-item.active .timeline-content h4 { font-weight: 700; color: var(--col-burgundy); }
    .timeline-content small { color: #6b7280; }

    /* Info Grids */
    .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; }
    .info-stack { display: flex; flex-direction: column; gap: 1rem; }
    .info-item label { font-size: 0.8rem; font-weight: 600; color: #6b7280; text-transform: uppercase; display: block; margin-bottom: 0.2rem; }
    .info-item p { margin: 0; color: #1f2937; }
    .info-item.full-width { grid-column: 1 / -1; }
    .highlight { font-weight: 700; color: var(--col-burgundy); }
    .text-box { background: var(--col-beige-light); padding: 1rem; border-radius: 8px; border: 1px solid #e5e7eb; font-size: 0.9rem; }
    .money { font-family: monospace; font-size: 1.1rem; }
    .grid-2-mini { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }

    /* Checklist */
    .checklist-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
    .checklist-item { display: flex; gap: 0.8rem; padding: 1rem; border: 1px solid #e5e7eb; border-radius: 8px; background: #fafafa; }
    .checklist-item.completed { background: #f0fdf4; border-color: #bbf7d0; }
    .check-icon { width: 24px; height: 24px; border-radius: 50%; background: #e5e7eb; color: #9ca3af; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; }
    .checklist-item.completed .check-icon { background: #22c55e; color: white; }
    .check-name { font-weight: 600; font-size: 0.9rem; margin: 0; color: #374151; }
    .checklist-item.completed .check-name { color: #166534; }
    .check-desc { font-size: 0.75rem; color: #6b7280; margin: 0; }

    /* Upload Action */
    .upload-action-area { text-align: center; padding: 1.5rem; background: rgba(106, 46, 77, 0.05); border: 2px dashed var(--col-burgundy); border-radius: 8px; margin-bottom: 1.5rem; }

    /* Historial Archivos */
    .files-stack { display: flex; flex-direction: column; gap: 1rem; }
    .file-group { background: #fafafa; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; }
    .file-group-header { padding: 0.8rem 1rem; background: #f3f4f6; display: flex; justify-content: space-between; align-items: center; }
    .doc-type { font-weight: 700; color: var(--col-burgundy); font-size: 0.9rem; }
    .doc-uploader { font-size: 0.75rem; color: #6b7280; }
    
    .file-list { padding: 0.5rem; }
    .file-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; border-bottom: 1px solid #eee; }
    .file-item:last-child { border-bottom: none; }
    .file-info { display: flex; align-items: center; gap: 0.8rem; }
    .file-thumb { width: 32px; height: 32px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; }
    .file-icon { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: #e5e7eb; border-radius: 4px; color: #6b7280; }
    .file-name { font-size: 0.85rem; color: #374151; }
    .no-files { padding: 1rem; text-align: center; font-size: 0.85rem; color: #9ca3af; font-style: italic; }

    /* Acciones Sidebar */
    .actions-stack { display: flex; flex-direction: column; gap: 1rem; }
    .alert-info { background: #eff6ff; border-left: 4px solid #3b82f6; padding: 0.8rem; border-radius: 4px; font-size: 0.9rem; color: #1e40af; }
    
    .btn { padding: 0.7rem 1rem; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; transition: all 0.2s; }
    .btn-primary { background: var(--col-burgundy); color: white; }
    .btn-primary:hover { opacity: 0.9; }
    .btn-secondary { background: white; border: 1px solid #d1d5db; color: #374151; }
    .btn-yellow { background: #eab308; color: white; }
    .btn-red { background: #ef4444; color: white; }
    .btn-dark { background: #374151; color: white; }
    .btn-block { width: 100%; }
    .btn-lg { font-size: 1rem; padding: 0.8rem 1.5rem; }
    .btn-icon-small { color: var(--col-burgundy); font-size: 1rem; }

    /* Modal */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center; }
    .modal-container { background: white; width: 90%; max-width: 500px; border-radius: var(--radius); overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
    .modal-header { padding: 1rem 1.5rem; background: var(--col-burgundy); color: white; display: flex; justify-content: space-between; align-items: center; }
    .modal-header h3 { margin: 0; font-size: 1.1rem; }
    .btn-icon-close { background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; }
    
    .modal-body { padding: 1.5rem; max-height: 70vh; overflow-y: auto; }
    .modal-footer { padding: 1rem 1.5rem; background: #f9fafb; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end; gap: 1rem; }
    
    .form-group { margin-bottom: 1rem; }
    .form-group label { display: block; font-weight: 600; font-size: 0.9rem; margin-bottom: 0.4rem; }
    input, select, textarea { width: 100%; padding: 0.7rem; border: 1px solid #d1d5db; border-radius: 8px; }
    .conditional-field { background: var(--col-beige-light); padding: 1rem; border-radius: 8px; border: 1px solid #e5e7eb; margin-top: 1rem; }
    .hidden { display: none; }

    /* Responsive */
    @media (max-width: 900px) {
        .details-layout { grid-template-columns: 1fr; }
        .header-card { flex-direction: column; align-items: flex-start; gap: 1rem; }
        .header-status { align-self: flex-start; }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Modal Disposición ---
    const modal = document.getElementById('disposicionModal');
    const openBtn = document.getElementById('openDisposicionBtn');
    const closeBtn = document.getElementById('closeDisposicionModal');
    const cancelBtn = document.getElementById('cancelDisposicionBtn');
    
    // Elementos condicionales
    const tipoSelect = document.getElementById('tipo_disposicion');
    const campos = {
        'Enajenación': { div: document.getElementById('campo_enajenacion'), input: document.getElementById('valor_enajenacion') },
        'Donación': { div: document.getElementById('campo_donacion'), input: document.getElementById('nombre_donatario') },
        'Destrucción': { div: document.getElementById('campo_destruccion'), input: document.getElementById('detalles_destruccion') }
    };

    if(openBtn) {
        openBtn.onclick = () => modal.classList.remove('hidden');
    }
    
    const closeModal = () => {
        modal.classList.add('hidden');
        document.getElementById('disposicionForm').reset();
        // Ocultar todos los condicionales
        Object.values(campos).forEach(c => {
            c.div.classList.add('hidden');
            c.input.removeAttribute('required');
        });
    };

    if(closeBtn) closeBtn.onclick = closeModal;
    if(cancelBtn) cancelBtn.onclick = closeModal;

    // Lógica de cambio de tipo
    if(tipoSelect) {
        tipoSelect.addEventListener('change', (e) => {
            const val = e.target.value;
            
            // Resetear todo
            Object.values(campos).forEach(c => {
                c.div.classList.add('hidden');
                c.input.removeAttribute('required');
            });

            // Mostrar seleccionado
            if(campos[val]) {
                campos[val].div.classList.remove('hidden');
                campos[val].input.setAttribute('required', 'true');
            }
        });
    }
});
</script>
{% endblock %}