{% extends "base.html" %}

{% block title %}{{ "Editar Resguardo" if resguardo_data.resguardo_id else "Agregar Resguardo" }}{% endblock %}

{% block content %}
<div class="flex-grow flex justify-center items-start p-8">
    <div class="container bg-white p-8 rounded-xl shadow-lg border border-gray-200 w-full max-w-4xl">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">
            {{ "Editar Resguardo" if resguardo_data.resguardo_id else "Agregar Resguardo" }}
        </h1>
        <div class="mb-4 text-gray-500 text-center">
            ID del Resguardo: {{ resguardo_data.resguardo_id }} | ID del Bien: {{ resguardo_data.bien_id }}
        </div>
        
        <form id="resguardoForm" action="{{ url_for('resguardos.editar_resguardo', id_resguardo=resguardo_data.resguardo_id) }}" method="post" enctype="multipart/form-data">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                <div class="col-span-1 md:col-span-2 bg-gray-50 p-6 rounded-lg shadow-sm">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Datos del Resguardo</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="No_Resguardo" class="block text-sm font-medium text-gray-700">No. de Resguardo:</label>
                            <input type="text" id="No_Resguardo" name="No_Resguardo" value="{{ resguardo_data.No_Resguardo or '' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        </div>
                        <div>
                            <label for="Fecha_Resguardo" class="block text-sm font-medium text-gray-700">Fecha de Resguardo:</label>
                            <input type="date" id="Fecha_Resguardo" name="Fecha_Resguardo" value="{{ resguardo_data.Fecha_Resguardo or '' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        </div>
                        <div>
                            <label for="Tipo_De_Resguardo" class="block text-sm font-medium text-gray-700">Tipo de Resguardo:</label>
                            <select id="Tipo_De_Resguardo" name="Tipo_De_Resguardo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                                <option value="1" {% if resguardo_data.Tipo_De_Resguardo == 1 %}selected{% endif %}>Sujeto de Control</option>
                                <option value="0" {% if resguardo_data.Tipo_De_Resguardo == 0 %}selected{% endif %}>Resguardo Normal</option>
                            </select>
                        </div>
                        <div>
                            <label for="No_Trabajador" class="block text-sm font-medium text-gray-700">No. de Trabajador:</label>
                            <input type="text" id="No_Trabajador" name="No_Trabajador" value="{{ resguardo_data.No_Trabajador or '' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        </div>
                        <div>
                            <label for="Puesto" class="block text-sm font-medium text-gray-700">Puesto:</label>
                            <input type="text" id="Puesto" name="Puesto" value="{{ resguardo_data.Puesto or '' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        </div>
                        <div>
                            <label for="Nombre_Director_Jefe_De_Area" class="block text-sm font-medium text-gray-700">Nombre del Director/Jefe de Área:</label>
                            <input type="text" id="Nombre_Director_Jefe_De_Area" name="Nombre_Director_Jefe_De_Area" value="{{ resguardo_data.Nombre_Director_Jefe_De_Area or '' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        </div>
                        <div>
                            <label for="Nombre_Del_Resguardante" class="block text-sm font-medium text-gray-700">Nombre del Resguardante:</label>
                            <input type="text" id="Nombre_Del_Resguardante" name="Nombre_Del_Resguardante" value="{{ resguardo_data.Nombre_Del_Resguardante or '' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        </div>
                        <div>
                            <label for="Area" class="block text-sm font-medium text-gray-700">Área:</label>
                            <select id="Area" name="Area" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                                {% for area in areas %}
                                    <option value="{{ area }}" {% if resguardo_data.Area == area %}selected{% endif %}>{{ area }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>

                <div class="col-span-1 md:col-span-2 bg-gray-50 p-6 rounded-lg shadow-sm">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Datos del Bien</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="No_Inventario" class="block text-sm font-medium text-gray-700">No. de Inventario:</label>
                            <input type="text" id="No_Inventario" name="No_Inventario" value="{{ resguardo_data.No_Inventario or '' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        </div>
                        <div>
                            <label for="Descripcion_Del_Bien" class="block text-sm font-medium text-gray-700">Descripción del Bien:</label>
                            <textarea id="Descripcion_Del_Bien" name="Descripcion_Del_Bien" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">{{ resguardo_data.Descripcion_Del_Bien or '' }}</textarea>
                        </div>
                        <div>
                            <label for="Descripcion_Corta_Del_Bien" class="block text-sm font-medium text-gray-700">Descripción Corta del Bien:</label>
                            <input type="text" id="Descripcion_Corta_Del_Bien" name="Descripcion_Corta_Del_Bien" value="{{ resguardo_data.Descripcion_Corta_Del_Bien or '' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        </div>
                        <div>
                            <label for="No_Factura" class="block text-sm font-medium text-gray-700">No. de Factura:</label>
                            <input type="text" id="No_Factura" name="No_Factura" value="{{ resguardo_data.No_Factura or '' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        </div>
                        <div>
                            <label for="Fecha_Factura" class="block text-sm font-medium text-gray-700">Fecha de Factura:</label>
                            <input type="date" id="Fecha_Factura" name="Fecha_Factura" value="{{ resguardo_data.Fecha_Factura or '' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        </div>
                        <div>
                            <label for="Proveedor" class="block text-sm font-medium text-gray-700">Proveedor:</label>
                            <input type="text" id="Proveedor" name="Proveedor" value="{{ resguardo_data.Proveedor or '' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        </div>
                        <div>
                            <label for="No_Cuenta" class="block text-sm font-medium text-gray-700">No. de Cuenta:</label>
                            <input type="text" id="No_Cuenta" name="No_Cuenta" value="{{ resguardo_data.No_Cuenta or '' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        </div>
                        <div>
                            <label for="Rubro" class="block text-sm font-medium text-gray-700">Rubro:</label>
                            <input type="text" id="Rubro" name="Rubro" value="{{ resguardo_data.Rubro or '' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        </div>
                        <div>
                            <label for="Sub_Cuenta_Armonizadora" class="block text-sm font-medium text-gray-700">Sub-Cuenta Armonizadora:</label>
                            <input type="text" id="Sub_Cuenta_Armonizadora" name="Sub_Cuenta_Armonizadora" value="{{ resguardo_data.Sub_Cuenta_Armonizadora or '' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        </div>
                        <div>
                            <label for="Poliza" class="block text-sm font-medium text-gray-700">Póliza:</label>
                            <input type="text" id="Poliza" name="Poliza" value="{{ resguardo_data.Poliza or '' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        </div>
                        <div>
                            <label for="Fecha_Poliza" class="block text-sm font-medium text-gray-700">Fecha de Póliza:</label>
                            <input type="date" id="Fecha_Poliza" name="Fecha_Poliza" value="{{ resguardo_data.Fecha_Poliza or '' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        </div>
                        <div>
                            <label for="Costo_Inicial" class="block text-sm font-medium text-gray-700">Costo Inicial:</label>
                            <input type="number" id="Costo_Inicial" name="Costo_Inicial" value="{{ resguardo_data.Costo_Inicial or '' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                            
                        </div>
                        <div>
                            <label for="Depreciacion_Acumulada" class="block text-sm font-medium text-gray-700">Depreciación Acumulada:</label>
                            <input type="number" id="Depreciacion_Acumulada" name="Depreciacion_Acumulada" value="{{ resguardo_data.Depreciacion_Acumulada or '' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        </div>
                        <div>
                            <label for="Costo_Final_Cantidad" class="block text-sm font-medium text-gray-700">Costo Final Cantidad:</label>
                            <input type="number" id="Costo_Final_Cantidad" name="Costo_Final_Cantidad" value="{{ resguardo_data.Costo_Final_Cantidad or '' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        </div>
                        <div>
                            <label for="Cantidad" class="block text-sm font-medium text-gray-700">Cantidad:</label>
                            <input type="number" id="Cantidad" name="Cantidad" value="{{ resguardo_data.Cantidad or '' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        </div>
                        <div>
                            <label for="Estado_Del_Bien" class="block text-sm font-medium text-gray-700">Estado del Bien:</label>
                            <input type="text" id="Estado_Del_Bien" name="Estado_Del_Bien" value="{{ resguardo_data.Estado_Del_Bien or '' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        </div>
                        <div>
                            <label for="Marca" class="block text-sm font-medium text-gray-700">Marca:</label>
                            <input type="text" id="Marca" name="Marca" value="{{ resguardo_data.Marca or '' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        </div>
                        <div>
                            <label for="Modelo" class="block text-sm font-medium text-gray-700">Modelo:</label>
                            <input type="text" id="Modelo" name="Modelo" value="{{ resguardo_data.Modelo or '' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        </div>
                        <div>
                            <label for="Numero_De_Serie" class="block text-sm font-medium text-gray-700">Número de Serie:</label>
                            <input type="text" id="Numero_De_Serie" name="Numero_De_Serie" value="{{ resguardo_data.Numero_De_Serie or '' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        </div>
                    </div>
                </div>
                
                <div class="col-span-1 md:col-span-2 bg-gray-50 p-6 rounded-lg shadow-sm">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Imágenes</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="imagenes_bien" class="block text-sm font-medium text-gray-700">Imágenes del Bien:</label>
                            <input type="file" id="imagenes_bien" name="imagenes_bien" multiple class="mt-1 block w-full text-sm text-gray-500
                                file:mr-4 file:py-2 file:px-4
                                file:rounded-full file:border-0
                                file:text-sm file:font-semibold
                                file:bg-blue-50 file:text-blue-700
                                hover:file:bg-blue-100">
                            {% if imagenes_bien_db %}
                                <div class="mt-4 grid grid-cols-2 gap-2">
                                    {% for img in imagenes_bien_db %}
                                        <div class="relative w-full h-24 image-container">
                                            <img src="{{ url_for('static', filename=img.ruta_imagen) }}" alt="Imagen del bien" class="w-full h-full object-cover rounded-md shadow-sm">
                                            <label class="absolute top-1 right-1 bg-red-500 text-white text-xs px-2 py-1 rounded-full cursor-pointer hover:bg-red-700">
                                                <input type="checkbox" name="eliminar_imagen_bien[]" value="{{ img.id }}" class="hidden image-checkbox">
                                                <i class="fas fa-trash"></i>
                                            </label>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div>
                            <label for="imagenes_resguardo" class="block text-sm font-medium text-gray-700">Imágenes del Resguardo:</label>
                            <input type="file" id="imagenes_resguardo" name="imagenes_resguardo" multiple class="mt-1 block w-full text-sm text-gray-500
                                file:mr-4 file:py-2 file:px-4
                                file:rounded-full file:border-0
                                file:text-sm file:font-semibold
                                file:bg-blue-50 file:text-blue-700
                                hover:file:bg-blue-100">
                            {% if imagenes_resguardo_db %}
                                <div class="mt-4 grid grid-cols-2 gap-2">
                                    {% for img in imagenes_resguardo_db %}
                                        <div class="relative w-full h-24 image-container">
                                            <img src="{{ url_for('static', filename=img.ruta_imagen) }}" alt="Imagen del resguardo" class="w-full h-full object-cover rounded-md shadow-sm">
                                            <label class="absolute top-1 right-1 bg-red-500 text-white text-xs px-2 py-1 rounded-full cursor-pointer hover:bg-red-700">
                                                <input type="checkbox" name="eliminar_imagen_resguardo[]" value="{{ img.id }}" class="hidden image-checkbox">
                                                <i class="fas fa-trash"></i>
                                            </label>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-8 flex justify-end space-x-4">
                <button type="submit" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
                    <i class="fas fa-save mr-2"></i> Guardar Cambios
                </button>
                <a href="{{ url_for('resguardos.ver_resguardos') }}" class="inline-flex items-center px-6 py-3 border border-gray-300 text-base font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
                    <i class="fas fa-ban mr-2"></i> Cancelar
                </a>
            </div>
        </form>
    </div>
</div>
<style>
/* Estilos para la imagen seleccionada para eliminar */
.image-container.selected {
    border: 3px solid #ef4444; /* Borde rojo */
    box-shadow: 0 0 10px rgba(239, 68, 68, 0.5); /* Sombra roja sutil */
    border-radius: 0.5rem; /* Asegura que el borde coincida con el borde del div */
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Escuchar el evento de cambio en los checkboxes de las imágenes
    const imageCheckboxes = document.querySelectorAll('.image-checkbox');
    
    imageCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            // Encontrar el contenedor de la imagen más cercano
            const imageContainer = this.closest('.image-container');
            
            // Alternar la clase 'selected'
            if (this.checked) {
                imageContainer.classList.add('selected');
            } else {
                imageContainer.classList.remove('selected');
            }
        });
    });

    // Código para el envío del formulario (mantener sin cambios)
    document.getElementById('resguardoForm').addEventListener('submit', function(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);

        fetch(form.action, {
            method: 'POST',
            body: formData,
        })
        .then(response => {
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                return response.json();
            }
            throw new Error('Respuesta no JSON recibida');
        })
        .then(data => {
            if (data.redirect_url) {
                window.location.href = data.redirect_url;
            } else {
                alert(`${data.category === 'success' ? '✅' : '❌'} ${data.message}`);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Ocurrió un error al guardar los cambios.');
        });
    });
});
</script>
{% endblock %}