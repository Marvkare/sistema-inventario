{# templates/inventarios/reporte_inventario.html #}

{% extends "base.html" %}

{% block title %}Reporte: {{ inventario.nombre }}{% endblock %}

{% block content %}

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">

    <div class="print:hidden">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">Reporte de Conciliación</h1>
                <p class="text-lg text-gray-600">{{ inventario.nombre }}</p>
            </div>
            <div class="flex space-x-2">
                <a href="{{ url_for('inventarios.gestionar_inventario', inventario_id=inventario.id) }}" class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">Regresar</a>
                <button onclick="window.print()" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">Imprimir</button>
                <a href="{{ url_for('inventarios.descargar_reporte_pdf', inventario_id=inventario.id) }}" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-gray-600 hover:bg-gray-700">
        Descargar PDF
    </a>
            </div>
        </div>
        <div class="bg-white p-6 shadow rounded-lg mb-8">
            <h2 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">Información General del Inventario</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6 text-sm">
                <div>
                    <dt class="font-medium text-gray-500 mb-2">Áreas y Jefes Involucrados</dt>
                    <dd class="mt-1 text-gray-900 space-y-2">
                        {% for area, jefe in area_jefe_map.items() %}
                        <div class="p-2 bg-gray-50 rounded">
                            <p class="font-semibold">{{ area }}</p>
                            <p class="text-gray-600 pl-2">- Jefe: {{ jefe }}</p>
                        </div>
                        {% else %}<p>No hay áreas asignadas.</p>{% endfor %}
                    </dd>
                </div>
                <div>
                    <dt class="font-medium text-gray-500 mb-2">Personal de la Brigada</dt>
                    <dd class="mt-1 text-gray-900">
                        <ul class="list-disc list-inside">
                        {% for miembro in brigada %}<li>{{ miembro }}</li>{% else %}<li>No hay personal asignado.</li>{% endfor %}
                        </ul>
                    </dd>
                </div>
            </div>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-5 gap-6 mb-8">
             <div class="bg-white p-5 shadow rounded-lg"><dt class="text-sm font-medium text-gray-500 truncate">Bienes Registrados</dt><dd class="mt-1 text-3xl font-semibold text-gray-900">{{ total_registrado }}</dd></div>
             <div class="bg-red-50 p-5 shadow rounded-lg"><dt class="text-sm font-medium text-red-700 truncate">Faltantes</dt><dd class="mt-1 text-3xl font-semibold text-red-900">{{ (faltantes_por_area.values()|map('length')|sum) }}</dd></div>
             <div class="bg-blue-50 p-5 shadow rounded-lg"><dt class="text-sm font-medium text-blue-700 truncate">Sobrantes</dt><dd class="mt-1 text-3xl font-semibold text-blue-900">{{ bienes_sobrantes|length }}</dd></div>
             <div class="bg-yellow-50 p-5 shadow rounded-lg"><dt class="text-sm font-medium text-yellow-700 truncate">Con Discrepancias</dt><dd class="mt-1 text-3xl font-semibold text-yellow-900">{{ (discrepancias_por_area.values()|map('length')|sum) }}</dd></div>
             <div class="bg-green-50 p-5 shadow rounded-lg">
                <dt class="text-sm font-medium text-green-700 truncate">Correctos</dt>
                <dd class="mt-1 text-3xl font-semibold text-green-900">{{ (correctos_por_area.values()|map('length')|sum) }}</dd></div>
        </div>
    </div>
<div class="space-y-6">
        
    <details class="bg-white shadow-lg rounded-lg overflow-hidden" open>
        <summary class="p-4 cursor-pointer font-medium text-red-800 bg-red-50">Bienes Faltantes</summary>
        <div class="border-t">
        {% for nombre_area, bienes_en_area in faltantes_por_area.items() %}
            <div class="p-4 border-b bg-red-50/50"><h4 class="font-semibold text-gray-700">Área: {{ nombre_area }}</h4></div>
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">No. Inventario</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Descripción</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Verificado por</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                    {% for bien in bienes_en_area %}
                        <tr>
                            <td class="px-4 py-2 text-sm font-mono">{{ bien.No_Inventario }}</td>
                            <td class="px-4 py-2 text-sm">{{ bien.Descripcion_Del_Bien }}</td>
                            <td class="px-4 py-2 text-sm">{{ bien.nombre_verificador or 'No aplica' }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p class="p-4 text-center text-sm text-gray-500">No hay bienes faltantes.</p>
        {% endfor %}
        </div>
    </details>
    
    <details class="bg-white shadow-lg rounded-lg overflow-hidden" open>
        <summary class="p-4 cursor-pointer font-medium text-blue-800 bg-blue-50">Bienes Sobrantes</summary>
        <div class="border-t overflow-x-auto">
            <table class="min-w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Descripción Capturada</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Marca/Modelo/Serie</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Capturado por</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                {% for bien in bienes_sobrantes %}
                    <tr>
                        <td class="px-4 py-2 text-sm">{{ bien.descripcion_bien }}</td>
                        <td class="px-4 py-2 text-sm">{{ bien.marca or 'N/A' }} / {{ bien.modelo or 'N/A' }} / {{ bien.numero_serie or 'N/A' }}</td>
                        <td class="px-4 py-2 text-sm">{{ bien.nombre_capturador or 'N/A' }}</td>
                    </tr>
                {% else %}
                    <tr><td colspan="3" class="text-center p-4 text-sm text-gray-500">No se registraron bienes sobrantes.</td></tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </details>
    
    <details class="bg-white shadow-lg rounded-lg overflow-hidden" open>
        <summary class="p-4 cursor-pointer font-medium text-yellow-800 bg-yellow-50">Bienes con Discrepancias</summary>
        <div class="border-t">
        {% for nombre_area, bienes_en_area in discrepancias_por_area.items() %}
            <div class="p-4 border-b bg-yellow-50/50"><h4 class="font-semibold text-gray-700">Área: {{ nombre_area }}</h4></div>
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">No. Inventario</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Descripción</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Observación</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                    {% for bien in bienes_en_area %}
                        <tr>
                            <td class="px-4 py-2 text-sm font-mono align-top">{{ bien.No_Inventario }}</td>
                            <td class="px-4 py-2 text-sm align-top">{{ bien.Descripcion_Del_Bien }}</td>
                            <td class="px-4 py-2 text-sm align-top">
                                <p><strong>Condición:</strong> {{ bien.condicion_fisica_reportada or 'N/A' }}</p>
                                <p><strong>Obs:</strong> {{ bien.observaciones or 'Ninguna' }}</p>
                                <p><strong>Verificado por:</strong> {{ bien.nombre_verificador or 'N/A' }}</p>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p class="p-4 text-center text-sm text-gray-500">No hay bienes con discrepancias.</p>
        {% endfor %}
        </div>
    </details>

    <details class="bg-white shadow-lg rounded-lg overflow-hidden">
        <summary class="p-4 cursor-pointer font-medium text-gray-700">Bienes Localizados Correctamente</summary>
        <div class="border-t">
        {% for nombre_area, bienes_en_area in correctos_por_area.items() %}
            <div class="p-4 border-b"><h4 class="font-semibold text-gray-700">Área: {{ nombre_area }}</h4></div>
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">No. Inventario</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Descripción</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Verificado por</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                    {% for bien in bienes_en_area %}
                        <tr>
                            <td class="px-4 py-2 text-sm font-mono">{{ bien.No_Inventario }}</td>
                            <td class="px-4 py-2 text-sm">{{ bien.Descripcion_Del_Bien }}</td>
                            <td class="px-4 py-2 text-sm">{{ bien.nombre_verificador or 'N/A' }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p class="p-4 text-center text-sm text-gray-500">No se encontraron bienes sin incidencias.</p>
        {% endfor %}
        </div>
    </details>

    <details class="bg-white shadow-lg rounded-lg overflow-hidden">
        <summary class="p-4 cursor-pointer font-medium text-gray-800">Bitácora de Verificación de Bienes ({{ bienes_revisados|length }})</summary>
        <div class="border-t overflow-x-auto">
            <table class="min-w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">No. Inventario</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Descripción</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Área</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Resultado de la Revisión</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Imágenes</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                {% for bien in bienes_revisados %}
                    <tr>
                        <td class="px-4 py-3 text-sm font-mono align-top">{{ bien.No_Inventario }}</td>
                        <td class="px-4 py-3 text-sm align-top">{{ bien.Descripcion_Del_Bien }}</td>
                        <td class="px-4 py-3 text-sm align-top">{{ bien.nombre_area or 'N/A' }}</td>
                        <td class="px-4 py-3 text-sm align-top">
                            <p><strong>Estatus:</strong> {% if bien.estatus_hallazgo == 'Localizado' %}<span class="font-medium text-green-600">Localizado</span>{% elif bien.estatus_hallazgo == 'Localizado con Discrepancia' %}<span class="font-medium text-yellow-600">Con Discrepancia</span>{% elif bien.estatus_hallazgo == 'No Localizado' %}<span class="font-medium text-red-600">No Localizado</span> {% endif %} </p>
                            <p class="mt-1"><strong>Condición:</strong> {{ bien.condicion_fisica_reportada or 'N/A' }}</p>
                            <p class="mt-1"><strong>Obs:</strong> <span class="text-gray-600">{{ bien.observaciones or 'Ninguna' }}</span></p>
                            <p class="mt-1"><strong>Verificado por:</strong> <span class="font-medium text-gray-800">{{ bien.nombre_verificador or 'N/A' }}</span></p>
                        </td>
                        <td class="px-4 py-3 text-sm align-top">
                            <div class="flex flex-wrap gap-2">
                            {% for foto_path in fotos_por_detalle.get(bien.id, []) %}
                                <a href="{{ url_for('bienes.serve_uploaded_file', filename=foto_path) }}" target="_blank">
                                    <img src="{{ url_for('bienes.serve_uploaded_file', filename=foto_path) }}" class="h-16 w-16 object-cover rounded hover:opacity-75">
                                </a>
                            {% else %}
                                <span class="text-gray-400 text-xs">Sin imágenes</span>
                            {% endfor %}
                            </div>
                        </td>
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="5" class="text-center p-4 text-sm text-gray-500">Aún no se ha revisado ningún bien.</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </details>
</div>

</div>

<style> @media print { body { background-color: white; } .print\:hidden { display: none; } details { page-break-inside: avoid; } } </style>

{% endblock %}