{% extends "base.html" %}

{% block title %}Reporte: {{ inventario.nombre }}{% endblock %}

{% block content %}
<div class="page-wrapper">
    <div class="container-limit">
        
        <div class="header-card no-print">
            <div class="header-content">
                <h1>Reporte de Inventario</h1>
                <p>{{ inventario.nombre }}</p>
            </div>
            <div class="header-actions">
                <a href="{{ url_for('inventarios.gestionar_inventario', inventario_id=inventario.id) }}" 
                   class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Regresar
                </a>
                <button onclick="window.print()" class="btn btn-blue">
                    <i class="fas fa-print"></i> Imprimir
                </button>
                <a href="{{ url_for('inventarios.descargar_reporte_pdf', inventario_id=inventario.id) }}" 
                   target="_blank" class="btn btn-dark">
                    <i class="fas fa-file-pdf"></i> PDF Oficial
                </a>
            </div>
        </div>

        <div class="print-header">
            <h1>Reporte de Resultados: {{ inventario.nombre }}</h1>
            <p>Generado el: <span id="print-date"></span></p>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <div class="icon-box"><i class="fas fa-info-circle"></i></div>
                <h2>Información General</h2>
            </div>
            <div class="card-body">
                <div class="grid-2">
                    <div class="info-section">
                        <h3><i class="fas fa-building"></i> Áreas y Responsables</h3>
                        <div class="list-stack">
                            {% for area, jefe in area_jefe_map.items() %}
                            <div class="list-item">
                                <span class="item-title">{{ area }}</span>
                                <span class="item-desc"><i class="fas fa-user-tie"></i> {{ jefe }}</span>
                            </div>
                            {% else %}
                            <p class="text-muted">No hay áreas asignadas.</p>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="info-section">
                        <h3><i class="fas fa-users"></i> Brigada de Inventario</h3>
                        <div class="list-stack">
                            {% for miembro in brigada %}
                            <div class="list-item">
                                <span class="item-title">{{ miembro.full_name }}</span>
                                <span class="item-desc">({{ miembro.username }})</span>
                            </div>
                            {% else %}
                            <p class="text-muted">No hay personal asignado.</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="stats-dashboard mb-4">
            <div class="stat-card">
                <div class="stat-icon icon-blue"><i class="fas fa-boxes"></i></div>
                <span class="stat-label">Registrados</span>
                <span class="stat-value">{{ total_registrado }}</span>
            </div>
            <div class="stat-card stat-missing">
                <div class="stat-icon icon-red"><i class="fas fa-times-circle"></i></div>
                <span class="stat-label text-red">Faltantes</span>
                <span class="stat-value text-red">{{ (faltantes_por_area.values()|map('length')|sum) }}</span>
            </div>
            <div class="stat-card stat-surplus">
                <div class="stat-icon icon-blue-dark"><i class="fas fa-plus-circle"></i></div>
                <span class="stat-label text-blue">Sobrantes</span>
                <span class="stat-value text-blue">{{ bienes_sobrantes|length }}</span>
            </div>
            <div class="stat-card stat-warning">
                <div class="stat-icon icon-yellow"><i class="fas fa-exclamation-triangle"></i></div>
                <span class="stat-label text-yellow">Discrepancias</span>
                <span class="stat-value text-yellow">{{ (discrepancias_por_area.values()|map('length')|sum) }}</span>
            </div>
            <div class="stat-card stat-success">
                <div class="stat-icon icon-green"><i class="fas fa-check-circle"></i></div>
                <span class="stat-label text-green">Correctos</span>
                <span class="stat-value text-green">{{ (correctos_por_area.values()|map('length')|sum) }}</span>
            </div>
        </div>

        <div class="details-stack">
            
            <details class="accordion-item border-red" open>
                <summary class="accordion-header header-red">
                    <div class="acc-title">
                        <i class="fas fa-times-circle"></i> Bienes Faltantes
                    </div>
                    <span class="badge badge-white-red">{{ (faltantes_por_area.values()|map('length')|sum) }}</span>
                </summary>
                <div class="accordion-body">
                    {% for nombre_area, bienes_en_area in faltantes_por_area.items() %}
                        <div class="sub-header">Área: {{ nombre_area }}</div>
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Descripción</th>
                                        <th>Marca/Modelo/Serie</th>
                                        <th>Capturador</th>
                                        <th>Evidencia</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for bien in bienes_en_area %} <tr>
                                        <td>{{ bien.No_Inventario }} - {{ bien.Descripcion_Del_Bien }}</td>
                                        <td class="text-muted">{{ bien.Marca }} / {{ bien.Modelo }}</td>
                                        <td>{{ bien.nombre_resguardante_esperado }}</td> <td><span class="text-muted">-</span></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="empty-state-row">No hay bienes faltantes.</div>
                    {% endfor %}
                </div>
            </details>
            
            <details class="accordion-item border-blue" open>
                <summary class="accordion-header header-blue">
                    <div class="acc-title">
                        <i class="fas fa-plus-circle"></i> Bienes Sobrantes
                    </div>
                    <span class="badge badge-white-blue">{{ bienes_sobrantes|length }}</span>
                </summary>
                <div class="accordion-body">
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Descripción Capturada</th>
                                    <th>Marca/Modelo/Serie</th>
                                    <th>Capturado por</th>
                                    <th>Fotos</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for bien in bienes_sobrantes %}
                                <tr>
                                    <td>{{ bien.descripcion_bien }}</td>
                                    <td class="text-muted">{{ bien.marca }} {{ bien.modelo }} {{ bien.numero_serie }}</td>
                                    <td>{{ bien.nombre_capturador or 'N/A' }}</td>
                                    <td>
                                        <div class="gallery-mini">
                                            {% for foto_url in fotos_por_sobrante.get(bien.id, []) %}
                                                <a href="{{ foto_url }}" target="_blank"><img src="{{ foto_url }}"></a>
                                            {% else %}
                                                <span class="text-muted small">Sin fotos</span>
                                            {% endfor %}
                                        </div>
                                    </td>
                                </tr>
                                {% else %}
                                <tr><td colspan="4" class="empty-state-row">No hay sobrantes registrados.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </details>
            
            <details class="accordion-item border-yellow" open>
                <summary class="accordion-header header-yellow">
                    <div class="acc-title">
                        <i class="fas fa-exclamation-triangle"></i> Con Discrepancias
                    </div>
                    <span class="badge badge-white-yellow">{{ (discrepancias_por_area.values()|map('length')|sum) }}</span>
                </summary>
                <div class="accordion-body">
                    {% for nombre_area, bienes in discrepancias_por_area.items() %}
                    <div class="sub-header">Área: {{ nombre_area }}</div>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead><tr><th>Inventario</th><th>Descripción</th><th>Observación</th></tr></thead>
                            <tbody>
                                {% for bien in bienes %}
                                <tr>
                                    <td class="font-mono font-bold">{{ bien.No_Inventario }}</td>
                                    <td>{{ bien.Descripcion_Del_Bien }}</td>
                                    <td>
                                        <div class="obs-box">
                                            <strong>Condición:</strong> {{ bien.condicion_fisica_reportada }}<br>
                                            <strong>Obs:</strong> {{ bien.observaciones }}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="empty-state-row">Sin discrepancias.</div>
                    {% endfor %}
                </div>
            </details>

            <details class="accordion-item border-green">
                <summary class="accordion-header header-green">
                    <div class="acc-title">
                        <i class="fas fa-check-circle"></i> Localizados Correctamente
                    </div>
                    <span class="badge badge-white-green">{{ (correctos_por_area.values()|map('length')|sum) }}</span>
                </summary>
                <div class="accordion-body">
                    {% for nombre_area, bienes in correctos_por_area.items() %}
                    <div class="sub-header">Área: {{ nombre_area }}</div>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead><tr><th>Inventario</th><th>Descripción</th><th>Verificado Por</th></tr></thead>
                            <tbody>
                                {% for bien in bienes %}
                                <tr>
                                    <td class="font-mono">{{ bien.No_Inventario }}</td>
                                    <td>{{ bien.Descripcion_Del_Bien }}</td>
                                    <td>{{ bien.nombre_verificador }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="empty-state-row">No hay bienes correctos.</div>
                    {% endfor %}
                </div>
            </details>

            <details class="accordion-item">
                <summary class="accordion-header header-gray">
                    <div class="acc-title"><i class="fas fa-list"></i> Bitácora Completa</div>
                </summary>
                <div class="accordion-body">
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead><tr><th>Inv</th><th>Área</th><th>Estatus</th><th>Fotos</th></tr></thead>
                            <tbody>
                                {% for bien in bienes_revisados %}
                                <tr>
                                    <td class="font-mono">{{ bien.No_Inventario }}</td>
                                    <td>{{ bien.nombre_area }}</td>
                                    <td><span class="badge badge-sm">{{ bien.estatus_hallazgo }}</span></td>
                                    <td>
                                        <div class="gallery-mini">
                                            {% for foto_url in fotos_por_detalle.get(bien.id, []) %}
                                                <a href="{{ foto_url }}" target="_blank"><img src="{{ foto_url }}"></a>
                                            {% endfor %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </details>

        </div>

    </div>
</div>
{% endblock %}

{% block styles %}
<style>
    /* VARIABLES */
    :root {
        --col-burgundy: #6A2E4D; --col-burgundy-dark: #551E3A;
        --col-beige: #BC9B6A; --col-bg: #f9fafb;
        --radius: 12px; --shadow: 0 4px 6px rgba(0,0,0,0.1);
        
        --col-red: #ef4444; --bg-red-light: #fef2f2; --border-red: #fecaca;
        --col-green: #16a34a; --bg-green-light: #f0fdf4; --border-green: #bbf7d0;
        --col-blue: #2563eb; --bg-blue-light: #eff6ff; --border-blue: #bfdbfe;
        --col-yellow: #ca8a04; --bg-yellow-light: #fefce8; --border-yellow: #fef08a;
        --col-gray: #4b5563; --bg-gray-light: #f3f4f6;
    }

    /* Base */
    .page-wrapper { min-height: 100vh; background: var(--col-bg); padding: 2rem 1rem; }
    .container-limit { max-width: 1280px; margin: 0 auto; }
    .mb-4 { margin-bottom: 1.5rem; }

    /* Header */
    .header-card { background: linear-gradient(to right, var(--col-burgundy), var(--col-burgundy-dark)); padding: 1.5rem; border-radius: var(--radius); color: white; display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; box-shadow: var(--shadow); }
    .header-content h1 { margin: 0; font-size: 1.8rem; }
    .header-actions { display: flex; gap: 0.5rem; }
    
    .print-header { display: none; } /* Solo visible en impresión */

    /* Info Card */
    .card { background: white; border-radius: var(--radius); border: 1px solid #e5e7eb; overflow: hidden; box-shadow: var(--shadow); }
    .card-header { padding: 1rem 1.5rem; background: #f9fafb; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; gap: 0.8rem; }
    .icon-box { width: 32px; height: 32px; background: var(--col-burgundy); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; }
    .card-header h2 { margin: 0; font-size: 1.1rem; color: var(--col-burgundy); }
    .card-body { padding: 1.5rem; }

    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
    .info-section h3 { font-size: 1rem; color: var(--col-gray); margin-bottom: 0.8rem; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.5rem; }
    .list-stack { display: flex; flex-direction: column; gap: 0.5rem; }
    .list-item { background: #fdfbf7; padding: 0.6rem 1rem; border-radius: 8px; border: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; }
    .item-title { font-weight: 600; color: #333; }
    .item-desc { font-size: 0.85rem; color: #666; }

    /* Dashboard Stats */
    .stats-dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; }
    .stat-card { background: white; padding: 1.5rem; border-radius: var(--radius); border: 1px solid #e5e7eb; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; flex-direction: column; align-items: center; }
    .stat-icon { width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; margin-bottom: 0.5rem; background: #f3f4f6; color: var(--col-gray); }
    .stat-label { font-size: 0.85rem; font-weight: 600; color: #666; text-transform: uppercase; }
    .stat-value { font-size: 1.8rem; font-weight: 700; color: #333; line-height: 1.2; }

    /* Stat Variants */
    .stat-missing { border-color: var(--border-red); background: var(--bg-red-light); }
    .icon-red { background: #fee2e2; color: var(--col-red); } .text-red { color: var(--col-red); }
    
    .stat-surplus { border-color: var(--border-blue); background: var(--bg-blue-light); }
    .icon-blue-dark { background: #dbeafe; color: var(--col-blue); } .text-blue { color: var(--col-blue); }

    .stat-warning { border-color: var(--border-yellow); background: var(--bg-yellow-light); }
    .icon-yellow { background: #fef9c3; color: var(--col-yellow); } .text-yellow { color: var(--col-yellow); }

    .stat-success { border-color: var(--border-green); background: var(--bg-green-light); }
    .icon-green { background: #dcfce7; color: var(--col-green); } .text-green { color: var(--col-green); }

    /* Acordeones Coloridos */
    .details-stack { display: flex; flex-direction: column; gap: 1rem; }
    details.accordion-item { border: 1px solid #e5e7eb; border-radius: 8px; background: white; overflow: hidden; }
    
    summary.accordion-header { padding: 1rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 600; list-style: none; }
    summary.accordion-header::-webkit-details-marker { display: none; }
    
    .header-red { background: var(--bg-red-light); color: #7f1d1d; border-bottom: 1px solid var(--border-red); }
    .border-red { border-color: var(--border-red); }
    .badge-white-red { background: white; color: var(--col-red); padding: 0.2rem 0.6rem; border-radius: 10px; font-size: 0.8rem; }

    .header-blue { background: var(--bg-blue-light); color: #1e3a8a; border-bottom: 1px solid var(--border-blue); }
    .border-blue { border-color: var(--border-blue); }
    .badge-white-blue { background: white; color: var(--col-blue); padding: 0.2rem 0.6rem; border-radius: 10px; font-size: 0.8rem; }

    .header-yellow { background: var(--bg-yellow-light); color: #713f12; border-bottom: 1px solid var(--border-yellow); }
    .border-yellow { border-color: var(--border-yellow); }
    .badge-white-yellow { background: white; color: var(--col-yellow); padding: 0.2rem 0.6rem; border-radius: 10px; font-size: 0.8rem; }

    .header-green { background: var(--bg-green-light); color: #14532d; border-bottom: 1px solid var(--border-green); }
    .border-green { border-color: var(--border-green); }
    .badge-white-green { background: white; color: var(--col-green); padding: 0.2rem 0.6rem; border-radius: 10px; font-size: 0.8rem; }

    .header-gray { background: #f3f4f6; color: #374151; border-bottom: 1px solid #e5e7eb; }

    .accordion-body { padding: 0; }
    .sub-header { background: rgba(0,0,0,0.02); padding: 0.5rem 1rem; font-size: 0.85rem; font-weight: 600; color: #666; border-bottom: 1px solid #eee; }

    /* Tablas y Contenido */
    .table-responsive { overflow-x: auto; }
    .data-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    .data-table th { text-align: left; padding: 0.8rem; background: #fff; border-bottom: 2px solid #eee; color: #555; font-size: 0.8rem; text-transform: uppercase; }
    .data-table td { padding: 0.8rem; border-bottom: 1px solid #eee; vertical-align: top; }
    .text-muted { color: #666; }
    .small { font-size: 0.8rem; }
    .font-mono { font-family: monospace; font-weight: 600; }
    .empty-state-row { text-align: center; padding: 1.5rem; color: #999; font-style: italic; }

    .obs-box { font-size: 0.85rem; line-height: 1.4; }
    .gallery-mini { display: flex; gap: 5px; flex-wrap: wrap; }
    .gallery-mini img { width: 40px; height: 40px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; }

    /* Botones */
    .btn { padding: 0.6rem 1.2rem; border-radius: 8px; text-decoration: none; font-weight: 600; border: none; cursor: pointer; display: inline-flex; align-items: center; gap: 0.5rem; }
    .btn-blue { background: var(--col-blue); color: white; }
    .btn-secondary { background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); }
    .btn-dark { background: #374151; color: white; }

    /* IMPRESIÓN */
    @media print {
        body { background: white; padding: 0; font-size: 10pt; }
        .page-wrapper { padding: 0; }
        .container-limit { max-width: 100%; }
        
        .no-print { display: none !important; }
        .print-header { display: block; text-align: center; margin-bottom: 20px; border-bottom: 2px solid black; padding-bottom: 10px; }
        
        .stats-dashboard { grid-template-columns: repeat(5, 1fr); gap: 0.5rem; }
        .stat-card { padding: 0.5rem; border: 1px solid #ccc; box-shadow: none; }
        .stat-icon { display: none; } /* Ahorrar tinta */
        
        details { border: 1px solid #000; margin-bottom: 10px; }
        summary { background: #eee !important; color: black !important; font-weight: bold; }
        .badge { border: 1px solid black; color: black !important; background: white !important; }
        
        .data-table th { background: #eee; color: black; font-weight: bold; }
        .data-table td { border-bottom: 1px solid #ccc; }
        
        /* Evitar cortes feos */
        .card, details { page-break-inside: avoid; }
    }

    @media (max-width: 768px) {
        .header-card { flex-direction: column; text-align: center; }
        .grid-2 { grid-template-columns: 1fr; }
    }
</style>

<script>
    document.getElementById('print-date').textContent = new Date().toLocaleDateString();
</script>
{% endblock %}