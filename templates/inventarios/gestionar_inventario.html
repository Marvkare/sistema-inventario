{% extends "base.html" %}

{% block title %}Gestionando: {{ inventario.nombre }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-50 to-beige-light/20 py-8 px-4">
    <div class="max-w-7xl mx-auto">
        
        <!-- Encabezado Principal -->
        <div class="bg-white rounded-2xl shadow-xl border border-beige-light overflow-hidden mb-8">
            <div class="bg-gradient-to-r from-burgundy to-burgundy-dark p-6 text-white">
                <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
                    <div class="flex-1">
                        <h1 class="text-2xl md:text-3xl font-bold">{{ inventario.nombre }}</h1>
                        <p class="text-beige-light mt-2">
                            <i class="fas fa-calendar-alt mr-2"></i>
                            Iniciado el: {{ inventario.fecha_inicio.strftime('%d de %B de %Y') }}
                        </p>
                    </div>
                    <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3">
                        <a href="{{ url_for('inventarios.listar_inventarios') }}" 
                           class="inline-flex items-center px-4 py-2 border-2 border-beige-light text-beige-light hover:bg-beige-light/10 rounded-xl transition-all duration-200">
                            <i class="fas fa-arrow-left mr-2"></i>
                            Regresar
                        </a>

                        {% if inventario.estatus == 'Planificado' %}
                        <form action="{{ url_for('inventarios.cambiar_estatus_inventario', inventario_id=inventario.id, accion='comenzar') }}" method="POST" onsubmit="return confirm('¿Deseas iniciar el levantamiento físico?');">
                            <button type="submit" class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-semibold rounded-xl shadow-lg transition-all duration-300 transform hover:scale-105">
                                <i class="fas fa-play-circle mr-2"></i>
                                Comenzar Levantamiento
                            </button>
                        </form>
                        {% elif inventario.estatus == 'En Progreso' %}
                        <form action="{{ url_for('inventarios.cambiar_estatus_inventario', inventario_id=inventario.id, accion='conciliar') }}" method="POST" onsubmit="return confirm('¿Has terminado de capturar todos los hallazgos?');">
                            <button type="submit" class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-yellow-500 to-yellow-600 hover:from-yellow-600 hover:to-yellow-700 text-white font-semibold rounded-xl shadow-lg transition-all duration-300 transform hover:scale-105">
                                <i class="fas fa-exchange-alt mr-2"></i>
                                Mover a Conciliación
                            </button>
                        </form>
                        {% elif inventario.estatus == 'En Conciliación' %}
                        <form action="{{ url_for('inventarios.cambiar_estatus_inventario', inventario_id=inventario.id, accion='finalizar') }}" method="POST" onsubmit="return confirm('¿Estás seguro de finalizar? Esta acción es irreversible.');">
                            <button type="submit" class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-semibold rounded-xl shadow-lg transition-all duration-300 transform hover:scale-105">
                                <i class="fas fa-flag-checkered mr-2"></i>
                                Finalizar Inventario
                            </button>
                        </form>
                        {% endif %}
                        
                        <span class="inline-flex items-center px-3 py-2 bg-white/10 rounded-xl text-beige-light font-semibold">
                            <i class="fas fa-info-circle mr-2"></i>
                            Estatus: {{ inventario.estatus }}
                        </span>
                    </div>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-2xl shadow-lg border border-beige-light overflow-hidden mb-6">
            <div class="p-6">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-lg font-semibold text-gray-700 flex items-center">
                        <i class="fas fa-users text-burgundy mr-2"></i>
                        Personal de la Brigada
                    </h3>
                    
                    {% if inventario.estatus in ['Planificado', 'En Progreso'] %}
                        <div class="flex items-center gap-2">
                            <button id="abrir-modal-remover-brigada" class="inline-flex items-center px-3 py-1 bg-red-100 hover:bg-red-200 text-red-700 font-semibold rounded-lg text-sm transition-all duration-200">
                                <i class="fas fa-user-minus mr-2"></i>
                                Remover
                            </button>
                            <button id="abrir-modal-brigada" class="inline-flex items-center px-3 py-1 bg-burgundy/10 hover:bg-burgundy/20 text-burgundy font-semibold rounded-lg text-sm transition-all duration-200">
                                <i class="fas fa-plus mr-2"></i>
                                Añadir
                            </button>
                        </div>
                    {% endif %}
                </div>
                
                <div class="bg-beige-light/20 p-4 rounded-xl border border-beige-light">
                    <ul class="space-y-2">
                        {% for miembro in brigada %}
                        <li class="flex items-center text-gray-700">
                            <i class="fas fa-user-check text-burgundy mr-3 text-sm"></i>
                            <span class="font-medium">{{ miembro.full_name }}</span>
                            <span class="text-gray-500 ml-2">({{ miembro.username }})</span>
                        </li>
                        {% else %}
                        <li class="text-gray-500 text-center">No hay personal asignado.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
</div>
        <!-- Pestañas de Navegación -->
        <div class="bg-white rounded-2xl shadow-lg border border-beige-light overflow-hidden mb-6">
            <div class="border-b border-beige-light">
                <nav class="-mb-px flex space-x-8 px-6" aria-label="Tabs">
                    <button id="tab-verificar" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-semibold text-sm border-burgundy text-burgundy flex items-center">
                        <i class="fas fa-clipboard-check mr-2"></i>
                        Bienes a Verificar
                    </button>
                    <button id="tab-sobrantes" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-semibold text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 flex items-center">
                        <i class="fas fa-boxes mr-2"></i>
                        Bienes Sobrantes ({{ sobrantes|length }})
                    </button>
                </nav>
            </div>
        </div>

        <!-- Contenido de Pestaña: Bienes a Verificar -->
        <div id="tab-verificar-content" class="tab-content space-y-6">
            <!-- Encabezado de Sección -->
            <div class="text-center bg-white rounded-2xl shadow-lg border border-beige-light p-6">
                <h2 class="text-xl font-bold text-burgundy mb-2 flex items-center justify-center">
                    <i class="fas fa-tasks mr-3"></i>
                    Cédula de Levantamiento por Área
                </h2>
                <p class="text-gray-600">Haz clic en cada área para ver y gestionar sus bienes correspondientes.</p>
            </div>

            <!-- Barra de Búsqueda -->
            <div class="bg-white rounded-2xl shadow-lg border border-beige-light p-4">
                <label for="search-bienes-input" class="sr-only">Buscar Bien</label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-search text-gray-400"></i>
                    </div>
                    <input type="search" id="search-bienes-input" 
                           placeholder="Buscar por No. Inventario, Descripción, Resguardante..." 
                           class="block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 bg-white">
                </div>
            </div>
            
            <!-- Lista de Áreas y Bienes -->
            {% for nombre_area, detalles_en_area in detalles_agrupados.items() %}
            <details class="bg-white shadow-lg rounded-2xl border border-beige-light overflow-hidden transition-all duration-300" open>
                <summary class="p-6 cursor-pointer flex justify-between items-center font-semibold text-gray-900 hover:bg-beige-light/20 transition-colors duration-200">
                    <div class="flex-1">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-building text-burgundy mr-3 text-lg"></i>
                            <span class="text-lg font-bold">Área: {{ nombre_area }}</span>
                        </div>
                        {% if detalles_en_area and detalles_en_area[0].Nombre_Director_Jefe_De_Area %}
                        <p class="text-sm text-gray-600 flex items-center">
                            <i class="fas fa-user-tie text-burgundy mr-2"></i>
                            Jefe de Área: {{ detalles_en_area[0].Nombre_Director_Jefe_De_Area }}
                        </p>
                        {% endif %}
                    </div>
                    <span class="inline-flex items-center px-4 py-2 bg-burgundy text-white text-sm font-bold rounded-full">
                        <i class="fas fa-box mr-2"></i>
                        {{ detalles_en_area|length }} bienes
                    </span>
                </summary>
                <div class="border-t border-beige-light overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-600">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50 border-b border-beige-light">
                            <tr>
                                <th class="px-6 py-4 font-semibold">No. Inventario</th>
                                <th class="px-6 py-4 font-semibold">Descripción</th>
                                <th class="px-6 py-4 font-semibold">Resguardante Esperado</th>
                                <th class="px-6 py-4 font-semibold">Estatus Hallazgo</th>
                                <th class="px-6 py-4 font-semibold text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-beige-light">
                            {% for detalle in detalles_en_area %}
                            <tr class="bien-row bg-white hover:bg-beige-light/10 transition-colors duration-200">
                                <td class="px-6 py-4 whitespace-nowrap font-mono text-gray-800 font-semibold">
                                    {{ detalle.No_Inventario }}
                                </td>
                                <td class="px-6 py-4 text-gray-700">
                                    {{ detalle.Descripcion_Del_Bien }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-gray-600">
                                    {{ detalle.nombre_resguardante_esperado }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    {% if detalle.estatus_hallazgo == 'Pendiente' %}
                                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-gray-100 text-gray-800 border border-gray-300">
                                            <i class="fas fa-clock mr-1"></i> Pendiente
                                        </span>
                                    {% elif detalle.estatus_hallazgo == 'Localizado' %}
                                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-green-100 text-green-800 border border-green-300">
                                            <i class="fas fa-check-circle mr-1"></i> Localizado
                                        </span>
                                    {% elif detalle.estatus_hallazgo == 'No Localizado' %}
                                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-red-100 text-red-800 border border-red-300">
                                            <i class="fas fa-times-circle mr-1"></i> No Localizado
                                        </span>
                                    {% elif detalle.estatus_hallazgo == 'Localizado con Discrepancia' %}
                                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-yellow-100 text-yellow-800 border border-yellow-300">
                                            <i class="fas fa-exclamation-triangle mr-1"></i> Con Discrepancia
                                        </span>
                                    {% endif %}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-center">
                                    {% if inventario.estatus == 'En Progreso' %}
                                        {% if detalle.estatus_hallazgo == 'Pendiente' %}
                                            <button class="revisar-btn inline-flex items-center text-burgundy hover:text-burgundy-dark font-semibold transition-colors duration-200 group"
                                                    data-detalle-id="{{ detalle.id }}"
                                                    data-inventario-id="{{ detalle.id_inventario }}"
                                                    data-no-inventario="{{ detalle.No_Inventario or '' }}"
                                                    data-descripcion="{{ detalle.Descripcion_Del_Bien or '' }}"
                                                    data-action="revisar">
                                                <i class="fas fa-edit group-hover:scale-110 transition-transform duration-300 mr-2"></i>
                                                Revisar
                                            </button>
                                        {% else %}
                                            <button class="revisar-btn inline-flex items-center text-green-600 hover:text-green-800 font-semibold transition-colors duration-200 group"
                                                    data-detalle-id="{{ detalle.id }}"
                                                    data-inventario-id="{{ detalle.id_inventario }}"
                                                    data-no-inventario="{{ detalle.No_Inventario or '' }}"
                                                    data-descripcion="{{ detalle.Descripcion_Del_Bien or '' }}"
                                                    data-action="editar">
                                                <i class="fas fa-pencil-alt group-hover:scale-110 transition-transform duration-300 mr-2"></i>
                                                Editar
                                            </button>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-gray-400 font-medium">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </details>
            {% else %}
            <div class="bg-white rounded-2xl shadow-lg border border-beige-light p-12 text-center">
                <i class="fas fa-inbox text-4xl text-gray-300 mb-4"></i>
                <h3 class="text-lg font-semibold text-gray-700">No hay bienes asignados</h3>
                <p class="mt-1 text-sm text-gray-500">No se encontraron bienes en las áreas seleccionadas para este inventario.</p>
            </div>
            {% endfor %}
        </div>

        <!-- Contenido de Pestaña: Bienes Sobrantes -->
        <div id="tab-sobrantes-content" class="tab-content hidden">
            <div class="bg-white rounded-2xl shadow-lg border border-beige-light overflow-hidden">
                <div class="p-6 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <div class="flex-1">
                        <h2 class="text-xl font-bold text-burgundy mb-2 flex items-center">
                            <i class="fas fa-boxes mr-3"></i>
                            Bienes Sobrantes Encontrados
                        </h2>
                        <p class="text-gray-600">Bienes encontrados en campo que no estaban en la lista original.</p>
                    </div>
                    {% if inventario.estatus != 'Planificado' %}
                    <button id="abrir-modal-sobrante" class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-semibold rounded-xl shadow-lg transition-all duration-300 transform hover:scale-105">
                        <i class="fas fa-plus-circle mr-2"></i>
                        Registrar Bien Sobrante
                    </button>
                    {% endif %}
                </div>
                
                <div class="border-t border-beige-light overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-600">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50 border-b border-beige-light">
                            <tr>
                                <th class="px-6 py-4 font-semibold">Descripción</th>
                                <th class="px-6 py-4 font-semibold">Marca / Modelo / Serie</th>
                                <th class="px-6 py-4 font-semibold">Estado de Resolución</th>
                                <th class="px-6 py-4 font-semibold text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-beige-light">
                            {% for sobrante in sobrantes %}
                            <tr class="bg-white hover:bg-beige-light/10 transition-colors duration-200">
                                <td class="px-6 py-4 text-gray-700">
                                    {{ sobrante.descripcion_bien }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-gray-600">
                                    {{ sobrante.marca or 'N/A' }} / {{ sobrante.modelo or 'N/A' }} / {{ sobrante.numero_serie or 'N/A' }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-blue-100 text-blue-800 border border-blue-300">
                                        {{ sobrante.estatus_resolucion }}
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-center">
                                    <a href="#" class="inline-flex items-center text-burgundy hover:text-burgundy-dark font-semibold transition-colors duration-200">
                                        <i class="fas fa-cog mr-2"></i>
                                        Gestionar
                                    </a>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="4" class="text-center text-gray-500 py-8">
                                    <i class="fas fa-inbox text-3xl text-gray-300 mb-3"></i>
                                    <p>No se han registrado bienes sobrantes.</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Bien Sobrante -->
<div id="sobrante-modal" class="fixed inset-0 z-50 overflow-y-auto hidden">
    <div class="flex items-end justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500/75 backdrop-blur-sm transition-opacity" id="sobrante-modal-backdrop"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>
        
        <div class="inline-block align-bottom bg-white rounded-2xl text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full border border-beige-light">
            <form action="{{ url_for('inventarios.agregar_sobrante', inventario_id=inventario.id) }}" method="POST" enctype="multipart/form-data">
                <div class="bg-white px-6 pt-6 pb-4">
                    <h3 class="text-xl font-bold text-burgundy mb-4 flex items-center">
                        <i class="fas fa-plus-circle mr-3"></i>
                        Registrar Bien Sobrante
                    </h3>
                    <div class="mt-4 space-y-4">
                        <!-- Los campos del formulario se mantienen exactamente igual -->
                        <div>
                            <label for="sobrante-area" class="block text-sm font-semibold text-gray-700 mb-2">Área donde se encontró</label>
                            <select id="sobrante-area" name="id_area_encontrado" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 bg-white">
                                <option value="" disabled selected>-- Selecciona un área --</option>
                                {% for area in todas_las_areas %}
                                    <option value="{{ area.id }}">{{ area.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div>
                            <label for="sobrante-descripcion" class="block text-sm font-semibold text-gray-700 mb-2">Descripción Detallada</label>
                            <textarea id="sobrante-descripcion" name="descripcion_bien" rows="3" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 bg-white resize-none"></textarea>
                        </div>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="sobrante-marca" class="block text-sm font-semibold text-gray-700 mb-2">Marca</label>
                                <input type="text" name="marca" id="sobrante-marca" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 bg-white">
                            </div>
                            <div>
                                <label for="sobrante-modelo" class="block text-sm font-semibold text-gray-700 mb-2">Modelo</label>
                                <input type="text" name="modelo" id="sobrante-modelo" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 bg-white">
                            </div>
                        </div>
                        <div>
                            <label for="sobrante-serie" class="block text-sm font-semibold text-gray-700 mb-2">Número de Serie</label>
                            <input type="text" name="numero_serie" id="sobrante-serie" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 bg-white">
                        </div>
                        
                        <div>
                            <label for="sobrante-condicion" class="block text-sm font-semibold text-gray-700 mb-2">Condición Física</label>
                            <select id="sobrante-condicion" name="condicion_fisica" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 bg-white">
                                <option>Bueno</option>
                                <option>Regular</option>
                                <option>Malo</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Fotografías</label>
                            <input type="file" name="fotos_sobrante" id="sobrante-fotos-input" multiple class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-semibold file:bg-burgundy file:text-white hover:file:bg-burgundy-dark transition-all duration-200"/>
                            <div id="sobrante-fotos-preview-container" class="mt-4 grid grid-cols-3 sm:grid-cols-4 gap-4">
                                <!-- Preview de imágenes -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-6 py-4 sm:flex sm:flex-row-reverse rounded-b-2xl">
                    <button type="submit" class="w-full inline-flex justify-center items-center px-4 py-3 bg-gradient-to-r from-burgundy to-burgundy-dark hover:from-burgundy-dark hover:to-burgundy text-white font-semibold rounded-xl shadow-lg transition-all duration-300 transform hover:scale-105 sm:ml-3 sm:w-auto sm:text-sm">
                        <i class="fas fa-save mr-2"></i> Registrar
                    </button>
                    <button type="button" id="sobrante-modal-cancelar" class="mt-3 w-full inline-flex justify-center items-center px-4 py-3 border-2 border-gray-300 text-gray-700 font-semibold bg-white hover:bg-gray-50 rounded-xl transition-all duration-200 sm:mt-0 sm:w-auto sm:text-sm">
                        <i class="fas fa-times mr-2"></i> Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="brigada-modal" class="fixed inset-0 z-50 overflow-y-auto hidden">
    <div class="flex items-end justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500/75 backdrop-blur-sm transition-opacity" id="brigada-modal-backdrop"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>
        
        <div class="inline-block align-bottom bg-white rounded-2xl text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full border border-beige-light">
            <form action="{{ url_for('inventarios.agregar_miembros_brigada', inventario_id=inventario.id) }}" method="POST">
                <div class="bg-white px-6 pt-6 pb-4">
                    <h3 class="text-xl font-bold text-burgundy mb-4 flex items-center">
                        <i class="fas fa-user-plus mr-3"></i>
                        Añadir Miembros a la Brigada
                    </h3>
                    <div class="mt-4 space-y-4">
                        <div>
                            <label for="brigada-usuarios" class="block text-sm font-semibold text-gray-700 mb-2">
                                Seleccionar usuarios para añadir
                            </label>
                            <select id="brigada-usuarios" name="user_ids" multiple required 
                                    class="w-full h-60 px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 bg-white">
                                {% for user in usuarios_disponibles %}
                                    <option value="{{ user.id }}">{{ user.full_name }} ({{ user.username }})</option>
                                {% else %}
                                    <option value="" disabled>No hay más usuarios disponibles para añadir.</option>
                                {% endfor %}
                            </select>
                            <p class="text-xs text-gray-500 mt-2">Mantén presionada la tecla Ctrl (o Cmd en Mac) para seleccionar múltiples usuarios.</p>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-6 py-4 sm:flex sm:flex-row-reverse rounded-b-2xl">
                    <button type="submit" class="w-full inline-flex justify-center items-center px-4 py-3 bg-gradient-to-r from-burgundy to-burgundy-dark hover:from-burgundy-dark hover:to-burgundy text-white font-semibold rounded-xl shadow-lg transition-all duration-300 transform hover:scale-105 sm:ml-3 sm:w-auto sm:text-sm">
                        <i class="fas fa-plus-circle mr-2"></i> Añadir Miembros
                    </button>
                    <button type="button" id="brigada-modal-cancelar" class="mt-3 w-full inline-flex justify-center items-center px-4 py-3 border-2 border-gray-300 text-gray-700 font-semibold bg-white hover:bg-gray-50 rounded-xl transition-all duration-200 sm:mt-0 sm:w-auto sm:text-sm">
                        <i class="fas fa-times mr-2"></i> Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="remover-brigada-modal" class="fixed inset-0 z-50 overflow-y-auto hidden">
    <div class="flex items-end justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500/75 backdrop-blur-sm transition-opacity" id="remover-brigada-modal-backdrop"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>
        
        <div class="inline-block align-bottom bg-white rounded-2xl text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full border border-beige-light">
            <form action="{{ url_for('inventarios.remover_miembros_brigada', inventario_id=inventario.id) }}" method="POST">
                <div class="bg-white px-6 pt-6 pb-4">
                    <h3 class="text-xl font-bold text-red-700 mb-4 flex items-center">
                        <i class="fas fa-user-minus mr-3"></i>
                        Remover Miembros de la Brigada
                    </h3>
                    <div class="mt-4 space-y-4">
                        <div>
                            <label for="brigada-usuarios-remover" class="block text-sm font-semibold text-gray-700 mb-2">
                                Seleccionar usuarios para remover
                            </label>
                            <select id="brigada-usuarios-remover" name="user_ids_remover" multiple required 
                                    class="w-full h-60 px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-red-500/50 focus:border-red-500 transition-all duration-200 bg-white">
                                
                                {% for miembro in brigada %}
                                    {% if miembro.id == inventario.id_usuario_creador %}
                                        <option value="{{ miembro.id }}" disabled class="text-gray-400">
                                            {{ miembro.full_name }} (Creador - No se puede remover)
                                        </option>
                                    {% else %}
                                        <option value="{{ miembro.id }}">{{ miembro.full_name }} ({{ miembro.username }})</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                            <p class="text-xs text-gray-500 mt-2">Mantén presionada la tecla Ctrl (o Cmd en Mac) para seleccionar múltiples usuarios.</p>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-6 py-4 sm:flex sm:flex-row-reverse rounded-b-2xl">
                    <button type="submit" class="w-full inline-flex justify-center items-center px-4 py-3 bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white font-semibold rounded-xl shadow-lg transition-all duration-300 transform hover:scale-105 sm:ml-3 sm:w-auto sm:text-sm">
                        <i class="fas fa-trash-alt mr-2"></i> Remover Miembros
                    </button>
                    <button type="button" id="remover-brigada-modal-cancelar" class="mt-3 w-full inline-flex justify-center items-center px-4 py-3 border-2 border-gray-300 text-gray-700 font-semibold bg-white hover:bg-gray-50 rounded-xl transition-all duration-200 sm:mt-0 sm:w-auto sm:text-sm">
                        <i class="fas fa-times mr-2"></i> Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para Revisar/Editar Bien -->
<div id="revisar-modal" class="fixed inset-0 z-50 overflow-y-auto hidden">
    <div class="flex items-end justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500/75 backdrop-blur-sm transition-opacity" id="modal-backdrop"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-2xl text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full border border-beige-light">
            <form method="POST" enctype="multipart/form-data">
                <input type="hidden" name="detalle_id" id="modal-detalle-id">
                <input type="hidden" name="inventario_id" id="modal-inventario-id"> 
                <div id="existing-fotos-container" class="mt-2 grid grid-cols-3 gap-4">
                    <!-- Fotos existentes -->
                </div>
                <div id="fotos-a-eliminar-container"></div>
                <div class="bg-white px-6 pt-6 pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                            <h3 class="text-xl font-bold text-burgundy mb-2 flex items-center" id="modal-title">
                                <i class="fas fa-edit mr-3"></i>
                                Revisar Bien: <span class="font-mono ml-2" id="modal-no-inventario"></span>
                            </h3>
                            <p class="text-sm text-gray-600 bg-beige-light/20 p-3 rounded-xl" id="modal-descripcion"></p>
                        </div>
                    </div>
                    <div class="mt-6 space-y-6">
                        <div>
                            <label class="text-base font-semibold text-gray-900 mb-3 flex items-center">
                                <i class="fas fa-search mr-2"></i>
                                Estatus del Hallazgo
                            </label>
                            <fieldset class="mt-2">
                                <div class="space-y-3">
                                    <div class="flex items-center bg-gray-50 p-3 rounded-xl hover:bg-gray-100 transition-colors duration-200">
                                        <input id="estatus-localizado" name="estatus_hallazgo" type="radio" value="Localizado" class="h-4 w-4 border-gray-300 text-burgundy focus:ring-burgundy/50">
                                        <label for="estatus-localizado" class="ml-3 block text-sm font-medium text-gray-700">Localizado</label>
                                    </div>
                                    <div class="flex items-center bg-gray-50 p-3 rounded-xl hover:bg-gray-100 transition-colors duration-200">
                                        <input id="estatus-no-localizado" name="estatus_hallazgo" type="radio" value="No Localizado" class="h-4 w-4 border-gray-300 text-burgundy focus:ring-burgundy/50">
                                        <label for="estatus-no-localizado" class="ml-3 block text-sm font-medium text-gray-700">No Localizado</label>
                                    </div>
                                    <div class="flex items-center bg-gray-50 p-3 rounded-xl hover:bg-gray-100 transition-colors duration-200">
                                        <input id="estatus-discrepancia" name="estatus_hallazgo" type="radio" value="Localizado con Discrepancia" class="h-4 w-4 border-gray-300 text-burgundy focus:ring-burgundy/50">
                                        <label for="estatus-discrepancia" class="ml-3 block text-sm font-medium text-gray-700">Localizado con Discrepancia</label>
                                    </div>
                                </div>
                            </fieldset>
                        </div>
                        <div>
                            <label for="condicion" class="block text-sm font-semibold text-gray-700 mb-2">Condición Física Reportada</label>
                            <select id="condicion" name="condicion_fisica" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 bg-white">
                                <option value="Bueno">Bueno</option>
                                <option value="Regular">Regular</option>
                                <option value="Malo">Malo</option>
                            </select>
                        </div>
                        <div>
                            <label for="observaciones" class="block text-sm font-semibold text-gray-700 mb-2">Observaciones</label>
                            <textarea id="observaciones" name="observaciones" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-burgundy/50 focus:border-burgundy transition-all duration-200 bg-white resize-none" placeholder="Ej: Ubicado en la oficina contigua, presenta un golpe en la esquina..."></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Añadir Evidencia Fotográfica</label>
                            <input type="file" name="fotos" id="fotos-input" multiple class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-semibold file:bg-burgundy file:text-white hover:file:bg-burgundy-dark transition-all duration-200"/>
                            <div id="fotos-preview-container" class="mt-4 grid grid-cols-3 gap-4">
                                <!-- Preview de imágenes nuevas -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-6 py-4 sm:flex sm:flex-row-reverse rounded-b-2xl">
                    <button type="submit" class="w-full inline-flex justify-center items-center px-4 py-3 bg-gradient-to-r from-burgundy to-burgundy-dark hover:from-burgundy-dark hover:to-burgundy text-white font-semibold rounded-xl shadow-lg transition-all duration-300 transform hover:scale-105">
                        <i class="fas fa-save mr-2"></i> Guardar Cambios
                    </button>
                    <button type="button" id="modal-cancelar" class="mt-3 w-full inline-flex justify-center items-center px-4 py-3 border-2 border-gray-300 text-gray-700 font-semibold bg-white hover:bg-gray-50 rounded-xl transition-all duration-200 sm:mt-0 sm:ml-3 sm:w-auto">
                        <i class="fas fa-times mr-2"></i> Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    .bg-burgundy { background-color: #6A2E4D; }
    .bg-burgundy-dark { background-color: #551E3A; }
    .text-burgundy { color: #6A2E4D; }
    .border-burgundy { border-color: #6A2E4D; }
    .focus\:ring-burgundy\/50:focus { --tw-ring-color: rgb(106 46 77 / 0.5); }
    .focus\:border-burgundy:focus { border-color: #6A2E4D; }
    
    .bg-beige { background-color: #BC9B6A; }
    .bg-beige-light { background-color: #D7C3A0; }
    .text-beige-light { color: #D7C3A0; }
    .border-beige { border-color: #BC9B6A; }
    .border-beige-light { border-color: #D7C3A0; }
    
    .from-burgundy { --tw-gradient-from: #6A2E4D; --tw-gradient-to: rgb(106 46 77 / 0); --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to); }
    .to-burgundy-dark { --tw-gradient-to: #551E3A; }

    .tab-button.active { 
        border-color: #6A2E4D; 
        color: #6A2E4D; 
    }
    .tab-content.hidden { 
        display: none; 
    }
    .preview-image-wrapper {
        position: relative;
    }
    .preview-image {
        width: 100%;
        height: 100px;
        object-fit: cover;
        border-radius: 0.75rem;
        border: 1px solid #D7C3A0;
    }
    .remove-image-btn {
        position: absolute;
        top: -0.5rem;
        right: -0.5rem;
        background-color: #ef4444;
        color: white;
        border-radius: 9999px;
        width: 1.5rem;
        height: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.875rem;
        font-weight: bold;
        cursor: pointer;
        border: 2px solid white;
        transition: background-color 0.2s;
    }
    .remove-image-btn:hover {
        background-color: #dc2626;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // ===================================================================
    // 1. SISTEMA DE TABS
    // ===================================================================
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');
    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            const targetTab = this.id.replace('tab-', '');
            tabButtons.forEach(btn => {
                btn.classList.remove('active', 'border-indigo-500', 'text-indigo-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            this.classList.add('active', 'border-indigo-500', 'text-indigo-600');
            this.classList.remove('border-transparent', 'text-gray-500');
            tabContents.forEach(content => content.classList.add('hidden'));
            document.getElementById(`tab-${targetTab}-content`).classList.remove('hidden');
        });
    });

    // ===================================================================
    // 2. LÓGICA DE LA BARRA DE BÚSQUEDA
    // ===================================================================
    const searchInput = document.getElementById('search-bienes-input');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            const areaDetails = document.querySelectorAll('#tab-verificar-content details');

            areaDetails.forEach(details => {
                const rows = details.querySelectorAll('tbody tr.bien-row');
                let visibleRows = 0;
                rows.forEach(row => {
                    const cellText = Array.from(row.cells).slice(0, 3).map(cell => cell.textContent.toLowerCase()).join(' ');
                    if (cellText.includes(searchTerm)) {
                        row.style.display = '';
                        visibleRows++;
                    } else {
                        row.style.display = 'none';
                    }
                });
                // Ocultar la sección del área si no hay resultados que coincidan
                if (visibleRows === 0 && searchTerm) {
                    details.style.display = 'none';
                } else {
                    details.style.display = '';
                }
            });
        });
    }

    // ===================================================================
    // 3. LÓGICA DE MODALES (REVISAR/EDITAR Y SOBRANTES)
    // ===================================================================

    // --- Constantes para el Modal "Revisar/Editar Bien" ---
    const revisarModal = document.getElementById('revisar-modal');
    const revisarModalBackdrop = document.getElementById('modal-backdrop');
    const revisarModalCancelar = document.getElementById('modal-cancelar');
    const revisarButtons = document.querySelectorAll('.revisar-btn');
    const fotosInput = document.getElementById('fotos-input');
    const previewContainer = document.getElementById('fotos-preview-container');
    const existingFotosContainer = document.getElementById('existing-fotos-container');
    const fotosAEliminarContainer = document.getElementById('fotos-a-eliminar-container');
    let fileStore = new DataTransfer(); // Almacén para manejar los archivos nuevos

    // --- Constantes para el Modal "Bien Sobrante" ---
    const sobranteModal = document.getElementById('sobrante-modal');
    const sobranteModalBackdrop = document.getElementById('sobrante-modal-backdrop');
    const sobranteModalCancelar = document.getElementById('sobrante-modal-cancelar');
    const abrirSobranteButton = document.getElementById('abrir-modal-sobrante');

    // --- Funciones para el Modal "Revisar/Editar Bien" ---
    async function openRevisarModal(button) {
        const detalleId = button.dataset.detalleId;
        const inventarioId = button.dataset.inventarioId;
        const noInventario = button.dataset.noInventario;
        const descripcion = button.dataset.descripcion;
        const action = button.dataset.action;

        // Configuración básica del formulario
        const modalForm = document.querySelector('#revisar-modal form');
        modalForm.action = `/inventarios/detalle/actualizar/${detalleId}`;
        document.getElementById('modal-detalle-id').value = detalleId;
        document.getElementById('modal-inventario-id').value = inventarioId;
        document.getElementById('modal-no-inventario').textContent = noInventario;
        document.getElementById('modal-descripcion').textContent = descripcion;

        if (action === 'editar') {
            try {
                const response = await fetch(`/inventarios/detalle/${detalleId}`);
                if (!response.ok) throw new Error('No se pudieron cargar los datos.');
                const data = await response.json();

                // Llenar formulario con datos existentes
                document.querySelector(`input[name="estatus_hallazgo"][value="${data.estatus_hallazgo}"]`).checked = true;
                document.querySelector('#condicion').value = data.condicion_fisica_reportada;
                document.querySelector('#observaciones').value = data.observaciones;

                // Mostrar fotos existentes
                existingFotosContainer.innerHTML = '';
                data.fotos.forEach(foto => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'preview-image-wrapper';
                    wrapper.id = `foto-existente-${foto.id}`;
                    wrapper.innerHTML = `
                       <img src="/images/${foto.ruta_archivo}" class="preview-image" alt="Foto existente"> 
                        <button type="button" class="remove-image-btn" title="Marcar para eliminar" data-foto-id="${foto.id}">×</button>
                    `;
                    existingFotosContainer.appendChild(wrapper);
                });
            } catch (error) {
                console.error("Error al cargar detalle:", error);
                alert("No se pudo cargar la información para editar. Inténtalo de nuevo.");
                return;
            }
        } else {
            // Acción de REVISAR: Asegurarse de que el estado por defecto sea 'Pendiente'
            const pendienteRadio = document.querySelector('input[name="estatus_hallazgo"][value="Pendiente"]');
            if(pendienteRadio) pendienteRadio.checked = true;
        }

        revisarModal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function closeRevisarModal() {
        if (!revisarModal) return;
        revisarModal.classList.add('hidden');
        document.body.style.overflow = 'auto';
        // Limpieza completa del modal
        document.querySelector('#revisar-modal form').reset();
        previewContainer.innerHTML = '';
        existingFotosContainer.innerHTML = '';
        fotosAEliminarContainer.innerHTML = '';
        fileStore = new DataTransfer();
        if (fotosInput) fotosInput.files = fileStore.files;
    }

    // --- Funciones para el Modal "Bien Sobrante" ---
    function openSobranteModal() {
        if (!sobranteModal) return;
        sobranteModal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function closeSobranteModal() {
        if (!sobranteModal) return;
        sobranteModal.classList.add('hidden');
        document.body.style.overflow = 'auto';

        // Limpieza del formulario y las previsualizaciones de imágenes
        document.querySelector('#sobrante-modal form').reset();
        sobrantePreviewContainer.innerHTML = '';
        sobranteFileStore = new DataTransfer();
        if (sobranteFotosInput) sobranteFotosInput.files = sobranteFileStore.files;
    }

    // --- Asignación de Eventos (Listeners) ---
    revisarButtons.forEach(button => {
        button.addEventListener('click', () => openRevisarModal(button));
    });
    if (revisarModalBackdrop) revisarModalBackdrop.addEventListener('click', closeRevisarModal);
    if (revisarModalCancelar) revisarModalCancelar.addEventListener('click', closeRevisarModal);

    if (abrirSobranteButton) abrirSobranteButton.addEventListener('click', openSobranteModal);
    if (sobranteModalBackdrop) sobranteModalBackdrop.addEventListener('click', closeSobranteModal);
    if (sobranteModalCancelar) sobranteModalCancelar.addEventListener('click', closeSobranteModal);
    
    // Listener para marcar una foto existente para eliminar
    existingFotosContainer.addEventListener('click', function(event) {
        if (event.target.matches('.remove-image-btn')) {
            const fotoId = event.target.dataset.fotoId;
            const wrapper = document.getElementById(`foto-existente-${fotoId}`);
            wrapper.style.display = 'none'; // Ocultar visualmente
            // Añadir un input oculto para que el backend sepa cuál borrar
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'fotos_a_eliminar';
            hiddenInput.value = fotoId;
            fotosAEliminarContainer.appendChild(hiddenInput);
        }
    });

    // ===================================================================
    // 4. LÓGICA PARA PREVISUALIZACIÓN DE IMÁGENES NUEVAS
    // ===================================================================
    if (fotosInput) {
        fotosInput.addEventListener('change', function(event) {
            const files = event.target.files;
            for (const file of files) {
                if (![...fileStore.files].find(f => f.name === file.name && f.size === file.size)) {
                    fileStore.items.add(file);
                }
            }
            fotosInput.files = fileStore.files;
            renderPreviews();
        });
    }

    function renderPreviews() {
        previewContainer.innerHTML = '';
        [...fileStore.files].forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const wrapper = document.createElement('div');
                wrapper.className = 'preview-image-wrapper';
                wrapper.innerHTML = `
                    <img src="${e.target.result}" class="preview-image" alt="Previsualización de ${file.name}">
                    <button type="button" class="remove-image-btn" title="Quitar ${file.name}" data-index="${index}">×</button>
                `;
                wrapper.querySelector('.remove-image-btn').addEventListener('click', removeFile);
                previewContainer.appendChild(wrapper);
            }
            reader.readAsDataURL(file);
        });
    }
    
    function removeFile(event) {
        const indexToRemove = parseInt(event.target.dataset.index, 10);
        const newFiles = new DataTransfer();
        [...fileStore.files].forEach((file, index) => {
            if (index !== indexToRemove) {
                newFiles.items.add(file);
            }
        });
        fileStore = newFiles;
        fotosInput.files = fileStore.files;
        renderPreviews();
    }

    // ===================================================================
    // 5. CERRAR MODALES CON LA TECLA ESCAPE
    // ===================================================================
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            if (revisarModal && !revisarModal.classList.contains('hidden')) {
                closeRevisarModal();
            }
            if (sobranteModal && !sobranteModal.classList.contains('hidden')) {
                closeSobranteModal();
            }
        }
    });
});

// ===================================================================
    // NUEVA SECCIÓN: LÓGICA PARA MODAL "AÑADIR BRIGADA"
    // ===================================================================

    // --- Constantes para el Modal "Añadir Brigada" ---
    const brigadaModal = document.getElementById('brigada-modal');
    const brigadaModalBackdrop = document.getElementById('brigada-modal-backdrop');
    const brigadaModalCancelar = document.getElementById('brigada-modal-cancelar');
    const abrirBrigadaModalBtn = document.getElementById('abrir-modal-brigada');

    // --- Funciones para el Modal "Añadir Brigada" ---
    function openBrigadaModal() {
        if (!brigadaModal) return;
        brigadaModal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function closeBrigadaModal() {
        if (!brigadaModal) return;
        brigadaModal.classList.add('hidden');
        document.body.style.overflow = 'auto';
        // Opcional: resetear el formulario si es necesario
        // document.querySelector('#brigada-modal form').reset();
    }

    // --- Asignación de Eventos (Listeners) ---
    if (abrirBrigadaModalBtn) abrirBrigadaModalBtn.addEventListener('click', openBrigadaModal);
    if (brigadaModalBackdrop) brigadaModalBackdrop.addEventListener('click', closeBrigadaModal);
    if (brigadaModalCancelar) brigadaModalCancelar.addEventListener('click', closeBrigadaModal);


    // ===================================================================
    // 5. CERRAR MODALES CON LA TECLA ESCAPE (MODIFICADO)
    // ===================================================================
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            if (revisarModal && !revisarModal.classList.contains('hidden')) {
                closeRevisarModal();
            }
            if (sobranteModal && !sobranteModal.classList.contains('hidden')) {
                closeSobranteModal();
            }
            // --- LÍNEA AÑADIDA ---
            if (brigadaModal && !brigadaModal.classList.contains('hidden')) {
                closeBrigadaModal();
            }
        }
    });

    // ===================================================================
    // NUEVA SECCIÓN: LÓGICA PARA MODAL "REMOVER BRIGADA"
    // ===================================================================

    // --- Constantes para el Modal "Remover Brigada" ---
    const removerBrigadaModal = document.getElementById('remover-brigada-modal');
    const removerBrigadaModalBackdrop = document.getElementById('remover-brigada-modal-backdrop');
    const removerBrigadaModalCancelar = document.getElementById('remover-brigada-modal-cancelar');
    const abrirRemoverBrigadaBtn = document.getElementById('abrir-modal-remover-brigada');

    // --- Funciones para el Modal "Remover Brigada" ---
    function openRemoverBrigadaModal() {
        if (!removerBrigadaModal) return;
        removerBrigadaModal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function closeRemoverBrigadaModal() {
        if (!removerBrigadaModal) return;
        removerBrigadaModal.classList.add('hidden');
        document.body.style.overflow = 'auto';
    }

    // --- Asignación de Eventos (Listeners) ---
    if (abrirRemoverBrigadaBtn) abrirRemoverBrigadaBtn.addEventListener('click', openRemoverBrigadaModal);
    if (removerBrigadaModalBackdrop) removerBrigadaModalBackdrop.addEventListener('click', closeRemoverBrigadaModal);
    if (removerBrigadaModalCancelar) removerBrigadaModalCancelar.addEventListener('click', closeRemoverBrigadaModal);

    // =CAL MODIFICACIÓN AL MANEJADOR DE LA TECLA 'ESCAPE' ==================
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            if (revisarModal && !revisarModal.classList.contains('hidden')) {
                closeRevisarModal();
            }
            if (sobranteModal && !sobranteModal.classList.contains('hidden')) {
                closeSobranteModal();
            }
            if (brigadaModal && !brigadaModal.classList.contains('hidden')) {
                closeBrigadaModal();
            }
            // --- LÍNEA AÑADIDA ---
            if (removerBrigadaModal && !removerBrigadaModal.classList.contains('hidden')) {
                closeRemoverBrigadaModal();
            }
        }
    });

const sobranteFotosInput = document.getElementById('sobrante-fotos-input');
    const sobrantePreviewContainer = document.getElementById('sobrante-fotos-preview-container');
    let sobranteFileStore = new DataTransfer(); // Almacén de archivos exclusivo para este modal

    if (sobranteFotosInput) {
        sobranteFotosInput.addEventListener('change', function(event) {
            const files = event.target.files;
            for (const file of files) {
                // Evita añadir duplicados
                if (![...sobranteFileStore.files].find(f => f.name === file.name && f.size === file.size)) {
                    sobranteFileStore.items.add(file);
                }
            }
            sobranteFotosInput.files = sobranteFileStore.files;
            renderSobrantePreviews();
        });
    }

    function renderSobrantePreviews() {
        sobrantePreviewContainer.innerHTML = ''; // Limpiar previsualizaciones
        [...sobranteFileStore.files].forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const wrapper = document.createElement('div');
                wrapper.className = 'preview-image-wrapper';
                // Usamos innerHTML para construir el elemento de una vez
                wrapper.innerHTML = `
                    <img src="${e.target.result}" class="preview-image" alt="Previsualización de ${file.name}">
                    <button type="button" class="remove-image-btn" title="Quitar ${file.name}" data-index="${index}">×</button>
                `;
                // Añadimos el listener al botón de eliminar recién creado
                wrapper.querySelector('.remove-image-btn').addEventListener('click', removeSobranteFile);
                sobrantePreviewContainer.appendChild(wrapper);
            }
            reader.readAsDataURL(file);
        });
    }
    
    function removeSobranteFile(event) {
        const indexToRemove = parseInt(event.target.dataset.index, 10);
        const newFiles = new DataTransfer();
        // Reconstruimos la lista de archivos sin el que se eliminó
        [...sobranteFileStore.files].forEach((file, index) => {
            if (index !== indexToRemove) {
                newFiles.items.add(file);
            }
        });
        sobranteFileStore = newFiles;
        sobranteFotosInput.files = sobranteFileStore.files;
        renderSobrantePreviews(); // Re-dibujamos las miniaturas
    }


</script>
{% endblock %}