{% extends "base.html" %}

{% block title %}Gestionando: {{ inventario.nombre }}{% endblock %}

{% block content %}
<div class="page-wrapper">
    <div class="container-limit">
        
        <div class="header-card">
            <div class="header-content">
                <h1>{{ inventario.nombre }}</h1>
                <div class="meta-row">
                    <span><i class="fas fa-calendar-alt"></i> Iniciado: {{ inventario.fecha_inicio.strftime('%d/%m/%Y') }}</span>
                    <span class="status-badge status-{{ inventario.estatus | lower | replace(' ', '-') }}">{{ inventario.estatus }}</span>
                </div>
            </div>
            
            <div class="header-actions">
                <a href="{{ url_for('inventarios.listar_inventarios') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Volver
                </a>

                {% if inventario.estatus == 'Planificado' %}
                    <form action="{{ url_for('inventarios.cambiar_estatus_inventario', inventario_id=inventario.id, accion='comenzar') }}" method="POST" onsubmit="return confirm('¿Iniciar levantamiento físico?');" class="inline-form">
                        <button type="submit" class="btn btn-blue"><i class="fas fa-play"></i> Comenzar</button>
                    </form>
                {% elif inventario.estatus == 'En Progreso' %}
                    <form action="{{ url_for('inventarios.cambiar_estatus_inventario', inventario_id=inventario.id, accion='conciliar') }}" method="POST" onsubmit="return confirm('¿Pasar a etapa de conciliación?');" class="inline-form">
                        <button type="submit" class="btn btn-yellow"><i class="fas fa-balance-scale"></i> Conciliar</button>
                    </form>
                {% elif inventario.estatus == 'En Conciliación' %}
                    <form action="{{ url_for('inventarios.cambiar_estatus_inventario', inventario_id=inventario.id, accion='finalizar') }}" method="POST" onsubmit="return confirm('¿FINALIZAR inventario? Esta acción es irreversible.');" class="inline-form">
                        <button type="submit" class="btn btn-green"><i class="fas fa-flag-checkered"></i> Finalizar</button>
                    </form>
                {% endif %}
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header header-between">
                <div class="header-left">
                    <div class="icon-box"><i class="fas fa-users"></i></div>
                    <h2>Personal de Brigada</h2>
                </div>
                {% if inventario.estatus in ['Planificado', 'En Progreso'] %}
                <div class="header-actions-small">
                    <button type="button" onclick="App.modals.open('remover-brigada-modal')" class="btn btn-sm btn-red-outline" title="Remover miembros">
                        <i class="fas fa-user-minus"></i>
                    </button>
                    <button type="button" onclick="App.modals.open('brigada-modal')" class="btn btn-sm btn-primary-outline" title="Añadir miembros">
                        <i class="fas fa-user-plus"></i> Añadir
                    </button>
                </div>
                {% endif %}
            </div>
            <div class="card-body">
                <div class="brigada-grid">
                    {% for miembro in brigada %}
                    <div class="brigada-badge">
                        <i class="fas fa-user-check"></i>
                        <span class="name">{{ miembro.full_name }}</span>
                        <small>({{ miembro.username }})</small>
                    </div>
                    {% else %}
                    <p class="text-muted italic">No hay personal asignado a la brigada.</p>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="tabs-container">
            <div class="tabs-nav">
                <button class="tab-button active" data-target="tab-verificar">
                    <i class="fas fa-tasks"></i> Bienes a Verificar
                </button>
                <button class="tab-button" data-target="tab-sobrantes">
                    <i class="fas fa-box-open"></i> Sobrantes ({{ sobrantes|length }})
                </button>
            </div>
        </div>

        <div id="tab-verificar" class="tab-content">
            <div class="search-wrapper mb-4">
                <i class="fas fa-search search-icon"></i>
                <input type="text" id="local-search" class="search-input" placeholder="Buscar por No. Inventario, Descripción o Resguardante...">
            </div>

            <div class="accordion-list">
                {% for nombre_area, detalles in detalles_agrupados.items() %}
                <details class="accordion-item" open>
                    <summary class="accordion-header">
                        <div class="acc-title">
                            <i class="fas fa-building"></i>
                            <span>{{ nombre_area }}</span>
                            {% if detalles and detalles[0].Nombre_Director_Jefe_De_Area %}
                            <span class="manager-tag"><i class="fas fa-user-tie"></i> {{ detalles[0].Nombre_Director_Jefe_De_Area }}</span>
                            {% endif %}
                        </div>
                        <span class="badge badge-mono">{{ detalles|length }}</span>
                    </summary>
                    
                    <div class="accordion-body">
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th width="15%">Inventario</th>
                                        <th width="35%">Descripción</th>
                                        <th width="20%">Resguardante</th>
                                        <th width="15%">Estatus</th>
                                        <th width="15%" class="text-center">Acción</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in detalles %}
                                    <tr class="searchable-row">
                                        <td class="font-mono font-bold search-target">{{ item.No_Inventario }}</td>
                                        <td class="search-target">{{ item.Descripcion_Del_Bien }}</td>
                                        <td class="text-muted search-target">{{ item.nombre_resguardante_esperado }}</td>
                                        <td>
                                            {% if item.estatus_hallazgo == 'Pendiente' %}
                                                <span class="badge badge-gray">Pendiente</span>
                                            {% elif item.estatus_hallazgo == 'Localizado' %}
                                                <span class="badge badge-green">Localizado</span>
                                            {% elif item.estatus_hallazgo == 'No Localizado' %}
                                                <span class="badge badge-red">No Localizado</span>
                                            {% else %}
                                                <span class="badge badge-yellow">Discrepancia</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-center">
                                            {% if inventario.estatus == 'En Progreso' %}
                                                <button type="button" 
                                                        class="btn-icon-text"
                                                        onclick="App.inventory.openReviewModal(this)"
                                                        data-id="{{ item.id }}"
                                                        data-inv-id="{{ item.id_inventario }}"
                                                        data-code="{{ item.No_Inventario }}"
                                                        data-desc="{{ item.Descripcion_Del_Bien }}"
                                                        data-action="{{ 'revisar' if item.estatus_hallazgo == 'Pendiente' else 'editar' }}">
                                                    <i class="fas fa-edit"></i> {{ 'Revisar' if item.estatus_hallazgo == 'Pendiente' else 'Editar' }}
                                                </button>
                                            {% else %}
                                                <span class="text-disabled">-</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </details>
                {% else %}
                <div class="empty-state">
                    <i class="fas fa-inbox"></i>
                    <p>No hay bienes asignados para este inventario.</p>
                </div>
                {% endfor %}
            </div>
        </div>

        <div id="tab-sobrantes" class="tab-content hidden">
            <div class="card">
                <div class="card-header header-between">
                    <div class="header-left">
                        <div class="icon-box"><i class="fas fa-boxes"></i></div>
                        <h2>Bienes Sobrantes</h2>
                    </div>
                    {% if inventario.estatus != 'Planificado' %}
                    <button onclick="App.modals.open('sobrante-modal')" class="btn btn-green">
                        <i class="fas fa-plus-circle"></i> Registrar Nuevo
                    </button>
                    {% endif %}
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Descripción</th>
                                    <th>Marca / Modelo / Serie</th>
                                    <th>Ubicación (Área)</th>
                                    <th class="text-center">Condición</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for sob in sobrantes %}
                                <tr>
                                    <td>{{ sob.descripcion_bien }}</td>
                                    <td class="text-muted">
                                        {{ sob.marca or '-' }} / {{ sob.modelo or '-' }} / {{ sob.numero_serie or '-' }}
                                    </td>
                                    <td>{{ sob.nombre_area_encontrado or 'N/A' }}</td>
                                    <td class="text-center"><span class="badge badge-mono">{{ sob.condicion_fisica }}</span></td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="4" class="text-center p-4 text-muted">No se han registrado bienes sobrantes.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<div id="revisar-modal" class="modal-overlay hidden">
    <div class="modal-container">
        <div class="modal-header">
            <h3>Revisión: <span id="rev-code" class="font-mono"></span></h3>
            <button class="btn-close" onclick="App.modals.close('revisar-modal')">&times;</button>
        </div>
        <div class="modal-body">
            <p id="rev-desc" class="alert alert-info mb-4"></p>
            
            <form id="form-revisar">
                <input type="hidden" name="detalle_id" id="rev-id">
                <input type="hidden" name="inventario_id" id="rev-inv-id">

                <div id="rev-existing-photos" class="preview-grid mb-3"></div>
                <div id="rev-photos-delete-container"></div> 

                <div class="form-group">
                    <label>Estatus del Hallazgo</label>
                    <div class="radio-group">
                        <label class="radio-card">
                            <input type="radio" name="estatus_hallazgo" value="Localizado">
                            <span><i class="fas fa-check-circle text-green"></i> Localizado</span>
                        </label>
                        <label class="radio-card">
                            <input type="radio" name="estatus_hallazgo" value="No Localizado">
                            <span><i class="fas fa-times-circle text-red"></i> No Localizado</span>
                        </label>
                        <label class="radio-card">
                            <input type="radio" name="estatus_hallazgo" value="Localizado con Discrepancia">
                            <span><i class="fas fa-exclamation-triangle text-yellow"></i> Discrepancia</span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label>Condición Física</label>
                    <select id="rev-condicion" name="condicion_fisica">
                        <option value="Bueno">Bueno</option>
                        <option value="Regular">Regular</option>
                        <option value="Malo">Malo</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Observaciones</label>
                    <textarea id="rev-obs" name="observaciones" rows="2"></textarea>
                </div>

                <div class="form-group">
                    <label>Añadir Fotos</label>
                    <div class="file-input-wrapper">
                        <input type="file" id="rev-file-input" multiple accept="image/*">
                    </div>
                    <div id="rev-new-photos" class="preview-grid mt-2"></div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="App.modals.close('revisar-modal')">Cancelar</button>
            <button type="button" class="btn btn-primary" onclick="App.inventory.submitReview()">Guardar Cambios</button>
        </div>
    </div>
</div>

<div id="sobrante-modal" class="modal-overlay hidden">
    <div class="modal-container">
        <div class="modal-header">
            <h3>Registrar Bien Sobrante</h3>
            <button class="btn-close" onclick="App.modals.close('sobrante-modal')">&times;</button>
        </div>
        <div class="modal-body">
            <form action="{{ url_for('inventarios.agregar_sobrante', inventario_id=inventario.id) }}" method="POST" enctype="multipart/form-data" id="form-sobrante">
                <div class="form-group">
                    <label>Área de Hallazgo *</label>
                    <select name="id_area_encontrado" required>
                        <option value="" disabled selected>Seleccione...</option>
                        {% for area in todas_las_areas %}
                        <option value="{{ area.id }}">{{ area.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>Descripción *</label>
                    <textarea name="descripcion_bien" rows="2" required></textarea>
                </div>
                <div class="form-grid-2">
                    <div class="form-group"><label>Marca</label><input type="text" name="marca"></div>
                    <div class="form-group"><label>Modelo</label><input type="text" name="modelo"></div>
                </div>
                <div class="form-group"><label>Serie</label><input type="text" name="numero_serie"></div>
                <div class="form-group">
                    <label>Condición</label>
                    <select name="condicion_fisica">
                        <option>Bueno</option><option>Regular</option><option>Malo</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Fotografías</label>
                    <input type="file" name="fotos_sobrante" multiple>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="submit" form="form-sobrante" class="btn btn-primary">Registrar</button>
        </div>
    </div>
</div>

<div id="brigada-modal" class="modal-overlay hidden">
    <div class="modal-container">
        <div class="modal-header"><h3>Añadir a Brigada</h3><button class="btn-close" onclick="App.modals.close('brigada-modal')">&times;</button></div>
        <div class="modal-body">
            <form action="{{ url_for('inventarios.agregar_miembros_brigada', inventario_id=inventario.id) }}" method="POST" id="form-add-brigada">
                <div class="form-group">
                    <label>Usuarios Disponibles (Ctrl+Click para múltiples)</label>
                    <select name="user_ids" multiple class="multi-select" required>
                        {% for user in usuarios_disponibles %}
                        <option value="{{ user.id }}">{{ user.full_name }} ({{ user.username }})</option>
                        {% endfor %}
                    </select>
                </div>
            </form>
        </div>
        <div class="modal-footer"><button type="submit" form="form-add-brigada" class="btn btn-primary">Añadir</button></div>
    </div>
</div>

<div id="remover-brigada-modal" class="modal-overlay hidden">
    <div class="modal-container">
        <div class="modal-header bg-red"><h3>Remover de Brigada</h3><button class="btn-close" onclick="App.modals.close('remover-brigada-modal')">&times;</button></div>
        <div class="modal-body">
            <form action="{{ url_for('inventarios.remover_miembros_brigada', inventario_id=inventario.id) }}" method="POST" id="form-rem-brigada">
                <div class="form-group">
                    <label>Seleccione usuarios a remover</label>
                    <select name="user_ids_remover" multiple class="multi-select" required>
                        {% for m in brigada if m.id != inventario.id_usuario_creador %}
                        <option value="{{ m.id }}">{{ m.full_name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </form>
        </div>
        <div class="modal-footer"><button type="submit" form="form-rem-brigada" class="btn btn-red">Remover</button></div>
    </div>
</div>

<input type="hidden" id="base-url-upload" value="{{ url_for('serve_uploaded_file', filename='') }}">

{% endblock %}

{% block styles %}
<style>
    /* VARIABLES */
    :root {
        --col-burgundy: #6A2E4D;
        --col-burgundy-dark: #551E3A;
        --col-beige: #BC9B6A;
        --col-beige-light: #fdfbf7;
        --col-bg: #f9fafb;
        --radius: 12px;
        --shadow: 0 4px 6px rgba(0,0,0,0.1);
        --border: #e5e7eb;
        
        /* Colores Estado */
        --bg-blue: #eff6ff; --text-blue: #1e40af;
        --bg-green: #f0fdf4; --text-green: #166534;
        --bg-red: #fef2f2; --text-red: #991b1b;
        --bg-yellow: #fefce8; --text-yellow: #854d0e;
    }

    .page-wrapper { min-height: 100vh; background: var(--col-bg); padding: 2rem 1rem; }
    .container-limit { max-width: 1280px; margin: 0 auto; }
    .hidden { display: none !important; }

    /* HEADER */
    .header-card { background: linear-gradient(to right, var(--col-burgundy), #551E3A); padding: 1.5rem; border-radius: var(--radius); color: white; display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; box-shadow: var(--shadow); flex-wrap: wrap; gap: 1rem; }
    .header-content h1 { margin: 0; font-size: 1.6rem; }
    .meta-row { font-size: 0.9rem; opacity: 0.9; margin-top: 0.5rem; display: flex; gap: 1rem; align-items: center; }
    
    .status-badge { padding: 0.2rem 0.6rem; border-radius: 4px; font-weight: bold; text-transform: uppercase; font-size: 0.75rem; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); }
    
    .header-actions { display: flex; gap: 0.5rem; align-items: center; }
    .inline-form { display: inline; }

    /* BRIGADA CARD */
    .card { background: white; border-radius: var(--radius); border: 1px solid var(--border); overflow: hidden; margin-bottom: 1.5rem; }
    .card-header { padding: 1rem 1.5rem; background: #fcfcfc; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 0.8rem; }
    .header-between { justify-content: space-between; }
    .header-left { display: flex; align-items: center; gap: 0.8rem; }
    .icon-box { width: 32px; height: 32px; background: var(--col-burgundy); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
    .card-header h2 { margin: 0; font-size: 1.1rem; color: var(--col-burgundy); }
    .card-body { padding: 1.5rem; }
    
    .brigada-grid { display: flex; flex-wrap: wrap; gap: 0.8rem; }
    .brigada-badge { display: flex; align-items: center; gap: 0.5rem; background: #fdfbf7; padding: 0.5rem 1rem; border-radius: 20px; border: 1px solid var(--border); font-size: 0.9rem; color: #333; }
    .brigada-badge i { color: var(--col-burgundy); }
    .brigada-badge small { color: #666; }

    /* TABS */
    .tabs-nav { display: flex; gap: 2rem; border-bottom: 1px solid var(--border); margin-bottom: 1.5rem; }
    .tab-button { background: none; border: none; padding: 1rem 0; font-weight: 600; color: #666; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.2s; font-size: 1rem; }
    .tab-button:hover { color: var(--col-burgundy); }
    .tab-button.active { color: var(--col-burgundy); border-bottom-color: var(--col-burgundy); }

    /* SEARCH & ACCORDIONS */
    .search-wrapper { position: relative; }
    .search-wrapper i { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #999; }
    .search-input { width: 100%; padding: 0.8rem 1rem 0.8rem 2.5rem; border: 1px solid #d1d5db; border-radius: 8px; outline: none; font-size: 0.95rem; }
    .search-input:focus { border-color: var(--col-burgundy); }

    details.accordion-item { border: 1px solid var(--border); border-radius: 8px; margin-bottom: 1rem; background: white; }
    summary.accordion-header { padding: 1rem; background: #fcfcfc; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 600; list-style: none; }
    summary.accordion-header:hover { background: #f9fafb; }
    .acc-title { display: flex; align-items: center; gap: 0.8rem; color: #333; }
    .acc-title i { color: var(--col-burgundy); }
    .manager-tag { background: #eff6ff; color: #1e40af; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: normal; margin-left: 0.5rem; border: 1px solid #dbeafe; }
    .accordion-body { border-top: 1px solid var(--border); }

    /* TABLE */
    .table-responsive { overflow-x: auto; }
    .data-table { width: 100%; border-collapse: collapse; min-width: 800px; }
    .data-table th { text-align: left; padding: 0.8rem 1rem; background: #f9fafb; color: #666; border-bottom: 1px solid var(--border); font-size: 0.8rem; text-transform: uppercase; }
    .data-table td { padding: 0.8rem 1rem; border-bottom: 1px solid var(--border); vertical-align: middle; font-size: 0.9rem; color: #333; }
    .data-table tr:hover { background: #fdfbf7; }
    .text-center { text-align: center; }
    .font-mono { font-family: monospace; }
    .text-muted { color: #666; }

    /* BADGES */
    .badge { padding: 0.2rem 0.6rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; white-space: nowrap; }
    .badge-mono { background: var(--col-burgundy); color: white; border-radius: 20px; }
    .badge-gray { background: #f3f4f6; color: #4b5563; border: 1px solid #e5e7eb; }
    .badge-green { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
    .badge-red { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
    .badge-yellow { background: #fef9c3; color: #854d0e; border: 1px solid #fef08a; }

    /* BUTTONS */
    .btn { padding: 0.6rem 1rem; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 0.4rem; text-decoration: none; font-size: 0.9rem; transition: all 0.2s; }
    .btn-blue { background: #2563eb; color: white; } .btn-blue:hover { background: #1d4ed8; }
    .btn-yellow { background: #ca8a04; color: white; } .btn-yellow:hover { background: #a16207; }
    .btn-green { background: #16a34a; color: white; } .btn-green:hover { background: #15803d; }
    .btn-secondary { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; }
    .btn-secondary:hover { background: rgba(255,255,255,0.3); }
    .btn-red { background: #dc2626; color: white; }
    .btn-primary { background: var(--col-burgundy); color: white; }
    .btn-sm { padding: 0.3rem 0.6rem; font-size: 0.8rem; }
    
    .btn-red-outline { background: white; border: 1px solid #dc2626; color: #dc2626; }
    .btn-primary-outline { background: white; border: 1px solid var(--col-burgundy); color: var(--col-burgundy); }
    
    .btn-icon-text { background: none; border: 1px solid #e5e7eb; padding: 0.3rem 0.8rem; border-radius: 4px; cursor: pointer; color: var(--col-burgundy); font-size: 0.85rem; }
    .btn-icon-text:hover { background: var(--col-burgundy); color: white; }

    /* MODALES */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; display: flex; align-items: center; justify-content: center; }
    .modal-container { background: white; width: 90%; max-width: 600px; max-height: 90vh; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
    .modal-header { padding: 1rem 1.5rem; background: var(--col-burgundy); color: white; display: flex; justify-content: space-between; align-items: center; }
    .modal-header.bg-red { background: #dc2626; }
    .modal-header h3 { margin: 0; font-size: 1.1rem; }
    .btn-close { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; }
    .modal-body { padding: 1.5rem; overflow-y: auto; }
    .modal-footer { padding: 1rem 1.5rem; border-top: 1px solid #e5e7eb; background: #f9fafb; display: flex; justify-content: flex-end; gap: 1rem; }

    /* FORMULARIOS EN MODAL */
    .form-group { margin-bottom: 1rem; }
    .form-group label { display: block; margin-bottom: 0.4rem; font-weight: 600; font-size: 0.9rem; color: #333; }
    input, select, textarea { width: 100%; padding: 0.6rem; border: 1px solid #d1d5db; border-radius: 6px; }
    .multi-select { height: 150px; }
    .form-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    
    /* Radio Cards */
    .radio-group { display: flex; flex-direction: column; gap: 0.5rem; }
    .radio-card { display: flex; align-items: center; gap: 0.8rem; padding: 0.8rem; border: 1px solid #e5e7eb; border-radius: 6px; cursor: pointer; margin: 0; }
    .radio-card:hover { background: #f9fafb; border-color: #ccc; }
    .radio-card input { width: auto; margin: 0; }
    .radio-card span i { margin-right: 0.5rem; }
    .text-green { color: #166534; } .text-red { color: #991b1b; } .text-yellow { color: #854d0e; }

    /* Previews */
    .preview-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; }
    .preview-image-wrapper { position: relative; height: 80px; border: 1px solid #ddd; border-radius: 6px; overflow: hidden; }
    .preview-image { width: 100%; height: 100%; object-fit: cover; }
    .remove-image-btn { position: absolute; top: 2px; right: 2px; background: #dc2626; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; }

    @media (max-width: 768px) {
        .header-card { flex-direction: column; text-align: center; gap: 1rem; }
        .header-actions { flex-direction: column; width: 100%; }
        .btn { width: 100%; justify-content: center; }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    const App = {
        // --- Módulo de Modales ---
        modals: {
            open: (id) => {
                document.getElementById(id).classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            },
            close: (id) => {
                document.getElementById(id).classList.add('hidden');
                document.body.style.overflow = 'auto';
                // Resetear formularios excepto el de revisión que se carga dinámicamente
                if (id !== 'revisar-modal') {
                    const form = document.querySelector(`#${id} form`);
                    if (form) form.reset();
                }
            }
        },

        // --- Módulo de Tabs ---
        tabs: {
            init: () => {
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.addEventListener('click', () => {
                        // Quitar active
                        document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                        // Activar
                        btn.classList.add('active');
                        document.getElementById(btn.dataset.target).classList.remove('hidden');
                    });
                });
            }
        },

        // --- Módulo de Búsqueda ---
        search: {
            init: () => {
                const input = document.getElementById('local-search');
                if (!input) return;
                input.addEventListener('input', (e) => {
                    const term = e.target.value.toLowerCase();
                    document.querySelectorAll('.accordion-item').forEach(acc => {
                        const rows = acc.querySelectorAll('.searchable-row');
                        let hasMatch = false;
                        rows.forEach(row => {
                            const text = row.querySelector('.search-target').innerText.toLowerCase();
                            if (text.includes(term)) {
                                row.style.display = '';
                                hasMatch = true;
                            } else {
                                row.style.display = 'none';
                            }
                        });
                        acc.style.display = (hasMatch || term === '') ? '' : 'none';
                    });
                });
            }
        },

        // --- Módulo de Inventario (Review) ---
        inventory: {
            fileStore: new DataTransfer(),

            openReviewModal: async (btn) => {
                const ds = btn.dataset;
                document.getElementById('rev-code').textContent = ds.code;
                document.getElementById('rev-desc').textContent = ds.desc;
                document.getElementById('rev-id').value = ds.id;
                document.getElementById('rev-inv-id').value = ds.invId;

                // Resetear UI del modal
                document.getElementById('rev-existing-photos').innerHTML = '';
                document.getElementById('rev-photos-delete-container').innerHTML = '';
                document.getElementById('rev-new-photos').innerHTML = '';
                App.inventory.fileStore = new DataTransfer();
                document.getElementById('rev-file-input').value = '';

                if (ds.action === 'editar') {
                    try {
                        const res = await fetch(`/inventarios/detalle/${ds.id}`);
                        if (res.ok) {
                            const data = await res.json();
                            
                            // Radio Buttons
                            const radio = document.querySelector(`input[name="estatus_hallazgo"][value="${data.estatus_hallazgo}"]`);
                            if (radio) radio.checked = true;
                            
                            document.getElementById('rev-condicion').value = data.condicion_fisica_reportada || 'Bueno';
                            document.getElementById('rev-obs').value = data.observaciones || '';

                            // Fotos Existentes
                            const container = document.getElementById('rev-existing-photos');
                            const baseUrl = document.getElementById('base-url-upload').value; // Helper oculto
                            
                            data.fotos.forEach(f => {
                                // Construir URL limpia
                                let url = baseUrl.replace('filename', '') + f.ruta_archivo.replace(/\\/g, '/');
                                // Si la ruta base termina en / y la archivo empieza en /, quitar uno
                                url = url.replace('//', '/'); 

                                const div = document.createElement('div');
                                div.className = 'preview-image-wrapper';
                                div.id = `exist-${f.id}`;
                                div.innerHTML = `
                                    <img src="${url}" class="preview-image">
                                    <button type="button" class="remove-image-btn" onclick="App.inventory.markDelete(${f.id})">×</button>
                                `;
                                container.appendChild(div);
                            });
                        }
                    } catch (e) { console.error(e); }
                } else {
                    // Default Nuevo
                    document.querySelector('input[name="estatus_hallazgo"][value="Localizado"]').checked = true;
                    document.getElementById('rev-condicion').value = 'Bueno';
                    document.getElementById('rev-obs').value = '';
                }

                App.modals.open('revisar-modal');
            },

            markDelete: (id) => {
                document.getElementById(`exist-${id}`).style.display = 'none';
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'fotos_a_eliminar';
                input.value = id;
                document.getElementById('rev-photos-delete-container').appendChild(input);
            },

            handleFileSelect: (e) => {
                const files = e.target.files;
                for (let file of files) {
                    App.inventory.fileStore.items.add(file);
                }
                e.target.files = App.inventory.fileStore.files;
                App.inventory.renderNewPreviews();
            },

            renderNewPreviews: () => {
                const container = document.getElementById('rev-new-photos');
                container.innerHTML = '';
                [...App.inventory.fileStore.files].forEach((file, idx) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const div = document.createElement('div');
                        div.className = 'preview-image-wrapper';
                        div.innerHTML = `
                            <img src="${e.target.result}" class="preview-image">
                            <button type="button" class="remove-image-btn" onclick="App.inventory.removeNewFile(${idx})">×</button>
                        `;
                        container.appendChild(div);
                    };
                    reader.readAsDataURL(file);
                });
            },

            removeNewFile: (idx) => {
                const dt = new DataTransfer();
                [...App.inventory.fileStore.files].forEach((f, i) => {
                    if (i !== idx) dt.items.add(f);
                });
                App.inventory.fileStore = dt;
                document.getElementById('rev-file-input').files = dt.files;
                App.inventory.renderNewPreviews();
            },

            submitReview: async () => {
                const form = document.getElementById('form-revisar');
                const detalleId = document.getElementById('rev-id').value;
                const formData = new FormData(form);
                
                // Asegurar archivos del DataTransfer
                formData.delete('fotos');
                [...App.inventory.fileStore.files].forEach(f => formData.append('fotos', f));

                try {
                    const res = await fetch(`/inventarios/detalle/actualizar/${detalleId}`, {
                        method: 'POST',
                        body: formData
                    });
                    if (res.ok) {
                        window.location.reload();
                    } else {
                        alert("Error al guardar");
                    }
                } catch (e) {
                    console.error(e);
                    alert("Error de conexión");
                }
            }
        }
    };

    document.addEventListener('DOMContentLoaded', () => {
        App.tabs.init();
        App.search.init();
        
        // Listener input fotos
        const input = document.getElementById('rev-file-input');
        if (input) input.addEventListener('change', App.inventory.handleFileSelect);

        // Tecla Escape para cerrar modales
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal-overlay:not(.hidden)').forEach(m => m.classList.add('hidden'));
                document.body.style.overflow = 'auto';
            }
        });
    });
    
    // Exponer App globalmente para los onclick del HTML
    window.App = App;
</script>
{% endblock %}