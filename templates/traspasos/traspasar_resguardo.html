{% extends "base.html" %}

{% block title %}Traspasar Resguardo{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-50 to-beige-light/20 py-8 px-4">
    <div class="max-w-6xl mx-auto">
        
        <!-- ENCABEZADO MEJORADO -->
        <div class="bg-white rounded-2xl shadow-xl border border-beige-light overflow-hidden mb-8">
            <div class="bg-gradient-to-r from-[#6A2E4D] to-[#551E3A] p-6 text-white">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold">
                            Traspasar Resguardo
                        </h1>
                        <p class="text-[#D7C3A0] mt-2">
                            Sistema de traspaso de resguardos entre áreas y resguardantes
                        </p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="w-10 h-10 bg-[#BC9B6A] rounded-full flex items-center justify-center">
                            <i class="fas fa-exchange-alt text-[#6A2E4D] text-lg"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-lg border border-beige-light overflow-hidden">
            <div class="p-6 md:p-8">
                <!-- Información del Resguardo Anterior -->
                <div class="mb-8 p-6 bg-red-50 rounded-xl border-l-4 border-red-400">
                    <div class="flex items-center mb-4">
                        <div class="w-8 h-8 bg-red-500 rounded-full flex items-center justify-center mr-3">
                            <i class="fas fa-user-slash text-white text-sm"></i>
                        </div>
                        <h3 class="text-xl font-bold text-red-800">Información del Resguardo Anterior</h3>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div class="space-y-2">
                            <p><strong class="font-semibold text-red-700">No. de Resguardo:</strong> {{ resguardo_anterior.No_Resguardo }}</p>
                            <p><strong class="font-semibold text-red-700">Resguardante Anterior:</strong> {{ resguardo_anterior.Nombre_Del_Resguardante }}</p>
                        </div>
                        <div class="space-y-2">
                            <p><strong class="font-semibold text-red-700">Área Anterior:</strong> {{ resguardo_anterior.Area_Anterior_Nombre }}</p>
                            <p><strong class="font-semibold text-red-700">Fecha de Asignación:</strong> {{ resguardo_anterior.Fecha_Resguardo }}</p>
                        </div>
                    </div>
                </div>

                <!-- Datos del Bien -->
                <div class="mb-8 p-6 bg-gray-50 rounded-xl border-l-4 border-gray-400">
                    <div class="flex items-center mb-4">
                        <div class="w-8 h-8 bg-gray-500 rounded-full flex items-center justify-center mr-3">
                            <i class="fas fa-box-open text-white text-sm"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800">Datos del Bien</h3>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div class="space-y-2">
                            <p><strong class="font-semibold text-gray-700">No. de Inventario:</strong> {{ resguardo_anterior.No_Inventario }}</p>
                            <p><strong class="font-semibold text-gray-700">Proveedor:</strong> {{ resguardo_anterior.Proveedor or 'N/A' }}</p>
                        </div>
                        <div class="space-y-2">
                            <p><strong class="font-semibold text-gray-700">Descripción:</strong> {{ resguardo_anterior.Descripcion_Corta_Del_Bien or 'N/A' }}</p>
                            <p><strong class="font-semibold text-gray-700">Número de Serie:</strong> {{ resguardo_anterior.Numero_De_Serie or 'N/A' }}</p>
                        </div>
                    </div>
                </div>

                <!-- Información del Nuevo Resguardante -->
                <div class="mb-8 p-6 bg-green-50 rounded-xl border-l-4 border-green-400">
                    <div class="flex items-center mb-4">
                        <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center mr-3">
                            <i class="fas fa-user-plus text-white text-sm"></i>
                        </div>
                        <h3 class="text-xl font-bold text-green-800">Información del Nuevo Resguardante</h3>
                    </div>
                    
                    <form id="traspasoForm" method="post" enctype="multipart/form-data" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div>
                                <label for="No_Resguardo_Nuevo" class="block text-sm font-semibold text-gray-700 mb-2">No. de Resguardo</label>
                                <input type="text" id="No_Resguardo_Nuevo" name="No_Resguardo_Nuevo" 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-[#6A2E4D]/50 focus:border-[#6A2E4D] transition-all duration-200"
                                       value="{{resguardo_anterior.No_Resguardo}}" required readonly>
                            </div>
                            <div>
                                <label for="Area_Nueva" class="block text-sm font-semibold text-gray-700 mb-2">Área Nueva</label>
                                <select name="Area_Nueva" id="Area_Nueva" 
                                        class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-[#6A2E4D]/50 focus:border-[#6A2E4D] transition-all duration-200" required>
                                    <option value="">Seleccione un área...</option>
                                    {% for area in areas %}
                                        <option value="{{ area.id }}">{{ area.nombre }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div>
                                <label for="Ubicacion_Nueva" class="block text-sm font-semibold text-gray-700 mb-2">Ubicación (Nueva)</label>
                                <input type="text" id="Ubicacion_Nueva" name="Ubicacion_Nueva" 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-[#6A2E4D]/50 focus:border-[#6A2E4D] transition-all duration-200">
                            </div>
                            <div>
                                <label for="Nombre_Del_Resguardante_Nuevo" class="block text-sm font-semibold text-gray-700 mb-2">Nombre del Resguardante (Nuevo)</label>
                                <input type="text" id="Nombre_Del_Resguardante_Nuevo" name="Nombre_Del_Resguardante_Nuevo" 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-[#6A2E4D]/50 focus:border-[#6A2E4D] transition-all duration-200" required>
                            </div>
                            <div>
                                <label for="No_Trabajador_Nuevo" class="block text-sm font-semibold text-gray-700 mb-2">No. Trabajador (Nuevo)</label>
                                <input type="text" id="No_Trabajador_Nuevo" name="No_Trabajador_Nuevo" 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-[#6A2E4D]/50 focus:border-[#6A2E4D] transition-all duration-200">
                            </div>
                            <div>
                                <label for="Puesto_Trabajador_Nuevo" class="block text-sm font-semibold text-gray-700 mb-2">Puesto (Nuevo)</label>
                                <input type="text" id="Puesto_Trabajador_Nuevo" name="Puesto_Trabajador_Nuevo" 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-[#6A2E4D]/50 focus:border-[#6A2E4D] transition-all duration-200">
                            </div>
                            <div>
                                <label for="No_Nomina_Trabajador_Nuevo" class="block text-sm font-semibold text-gray-700 mb-2">No. Nómina (Nuevo)</label>
                                <input type="number" id="No_Nomina_Trabajador_Nuevo" name="No_Nomina_Trabajador_Nuevo" 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-[#6A2E4D]/50 focus:border-[#6A2E4D] transition-all duration-200">
                            </div>
                            <div>
                                <label for="Fecha_Resguardo_Nuevo" class="block text-sm font-semibold text-gray-700 mb-2">Fecha del Resguardo (Nuevo)</label>
                                <input type="date" id="Fecha_Resguardo_Nuevo" name="Fecha_Resguardo_Nuevo" 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-[#6A2E4D]/50 focus:border-[#6A2E4D] transition-all duration-200" required>
                            </div>
                            <div>
                                <label for="Nombre_Director_Jefe_De_Area_Nueva" class="block text-sm font-semibold text-gray-700 mb-2">Nombre Director/Jefe de Área (Nueva)</label>
                                <input type="text" id="Nombre_Director_Jefe_De_Area_Nueva" name="Nombre_Director_Jefe_De_Area_Nueva" 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-[#6A2E4D]/50 focus:border-[#6A2E4D] transition-all duration-200">
                            </div>
                            <div>
                                <label for="Tipo_De_Resguardo_Display" class="block text-sm font-semibold text-gray-700 mb-2">Tipo de Resguardo</label>
                                <input type="text" id="Tipo_De_Resguardo_Display" 
                                       class="w-full px-4 py-3 bg-gray-100 border border-gray-300 rounded-xl" 
                                       value="{% if resguardo_anterior.Tipo_De_Resguardo == 1 %}Sujeto de Control{% else %}Resguardo Normal{% endif %}" readonly>
                                <input type="hidden" name="Tipo_De_Resguardo_Nuevo" value="{{ resguardo_anterior.Tipo_De_Resguardo }}">
                            </div>
                        </div>

                        <!-- Imagen del Bien -->
                        <div class="mt-6">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Imagen del Bien en su Nuevo Estado/Ubicación</label>
                            <input type="file" name="imagen_nuevo_resguardo" id="nuevo-resguardo-fotos-input" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-gray-50 file:text-gray-700 hover:file:bg-gray-100"/>
                            <div id="nuevo-resguardo-fotos-preview-container" class="mt-4 grid grid-cols-2 sm:grid-cols-4 gap-4"></div>
                        </div>

                        <!-- SECCIÓN DE OFICIOS -->
                        <div id="oficios-container" class="space-y-6 mt-8">
                            <!-- Los oficios se generarán dinámicamente aquí -->
                        </div>

                        <!-- BOTONES DE ACCIÓN -->
                        <div class="flex flex-col sm:flex-row justify-between items-center gap-4 mt-8 pt-6 border-t border-gray-200">
                            <button type="button" id="add-oficio-btn" 
                                    class="inline-flex items-center justify-center px-6 py-3 border-2 border-dashed border-[#6A2E4D] text-base font-semibold rounded-xl text-[#6A2E4D] bg-white hover:bg-[#6A2E4D] hover:text-white transition-all duration-200 ease-in-out">
                                <i class="fas fa-plus mr-2"></i> Agregar Oficio de Traspaso
                            </button>
                            <button type="submit" 
                                    class="inline-flex items-center justify-center px-8 py-3 border border-transparent text-base font-semibold rounded-xl shadow-sm text-white bg-gradient-to-r from-[#6A2E4D] to-[#551E3A] hover:from-[#551E3A] hover:to-[#6A2E4D] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#6A2E4D] transition-all duration-200 ease-in-out">
                                <i class="fas fa-save mr-2"></i> Confirmar Traspaso
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<template id="oficio-template">
    <div class="oficio-block mb-8 p-6 bg-blue-50 rounded-xl border-l-4 border-blue-400">
        <div class="flex justify-between items-center mb-4">
            <div class="flex items-center">
                <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center mr-3">
                    <i class="fas fa-file-invoice text-white text-sm"></i>
                </div>
                <h3 class="text-xl font-bold text-blue-800">
                    Oficio de Traspaso #<span class="oficio-number">1</span>
                </h3>
            </div>
            <button type="button" class="remove-oficio-btn text-red-500 hover:text-red-700 transition-colors duration-200" title="Eliminar este oficio">
                <i class="fas fa-trash-alt text-lg"></i>
            </button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Nombre del Solicitante</label>
                <input type="text" name="Nombre_Solicitante" 
                       class="nombre-solicitante-input w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-[#6A2E4D]/50 focus:border-[#6A2E4D] transition-all duration-200" required>
            </div>
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Área Solicitante</label>
                <select name="Area_Solicitante" 
                        class="area-solicitante-select w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-[#6A2E4D]/50 focus:border-[#6A2E4D] transition-all duration-200" required>
                    <option value="" disabled selected>-- Selecciona un área --</option>
                    {% for area in areas %}
                        <option value="{{ area.id }}">{{ area.nombre }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Jefe de Área Solicitante</label>
                <input type="text" name="Jefe_Area_Solicitante" 
                       class="jefe-area-input w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-[#6A2E4D]/50 focus:border-[#6A2E4D] transition-all duration-200" required>
            </div>
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Dependencia</label>
                <input type="text" name="Dependencia_Oficio" 
                       class="dependencia-input w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-[#6A2E4D]/50 focus:border-[#6A2E4D] transition-all duration-200">
            </div>
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Oficio Clave</label>
                <input type="text" name="Oficio_clave" 
                       class="oficio-clave-input w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-[#6A2E4D]/50 focus:border-[#6A2E4D] transition-all duration-200">
            </div>
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Lugar y Fecha</label>
                <input type="date" name="Lugar_Fecha_Oficio" 
                       class="fecha-oficio-input w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-[#6A2E4D]/50 focus:border-[#6A2E4D] transition-all duration-200" required>
            </div>
            <div class="md:col-span-2 lg:col-span-3">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Asunto</label>
                <textarea name="Asunto_Oficio" rows="3" 
                          class="asunto-textarea w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-[#6A2E4D]/50 focus:border-[#6A2E4D] transition-all duration-200" required></textarea>
            </div>
            <div class="md:col-span-2 lg:col-span-3">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Archivos Adjuntos del Oficio</label>
                <input type="file" name="fotos_oficio" 
                       class="file-input-oficio w-full px-4 py-3 border border-gray-300 rounded-xl file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-gray-50 file:text-gray-700 hover:file:bg-gray-100" multiple />
                <div class="fotos-oficio-preview-container mt-4 grid grid-cols-2 sm:grid-cols-4 gap-4"></div>
            </div> 
        </div>
    </div>
</template>

{% endblock %}

{% block styles %}
<style>
    .preview-image-wrapper {
        position: relative;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .preview-image {
        width: 100%;
        height: 120px;
        object-fit: cover;
    }
    
    .remove-image-btn {
        position: absolute;
        top: 4px;
        right: 4px;
        background: rgba(239, 68, 68, 0.9);
        color: white;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
    }
    
    .remove-image-btn:hover {
        background: rgba(220, 38, 38, 0.9);
    }
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const traspasoForm = document.getElementById('traspasoForm');
    const oficiosContainer = document.getElementById('oficios-container');
    const addOficioBtn = document.getElementById('add-oficio-btn');
    const oficioTemplate = document.getElementById('oficio-template');
    let oficioIndex = 0; // Empezamos en 0 para que el primero sea 1

    // Almacén para archivos
    const fileStores = {};

    // ===================================================================
    // FUNCIONES PARA PREVISUALIZACIÓN DE IMÁGENES
    // ===================================================================
    function initializeFileInput(fileInput) {
        if (!fileInput) return;
        
        const inputId = fileInput.id;
        if (!fileStores[inputId]) {
            fileStores[inputId] = [];
        }

        fileInput.addEventListener('change', function(event) {
            const files = Array.from(event.target.files);
            const previewContainer = this.nextElementSibling;
            
            if (!previewContainer) {
                console.error('No se encontró contenedor de preview para:', inputId);
                return;
            }

            // Agregar nuevos archivos al almacén
            files.forEach(file => {
                const exists = fileStores[inputId].some(f => 
                    f.name === file.name && f.size === file.size
                );
                if (!exists) {
                    fileStores[inputId].push(file);
                }
            });

            renderPreviews(inputId, previewContainer);
        });
    }

    function renderPreviews(inputId, container) {
        container.innerHTML = '';
        const files = fileStores[inputId];

        files.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const wrapper = document.createElement('div');
                wrapper.className = 'preview-image-wrapper';
                wrapper.innerHTML = `
                    <img src="${e.target.result}" class="preview-image">
                    <button type="button" class="remove-image-btn" data-input-id="${inputId}" data-index="${index}">×</button>
                `;
                container.appendChild(wrapper);
            };
            reader.readAsDataURL(file);
        });
    }

    // Eliminar imágenes
    document.addEventListener('click', function(e) {
        if (e.target.closest('.remove-image-btn')) {
            const btn = e.target.closest('.remove-image-btn');
            const inputId = btn.dataset.inputId;
            const index = parseInt(btn.dataset.index);
            
            if (fileStores[inputId]) {
                fileStores[inputId].splice(index, 1);
                const fileInput = document.getElementById(inputId);
                const previewContainer = fileInput.nextElementSibling;
                renderPreviews(inputId, previewContainer);
            }
        }
    });

    // ===================================================================
    // FUNCIONES PARA OFICIOS DINÁMICOS
    // ===================================================================
    function createOficio() {
        oficioIndex++;
        const newOficioElement = oficioTemplate.content.cloneNode(true);
        
        // Actualizar número del oficio
        newOficioElement.querySelector('.oficio-number').textContent = oficioIndex;
        
        // Actualizar todos los names e ids con el índice
        const elementsToUpdate = newOficioElement.querySelectorAll('[name]');
        elementsToUpdate.forEach(element => {
            const originalName = element.getAttribute('name');
            const newName = `${originalName}_${oficioIndex}`;
            element.setAttribute('name', newName);
            element.setAttribute('id', newName);
        });
        
        // Agregar al DOM
        oficiosContainer.appendChild(newOficioElement);
        
        // Inicializar el file input
        const newFileInput = oficiosContainer.querySelector(`.oficio-block:last-child .file-input-oficio`);
        if (newFileInput) {
            initializeFileInput(newFileInput);
        }
        
        updateOficioNumbers();
        updateUI();
    }

    function removeOficio(oficioBlock) {
        const fileInput = oficioBlock.querySelector('.file-input-oficio');
        if (fileInput && fileStores[fileInput.id]) {
            delete fileStores[fileInput.id];
        }
        oficioBlock.remove();
        updateOficioNumbers();
        updateUI();
    }

    function updateOficioNumbers() {
        const blocks = oficiosContainer.querySelectorAll('.oficio-block');
        blocks.forEach((block, index) => {
            const numberSpan = block.querySelector('.oficio-number');
            if (numberSpan) {
                numberSpan.textContent = index + 1;
            }
        });
    }

    function updateUI() {
        const oficiosCount = oficiosContainer.querySelectorAll('.oficio-block').length;
        const submitBtn = traspasoForm.querySelector('button[type="submit"]');
        
        // Mostrar/ocultar botón de eliminar según la cantidad
        const removeBtns = oficiosContainer.querySelectorAll('.remove-oficio-btn');
        removeBtns.forEach(btn => {
            btn.style.display = oficiosCount > 1 ? 'block' : 'none';
        });
        
        // Deshabilitar/enabled el botón de enviar
        if (submitBtn) {
            if (oficiosCount === 0) {
                submitBtn.disabled = true;
                submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
                submitBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                submitBtn.classList.add('bg-gray-400');
            } else {
                submitBtn.disabled = false;
                submitBtn.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-gray-400');
                submitBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            }
        }
    }

    // ===================================================================
    // EVENT LISTENERS
    // ===================================================================
    addOficioBtn.addEventListener('click', createOficio);

    oficiosContainer.addEventListener('click', function(e) {
        if (e.target.closest('.remove-oficio-btn')) {
            const oficioBlock = e.target.closest('.oficio-block');
            removeOficio(oficioBlock);
        }
    });

    traspasoForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Validar que haya al menos un oficio
        const oficiosCount = oficiosContainer.querySelectorAll('.oficio-block').length;
        if (oficiosCount === 0) {
            alert('Debe agregar al menos un oficio de traspaso');
            return;
        }

        const formData = new FormData(this);
        
        // Agregar archivos al FormData
        for (const inputId in fileStores) {
            const files = fileStores[inputId];
            const inputName = document.getElementById(inputId)?.name;
            
            if (inputName && files.length > 0) {
                formData.delete(inputName);
                files.forEach(file => {
                    formData.append(inputName, file);
                });
            }
        }
        
        try {
            const response = await fetch(this.action, {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            if (response.ok && result.redirect_url) {
                window.location.href = result.redirect_url;
            } else {
                alert(result.message || 'Error al procesar la solicitud');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error de conexión');
        }
    });

    // ===================================================================
    // INICIALIZACIÓN
    // ===================================================================
    // Crear primer oficio automáticamente
    createOficio();
    
    // Inicializar input de resguardo de fotos
    initializeFileInput(document.getElementById('nuevo-resguardo-fotos-input'));
    
    // Actualizar UI inicial
    updateUI();
});
</script>
{% endblock %}