{% extends "base.html" %}

{% block content %}
<div class="flex-grow flex flex-col items-center p-8">
    <div class="container bg-white p-8 rounded-xl shadow-lg border border-gray-200 w-full max-w-4xl">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="flash-message flash-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="flex justify-between items-center mb-6">
            <h2 class="text-3xl font-bold text-gray-800">
                {% if form_data.id %}
                    Editar Resguardo: {{ form_data.No_Inventario if form_data.No_Inventario is not none else form_data.id }}
                {% else %}
                    Agregar Nuevo Resguardo
                {% endif %}
            </h2>
            <div class="flex space-x-2">
                <a href="{{ url_for('resguardos.crear_resguardo') }}" class="text-gray-600 hover:text-gray-900 transition-colors flex items-center">
                    <i class="fas fa-sync-alt mr-1"></i> Limpiar Formulario
                </a>
            </div>
        </div>



        <form id="resguardoForm"
              method="post"
              enctype="multipart/form-data"
              class="space-y-6">

            

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                
                <div>
                    <label for="No_Factura" class="block text-sm font-medium text-gray-700">No. de Factura</label>
                    <input type="text" id="No_Factura" name="No_Factura" value="{{ form_data.No_Factura if form_data.No_Factura is not none else '' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                </div>

                <div>
                    <label for="No_Inventario" class="block text-sm font-medium text-gray-700">No. de Inventario</label>
                    <input type="text" id="No_Inventario" name="No_Inventario" value="{{ form_data.No_Inventario if form_data.No_Inventario is not none else '' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                </div>
                <div>
                    <label for="No_Resguardo" class="block text-sm font-medium text-gray-700">No. de Resguardo</label>
                    <input type="text" id="No_Resguardo" name="No_Resguardo" value="{{ form_data.No_Resguardo if form_data.No_Resguardo is not none else '' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                </div>

                <div>
                    <label for="No_Cuenta" class="block text-sm font-medium text-gray-700">No. de Cuenta</label>
                    <input type="text" id="No_Cuenta" name="No_Cuenta" value="{{ form_data.No_Cuenta if form_data.No_Cuenta is not none else '' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                </div>
                <div>
                    <label for="No_Trabajador" class="block text-sm font-medium text-gray-700">No. de Trabajador</label>
                    <input type="text" id="No_Trabajador" name="No_Trabajador" value="{{ form_data.No_Trabajador if form_data.No_Trabajador is not none else '' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                </div>

                <div>
                    <label for="Proveedor" class="block text-sm font-medium text-gray-700">Proveedor</label>
                    <input type="text" id="Proveedor" name="Proveedor" value="{{ form_data.Proveedor if form_data.Proveedor is not none else '' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                </div>
                <div>
                    <label for="Fecha_Resguardo" class="block text-sm font-medium text-gray-700">Fecha de Resguardo</label>
                    <input type="date" id="Fecha_Resguardo" name="Fecha_Resguardo" value="{{ form_data.Fecha_Resguardo if form_data.Fecha_Resguardo is not none else '' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                </div>

                <div>
                    <label for="Descripcion_Del_Bien" class="block text-sm font-medium text-gray-700">Descripción del Bien</label>
                    <textarea id="Descripcion_Del_Bien" name="Descripcion_Del_Bien" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">{{ form_data.Descripcion_Del_Bien if form_data.Descripcion_Del_Bien is not none else '' }}</textarea>
                </div>
                <div>
                    <label for="Descripcion_Corta_Del_Bien" class="block text-sm font-medium text-gray-700">Descripción corta el bien</label>
                    <textarea id="Descripcion_Corta_Del_Bien" name="Descripcion_Corta_Del_Bien" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">{{ form_data.Descripcion_Corta_Del_Bien if form_data.Descripcion_Corta_Del_Bien is not none else '' }}</textarea>
                </div>

                {# MODIFICACIÓN AQUÍ: Selector de Área con botones #}
                <div>
                    <label for="Area" class="block text-sm font-medium text-gray-700">Área</label>
                    <div class="flex items-center space-x-2 mt-1">
                        <select id="Area" name="Area" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                            <option value="">Selecciona un área</option>
                            {% for area in areas %}
                                <option value="{{ area }}" {% if form_data.Area == area %}selected{% endif %}>{{ area }}</option>
                            {% endfor %}
                        </select>
                        <button type="button" id="addAreaBtn" class="bg-green-500 text-white p-2 rounded-md shadow-sm hover:bg-green-600 transition-colors" title="Agregar Nueva Área">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button type="button" id="refreshAreasBtn" class="bg-gray-400 text-white p-2 rounded-md shadow-sm hover:bg-gray-500 transition-colors" title="Refrescar Áreas">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
                {# FIN MODIFICACIÓN #}

                <div>
                    <label for="Rubro" class="block text-sm font-medium text-gray-700">Rubro</label>
                    <input type="text" id="Rubro" name="Rubro" value="{{ form_data.Rubro if form_data.Rubro is not none else '' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                </div>

                <div>
                    <label for="Poliza" class="block text-sm font-medium text-gray-700">Póliza</label>
                    <input type="text" id="Poliza" name="Poliza" value="{{ form_data.Poliza if form_data.Poliza is not none else '' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                </div>
                <div>
                    <label for="Fecha_Poliza" class="block text-sm font-medium text-gray-700">Fecha de Póliza</label>
                    <input type="date" id="Fecha_Poliza" name="Fecha_Poliza" value="{{ form_data.Fecha_Poliza if form_data.Fecha_Poliza is not none else '' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                </div>

                <div>
                    <label for="Sub_Cuenta_Armonizadora" class="block text-sm font-medium text-gray-700">Sub-Cuenta Armonizadora</label>
                    <input type="text" id="Sub_Cuenta_Armonizadora" name="Sub_Cuenta_Armonizadora" value="{{ form_data.Sub_Cuenta_Armonizadora if form_data.Sub_Cuenta_Armonizadora is not none else '' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                </div>
                <div>
                    <label for="Fecha_Factura" class="block text-sm font-medium text-gray-700">Fecha de Factura</label>
                    <input type="date" id="Fecha_Factura" name="Fecha_Factura" value="{{ form_data.Fecha_Factura if form_data.Fecha_Factura is not none else '' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                </div>

                <div>
                    <label for="Costo_Inicial" class="block text-sm font-medium text-gray-700">Costo Inicial</label>
                    <input type="number" step="0.01" id="Costo_Inicial" name="Costo_Inicial" value="{{ form_data.Costo_Inicial if form_data.Costo_Inicial is not none else '' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                </div>
                <div>
                    <label for="Depreciacion_Acumulada" class="block text-sm font-medium text-gray-700">Depreciación Acumulada</label>
                    <input type="number" step="0.01" id="Depreciacion_Acumulada" name="Depreciacion_Acumulada" value="{{ form_data.Depreciacion_Acumulada if form_data.Depreciacion_Acumulada is not none else '' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                </div>

                <div>
                    <label for="Costo_Final_Cantidad" class="block text-sm font-medium text-gray-700">Costo Final</label>
                    <input type="number" step="0.01" id="Costo_Final_Cantidad" name="Costo_Final_Cantidad" value="{{ form_data.Costo_Final_Cantidad if form_data.Costo_Final_Cantidad is not none else '' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                </div>
                <div>
                    <label for="Cantidad" class="block text-sm font-medium text-gray-700">Cantidad</label>
                    <input type="number" id="Cantidad" name="Cantidad" value="{{ form_data.Cantidad if form_data.Cantidad is not none else '' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                </div>

                
                

                <div>
                    <label for="Nombre_Director_Jefe_De_Area" class="block text-sm font-medium text-gray-700">Nombre Director/Jefe de Área</label>
                    <input type="text" id="Nombre_Director_Jefe_De_Area" name="Nombre_Director_Jefe_De_Area" value="{{ form_data.Nombre_Director_Jefe_De_Area if form_data.Nombre_Director_Jefe_De_Area is not none else '' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                </div>
                <div>
                    <label for="Tipo_De_Resguardo" class="block text-sm font-medium text-gray-700">Tipo de Resguardo</label>
                    <select id="Tipo_De_Resguardo" name="Tipo_De_Resguardo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                        <option value="1" {% if form_data.Tipo_De_Resguardo == 1 %}selected{% endif %}>Sujeto de Control</option>
                        <option value="0" {% if form_data.Tipo_De_Resguardo == 0 %}selected{% endif %}>Resguardo Normal</option>
                    </select>
                </div>

                <div>
                    <label for="Adscripcion_Direccion_Area" class="block text-sm font-medium text-gray-700">Adscripción Dirección Área</label>
                    <input type="text" id="Adscripcion_Direccion_Area" name="Adscripcion_Direccion_Area" value="{{ form_data.Adscripcion_Direccion_Area if form_data.Adscripcion_Direccion_Area is not none else '' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                </div>
                <div>
                    <label for="Nombre_Del_Resguardante" class="block text-sm font-medium text-gray-700">Nombre del Resguardante</label>
                    <input type="text" id="Nombre_Del_Resguardante" name="Nombre_Del_Resguardante" value="{{ form_data.Nombre_Del_Resguardante if form_data.Nombre_Del_Resguardante is not none else '' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                </div>
                <div>
                    <label for="Puesto" class="block text-sm font-medium text-gray-700">Puesto del resguardante</label>
                    <input type="text" id="Puesto" name="Puesto" value="{{ form_data.Puesto if form_data.Puesto is not none else '' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                </div>
                <div>
                    <label for="Estado_Del_Bien" class="block text-sm font-medium text-gray-700">Estado del Bien</label>
                    <input type="text" id="Estado_Del_Bien" name="Estado_Del_Bien" value="{{ form_data.Estado_Del_Bien if form_data.Estado_Del_Bien is not none else '' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                </div>
                <div>
                    <label for="Marca" class="block text-sm font-medium text-gray-700">Marca</label>
                    <input type="text" id="Marca" name="Marca" value="{{ form_data.Marca if form_data.Marca is not none else '' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                </div>

                <div>
                    <label for="Modelo" class="block text-sm font-medium text-gray-700">Modelo</label>
                    <input type="text" id="Modelo" name="Modelo" value="{{ form_data.Modelo if form_data.Modelo is not none else '' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                </div>
                <div>
                    <label for="Numero_De_Serie" class="block text-sm font-medium text-gray-700">Número de Serie</label>
                    <input type="text" id="Numero_De_Serie" name="Numero_De_Serie" value="{{ form_data.Numero_De_Serie if form_data.Numero_De_Serie is not none else '' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                </div>
                
                <div>
                    <label for="imagenes_bien" class="block text-sm font-medium text-gray-700">Imágenes del Bien</label>
                    <input type="file" name="imagenes_bien" id="imagenes_bien" accept="image/*" multiple class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 cursor-pointer">
                    <p class="text-xs text-gray-500 mt-1">Puedes seleccionar una o más imágenes para el bien. Se añadirán a las que ya seleccionaste.</p>
                    <div id="preview-bien" class="mt-2 flex flex-wrap gap-2"></div>
                </div>

                <div>
                    <label for="imagenes_resguardo" class="block text-sm font-medium text-gray-700">Imágenes del Resguardo</label>
                    <input type="file" name="imagenes_resguardo" id="imagenes_resguardo" accept="image/*" multiple class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 cursor-pointer">
                    <p class="text-xs text-gray-500 mt-1">Puedes seleccionar una o más imágenes para el resguardo. Se añadirán a las que ya seleccionaste.</p>
                    <div id="preview-resguardo" class="mt-2 flex flex-wrap gap-2"></div>
                </div>
                </div>

            <div class="mt-8">
                <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg shadow-md hover:bg-blue-700 transition-colors font-semibold text-lg">
                    {% if form_data.id %}
                        Guardar Cambios
                    {% else %}
                        Agregar Resguardo
                    {% endif %}
                </button>
            </div>
        </form>
    </div>
</div>


        <div class="bg-gray-50 p-6 rounded-lg mb-8 border border-gray-200">
            <h3 class="text-2xl font-semibold mb-2 text-gray-700">Carga Masiva de Resguardos (Excel)</h3>
            <p class="text-gray-600 mb-4">Sube un archivo Excel para ingresar múltiples resguardos. Asegúrate de que los nombres de las columnas en tu Excel coincidan con los nombres de las columnas de la base de datos (sensible a mayúsculas y minúsculas y guiones bajos).</p>
            <p class="text-sm text-gray-600 mb-4">La columna **"NO.POLIZA"** de tu imagen de ejemplo, se mapearía a **`Poliza`** en la base de datos.</p>
            <P class="text-sm font-semibold text-red-600 mb-2">¡ADVERTENCIA! El nombre de las columnas es importante para que sean reconocidas. Las columnas que soporta el sistema son las siguientes:</P>
            <ul class="list-disc list-inside text-sm text-gray-700 mb-4">
                <li>NO.POLIZA</li>
                <li>FECHA POLIZA</li>
                <li>SUB-CTA. ARMONIZADORA</li>
                <li>NO. DE CUENTA</li>
                <li>NO. DE INVENTARIO</li>
                <li>NO. DE RESGUARDO</li>
                <li>PROVEEDOR</li>
                <li>FACTURA</li>
                <li>FECHA FACTURA</li>
                <li>COSTO INICIAL</li>
                <li>DEPRECIACION ACUMULADA</li>
                <li>COSTO FINAL</li>
                <li>CANTIDAD</li>
                <li>DESCRIPCION FISICAS DEL BIEN</li>
                <li>AREA</li>
                <li>RUBRO</li>
                <li>PUESTO</li>
                <li>NO. DE TRABAJADOR</li>
                <li>NOMBRE DIRECTOR/JEFES DE AREA   </li>
                <li>FECHA RESGUARDO</li>
                <li>NOMBRE DEL RESGUARDANTE</li>
            </ul>

            <form action="{{ url_for('excel_import.upload_excel') }}" method="post" enctype="multipart/form-data" class="flex items-center space-x-4">
                <input type="file" name="excel_file" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer">
                <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg shadow-md hover:bg-blue-700 transition-colors font-medium flex items-center">
                    <i class="fas fa-upload mr-2"></i> Subir Excel
                </button>
            </form>
        </div>

{# MODAL para agregar nueva área #}
<div id="addAreaModal" class="modal hidden">
    <div class="modal-content">
        <h3 class="text-xl font-semibold mb-4 text-gray-800">Agregar Nueva Área</h3>
        <input type="text" id="newAreaName" placeholder="Nombre de la nueva área" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border mb-4">
        <div class="flex justify-end space-x-2">
            <button type="button" id="cancelAddAreaBtn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition-colors">Cancelar</button>
            <button type="button" id="saveNewAreaBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">Guardar Área</button>
        </div>
    </div>
</div>
{# FIN MODAL #}

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // JavaScript para ocultar los mensajes flash después de 6 segundos
        const flashMessages = document.querySelectorAll('.flash-message');
        flashMessages.forEach(msg => {
            setTimeout(() => {
                msg.style.opacity = '0';
                msg.style.display = 'none';
            }, 6000);
        });

        // Variables para gestionar las imágenes
        let selectedFilesBien = [];
        let selectedFilesResguardo = [];

        // Función para renderizar las vistas previas de las imágenes
        function renderPreviews(fileArray, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = ''; // Limpiar vistas previas existentes
            fileArray.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const wrapper = document.createElement('div');
                    wrapper.classList.add('relative', 'w-24', 'h-24', 'rounded-md', 'overflow-hidden', 'shadow-sm', 'border');

                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.classList.add('w-full', 'h-full', 'object-cover');

                    const removeBtn = document.createElement('button');
                    removeBtn.innerHTML = '<i class="fas fa-times-circle text-xl"></i>';
                    removeBtn.title = 'Eliminar imagen';
                    removeBtn.classList.add('absolute', 'top-0', 'right-0', 'text-red-500', 'bg-white', 'bg-opacity-75', 'rounded-full', 'hover:text-red-700', 'transition-colors', 'p-1', 'm-1');
                    removeBtn.addEventListener('click', (event) => {
                        event.preventDefault(); // Evitar que el botón envíe el formulario
                        fileArray.splice(index, 1); // Eliminar el archivo del array
                        renderPreviews(fileArray, containerId); // Volver a renderizar las vistas previas
                    });

                    wrapper.appendChild(img);
                    wrapper.appendChild(removeBtn);
                    container.appendChild(wrapper);
                };
                reader.readAsDataURL(file);
            });
        }

        // Event listener para el selector de imágenes del bien
        document.getElementById('imagenes_bien').addEventListener('change', (event) => {
            const files = event.target.files;
            Array.from(files).forEach(file => {
                selectedFilesBien.push(file); // Añadir archivos al array
            });
            // Limpiar el input para permitir seleccionar más archivos
            event.target.value = '';
            renderPreviews(selectedFilesBien, 'preview-bien');
        });

        // Event listener para el selector de imágenes del resguardo
        document.getElementById('imagenes_resguardo').addEventListener('change', (event) => {
            const files = event.target.files;
            Array.from(files).forEach(file => {
                selectedFilesResguardo.push(file); // Añadir archivos al array
            });
            // Limpiar el input para permitir seleccionar más archivos
            event.target.value = '';
            renderPreviews(selectedFilesResguardo, 'preview-resguardo');
        });

        // Event listener para el envío del formulario
        const resguardoForm = document.getElementById('resguardoForm');
        resguardoForm.addEventListener('submit', async (event) => {
            event.preventDefault(); // Detener el envío del formulario por defecto

            const form = event.target;
            const formData = new FormData(form);

            // Agregar las imágenes de los arrays al FormData
            selectedFilesBien.forEach(file => {
                formData.append('imagenes_bien', file);
            });
            selectedFilesResguardo.forEach(file => {
                formData.append('imagenes_resguardo', file);
            });

            // Determinar la URL de la API
            let url;
            
            url = `{{ url_for('resguardos.crear_resguardo') }}`;
            

            // Enviar los datos del formulario usando fetch
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    body: formData,
                });

                // Asumir que el servidor responde con JSON
                const result = await response.json();
                if (response.ok) {
                    showFlashMessage(result.message || 'Resguardo guardado con éxito.', 'success');
                    // Opcional: limpiar los arrays para un nuevo formulario
                    selectedFilesBien = [];
                    selectedFilesResguardo = [];
                    renderPreviews([], 'preview-bien');
                    renderPreviews([], 'preview-resguardo');
                } else {
                    showFlashMessage(result.message || 'Error al guardar el resguardo.', 'error');
                }
            } catch (error) {
                console.error('Error durante la solicitud:', error);
                showFlashMessage('Error en la conexión con el servidor.', 'error');
            }
        });

        // --- Funciones del Modal y la Carga de Áreas (Sin cambios) ---
        const areaSelect = document.getElementById('Area');
        const addAreaBtn = document.getElementById('addAreaBtn');
        const refreshAreasBtn = document.getElementById('refreshAreasBtn');
        const addAreaModal = document.getElementById('addAreaModal');
        const newAreaNameInput = document.getElementById('newAreaName');
        const cancelAddAreaBtn = document.getElementById('cancelAddAreaBtn');
        const saveNewAreaBtn = document.getElementById('saveNewAreaBtn');

        function showFlashMessage(message, category) {
            const flashContainer = document.querySelector('.container');
            const newMessageDiv = document.createElement('div');
            newMessageDiv.classList.add('flash-message', `flash-${category}`);
            newMessageDiv.textContent = message;
            flashContainer.insertBefore(newMessageDiv, flashContainer.firstChild);
            
            setTimeout(() => {
                newMessageDiv.style.opacity = '0';
                newMessageDiv.style.display = 'none';
                newMessageDiv.remove();
            }, 6000);
        }

        async function loadAreas() {
            try {
                const response = await fetch("{{ url_for('areas.get_areas') }}");
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const areas = await response.json();
                const currentSelectedArea = areaSelect.value;
                areaSelect.innerHTML = '<option value="">Selecciona un área</option>';
                areas.forEach(area => {
                    const option = document.createElement('option');
                    option.value = area;
                    option.textContent = area;
                    areaSelect.appendChild(option);
                });
                if (currentSelectedArea && areas.includes(currentSelectedArea)) {
                    areaSelect.value = currentSelectedArea;
                } else if (currentSelectedArea) {
                    areaSelect.value = '';
                }
                showFlashMessage('Áreas actualizadas correctamente.', 'success');
            } catch (error) {
                console.error('Error al cargar las áreas:', error);
                showFlashMessage('Error al cargar las áreas.', 'error');
            }
        }

        addAreaBtn.addEventListener('click', () => {
            newAreaNameInput.value = '';
            addAreaModal.classList.remove('hidden');
        });

        cancelAddAreaBtn.addEventListener('click', () => {
            addAreaModal.classList.add('hidden');
        });

        saveNewAreaBtn.addEventListener('click', async () => {
            const newArea = newAreaNameInput.value.trim();
            if (newArea) {
                try {
                    const response = await fetch("{{ url_for('areas.add_area') }}", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ area_name: newArea })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        showFlashMessage(data.message, 'success');
                        addAreaModal.classList.add('hidden');
                        await loadAreas();
                        areaSelect.value = newArea;
                    } else {
                        showFlashMessage(data.message || 'Error al guardar el área.', 'error');
                    }
                } catch (error) {
                    console.error('Error al guardar nueva área:', error);
                    showFlashMessage('Error al guardar el área.', 'error');
                }
            } else {
                showFlashMessage('El nombre del área no puede estar vacío.', 'warning');
            }
        });

        refreshAreasBtn.addEventListener('click', async () => {
            await loadAreas();
        });
    });
</script>
{% endblock %}
