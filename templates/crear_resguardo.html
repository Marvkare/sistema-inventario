{% extends "base.html" %}

{% block content %}
<div class="min-h-screen bg-gray-100 py-8">
    <div class="container mx-auto px-4">
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6 md:p-8 max-w-4xl mx-auto">
            
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="flash-message flash-{{ category }} mb-6 p-4 rounded-lg border-l-4 {% if category == 'success' %}bg-green-100 border-green-500 text-green-700{% elif category == 'error' %}bg-red-100 border-red-500 text-red-700{% else %}bg-blue-100 border-blue-500 text-blue-700{% endif %}">
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-4 md:mb-0">
                    {% if form_data.id %}
                        Editar Resguardo: {{ form_data.No_Inventario if form_data.No_Inventario is not none else form_data.id }}
                    {% else %}
                        Formulario de nuevo bien, resguardo 
                    {% endif %}
                </h2>
                <div class="flex space-x-2">
                    <a href="{{ url_for('resguardos.crear_resguardo') }}" class="text-gray-600 hover:text-gray-900 transition-colors flex items-center bg-gray-100 px-3 py-2 rounded-lg">
                        <i class="fas fa-sync-alt mr-1"></i> Limpiar Formulario
                    </a>
                </div>
            </div>
            <div>
                <p style="color: red;">Para crear un nuevo bien resguardo es obligatorio el numero de factura  y de inventario</p>
            </div>
            
            <form id="resguardoForm" method="post" enctype="multipart/form-data" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    
                    <div>
                        <label for="No_Factura" class="block text-sm font-medium text-gray-700 mb-1">No. de Factura</label>
                        <input type="text" id="No_Factura" name="No_Factura" value="{{ form_data.No_Factura if form_data.No_Factura is not none else '' }}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <div>
                        <label for="No_Inventario" class="block text-sm font-medium text-gray-700 mb-1">No. de Inventario</label>
                        <input type="text" id="No_Inventario" name="No_Inventario" value="{{ form_data.No_Inventario if form_data.No_Inventario is not none else '' }}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div>
                        <label for="No_Resguardo" class="block text-sm font-medium text-gray-700 mb-1">No. de Resguardo</label>
                        <input type="text" id="No_Resguardo" name="No_Resguardo" value="{{ form_data.No_Resguardo if form_data.No_Resguardo is not none else '' }}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <div>
                        <label for="No_Cuenta" class="block text-sm font-medium text-gray-700 mb-1">No. de Cuenta</label>
                        <input type="text" id="No_Cuenta" name="No_Cuenta" value="{{ form_data.No_Cuenta if form_data.No_Cuenta is not none else '' }}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div>
                        <label for="No_Trabajador" class="block text-sm font-medium text-gray-700 mb-1">No. de Trabajador</label>
                        <input type="text" id="No_Trabajador" name="No_Trabajador" value="{{ form_data.No_Trabajador if form_data.No_Trabajador is not none else '' }}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <div>
                        <label for="Proveedor" class="block text-sm font-medium text-gray-700 mb-1">Proveedor</label>
                        <input type="text" id="Proveedor" name="Proveedor" value="{{ form_data.Proveedor if form_data.Proveedor is not none else '' }}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div>
                        <label for="Fecha_Resguardo" class="block text-sm font-medium text-gray-700 mb-1">Fecha de Resguardo</label>
                        <input type="date" id="Fecha_Resguardo" name="Fecha_Resguardo" value="{{ form_data.Fecha_Resguardo if form_data.Fecha_Resguardo is not none else '' }}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <div>
                        <label for="Descripcion_Del_Bien" class="block text-sm font-medium text-gray-700 mb-1">Descripción del Bien</label>
                        <textarea id="Descripcion_Del_Bien" name="Descripcion_Del_Bien" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">{{ form_data.Descripcion_Del_Bien if form_data.Descripcion_Del_Bien is not none else '' }}</textarea>
                    </div>
                    
                    <div>
                        <label for="Descripcion_Corta_Del_Bien" class="block text-sm font-medium text-gray-700 mb-1">Descripción corta del bien</label>
                        <textarea id="Descripcion_Corta_Del_Bien" name="Descripcion_Corta_Del_Bien" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">{{ form_data.Descripcion_Corta_Del_Bien if form_data.Descripcion_Corta_Del_Bien is not none else '' }}</textarea>
                    </div>

                    <div>
                        <label for="Area" class="block text-sm font-medium text-gray-700 mb-1">Área</label>
                        <div class="flex items-center space-x-2">
                            <select id="Area" name="Area" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Selecciona un área</option>
                                {% for area in areas %}
                                    <option value="{{ area }}" {% if form_data.Area == area %}selected{% endif %}>{{ area }}</option>
                                {% endfor %}
                            </select>
                            <button type="button" id="addAreaBtn" class="bg-green-500 hover:bg-green-600 text-white p-2 rounded-lg shadow-sm transition-colors" title="Agregar Nueva Área">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button type="button" id="refreshAreasBtn" class="bg-gray-400 hover:bg-gray-500 text-white p-2 rounded-lg shadow-sm transition-colors" title="Refrescar Áreas">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>

                    <div>
                        <label for="Rubro" class="block text-sm font-medium text-gray-700 mb-1">Rubro</label>
                        <input type="text" id="Rubro" name="Rubro" value="{{ form_data.Rubro if form_data.Rubro is not none else '' }}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <div>
                        <label for="Poliza" class="block text-sm font-medium text-gray-700 mb-1">Póliza</label>
                        <input type="text" id="Poliza" name="Poliza" value="{{ form_data.Poliza if form_data.Poliza is not none else '' }}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div>
                        <label for="Fecha_Poliza" class="block text-sm font-medium text-gray-700 mb-1">Fecha de Póliza</label>
                        <input type="date" id="Fecha_Poliza" name="Fecha_Poliza" value="{{ form_data.Fecha_Poliza if form_data.Fecha_Poliza is not none else '' }}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <div>
                        <label for="Sub_Cuenta_Armonizadora" class="block text-sm font-medium text-gray-700 mb-1">Sub-Cuenta Armonizadora</label>
                        <input type="text" id="Sub_Cuenta_Armonizadora" name="Sub_Cuenta_Armonizadora" value="{{ form_data.Sub_Cuenta_Armonizadora if form_data.Sub_Cuenta_Armonizadora is not none else '' }}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div>
                        <label for="Fecha_Factura" class="block text-sm font-medium text-gray-700 mb-1">Fecha de Factura</label>
                        <input type="date" id="Fecha_Factura" name="Fecha_Factura" value="{{ form_data.Fecha_Factura if form_data.Fecha_Factura is not none else '' }}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <div>
                        <label for="Costo_Inicial" class="block text-sm font-medium text-gray-700 mb-1">Costo Inicial</label>
                        <input type="number" step="0.01" id="Costo_Inicial" name="Costo_Inicial" value="{{ form_data.Costo_Inicial if form_data.Costo_Inicial is not none else '' }}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div>
                        <label for="Depreciacion_Acumulada" class="block text-sm font-medium text-gray-700 mb-1">Depreciación Acumulada</label>
                        <input type="number" step="0.01" id="Depreciacion_Acumulada" name="Depreciacion_Acumulada" value="{{ form_data.Depreciacion_Acumulada if form_data.Depreciacion_Acumulada is not none else '' }}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <div>
                        <label for="Costo_Final_Cantidad" class="block text-sm font-medium text-gray-700 mb-1">Costo Final</label>
                        <input type="number" step="0.01" id="Costo_Final_Cantidad" name="Costo_Final_Cantidad" value="{{ form_data.Costo_Final_Cantidad if form_data.Costo_Final_Cantidad is not none else '' }}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div>
                        <label for="Cantidad" class="block text-sm font-medium text-gray-700 mb-1">Cantidad</label>
                        <input type="number" id="Cantidad" name="Cantidad" value="{{ form_data.Cantidad if form_data.Cantidad is not none else '' }}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div>
                        <label for="Nombre_Director_Jefe_De_Area" class="block text-sm font-medium text-gray-700 mb-1">Nombre Director/Jefe de Área</label>
                        <input type="text" id="Nombre_Director_Jefe_De_Area" name="Nombre_Director_Jefe_De_Area" value="{{ form_data.Nombre_Director_Jefe_De_Area if form_data.Nombre_Director_Jefe_De_Area is not none else '' }}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div>
                        <label for="Tipo_De_Resguardo" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Resguardo</label>
                        <select id="Tipo_De_Resguardo" name="Tipo_De_Resguardo" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <option value="1" {% if form_data.Tipo_De_Resguardo == 1 %}selected{% endif %}>Sujeto de Control</option>
                            <option value="0" {% if form_data.Tipo_De_Resguardo == 0 %}selected{% endif %}>Resguardo Normal</option>
                        </select>
                    </div>

                    
                    <div>
                        <label for="Nombre_Del_Resguardante" class="block text-sm font-medium text-gray-700 mb-1">Nombre del Resguardante</label>
                        <input type="text" id="Nombre_Del_Resguardante" name="Nombre_Del_Resguardante" value="{{ form_data.Nombre_Del_Resguardante if form_data.Nombre_Del_Resguardante is not none else '' }}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div>
                        <label for="Puesto" class="block text-sm font-medium text-gray-700 mb-1">Puesto del resguardante</label>
                        <input type="text" id="Puesto" name="Puesto" value="{{ form_data.Puesto if form_data.Puesto is not none else '' }}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div>
                        <label for="Estado_Del_Bien" class="block text-sm font-medium text-gray-700 mb-1">Estado del Bien</label>
                        <input type="text" id="Estado_Del_Bien" name="Estado_Del_Bien" value="{{ form_data.Estado_Del_Bien if form_data.Estado_Del_Bien is not none else '' }}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div>
                        <label for="Marca" class="block text-sm font-medium text-gray-700 mb-1">Marca</label>
                        <input type="text" id="Marca" name="Marca" value="{{ form_data.Marca if form_data.Marca is not none else '' }}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <div>
                        <label for="Modelo" class="block text-sm font-medium text-gray-700 mb-1">Modelo</label>
                        <input type="text" id="Modelo" name="Modelo" value="{{ form_data.Modelo if form_data.Modelo is not none else '' }}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div>
                        <label for="Numero_De_Serie" class="block text-sm font-medium text-gray-700 mb-1">Número de Serie</label>
                        <input type="text" id="Numero_De_Serie" name="Numero_De_Serie" value="{{ form_data.Numero_De_Serie if form_data.Numero_De_Serie is not none else '' }}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div class="md:col-span-2">
                        <h3 class="text-xl font-semibold text-blue-800 mb-4 border-b pb-2">Imágenes</h3>
                    </div>

                    <div>
                        <label for="imagenes_bien" class="block text-sm font-medium text-gray-700 mb-1">Imagen del Bien</label>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center">
                            <label for="imagenes_bien" class="cursor-pointer flex flex-col items-center">
                                <i class="fas fa-camera text-blue-500 text-3xl mb-2"></i>
                                <span class="text-blue-500 font-medium">Seleccionar imagen para recortar</span>
                            </label>
                            <input type="file" name="imagenes_bien" id="imagenes_bien" accept="image/*" class="hidden">
                            <p class="text-xs text-gray-500 mt-2">Selecciona una imagen para el bien. Se abrirá el editor de recorte.</p>
                        </div>
                        <div id="preview-bien" class="mt-4 flex flex-wrap gap-2"></div>
                    </div>

                    <div>
                        <label for="imagenes_resguardo" class="block text-sm font-medium text-gray-700 mb-1">Imágenes del Resguardo</label>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center">
                            <label for="imagenes_resguardo" class="cursor-pointer flex flex-col items-center">
                                <i class="fas fa-images text-blue-500 text-3xl mb-2"></i>
                                <span class="text-blue-500 font-medium">Seleccionar imágenes para recortar</span>
                            </label>
                            <input type="file" name="imagenes_resguardo" id="imagenes_resguardo" accept="image/*" multiple class="hidden">
                            <p class="text-xs text-gray-500 mt-2">Puedes seleccionar una o más imágenes para el resguardo. Cada una se recortará individualmente.</p>
                        </div>
                        <div id="preview-resguardo" class="mt-4 flex flex-wrap gap-2"></div>
                    </div>
                </div>

                <div class="mt-8">
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-semibold text-lg transition-colors">
                        {% if form_data.id %}
                            Guardar Cambios
                        {% else %}
                            Agregar Resguardo
                        {% endif %}
                    </button>
                </div>
            </form>
        </div>

        <div class="bg-gray-50 p-6 rounded-lg mt-8 border border-gray-200">
            <h3 class="text-2xl font-semibold mb-2 text-gray-700">Carga Masiva de Resguardos (Excel)</h3>
            <p class="text-gray-600 mb-4">Sube un archivo Excel para ingresar múltiples resguardos. Asegúrate de que los nombres de las columnas en tu Excel coincidan con los nombres de las columnas de la base de datos (sensible a mayúsculas y minúsculas y guiones bajos).</p>
            <p class="text-sm text-gray-600 mb-4">La columna <strong>"NO.POLIZA"</strong> de tu imagen de ejemplo, se mapearía a <strong>`Poliza`</strong> en la base de datos.</p>
            <p class="text-sm font-semibold text-red-600 mb-2">¡ADVERTENCIA! El nombre de las columnas es importante para que sean reconocidas. Las columnas que soporta el sistema son las siguientes:</p>
            <ul class="list-disc list-inside text-sm text-gray-700 mb-4">
                <li>NO. DE INVENTARIO</li>
                <li>NO. FACTURA</li>
                <li>NO. DE CUENTA</li>
                <li>NO. DE RESGUARDO</li>
                <li>PROVEEDOR</li>
                <li>DESCRIPCION DEL BIEN</li>
                <li>DESCRIPCION CORTA DEL BIEN</li>
                <li>RUBRO</li>
                <li>NO.POLIZA</li>
                <li>FECHA POLIZA</li>
                <li>SUB-CTA. ARMONIZADORA</li>
                <li>FECHA FACTURA</li>
                <li>COSTO INICIAL</li>
                <li>DEPRECIACION ACUMULADA</li>
                <li>COSTO FINAL</li>
                <li>CANTIDAD</li>
                <li>ESTADO DEL BIEN</li>
                <li>MARCA</li>
                <li>MODELO</li>
                <li>NUMERO DE SERIE</li>
                <li>TIPO DE ALTA</li>
                <li>UBICACION</li>
                <li>AREA</li>
                <li>TIPO DE RESGUARDO</li>
                <li>FECHA DE RESGUARDO</li>
                <li>NO. DE TRABAJADOR</li>
                <li>PUESTO TRABAJADOR</li>
                <li>NOMBRE DEL RESGUARDANTE</li>
                <li>NOMBRE DIRECTOR/JEFES DE AREA</li>
            </ul>

            <form action="{{ url_for('excel_import.upload_excel') }}" method="post" enctype="multipart/form-data" class="flex flex-col md:flex-row items-start md:items-center space-y-4 md:space-y-0 md:space-x-4">
                <input type="file" name="excel_file" class="flex-grow px-4 py-2 border border-gray-300 rounded-lg">
                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition-colors font-medium flex items-center">
                    <i class="fas fa-upload mr-2"></i> Subir Excel
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Modal para agregar área -->
<div id="addAreaModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg shadow-xl w-11/12 md:w-1/3 p-6">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">Agregar Nueva Área</h3>
        <input type="text" id="newAreaName" placeholder="Nombre de la nueva área" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 mb-4">
        <div class="flex justify-end space-x-2">
            <button type="button" id="cancelAddAreaBtn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition-colors">Cancelar</button>
            <button type="button" id="saveNewAreaBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">Guardar Área</button>
        </div>
    </div>
</div>

<!-- Modal para recorte de imagen -->
<div id="imageCropModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg shadow-xl w-11/12 md:w-3/4 lg:w-2/3 max-h-screen overflow-auto">
        <div class="flex justify-between items-center border-b px-6 py-4">
            <h3 class="text-xl font-semibold text-gray-800" id="modalTitle">Recortar Imagen</h3>
            <button type="button" class="close-modal text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
        </div>
        <div class="p-6">
            <div class="w-full h-96 mb-4">
                <img id="imageToCrop" src="" class="max-w-full h-full mx-auto">
            </div>
            <div class="flex justify-end space-x-3">
                <button type="button" id="cancelCrop" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">Cancelar</button>
                <button type="button" id="cropImage" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Recortar y Guardar</button>
            </div>
        </div>
    </div>
</div>

<!-- Incluir Cropper.js -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Variables
        let selectedFilesBien = [];
        let selectedFilesResguardo = [];
        let cropperInstance = null;
        let currentCropMode = null; // 'bien' o 'resguardo'
        let currentResguardoFiles = [];
        let currentResguardoIndex = 0;
        
        // Elementos del DOM
        const imagenBienInput = document.getElementById('imagenes_bien');
        const imagenResguardoInput = document.getElementById('imagenes_resguardo');
        const imageCropModal = document.getElementById('imageCropModal');
        const imageToCrop = document.getElementById('imageToCrop');
        const modalTitle = document.getElementById('modalTitle');
        const cropImageBtn = document.getElementById('cropImage');
        const cancelCropBtn = document.getElementById('cancelCrop');
        const closeModalBtn = document.querySelector('.close-modal');
        const resguardoForm = document.getElementById('resguardoForm');
        
        const areaSelect = document.getElementById('Area');
        const addAreaBtn = document.getElementById('addAreaBtn');
        const refreshAreasBtn = document.getElementById('refreshAreasBtn');
        const addAreaModal = document.getElementById('addAreaModal');
        const newAreaNameInput = document.getElementById('newAreaName');
        const cancelAddAreaBtn = document.getElementById('cancelAddAreaBtn');
        const saveNewAreaBtn = document.getElementById('saveNewAreaBtn');

        // Configurar los labels como disparadores de los inputs de archivo
        document.querySelector('label[for="imagenes_bien"]').addEventListener('click', function() {
            imagenBienInput.click();
        });
        
        document.querySelector('label[for="imagenes_resguardo"]').addEventListener('click', function() {
            imagenResguardoInput.click();
        });

        // Ocultar mensajes flash después de 6 segundos
        const flashMessages = document.querySelectorAll('.flash-message');
        flashMessages.forEach(msg => {
            setTimeout(() => {
                msg.style.opacity = '0';
                setTimeout(() => {
                    msg.style.display = 'none';
                }, 300);
            }, 6000);
        });

        // Funciones auxiliares
        function showFlashMessage(message, category) {
            const flashContainer = document.querySelector('.container');
            const newMessageDiv = document.createElement('div');
            newMessageDiv.classList.add('flash-message', 'p-4', 'rounded-lg', 'border-l-4', 'mb-6');
            
            if (category === 'success') {
                newMessageDiv.classList.add('bg-green-100', 'border-green-500', 'text-green-700');
            } else if (category === 'error') {
                newMessageDiv.classList.add('bg-red-100', 'border-red-500', 'text-red-700');
            } else {
                newMessageDiv.classList.add('bg-blue-100', 'border-blue-500', 'text-blue-700');
            }
            
            newMessageDiv.textContent = message;
            flashContainer.insertBefore(newMessageDiv, flashContainer.firstChild);
            
            setTimeout(() => {
                newMessageDiv.style.opacity = '0';
                setTimeout(() => {
                    newMessageDiv.style.display = 'none';
                    newMessageDiv.remove();
                }, 300);
            }, 6000);
        }

        function renderPreviews(fileArray, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            fileArray.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'relative w-24 h-24 rounded-lg overflow-hidden shadow-md border';
                    
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'w-full h-full object-cover';
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                    removeBtn.title = 'Eliminar imagen';
                    removeBtn.className = 'absolute top-0 right-0 bg-white bg-opacity-70 text-red-500 rounded-full p-1 m-1 hover:text-red-700';
                    removeBtn.onclick = function(event) {
                        event.preventDefault();
                        fileArray.splice(index, 1);
                        renderPreviews(fileArray, containerId);
                    };
                    
                    previewItem.appendChild(img);
                    previewItem.appendChild(removeBtn);
                    container.appendChild(previewItem);
                };
                reader.readAsDataURL(file);
            });
        }
        
        // Función para mostrar el modal de recorte
        function showCropModal() {
            imageCropModal.classList.remove('hidden');
        }
        
        // Función para ocultar el modal de recorte
        function hideCropModal() {
            imageCropModal.classList.add('hidden');
            if (cropperInstance) {
                cropperInstance.destroy();
                cropperInstance = null;
            }
        }
        
        // Evento cuando se selecciona una imagen para el bien
        imagenBienInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                currentCropMode = 'bien';
                modalTitle.textContent = 'Recortar Imagen del Bien';
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    imageToCrop.src = e.target.result;
                    showCropModal();
                    
                    // Inicializar Cropper.js después de que la imagen se cargue
                    imageToCrop.onload = function() {
                        if (cropperInstance) {
                            cropperInstance.destroy();
                        }
                        
                        cropperInstance = new Cropper(imageToCrop, {
                            aspectRatio: NaN,
                            viewMode: 1,
                            responsive: true,
                            dragMode: 'move',
                            autoCropArea: 0.8,
                        });
                    };
                };
                reader.readAsDataURL(file);
            }
        });
        
        // Evento cuando se seleccionan imágenes para el resguardo
        imagenResguardoInput.addEventListener('change', function(event) {
            const files = Array.from(event.target.files);
            if (files.length > 0) {
                currentCropMode = 'resguardo';
                currentResguardoFiles = files;
                currentResguardoIndex = 0;
                
                // Procesar la primera imagen
                processNextResguardoImage();
            }
        });
        
        // Función para procesar la siguiente imagen de resguardo
        function processNextResguardoImage() {
            if (currentResguardoIndex < currentResguardoFiles.length) {
                const file = currentResguardoFiles[currentResguardoIndex];
                modalTitle.textContent = `Recortar Imagen de Resguardo (${currentResguardoIndex + 1}/${currentResguardoFiles.length})`;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    imageToCrop.src = e.target.result;
                    showCropModal();
                    
                    // Inicializar Cropper.js después de que la imagen se cargue
                    imageToCrop.onload = function() {
                        if (cropperInstance) {
                            cropperInstance.destroy();
                        }
                        
                        cropperInstance = new Cropper(imageToCrop, {
                            aspectRatio: NaN,
                            viewMode: 1,
                            responsive: true,
                            dragMode: 'move',
                            autoCropArea: 0.8,
                        });
                    };
                };
                reader.readAsDataURL(file);
            }
        }
        
        // Evento para recortar la imagen
        cropImageBtn.addEventListener('click', function() {
            if (cropperInstance) {
                cropperInstance.getCroppedCanvas({
                    width: 500,
                    height: 500
                }).toBlob(function(blob) {
                    const fileName = currentCropMode === 'bien' ? 'cropped_bien.png' : `cropped_resguardo_${currentResguardoIndex + 1}.png`;
                    const file = new File([blob], fileName, { type: 'image/png' });
                    
                    if (currentCropMode === 'bien') {
                        selectedFilesBien = [file];
                        renderPreviews(selectedFilesBien, 'preview-bien');
                        hideCropModal();
                    } else if (currentCropMode === 'resguardo') {
                        selectedFilesResguardo.push(file);
                        renderPreviews(selectedFilesResguardo, 'preview-resguardo');
                        
                        // Procesar la siguiente imagen
                        currentResguardoIndex++;
                        if (currentResguardoIndex < currentResguardoFiles.length) {
                            processNextResguardoImage();
                        } else {
                            hideCropModal();
                        }
                    }
                }, 'image/png');
            }
        });
        
        // Eventos para cerrar el modal
        cancelCropBtn.addEventListener('click', function() {
            if (currentCropMode === 'resguardo') {
                // Si estamos en modo resguardo, pasar a la siguiente imagen sin guardar la actual
                currentResguardoIndex++;
                if (currentResguardoIndex < currentResguardoFiles.length) {
                    processNextResguardoImage();
                } else {
                    hideCropModal();
                }
            } else {
                hideCropModal();
            }
        });
        
        closeModalBtn.addEventListener('click', function() {
            if (currentCropMode === 'resguardo') {
                // Si estamos en modo resguardo, cancelar todo el proceso
                currentResguardoIndex = currentResguardoFiles.length;
            }
            hideCropModal();
        });
        
        // Cerrar modal al hacer clic fuera del contenido
        window.addEventListener('click', function(event) {
            if (event.target === imageCropModal) {
                if (currentCropMode === 'resguardo') {
                    // Si estamos en modo resguardo, cancelar todo el proceso
                    currentResguardoIndex = currentResguardoFiles.length;
                }
                hideCropModal();
            }
        });
        
        // Evento para enviar el formulario
        resguardoForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            
            // Eliminar los archivos originales del formulario
            formData.delete('imagenes_bien');
            formData.delete('imagenes_resguardo');
            
            if (selectedFilesBien.length > 0) {
                formData.append('imagenes_bien', selectedFilesBien[0]);
            }
            
            selectedFilesResguardo.forEach(file => {
                formData.append('imagenes_resguardo', file);
            });
            
            let url = `{{ url_for('resguardos.crear_resguardo') }}`;
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    body: formData,
                });
                
                const result = await response.json();
                if (response.ok) {
                    showFlashMessage(result.message || 'Resguardo guardado con éxito.', 'success');
                    selectedFilesBien = [];
                    selectedFilesResguardo = [];
                    renderPreviews([], 'preview-bien');
                    renderPreviews([], 'preview-resguardo');
                } else {
                    showFlashMessage(result.message || 'Error al guardar el resguardo.', 'error');
                }
            } catch (error) {
                console.error('Error durante la solicitud:', error);
                showFlashMessage('Error en la conexión con el servidor.', 'error');
            }
        });
        
        // Lógica para áreas
        addAreaBtn.addEventListener('click', function() {
            newAreaNameInput.value = '';
            addAreaModal.classList.remove('hidden');
        });
        
        cancelAddAreaBtn.addEventListener('click', function() {
            addAreaModal.classList.add('hidden');
        });
        
        saveNewAreaBtn.addEventListener('click', async function() {
            const newArea = newAreaNameInput.value.trim();
            if (newArea) {
                try {
                    const response = await fetch("{{ url_for('areas.add_area') }}", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ area_name: newArea })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        showFlashMessage(data.message, 'success');
                        addAreaModal.classList.add('hidden');
                        await loadAreas();
                        areaSelect.value = newArea;
                    } else {
                        showFlashMessage(data.message || 'Error al guardar el área.', 'error');
                    }
                } catch (error) {
                    console.error('Error al guardar nueva área:', error);
                    showFlashMessage('Error al guardar el área.', 'error');
                }
            } else {
                showFlashMessage('El nombre del área no puede estar vacío.', 'warning');
            }
        });
        
        refreshAreasBtn.addEventListener('click', async function() {
            await loadAreas();
        });
        
        async function loadAreas() {
            try {
                const response = await fetch("{{ url_for('areas.get_areas') }}");
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const areas = await response.json();
                const currentSelectedArea = areaSelect.value;
                areaSelect.innerHTML = '<option value="">Selecciona un área</option>';
                areas.forEach(area => {
                    const option = document.createElement('option');
                    option.value = area;
                    option.textContent = area;
                    areaSelect.appendChild(option);
                });
                if (currentSelectedArea && areas.includes(currentSelectedArea)) {
                    areaSelect.value = currentSelectedArea;
                } else if (currentSelectedArea) {
                    areaSelect.value = '';
                }
                showFlashMessage('Áreas actualizadas correctamente.', 'success');
            } catch (error) {
                console.error('Error al cargar las áreas:', error);
                showFlashMessage('Error al cargar las áreas.', 'error');
            }
        }
    });
</script>
{% endblock %}