{% extends "base.html" %}

{% block title %}Traspasar Resguardo{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto py-6 sm:px-6 lg:px-8">
    <div class="bg-white overflow-hidden shadow-xl sm:rounded-lg p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Traspasar Resguardo: {{ resguardo_anterior.No_Inventario }}</h2>
        
        <!-- Contenedor para los mensajes flash de JavaScript -->
        <div id="js-flash-container"></div>

        <form id="traspasoForm" method="post" enctype="multipart/form-data" class="space-y-6">

            <!-- Sección de Información del Resguardo Anterior -->
            <div class="mb-8 p-6 bg-red-50 rounded-lg border-l-4 border-red-400">
                <h3 class="text-xl font-semibold text-red-800 mb-4 flex items-center">
                    <i class="fas fa-user-slash text-red-500 mr-3"></i>
                    Información del Resguardo Anterior
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div>
                        <p><strong class="font-medium text-red-700">No. de Resguardo:</strong> {{ resguardo_anterior.No_Resguardo }}</p>
                        <p><strong class="font-medium text-red-700">Resguardante Anterior:</strong> {{ resguardo_anterior.Nombre_Del_Resguardante }}</p>
                    </div>
                    <div>
                        <p><strong class="font-medium text-red-700">Área Anterior:</strong> {{ resguardo_anterior.Area_Anterior_Nombre }}</p>
                        <p><strong class="font-medium text-red-700">Fecha de Asignación:</strong> {{ resguardo_anterior.Fecha_Resguardo }}</p>
                    </div>
                </div>
            </div>

            <!-- Sección de Información del Bien (Lectura) -->
            <div class="mb-8 p-6 bg-gray-50 rounded-lg border-l-4 border-gray-400">
                <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-box-open text-gray-600 mr-3"></i>
                    Datos del Bien
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div>
                        <p><strong class="font-medium text-gray-700">No. de Inventario:</strong> {{ resguardo_anterior.No_Inventario }}</p>
                        <p><strong class="font-medium text-gray-700">Proveedor:</strong> {{ resguardo_anterior.Proveedor or 'N/A' }}</p>
                    </div>
                    <div>
                        <p><strong class="font-medium text-gray-700">Descripción:</strong> {{ resguardo_anterior.Descripcion_Del_Bien or 'N/A' }}</p>
                        <p><strong class="font-medium text-gray-700">Número de Serie:</strong> {{ resguardo_anterior.Numero_De_Serie or 'N/A' }}</p>
                    </div>
                </div>
            </div>
            
            <!-- Sección de Información del Nuevo Resguardo -->
            <div class="mb-8 p-6 bg-green-50 rounded-lg border-l-4 border-green-400">
                <h3 class="text-xl font-semibold text-green-800 mb-4 flex items-center">
                    <i class="fas fa-user-plus text-green-500 mr-3"></i>
                    Información del Nuevo Resguardante
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div>
                        <label for="No_Resguardo_Nuevo" class="block text-sm font-medium text-gray-700">No. de Resguardo</label>
                        <input type="text"  id="No_Resguardo_Nuevo" name="No_Resguardo_Nuevo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" value="{{resguardo_anterior.No_Resguardo}}" required readonly>
                    </div>
                    <div>
                       <label for="Area_Nueva">Área Nueva</label>
                        <select name="Area_Nueva" id="Area_Nueva" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                            <option value="">Seleccione un área...</option>
                            {% for area in areas %}
                                <option value="{{ area.id }}">{{ area.nombre }}</option>
                            {% endfor %}
                        </select> 
                    </div>
                    <div>
                        <label for="Ubicacion_Nueva" class="block text-sm font-medium text-gray-700">Ubicación (Nueva)</label>
                        <input type="text" id="Ubicacion_Nueva" name="Ubicacion_Nueva" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="Nombre_Del_Resguardante_Nuevo" class="block text-sm font-medium text-gray-700">Nombre del Resguardante (Nuevo)</label>
                        <input type="text" id="Nombre_Del_Resguardante_Nuevo" name="Nombre_Del_Resguardante_Nuevo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                    </div>
                    <div>
                        <label for="No_Trabajador_Nuevo" class="block text-sm font-medium text-gray-700">No. Trabajador (Nuevo)</label>
                        <input type="text" id="No_Trabajador_Nuevo" name="No_Trabajador_Nuevo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="Puesto_Trabajador_Nuevo" class="block text-sm font-medium text-gray-700">Puesto (Nuevo)</label>
                        <input type="text" id="Puesto_Trabajador_Nuevo" name="Puesto_Trabajador_Nuevo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                     <div>
                        <label for="No_Nomina_Trabajador_Nuevo" class="block text-sm font-medium text-gray-700">No. Nómina (Nuevo)</label>
                        <input type="number" id="No_Nomina_Trabajador_Nuevo" name="No_Nomina_Trabajador_Nuevo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="Fecha_Resguardo_Nuevo" class="block text-sm font-medium text-gray-700">Fecha del Resguardo (Nuevo)</label>
                        <input type="date" id="Fecha_Resguardo_Nuevo" name="Fecha_Resguardo_Nuevo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                    </div>
                    <div>
                        <label for="Nombre_Director_Jefe_De_Area_Nueva" class="block text-sm font-medium text-gray-700">Nombre Director/Jefe de Área (Nueva)</label>
                        <input type="text" id="Nombre_Director_Jefe_De_Area_Nueva" name="Nombre_Director_Jefe_De_Area_Nueva" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="Tipo_De_Resguardo_Display" class="block text-sm font-medium text-gray-700">Tipo de Resguardo</label>
                        <input type="text" id="Tipo_De_Resguardo_Display" class="mt-1 block w-full rounded-md border-gray-300 bg-gray-100 shadow-sm" value="{% if resguardo_anterior.Tipo_De_Resguardo == 1 %}Sujeto de Control{% else %}Resguardo Normal{% endif %}" readonly>
                        <input type="hidden" name="Tipo_De_Resguardo_Nuevo" value="{{ resguardo_anterior.Tipo_De_Resguardo }}">
                    </div>
                </div>
            </div>

            <!-- Sección de Datos del Oficio de Traspaso y Archivos -->
            <div id="oficios-container" class="space-y-6">
                <!-- El primer oficio se carga por defecto -->
                <div class="oficio-block mb-8 p-6 bg-blue-50 rounded-lg border-l-4 border-blue-400" data-oficio-index="1">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-blue-800 flex items-center">
                            <i class="fas fa-file-invoice-dollar text-blue-500 mr-3"></i>
                            Oficio de Traspaso #<span class="oficio-number">1</span>
                        </h3>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div>
                            <label for="Dependencia_Oficio_1" class="block text-sm font-medium text-gray-700">Dependencia</label>
                            <input type="text" id="Dependencia_Oficio_1" name="Dependencia_Oficio_1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="Oficio_clave_1" class="block text-sm font-medium text-gray-700">Oficio Clave</label>
                            <input type="text" id="Oficio_clave_1" name="Oficio_clave_1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="Lugar_Fecha_Oficio_1" class="block text-sm font-medium text-gray-700">Lugar y Fecha</label>
                            <input type="date" id="Lugar_Fecha_Oficio_1" name="Lugar_Fecha_Oficio_1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        </div>
                        <div class="md:col-span-2 lg:col-span-3">
                            <label for="Asunto_Oficio_1" class="block text-sm font-medium text-gray-700">Asunto</label>
                            <textarea id="Asunto_Oficio_1" name="Asunto_Oficio_1" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex justify-end mt-8">
                <button type="submit" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    <i class="fas fa-save mr-2"></i>
                    Confirmar Traspaso
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const traspasoForm = document.getElementById('traspasoForm');
        
        // Función para mostrar mensajes de error de JavaScript
        function showJsFlashMessage(message, category) {
            const container = document.getElementById('js-flash-container');
            const alertClasses = {
                'success': 'bg-green-100 border-green-500 text-green-700',
                'danger': 'bg-red-100 border-red-500 text-red-700',
                'warning': 'bg-yellow-100 border-yellow-500 text-yellow-700'
            };
            const alertDiv = document.createElement('div');
            alertDiv.className = `p-4 mb-4 rounded-lg border-l-4 ${alertClasses[category] || 'bg-gray-100 border-gray-500 text-gray-700'}`;
            alertDiv.textContent = message;
            container.innerHTML = ''; // Limpiar mensajes anteriores
            container.appendChild(alertDiv);
        }

        traspasoForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(traspasoForm);
            
            try {
                const response = await fetch(traspasoForm.action, {
                    method: 'POST',
                    body: formData,
                });
                
                const result = await response.json();
                
                if (response.ok && result.redirect_url) {
                    window.location.href = result.redirect_url;
                } else {
                    showJsFlashMessage(result.message || 'Ocurrió un error.', result.category || 'danger');
                }

            } catch (error) {
                console.error('Error:', error);
                showJsFlashMessage('Ocurrió un error de red. Por favor, intente de nuevo.', 'danger');
            }
        });
    });
</script>
{% endblock %}

